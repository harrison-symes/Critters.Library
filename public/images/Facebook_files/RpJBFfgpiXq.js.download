;/*FB_PKG_DELIM*/

__d("EncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYISingleton","I64"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l;async function a(a,b,c,e,f,g,n){var o=d("EncryptedBackupsDYISingleton").getSingleton(),p=o.getLogger();o=o.getThreadKeyForThreadId(b);if(o==null){p.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread key for thread id: ",""])),b);return}void p.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handling message range query for thread with thread key ",", hasMoreBefore: ",""])),b,e);c.length>0&&await g(o,b,c);if(!e||f==null){e&&f==null&&void p.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["nextTimestampMs was not supplied for thread with thread key ","."])),b);m(o);return}g=(l||(l=d("I64"))).to_string(f);void p.LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Issuing next range query for thread with thread key ",", server generated next reference timestamp: ",""])),b,g);void n(a,g,b)}function m(a){var b=d("EncryptedBackupsDYISingleton").getSingleton();b.deleteThreadKeyFromThreadsRestoreInProgress(a)}g.handleMessageRangeQueryRestore=a}),98);
__d("MAWAsyncEBPendingQueryPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g,h=new Map(),i=new Map(),j=new Map(),k=new Map(),l=new Map(),m=new Map();function a(a){var c=new(g||(g=b("Promise")))(function(b,c){i.set(a,b),k.set(a,c)});h.set(a,c);return c}function c(a,b){j.set(a,b)}function d(a){return j.get(a)}function e(a){var c=new(g||(g=b("Promise")))(function(b,c){l.set(a,{data:null,resolve:b}),m.set(a,c)});return c}function n(a,b){var c=i.get(a);c!=null&&(i["delete"](a),c(b));c=l.get(a);c!=null&&l.set(a,{data:b,resolve:c.resolve})}function o(a,b){var c=k.get(a);c!=null&&(i["delete"](a),c(b));c=m.get(a);c!=null&&(m["delete"](a),c(b),l["delete"](a))}function p(a){var b=l.get(a);b!=null&&b.data!=null&&(b.resolve(b.data),l["delete"](a),m["delete"](a))}f.getPendingQueryPromiseFromTrace=a;f.setJidFromThreadId=c;f.getJidFromThreadId=d;f.getWaitForRestorePromiseFromTrace=e;f.resolvePendingQueryIfPresent=n;f.rejectPendingQueryIfPresent=o;f.resolvePendingQueryUponReStore=p}),66);
__d("MAWEncryptedBackupsDYIProcessProtobufMessages",["CurrentUser","EncryptedBackupsDYIMessageProcessingUtils","EncryptedBackupsDYISingleton","MAWGroupPollsDualEncryptionUtils","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWMsgType","WAHashUtils","WAJids","WALongInt","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;async function a(a,b,e){var f=d("EncryptedBackupsDYISingleton").getSingleton(),g=f.getLogger();void g.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Processing "," protobuf messages for thread ",""])),e.length,b);e=e.map(function(b){var c=f.hasMessage(a,d("WAStanzaUtils").toStanzaId(b.otid));if(c){g.DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Encountered a duplicate message otid ",", skipping"])),b.otid);return null}return b}).filter(Boolean);var n=d("MAWJids").toUserJid(c("CurrentUser").getAccountID()),o=!1,p=!1,q;try{for(var r=babelHelpers.asyncIterator(e),e;o=!(e=await r.next()).done;o=!1){e=e.value;try{e=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(e,n,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);if(e==null){void g.WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Decoded protobuf is empty"])));return}if(e!=null&&e.metadata!=null&&e.metadata.messageId!=null){var s=d("WAStanzaUtils").toStanzaId(e.metadata.messageId);e=await B(a,b,e);if(e==null){void g.WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"])));continue}f.setMessagesByThreadKey(a,s,e)}else{void g.WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"])));continue}}catch(a){void g.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf. Dropping the message: ",""])),a);continue}}}catch(a){p=!0,q=a}finally{try{o&&r.return!=null&&await r.return()}finally{if(p)throw q}}}async function B(a,b,c){var e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger(),g=c.metadata,h=c.msgType,i=c.sortOrderMs;if(g==null||h==null){void f.WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: metadata or message type is null"])));return}h=g.messageId;var j=g.senderId;g=g.timestampMs;if(g==null||typeof g!=="number"||h==null||j==null){void f.WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: ts or messageId or senderId is null"])));return}h=d("WATimeUtils").castMilliSecondsToUnixTime(g);g=d("EncryptedBackupsDYIMessageProcessingUtils").buildBaseDyiMessage(j,i);j=(j=c.decodedPayload)==null?void 0:j.text;if(c.editMsgData.length>0){var k=h;c.editMsgData.forEach(function(a){var b;if(a.ts>k&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){k=a.ts;j=(b=a.editMsgContent.message)==null?void 0:b.text}})}c.reactionData.length>0&&(g.reactions=c.reactionData.map(function(a){var b=a.reaction;a=a.senderId;return{actor:(a=e.getContactNameForContactId(a))!=null?a:"unknown",reaction:(a=b.text)!=null?a:"unknown"}}));switch(c.msgType){case d("MAWMsgType").MSG_TYPE.TEXT:g.type="text";g.text=j||"";break;case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.PTT:g.type="media";g.text=j||"";g=D(a,b,c,i,g);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:void f.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Documents are not supported in DYI"])));return;case d("MAWMsgType").MSG_TYPE.XMA:g.type="link";if(c.xmaData==null){void f.WARN(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] XMA message doesn't have xmaData"])));return}g.text=((h=c.xmaData)==null?void 0:h.ctas.map(function(a){return a.nativeUrl}).filter(Boolean).join("\n"))||"";break;case d("MAWMsgType").MSG_TYPE.REVOKED:g.type="placeholder";g.isUnsent=!0;g.text="User unsent a message";break;case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:g.type="poll";g.text=await C(c);break;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:void f.WARN(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Bump message is not supported in DYI"])));return;default:void f.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Explicitly dropping "," message type"])),c.msgType);return}return g}async function C(a){var b=d("EncryptedBackupsDYISingleton").getSingleton().getLogger(),c=a.groupPollInfo;if(c==null){void b.WARN(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Group poll creation message is missing group poll info"])));return""}var e=new Map(),f=new Map();await Promise.all(c.options.map(async function(a){var b=await d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(a);e.set(b,{optionName:a,voterUserJids:[]})}));if(a.groupPollUpdateData!=null){var g=!1,h=!1,i;try{for(var j=babelHelpers.asyncIterator(a.groupPollUpdateData),k;g=!(k=await j.next()).done;g=!1){k=k.value;var l,m;if(((l=k.pollCreationMessageKey)==null?void 0:l.id)==null||((l=k.pollCreationMessageKey)==null?void 0:l.remoteJid)==null){b.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Poll creation message key is incomplete. Skipping"])));continue}l=k.pollCreationMessageKey;var n=l.id;l=l.remoteJid;l=d("WAJids").unsafeCoerceToUserJid(l);m={pollCreationMessageKey:c.encKey,pollCreationSenderJid:d("WAJids").toMsgrUserJid(((m=a.metadata)==null?void 0:m.senderId)||""),pollCreationStanzaId:d("WAStanzaUtils").toStanzaId(n),pollUpdateSenderJid:l,pollUpdateStanzaId:k.externalId};if(k.addOption!=null){n=await d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollAddOption(k.addOption,m);if(n.success){var o=n.value,p=!1,q=!1,r;try{for(var s=babelHelpers.asyncIterator(o.pollOption),o;p=!(o=await s.next()).done;p=!1){o=o.value;if(o.optionName==null)continue;o=o.optionName;var y=await d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(o);e.has(y)||e.set(y,{optionName:o,voterUserJids:[]})}}catch(a){q=!0,r=a}finally{try{p&&s.return!=null&&await s.return()}finally{if(q)throw r}}}else b.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Decryption failure when trying to decrypt poll add option update: ",""])),n.error)}if(k.vote!=null){y=await d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollVote(k.vote,m);if(y.success){o=y.value;if(o.senderTimestampMs==null){b.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[Polls] senderTimestampMs is null. Cannot determine the latest poll vote"])));continue}p=o.selectedOptions;q=o.senderTimestampMs;n=f.get(l);(n==null||n.senderTimestampMs<d("WALongInt").numberOrThrowIfTooLarge(q))&&f.set(l,{senderTimestampMs:d("WALongInt").numberOrThrowIfTooLarge(q),votes:p.map(d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash)})}else b.ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Decryption failure when trying to decrypt poll vote update: ",""])),y.error)}}}catch(a){h=!0,i=a}finally{try{g&&j.return!=null&&await j.return()}finally{if(h)throw i}}}for(k of f){m=k[0];o=k[1];for(n of o.votes){l=e.get(n);l==null?e.set(n,{optionName:"Unknown",voterUserJids:[m]}):e.set(n,babelHelpers.extends({},l,{voterUserJids:[].concat(l.voterUserJids,[m])}))}}return"Question: "+c.name+"; Options: "+Array.from(e).map(function(a){a[0];a=a[1];var b=a.optionName;a=a.voterUserJids;return b+" ("+a.length+" votes"+(a.length>0?": "+a.map(function(a){return d("EncryptedBackupsDYIMessageProcessingUtils").getSenderName(d("WAJids").userIdFromJid(d("WAJids").unsafeCoerceToUserJid(a)))}).join(", "):"")+")"}).join("; ")}function D(a,b,c,e,f){var g;a=d("EncryptedBackupsDYISingleton").getSingleton();var h=a.getLogger();if(c.mediaMetadata==null){void h.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media data"])));return f}var i=c.mediaMetadata,j=i.mediaEntryData;i=i.plaintextHash;g=(g=(g=c.metadata)==null?void 0:g.senderId)!=null?g:"0";c=d("WAStanzaUtils").toStanzaId(c.externalId);i=d("WAHashUtils").stringToPlaintextHash(i);f.media.add(i);if(!a.isAttachmentDownloadInProgressForPlaintextHash(i)&&!a.isAttachmentDownloadCompleteForPlaintextHash(i)){void h.LOG(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Starting DYI media download for attachemnt with hash ",""])),d("WAHashUtils").sanitisePlaintextHash(i));a.addPlaintextHashToAttachmentDownloadsInProgress(i);if(j==null){h.ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media entry data"])));a.deletePlaintextHashFromAttachmentDownloadsInProgress(i);return f}h={author:d("WAJids").toMsgrUserJid(g),chat:d("WAJids").toMsgrUserJid(b),externalId:c};void d("EncryptedBackupsDYIMessageProcessingUtils").downloadMediaWithMediaManager(i,h,e,j)}return f}g.processEBProtobufMessagesForDYI=a}),98);
__d("MAWEncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYIHandleMessageRestore","EncryptedBackupsDYISingleton","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","MAWEBRestoreTrackingUtils","MAWEncryptedBackupsDYIProcessProtobufMessages","MAWJobDefinitions","MAWThreadKeyUtils","MpsOverBridge","MpsTypes","WAJids","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a=(i||d("LSIntEnum")).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI);var l=c("justknobx")._("467"),m=async function(a,b,e){d("MAWEBRestoreTrackingUtils").markEBRestoreDYI(c("LSMEBTaskCreationSource").MSGR_DYI);a=d("WAJids").createJidUtils({platform:"msgr"}).toUserJid(e);b=d("MpsTypes").toTimestamp(Number(b));b=await d("MpsOverBridge").mps().loadMessages({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"remote-only"},debug:{purpose:"dyi"},direction:"desc",from:[b,null],numMessages:l,threadId:d("MpsTypes").toThreadId(a)});if(!b.success){d("EncryptedBackupsDYISingleton").getSingleton().getLogger().ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Message batch query failed for thread ",": ",""])),e,b.error);d("EncryptedBackupsDYISingleton").getSingleton().deleteThreadKeyFromThreadsRestoreInProgress(d("MAWThreadKeyUtils").toStringThreadKey(e));return}a=b.value;b=a.cursorInfo;a=a.messages;var f=(b==null?void 0:b.endCursor)!=null?(j||(j=d("I64"))).of_float(b.endCursor[0]):void 0;await n(e,a.map(d("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage),b.hasNext,f)};async function n(a,b,c,e){var f=await (k||(k=d("LSDatabaseSingleton"))).LSDatabaseSingleton;await d("EncryptedBackupsDYIHandleMessageRestore").handleMessageRangeQueryRestore(f,a,b,c,e,d("MAWEncryptedBackupsDYIProcessProtobufMessages").processEBProtobufMessagesForDYI,m)}g.taskCreationSource=a;g.MESSENGER_DYI_BATCH_SIZE=l;g.issueNextRangeQuery=m;g.handleMAWProtobufMessageRangeQueryRestore=n}),98);
__d("MWSimpleWorkQueue",["FBLogger","Promise","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i={first:null,last:null};function a(a){return new(h||(h=b("Promise")))(function(d,e){var f=function(){var f=new(h||(h=b("Promise")))(function(a,b){window.setTimeout(function(){b(c("err")("Work item timed out after 30 seconds"))},3e4)});return h.race([a(),f]).then(d,e)};if(i.first===null||i.last==null)i.first=i.last={next:null,value:f},j();else{var g=i.last;g.next={next:null,value:f};i.last=g.next}})}function j(){if(i.first===null)return;var a=i.first;if(a==null)return;var b=function(){i.first=a.next;if(i.first==null){i.last=null;return}j()};a.value().then(function(){b()})["catch"](function(a){c("FBLogger")("messenger_web").catching(a).mustfix("Error in MWSimpleWorkQueue"),b()})}g.queueWork=a}),98);
__d("MAWRestoreProtobufsFromEncryptedBackupsDeferred",["ExecutionEnvironment","I64","MWSimpleWorkQueue","WAJobOrchestratorTypes","cr:10036","justknobx","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MAWRestoreProtobufsFromEncryptedBackupsNOP").__setRef("MAWRestoreProtobufsFromEncryptedBackupsDeferred");function a(a,e,f,g,k,l,m,n,o,p,q,r,s,t,u){t===void 0&&(t=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);return j.load().then(async function(j){(i||(i=c("ExecutionEnvironment"))).isInWorker&&b("cr:10036")!=null&&await b("cr:10036").init();var v=function(b){return j.call(b,a,e,f,g,k!=null?(h||(h=d("I64"))).to_float(k):0,l,m!=null?(h||(h=d("I64"))).to_float(m):(h||(h=d("I64"))).to_float((h||(h=d("I64"))).max_int),n,o,p,q,r,s,t,u)};return c("justknobx")._("4404")?d("MWSimpleWorkQueue").queueWork(function(){return v(null)}):v(null)})}g.call=a}),98);
__d("LSProtobufRestoreHandler",["CurrentUser","LSIntEnum","LSMEBTaskCreationSource","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEBUnstoredDbMsgUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","WAErrorMessage","WATagsLogger","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r=["ERROR"],s,t=d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore"]);async function a(a,b,e,f,g,v,w,x,y,z,A,B,C){var D=t.TAGS([x!=null?x:"no_request_id"]);D.ERROR;D=babelHelpers.objectWithoutPropertiesLoose(D,r);var E=D;D=null;A!=null&&(D=u(A));E.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop"])));d("MAWEBRestoreTrackingUtils").markEBRestoreProtobuf(B);b.type==="convertedProtobufs"?A=b.convertedProtobufs:(b.type,A=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(b.decryptedMessagesProtobufs));d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(A,"protobuf_restore");if(x!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:x});b=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());b=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(A,a,void 0,b);if(e===!0&&b.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_decodedMessages_inconsistency",traceId:x});var F=A.length;E.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""])),F);t.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""])),F)}d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(x,{echoMessages:D,hasMoreAfter:g,hasMoreBefore:e,isPointQuery:w,messages:b,nextMessageTimestampMsBefore:f,protobufMessages:A,referenceTimestamp:y,requestId:x,restoreType:"protobuf",threadId:a})}catch(a){F=d("WAErrorMessage").maybeGetMessageFromError(a);E.WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""])),F);t.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""])),F);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(x,a instanceof Error?a:c("err")(F))}e===!0&&A.length===0&&(x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_messages_inconsistency",traceId:x}),E.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no messages but hasMoreBefore is true"]))),t.ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no messages but hasMoreBefore is true"]))));b=B!=null&&(s||(s=d("LSIntEnum"))).unwrapIntEnum(B)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(b){x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"search_restore_end",traceId:x});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(x);return Promise.resolve()}F=B!=null&&(s||(s=d("LSIntEnum"))).unwrapIntEnum(B)===c("LSMEBTaskCreationSource").MSGR_DYI;if(F){E.LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"])));await d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(a,A,e,f);x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"dyi_restore_end",traceId:x});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(x);return Promise.resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),A,e,f,g,v,w,x,y,z,D,B,void 0,C!=null?C:void 0),function(){x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end",traceId:x})},function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);E.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to restore protobufs, with error: ",""])),a);t.ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to restore protobufs, with error: ",""])),a);a={string:{error:a}};x!=null&&d("MAWEBRestoreTrackingUtils").markEBRestoreFail(x,!1,"native_op_reject",a)});return Promise.resolve()}function u(a){return c("LSVec").toArray(a).map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(a)})}g.handleProtobufRestoreHelper=a;g.convertLSEchoMessageVecToArray=u}),98);
__d("MAWThreadIdToChatJidMapping",["I64","MAWAsyncEBPendingQueryPromise","MAWJidUtils","ReQL","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=new Map();async function a(a,b,c){if(l.has(b))return l.get(b);var e=d("MAWAsyncEBPendingQueryPromise").getJidFromThreadId(b);if(e!=null){l.set(b,e);return e}e=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table.index("jid")).getKeyRange((k||(k=d("I64"))).of_string(b)));if(e==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find MI ACT mapping table entry for threadId ",", called from ",""])),b,c);return null}var f=e.serverThreadKey;e=e.jid;a=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.threads).getKeyRange(f));if(a==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find thread with serverThreadKey ",", called from ",""])),(k||(k=d("I64"))).to_string(f),c);return null}f=d("MAWJidUtils").LSJidtoChatJid(e,a.threadType);if(f!=null){l.set(b,f);return f}else{d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot generate ChatJid from threadKey, called from ",""])),c);return null}}g.genChatJidFromThreadId=a}),98);
__d("LSRestoreProtobufs.nop",["LSProtobufRestoreHandler","MAWMpsGating","MAWThreadIdToChatJidMapping","MWEBODSEntityName.enum","MWEBODSUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";a=async function(a,b,e,f,g,h,i,j,k,l,m,n,o,p,q){d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore_protobufs");if(d("MAWMpsGating").isFullMpsEnabled())return;b=null;q!=null?b=d("WAJids").validateChatJid(q):d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore_protobufs.no_chat_jid_provided");b==null&&(b=await d("MAWThreadIdToChatJidMapping").genChatJidFromThreadId(a,e,"LSRestoreProtobufs.nop"));b==null&&d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore_protobufs.no_chat_jid");return d("LSProtobufRestoreHandler").handleProtobufRestoreHelper(e,{decryptedMessagesProtobufs:f,type:"decryptedMessagesProtobufs"},g,h,i,j,k,l,m,n,o,p,b)};a.__nop_name__="LSRestoreProtobufs";g.default=a}),98);
__d("MAWBridgeUpdateClientRestoreStatus",["I64","LSEncryptedBackupsClientRestoreState","LSIntEnum","MAWUpdateClientRestoreStatusOperationType","ReQL","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.encrypted_backups_client_restore_status).filter(function(a){return a.threadId===b})).then(function(b){if(b!=null)return a.encrypted_backups_client_restore_status.delete(b.threadId).then(c("emptyFunction"));else return Promise.resolve()})}function k(a,b,e,f){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.encrypted_backups_client_restore_status).getKeyRange(b)).then(function(f){if(f!=null)return a.encrypted_backups_client_restore_status.put({lastUpdated:(h||(h=d("I64"))).of_float(Date.now()),restoreStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsClientRestoreState").RESTORE_COMPLETE),serverThreadKey:e,threadId:b});else return Promise.resolve()})}function a(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.encrypted_backups_client_restore_status)).then(function(b){return b.reduce(function(b,c){return b.then(function(){return j(a,c.threadId)})},Promise.resolve())})}async function b(a,b){var e=b.threadId,f=b.action;f===d("MAWUpdateClientRestoreStatusOperationType").upsertClientRestoreStatus?await a.encrypted_backups_client_restore_status.put({lastUpdated:(h||(h=d("I64"))).of_float(Date.now()),restoreStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsClientRestoreState").RESTORE_IN_PROGRESS),serverThreadKey:void 0,threadId:e}):await k(a,b.threadId,void 0,b.ebPrefetch);return Promise.resolve()}g.truncateClientRestoreStatusTable=a;g.call=b}),98);
__d("MWEncryptedBackUpEBNotEnabledError",[],(function(a,b,c,d,e,f){"use strict";a="EB not enabled";f.EB_NOT_ENABLED=a}),66);
__d("isEbEnabledWithIGDEligibilityCheck",["EBIsEbEnabled","Promise","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return!c("gkx")("23914")?(h||(h=b("Promise"))).resolve(!1):d("EBIsEbEnabled").isEbEnabledLS(a.tables)}g.isEbEnabledWithIGDEligibilityCheck=a}),98);