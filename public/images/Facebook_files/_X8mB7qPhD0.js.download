;/*FB_PKG_DELIM*/

__d("MpsFutureProofKey",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({WCEPlaintextPayloadFutureProofPlaceholder:0,WCEPlaintextPayloadFutureProofNoPlaceholder:1,WCEPlaintextPayloadFutureProofIgnore:2});f.WCEPlaintextPayloadFutureProof=a}),66);
__d("WABuildMpsPayload",["MpsFutureProofKey","MpsTypes","WAArmadilloBackupMessage.pb","WAArmadilloMiTransportAdminMessage.pb","WAArmadilloTransportEvent.pb","WAGlobals","WAJids","WALogger","WATimeUtils","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a,b){var c=d("WAJids").extractUserId(b.senderJid);d("MpsTypes").toThreadId(b.threadId);var e;b.hideDecryptionFailure!=null&&(e=b.hideDecryptionFailure?d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder:d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofPlaceholder);a=d("encodeProtobuf").encodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,babelHelpers["extends"]({},a,{metadata:{frankingMetadata:{frankingTag:b.frankingTag,reportingTag:b.reportingTag},messageId:b.externalId,payloadVersion:2,senderId:c,futureProofBehavior:e,timestampMs:b.timestampMs}})).readBuffer();return a}function l(a,b){var c=d("WAJids").extractUserId(b.senderJid),e=d("MpsTypes").toThreadId(b.threadId),f=b.millisServerTs!=null?b.millisServerTs:b.serverTs*1e3+d("WAGlobals").getDependencies().extractMsFromStanzaId(b.externalId);a=k(a,{senderJid:b.senderJid,externalId:b.externalId,frankingTag:b.frankingTag,reportingTag:b.reportingTag,hideDecryptionFailure:b.hideDecryptionFailure,threadId:b.threadId,timestampMs:d("MpsTypes").toTimestamp(f)});return{messageId:d("MpsTypes").toMessageId(b.externalId),payload:d("MpsTypes").toBytes(a),senderId:c,threadId:e,timestampMs:d("MpsTypes").toTimestamp(f)}}function a(a,b,c){try{var e={};switch(c.type){case"message":e={encryptedTransportMessage:c.applicationPayload};break;case"ciphertext":e={encryptedTransportEvent:{payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:d("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;case"unavailable":e={encryptedTransportEvent:{payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloTransportEvent.pb").TransportEventSpec,{placeholder:{type:d("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE}}).readBuffer(),version:3}};break;default:c.type}return l(e,{senderJid:d("WAJids").extractUserJid(b.from),externalId:a.stanzaId,serverTs:a.serverTs,frankingTag:a.frankingTag,reportingTag:a.reportingTag,hideDecryptionFailure:a.hideDecryptionFailure,threadId:b.chat})}catch(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["buildMpsMessagePayload: ",""])),a);return null}}function b(a,b,c){if(c.payload==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: No appdata payload"])));return null}try{return l({encryptedTransportMessage:c.payload},{senderJid:d("WAJids").extractUserJid(a.from),externalId:a.stanzaId,serverTs:b,threadId:d("WAJids").extractUserJid(a.from)})}catch(a){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["buildMpsAppdataPayload: ",""])),a);return null}}function c(a,b,c,e,f){c={payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupMembershipAddModeChanged:{mode:c}}).readBuffer(),version:3};return l({miTransportAdminMessage:c},{serverTs:e!=null?e:d("WATimeUtils").unixTime(),externalId:f,hideDecryptionFailure:!1,senderJid:b,threadId:a})}function e(a,b,c,e,f,g){c={payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupAdminChanged:{targetUserId:c.map(d("WAJids").extractUserId),action:e}}).readBuffer(),version:3};return l({miTransportAdminMessage:c},{serverTs:f!=null?f:d("WATimeUtils").unixTime(),externalId:g,hideDecryptionFailure:!1,senderJid:b,threadId:a})}function f(a,b,c,e,f,g){c={payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupParticipantChanged:{targetUserId:c.map(d("WAJids").extractUserId),action:e}}).readBuffer(),version:3};return l({miTransportAdminMessage:c},{serverTs:f!=null?f:d("WATimeUtils").unixTime(),externalId:g,hideDecryptionFailure:!1,senderJid:b,threadId:a})}function m(a,b,c,e,f){c={payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloMiTransportAdminMessage.pb").MiTransportAdminMessageSpec,{groupNameChanged:{groupName:c}}).readBuffer(),version:3};return l({miTransportAdminMessage:c},{serverTs:e!=null?e:d("WATimeUtils").unixTime(),externalId:f,hideDecryptionFailure:!1,senderJid:b,threadId:a})}function n(a,b,c){var e={payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{icdcAlert:{type:d("WAArmadilloTransportEvent.pb").TransportEvent$Event$IcdcAlert$Type.DETECTED}}}).readBuffer(),version:3};return l({encryptedTransportEvent:e},{serverTs:b!=null?b:d("WATimeUtils").unixTime(),externalId:c,hideDecryptionFailure:!1,senderJid:a,threadId:a})}function o(a,b,c,e,f,g){e={payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloTransportEvent.pb").TransportEventSpec,{event:{deviceChange:{type:e,devicePlatform:f,deviceModel:g}}}).readBuffer(),version:3};return l({encryptedTransportEvent:e},{serverTs:b!=null?b:d("WATimeUtils").unixTime(),externalId:c,hideDecryptionFailure:!1,senderJid:a,threadId:a})}g.buildBackupProtobufBytes=k;g.buildMpsMessage=l;g.buildMpsMessageFromIncomingMessage=a;g.buildMpsAppdataPayload=b;g.buildMpsGroupMemberAddType=c;g.buildMpsGroupAdminChangedMsg=e;g.buildMpsGroupParticipantsChanged=f;g.buildMpsGroupNameChangedMsg=m;g.buildMpsIcdcAdminMessage=n;g.buildMpsDeviceChangeAdminMessage=o}),98);
__d("WADbRegistrationApi",["WADbSignal","WAJids","WALogger","WASignalDB","err"],(function(a,b,c,d,e,f,g){"use strict";var h;f=function(a,b){return d("WASignalDB").getDb().runInTransaction(["contacts"],"readwrite",async function(c){var d=await c.stores.contacts.get(a);if(d!=null)return c.stores.contacts.bulkPut([babelHelpers.extends({},d,{icdcInfo:b})]);else return c.stores.contacts.bulkPut([{contactJid:a,dhash:null,icdcInfo:b}])},d("WASignalDB").signalOp("saveICDC"))};function a(a){return d("WASignalDB").getDb().runInTransaction(["meta"],"readwrite",function(b){return b.stores.meta.bulkPut([{key:d("WADbSignal").MetaKeysEnum.deviceId,value:{deviceId:a}}])},d("WASignalDB").signalOp("saveDeviceId"))}function b(a,b){return d("WASignalDB").getDb().runInTransaction(["meta","signedPrekey"],"readwrite",async function(c){var e;await Promise.all([c.stores.meta.bulkPut([{key:(e=d("WADbSignal")).MetaKeysEnum.deviceUUID,value:{deviceUUID:b.deviceUUID}},{key:e.MetaKeysEnum.fbid,value:{fbid:a}},{key:e.MetaKeysEnum.regId,value:{regId:b.signalRegInfo.regId}},{key:e.MetaKeysEnum.identityKeyPair,value:{identityKeyPair:b.signalRegInfo.identityKeyPair}},{key:e.MetaKeysEnum.lastSignedPrekeyId,value:{lastSignedPrekeyId:b.signalRegInfo.signedPreKey.keyId}},{key:e.MetaKeysEnum.registrationVersion,value:{registrationVersion:b.registrationVersion}},{key:e.MetaKeysEnum.authKeyPair,value:{authKeyPair:b.signalRegInfo.authKeyPair}},{key:e.MetaKeysEnum.deviceRegUnixTime,value:{deviceRegUnixTime:b.registrationUnixTime}}]),c.stores.signedPrekey.bulkPut([b.signalRegInfo.signedPreKey])])},d("WASignalDB").signalOp("saveRegistrationMeta"))}var i=function(a,b){var c=b.sessionId;return d("WASignalDB").getDb().runInTransaction(["meta"],"readwrite",function(a){return a.stores.meta.bulkPut([{key:d("WADbSignal").MetaKeysEnum.lastSessionDeviceWasLinkedTo,value:{lastSessionDeviceWasLinkedTo:c}}])},d("WASignalDB").signalOp("saveLastSessionDeviceWasLinkedTo"))};function e(){return d("WASignalDB").getDb().runInTransaction(["meta"],"readonly",async function(a){a=await a.stores.meta.bulkGet([(a=d("WADbSignal")).MetaKeysEnum.fbid,a.MetaKeysEnum.deviceId,a.MetaKeysEnum.cat,a.MetaKeysEnum.regId,a.MetaKeysEnum.identityKeyPair,a.MetaKeysEnum.authKeyPair]);var b=a[0],e=a[1],f=a[2],g=a[3],i=a[4];a=a[5];d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["worker: got db data"])));b=b==null?void 0:b.value.fbid;e=e==null?void 0:e.value.deviceId;f=f==null?void 0:f.value.cat;g=g==null?void 0:g.value.regId;i=i==null?void 0:i.value.identityKeyPair;a=a==null?void 0:a.value.authKeyPair;if(b==null)throw c("err")("fbid not set");if(e==null)throw c("err")("deviceId not set");if(f==null)throw c("err")("fbCat not set");if(g==null||i==null)throw c("err")("regInfo not set");return{deviceJid:d("WAJids").toDeviceJid(d("WAJids").toMsgrUserJid(b),e),fbCat:f.encrypted_serialized_cat,regInfo:{authKeyPair:a,regId:g,staticKeyPair:i},userJid:d("WAJids").toMsgrUserJid(b)}},d("WASignalDB").signalOp("loadAllRegistrationMeta"))}g.saveICDC=f;g.saveDeviceId=a;g.saveRegistrationMeta=b;g.saveLastSessionDeviceWasLinkedTo=i;g.loadAllRegistrationMetaInTransaction=e}),98);
__d("WAGetLocalPublicPrivateIdentityKeyApi",["WADbSignal","WALogger","WASignalDB","WASignalKeys","err"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){return d("WASignalDB").getDb().runInTransaction(["meta"],"readonly",async function(a){var b;a=await a.stores.meta.get(d("WADbSignal").MetaKeysEnum.identityKeyPair);if((a==null||(b=a.value)==null?void 0:b.identityKeyPair)==null){var e="[Remote Presence Error] Identity key pair was null";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),e);throw c("err")(e)}return d("WASignalKeys").toSerializedKeyPair(a.value.identityKeyPair)},d("WASignalDB").signalOp("getLocalPublicPrivateIdentityKey"))};g.getLocalPublicPrivateIdentityKey=a}),98);
__d("WAGetIdentityKeys",["WAGetLocalPublicPrivateIdentityKeyApi"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){a=await d("WAGetLocalPublicPrivateIdentityKeyApi").getLocalPublicPrivateIdentityKey();var b=a.privateKey;a=a.serializedPubKey;return{identityPrivateKey:b,identityPublicKey:a}}g.getIdentityKeysInWorker=a}),98);