;/*FB_PKG_DELIM*/

__d("LSOptimisticSendAttachmentShareForward",["LSAppendDataTraceAddon","LSInsertOptimisticAttachment","LSIssueNewTaskWithExtraOperationsAndGetTaskID","LSLocalApplyOptimisticMessage","LSPredefineTraceForTask"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return c.storedProcedure(b("LSLocalApplyOptimisticMessage"),a[0],a[1],a[2],a[3],a[4],a[5],void 0,void 0,void 0,void 0,c.i64.cast([0,3]),void 0,void 0,void 0,!0).then(function(a){return a=a,d[0]=a[0],d[1]=a[1],a})},function(e){return c.storedProcedure(b("LSInsertOptimisticAttachment"),a[1],d[1],d[0],d[0],a[6],c.i64.cast([0,2]),void 0,c.i64.cast([0,0]),void 0,!0,!1)},function(b){return c.db.table(9).fetch([[[a[1]]]]).next().then(function(a,b){var e=a.done;a=a.value;return e?d[2]=c.i64.cast([0,1]):(b=a.item,d[9]=b.syncGroup,c.i64.neq(d[9],void 0)?d[8]=d[9]:d[8]=c.i64.cast([0,1]),d[2]=d[8])})},function(e){return c.storedProcedure(b("LSIssueNewTaskWithExtraOperationsAndGetTaskID"),c.i64.to_string(a[1]),c.i64.cast([0,46]),"",void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),d[2],void 0,c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[4]=a[0],a})},function(e){return void 0!==void 0?c.sequence([function(a){return c.storedProcedure(b("LSPredefineTraceForTask"),void 0,d[4],c.i64.to_string(c.i64.cast([0,46])),d[0])},function(e){return d[10]=c.i64.to_string(a[7]),d[10]!==void 0?d[8]=d[10]:d[8]=c.i64.to_string(c.i64.cast([0,0])),d[9]=",",c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,20]),c.i64.cast([0,1]),void 0,[d[8],d[9],c.i64.to_string(c.i64.cast([0,4])),d[9],c.i64.to_string(a[2])].join(""))}]):c.resolve()},function(b){return void 0?d[5]=!1:d[5]=!0,d[5]?(b=[void 0,void 0],d[6]=b[0],d[7]=b[1],b):(d[8]=(void 0).get("share_treatment_type"),d[9]=(void 0).get("share_treatment_name"),b=[d[8],d[9]],d[6]=b[0],d[7]=b[1]),c.db.table(31).add({taskId:d[4],threadKey:a[1],offlineThreadingId:d[0],threadAttributionSource:a[7],sendType:c.i64.cast([0,4]),markThreadRead:!1,initiatingSource:a[8]})},function(a){return e[0]=d[0]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxOptimisticSendAttachmentShareForwardStoredProcedure";a.__tables__=["threads","messages_optimistic_context"];e.exports=a}),null);
__d("LSOptimisticSendAttachmentShareForwardStoredProcedure",["LSOptimisticSendAttachmentShareForward","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOptimisticSendAttachmentShareForward"),e.senderId,e.threadKey,e.threadType,e.text,e.snippet,e.snippetHasEmoji,e.forwardedShareId,e.source,e.initiatingSource);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSOptimisticSendURLShare",["LSInsertOptimisticAttachment","LSIssueNewTaskWithExtraOperationsAndGetTaskID","LSLocalApplyOptimisticMessage"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return c.storedProcedure(b("LSLocalApplyOptimisticMessage"),a[0],a[1],a[2],a[3],a[4],a[5],void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1).then(function(a){return a=a,d[0]=a[0],d[1]=a[1],a})},function(e){return c.storedProcedure(b("LSInsertOptimisticAttachment"),a[1],d[1],d[0],d[0],d[0],c.i64.cast([0,7]),a[6],c.i64.cast([0,0]),void 0,!1,!0)},function(b){return c.db.table(9).fetch([[[a[1]]]]).next().then(function(a,b){var e=a.done;a=a.value;return e?d[2]=c.i64.cast([0,1]):(b=a.item,d[6]=b.syncGroup,c.i64.neq(d[6],void 0)?d[5]=d[6]:d[5]=c.i64.cast([0,1]),d[2]=d[5])})},function(e){return c.storedProcedure(b("LSIssueNewTaskWithExtraOperationsAndGetTaskID"),c.i64.to_string(a[1]),c.i64.cast([0,46]),"",void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),d[2],void 0,c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[4]=a[0],a})},function(b){return c.db.table(31).add({taskId:d[4],threadKey:a[1],offlineThreadingId:d[0],threadAttributionSource:a[7],sendType:c.i64.cast([0,6]),markThreadRead:!1,initiatingSource:a[8]})},function(a){return e[0]=d[0]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMailboxOptimisticSendURLShareStoredProcedure";a.__tables__=["threads","messages_optimistic_context"];e.exports=a}),null);
__d("LSOptimisticSendURLShareStoredProcedure",["LSOptimisticSendURLShare","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOptimisticSendURLShare"),e.senderId,e.threadKey,e.threadType,e.text,e.snippet,e.snippetHasEmoji,e.url,e.source,e.initiatingSource);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSShareAttachment",["I64","LSDatabaseSingleton","LSFactory","LSIntEnum","LSMessagingInitiatingSource","LSOptimisticSendAttachmentShareForwardStoredProcedure","LSOptimisticSendURLShareStoredProcedure","LSThreadAttributionTypeUtil","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;async function a(a,b){var e,g=await (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,k=(i||(i=d("I64"))).of_string(a.actorID),l=i.of_string(a.targetID),m=a.shareID,n=(e=a.message)!=null?e:"",o=a.targetType==="group"?(j||(j=d("LSIntEnum"))).ofNumber(2):(j||(j=d("LSIntEnum"))).ofNumber(1),p=d("LSThreadAttributionTypeUtil").getSourceAndResetAttribution(l,a.entryPoint),q=b!=null?b:d("sendToSentQPLLogger").markSendToSentStart();d("sendToSentQPLLogger").markSendToSentPoint(q,"create_optimistic_message_start");return g.runInTransaction(async function(b){var e=(j||(j=d("LSIntEnum"))).ofNumber(c("LSMessagingInitiatingSource").FACEBOOK_CHAT);if(a.url!=null){var f=a.url;f=await c("LSOptimisticSendURLShareStoredProcedure")(c("LSFactory")(b),{initiatingSource:e,senderId:k,snippetHasEmoji:!1,source:p,text:n,threadKey:l,threadType:o,url:f});d("sendToSentQPLLogger").markSendToSentPoint(q,"create_optimistic_message_end");return f}f=await c("LSOptimisticSendAttachmentShareForwardStoredProcedure")(c("LSFactory")(b),{forwardedShareId:m,initiatingSource:e,senderId:k,snippetHasEmoji:!1,source:p,text:n,threadKey:l,threadType:o});d("sendToSentQPLLogger").markSendToSentPoint(q,"create_optimistic_message_end");return[f[0]]},"readwrite",void 0,void 0,f.id+":58")}g.share=a}),98);
__d("MAWCreateOneToOneThreadWithStringFBID",["I64","MAWCreateOneToOneThread"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e){b=(h||(h=d("I64"))).of_string(b);return d("MAWCreateOneToOneThread").call(a,b,void 0,c,e)}g.call=a}),98);
__d("MAWInformTreatmentTypeTransform",["WAArmadilloXMA.pb"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case"MEDIA_LABEL":return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.MEDIA_LABEL;case"POST_COVER":return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.POST_COVER;case"POST_LABEL":return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.POST_LABEL;case"WARNING_SCREENS":return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING_SCREENS;default:return d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}g["default"]=a}),98);
__d("MAWShareAttachment",["FBLogger","I64","LSDatabaseSingleton","LSIntEnum","LSMessagingThreadAttributionType","MAWBridgeSendAndReceive","MAWConvertExtendedContentTypeToLSXmaContentType","MAWCreateOneToOneThreadWithStringFBID","MAWExternalId","MAWFetchUserJids","MAWFetchXMAData","MAWFetchXMADataUtils","MAWGetEphemeralSettings","MAWImagePreProcess","MAWImageUtils","MAWInformTreatmentTypeTransform","MAWMessageSendReporter","MAWMiActMaybeCreateActThread","MAWMiActOnActThreadReady","MAWMpsGating","MAWWaitForBackendSetup","MAWXMALoggingUtils","MWPBumpEntityKey","WAArmadilloXMA.pb","WAGetSafeQPLError","WAJids","WAMediaQplHelper","WAResultOrError","emptyFunction","getErrorSafe","nullthrows","qpl","sendToSentQPLLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a){if(a==null)return void 0;a=a.trim();return a===""?void 0:a}var l=3e5;async function m(a,b,e,f,g,j,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D){if(a!=null)try{await d("MAWWaitForBackendSetup").waitForBackendSetup("fetch-devices-and-share-xma")}catch(a){w=c("getErrorSafe")(a);d("sendToSentQPLLogger").addSendToSentAnnotations(t,{string:{wait_for_backend_error_in_share:d("WAGetSafeQPLError").getSafeQPLErrorMessage(w)}});d("sendToSentQPLLogger").markSendToSentFail(t,"backend_setup_fail",w);return d("WAResultOrError").makeError({isRetriable:!1,type:"failed-to-fetch-devices-for-xma-share"})}d("sendToSentQPLLogger").markSendToSentPoint(t,"fetch_ephemeral_settings_start");a=await d("MAWGetEphemeralSettings").getEphemeralSetting(b,u);d("sendToSentQPLLogger").markSendToSentPoint(t,"fetch_ephemeral_settings_end");if(b==null){d("sendToSentQPLLogger").markSendToSentPoint(t,"failed_to_fetch_chat_jid_for_xma_share");return d("WAResultOrError").makeError({isRetriable:!1,type:"failed-to-fetch-chat-jid-for-xma-share"})}w=k(e.message);var E=w!=null&&!d("MAWMpsGating").isXmaWithoutAssociatedMsg(),F=void 0,G=void 0;E&&(F=d("MAWExternalId").generateExternalId(),G=c("nullthrows")(w),w=void 0);E=v===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;var H=d("MAWConvertExtendedContentTypeToLSXmaContentType").convertExtendedContentTypeToLSXmaContentType(v);H=H!=null?(h||(h=d("I64"))).of_int32(H):void 0;if(u!=null){var I=null;g!=null&&(I=await d("MAWImagePreProcess").optimisticImagePreprocess(g.file));B=await B({actionUrl:n==null?void 0:n.actionUrl,associatedMsgId:F,associatedMsgText:G,commands:void 0,contentRef:A,instanceKey:t,isReceiverFetch:E,lssTraceApi:void 0,mentionedJids:void 0,messageExternalId:z,messageText:d("MAWMpsGating").isXmaWithoutAssociatedMsg()?w!=null?w:"":"",offlineAttachmentId:y,onOfflineMsgId:c("emptyFunction"),optimisticMediaAttachment:I,reply:void 0,subtitleText:p,threadKey:u,titleText:q,xmaContentType:H});I=B!=null?{messageExternalId:z,offlineMsgTimestamp:B.offlineMsgTimestamp}:void 0;I!=null&&C(I.messageExternalId,I.offlineMsgTimestamp)}d("sendToSentQPLLogger").markSendToSentPoint(t,"sending_message_to_wajob");E&&A==null&&d("MWPBumpEntityKey").bumpEntityKey("maw.share_attachment","content_ref_null_for_rf_xma");d("sendToSentQPLLogger").addSendToSentAnnotations(t,{string:{attachment_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(((u=g==null?void 0:g.file.size)!=null?u:0)+((H=j==null?void 0:j.file.size)!=null?H:0)+((B=f==null?void 0:f.file.size)!=null?B:0)),favicon_attachment_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket((C=f==null?void 0:f.file.size)!=null?C:0),header_attachment_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket((I=j==null?void 0:j.file.size)!=null?I:0),preview_attachment_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket((E=g==null?void 0:g.file.size)!=null?E:0)}});D==null||D.addMetadata("attachment_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket(((u=g==null?void 0:g.file.size)!=null?u:0)+((H=j==null?void 0:j.file.size)!=null?H:0)+((B=f==null?void 0:f.file.size)!=null?B:0)));D==null||D.addMetadata("favicon_attachment_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket((C=f==null?void 0:f.file.size)!=null?C:0));D==null||D.addMetadata("header_attachment_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket((I=j==null?void 0:j.file.size)!=null?I:0));D==null||D.addMetadata("preview_attachment_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket((E=g==null?void 0:g.file.size)!=null?E:0));C=d("MAWBridgeSendAndReceive").sendAndReceive("backend","sendXMAShareMsg",{args:{content:d("MAWMpsGating").isXmaWithoutAssociatedMsg()?w:void 0,ephemeralSetting:a==null?void 0:a,offlineAttachmentId:y,source:(i||(i=d("LSIntEnum"))).ofNumber(s!=null?s:c("LSMessagingThreadAttributionType").UNKNOWN),xmaMessageType:v!=null?v:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE},associatedMsgContent:G,associatedMsgContentExternalId:F,chatJid:b,faviconFile:f,headerFile:j,previewFile:g,qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:t,xmaArgs:{contentRef:A,ctas:m,defaultCTA:n,headerTitle:r!=null?r:void 0,overlayIconGlyph:o!=null?o:c("MAWInformTreatmentTypeTransform")((u=e.messagingInformTreatmentInfo)==null?void 0:u.treatmentType),overlayTitle:(B=(H=e.messagingInformTreatmentInfo)==null?void 0:H.messagingInformTreatmentName)!=null?B:void 0,subtitleText:p!=null?p:void 0,titleText:q!=null?q:void 0},xmaMsgExternalId:z},{timeoutMs:l});await d("MAWMessageSendReporter").MAWMessageSendReporter({chatJid:b,externalId:z},C,{qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:t},x);return d("WAResultOrError").makeResult({description:"removal pending rollout of MAWMessageSendReporterV2",messageType:"fixMe"})}async function a(a,b,e,f,g,i,k,l,n,o,p,q,r,s,t){var u=g,v=await (j||(j=d("LSDatabaseSingleton"))).LSDatabaseSingleton,w={linkType:"unknown",transportLayerForLogging:"sender_copy",xmaTargetTypeForLogging:null};if(l==null&&a!=null){var x=b.url;if(x==null){k.failTrace("null_xma_url",!0);d("sendToSentQPLLogger").markSendToSentFail(u,"null_xma_url");c("FBLogger")("messenger_web_sharing").mustfix("[MAWShareAttachment] Attachment URL is null");return d("WAResultOrError").makeError({isRetriable:!1,type:"null-xma-url"})}try{d("sendToSentQPLLogger").markSendToSentPoint(u,"xma_data_query_start"),k.addMarkerPoint("xma_data_query_start","AppTiming"),n!=null?w=await n:w=await d("MAWFetchXMAData").fetchXMAData(a,x,[u]),d("sendToSentQPLLogger").markSendToSentPoint(u,"xma_data_query_end"),k.addMarkerPoint("xma_data_query_end","AppTiming")}catch(a){if(a.message.includes(d("MAWFetchXMADataUtils").XMA_DATA_ERRORS.failed_to_parse_json_for_xma_share)){d("sendToSentQPLLogger").markSendToSentFail(u,"failed_to_parse_json_for_xma_share",a);return d("WAResultOrError").makeError({isRetriable:!1,type:"failed-to-parse-json-for-xma-share"})}else{n=c("getErrorSafe")(a);d("sendToSentQPLLogger").addSendToSentAnnotations(g,{string:{share_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(n),share_error_entrypoint:"MAWShareAttachment"}});d("sendToSentQPLLogger").markSendToSentFail(u,"unknown_xma_error",n);throw a}}}w=l!=null?l:w;a=w;var y=a.contentRef,z=a.ctas,A=a.defaultCTA,B=a.header_title;a.image_blob;var C=a.overlayIconGlyph,D=a.subtitle_text,E=a.title_text;x=a.transportLayerForLogging;var F=a.xma_message_type;n=a.xmaTargetTypeForLogging;d("sendToSentQPLLogger").addSendToSentAnnotations(u,{string:{transportLayer:x,xmaTargetType:d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(n)}});l=t!=null?await t:await d("MAWFetchXMADataUtils").makeXMAFileArgs(w,u);var G=l.faviconFileArgs,H=l.headerImageFileArgs,I=l.previewFileArgs;d("sendToSentQPLLogger").addSendToSentAnnotations(g,{string:{favicon_original_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket((a=G==null?void 0:G.file.size)!=null?a:0),header_original_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket((x=H==null?void 0:H.file.size)!=null?x:0),original_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(((n=I==null?void 0:I.file.size)!=null?n:0)+((t=H==null?void 0:H.file.size)!=null?t:0)+((w=G==null?void 0:G.file.size)!=null?w:0)),preview_original_file_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket((l=I==null?void 0:I.file.size)!=null?l:0)}});k==null||k.addMetadata("favicon_original_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket((g=G==null?void 0:G.file.size)!=null?g:0));k==null||k.addMetadata("header_original_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket((a=H==null?void 0:H.file.size)!=null?a:0));k==null||k.addMetadata("original_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket(((x=I==null?void 0:I.file.size)!=null?x:0)+((n=H==null?void 0:H.file.size)!=null?n:0)+((t=G==null?void 0:G.file.size)!=null?t:0)));k==null||k.addMetadata("preview_original_file_size",d("WAMediaQplHelper").convertIntegerSizeToStringBucket((w=I==null?void 0:I.file.size)!=null?w:0));if(e!=null)if(e.isTargetE2E===!0){var J=(h||(h=d("I64"))).of_string_opt(b.targetID);if(J==null){d("sendToSentQPLLogger").markSendToSentFail(u,"failed_to_fetch_chat_jid_for_xma_share");return d("WAResultOrError").makeError({isRetriable:!1,type:"failed-to-fetch-chat-jid-for-xma-share"})}l=s!=null?await s:await d("sendToSentQPLLogger").measureSendToSentPerformance("maybe_convert_preview_gif_to_thumbnail",u,function(){return d("MAWImageUtils").generatePreviewBlobForShare(I)});d("sendToSentQPLLogger").markSendToSentPoint(u,"fetch_existing_chat_jid_start");await d("sendToSentQPLLogger").measureSendToSentPerformance("maybe_load_existing_thread",u,function(){return c("MAWMiActMaybeCreateActThread")(v,J,"shareSecureAttachment",u)});g=await d("MAWMiActOnActThreadReady").waitForACTThreadReady(v.tables,J,"fetch-existing-chatJid",u);a=g.chatJid;x=g.serverThreadKey;n=d("WAJids").interpretAsUserJid(a);n!=null?t=[n]:t=await d("MAWFetchUserJids").fetchUserJids(v,b.targetID);d("sendToSentQPLLogger").markSendToSentPoint(u,"fetch_existing_chat_jid_end");return m(t,a,b,G,l!=null?l:void 0,H,z,A,C,D,E,B,f,u,x,F,i,v,o,p,y,q,r,k)}else if(e.targetType==="USER"){d("sendToSentQPLLogger").markSendToSentPoint(u,"create_thread_for_xma_share_start");return d("MAWCreateOneToOneThreadWithStringFBID").call(v,e.targetID,"shareSecureAttachment",u).then(function(a){a=a==null?void 0:a.jid;if(a==null){d("sendToSentQPLLogger").markSendToSentFail(u,"failed_to_create_chat_for_xma_share");return d("WAResultOrError").makeError({isRetriable:!1,type:"failed-to-create-chat-for-xma-share"})}d("sendToSentQPLLogger").markSendToSentPoint(u,"create_thread_for_xma_share_end");var c=[d("WAJids").interpretAsUserJid(a)].filter(Boolean);return m(c,a,b,G,I,H,z,A,C,D,E,B,f,u,void 0,F,i,v,o,p,y,q,r,k)}).catch(function(a){d("sendToSentQPLLogger").markSendToSentFail(u,"failed_to_create_chat_for_xma_share",a);k.addMarkerPoint(a?a.toString():"unknown LSS error","AppTiming");throw a})}return d("WAResultOrError").makeResult({description:"catch-all",messageType:"fixMe"})}g.shareSecureAttachment=a}),98);