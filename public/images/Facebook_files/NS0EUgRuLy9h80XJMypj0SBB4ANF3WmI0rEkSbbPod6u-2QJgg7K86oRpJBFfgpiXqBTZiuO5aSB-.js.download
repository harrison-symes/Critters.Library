;/*FB_PKG_DELIM*/

__d("Cache",["TimeSlice"],(function(a,b,c,d,e,f,g){"use strict";var h=6e4;a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.has=function(a){return this.$1.has(a)};b.get=function(a,b){a=this.__getRaw(a);return!a?b:a.$2};b.getAll=function(a,b){var c=this,d=new Map();a.forEach(function(a){return d.set(a,c.get(a,b))});return d};b["delete"]=function(a){var b=this.__getRaw(a);b&&b.$3&&clearTimeout(b.$3);return this.$1["delete"](a)};b.clear=function(){this.$1.forEach(function(a){a&&a.$3&&clearTimeout(a.$3)}),this.$1.clear()};b.set=function(a,b,d,e){if(!this.shouldUpdate(a,d))return!1;var f=this.__getRaw(a);f||(f=this.__getNewRawObject());delete f.$2;delete f.$4;f.$3&&clearTimeout(f.$3);delete f.$3;f.$2=b;d!=null&&(f.$4=d);e!=null&&e>=0&&(f.$3=setTimeout(c("TimeSlice").guard(this["delete"].bind(this,a),"Cache expiration timeout"),e*h));this.__setRaw(a,f);return!0};b.shouldUpdate=function(a,b){a=this.__getRaw(a);return a==null||a.$4==null||b==null||b>a.$4};b.size=function(){return this.$1.size};b.__getRaw=function(a){return this.$1.get(a)};b.__setRaw=function(a,b){this.$1.set(a,b)};b.__getNewRawObject=function(){return{$2:null,$3:null,$4:null,$5:null,$6:null}};b.__keys=function(){return this.$1.keys()};return a}();g["default"]=a}),98);
__d("EBAPI",["MAWEBCombinedSwitch","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=(a=c("requireDeferred"))("EBAPIMinosVerifySingleEpoch").__setRef("EBAPI"),i=a("EBAPIWriteMinosPublicKeysForRecipient").__setRef("EBAPI"),j=a("EBGetContactEpochHead").__setRef("EBAPI"),k=a("EBGetMessageKeys").__setRef("EBAPI"),l=a("EBIsEbEnabled").__setRef("EBAPI"),m=a("EBMessageRangeQueryForIndexing").__setRef("EBAPI"),n=a("EBMinosWriteKeyChangeAdminMessage").__setRef("EBAPI"),o=a("EBMinosWriteSecureStorageAlert").__setRef("EBAPI");b={getContactEpochHead:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return j.load().then(function(a){return a.getContactEpochHead.apply(a,b)})},getMessageKeys:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return k.load().then(function(a){return a.getMessageKeys.apply(a,b)})},isEBEnabled:function(){return d("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled()},isEbEnabledEbSwitch:function(){return l.load().then(function(a){return a.isEbEnabledEbSwitch()})},messageRangeQueryForIndexing:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return m.load().then(function(a){return a.messageRangeQueryForIndexing.apply(a,b)})},minosVerifySingleEpoch:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return h.load().then(function(a){return a.minosVerifySingleEpoch.apply(a,b)})},writeMinosKeyChangeAdminMessage:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return n.load().then(function(a){return a.writeMinosKeyChangeAdminMessage.apply(a,b)})},writeMinosMailboxKeysForRecipientAPI:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return i.load().then(function(a){return a.writeMinosMailboxKeysForRecipientAPI.apply(a,b)})},writeMinosSecureStorageAlert:function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return o.load().then(function(a){return a.writeMinosSecureStorageAlert.apply(a,b)})}};e=b;g["default"]=e}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum")({MSGR:"msgr",IGD:"igd"});c=a;f["default"]=c}),66);
__d("IGDWEBUploadMessageUtils",["I64","MAWExtractMsFromExternalId","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){var c=d("MAWExtractMsFromExternalId").extractMsFromExternalId((i||(i=d("I64"))).of_string(a));c==null&&d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Could not extract ms from externalId: ",""])),a);return d("WATimeUtils").castToMillisTime(Number(b)*1e3+(c!=null?c:0))}g.generateProtobufServerTs=a}),98);
__d("EncryptedBackupsUploadEntity",["$InternalEnum","EncryptedBackupsUtils","IGDWEBUploadMessageUtils","WAArmadilloBackupMessage.pb","WAByteArray","WAGlobals","WAJids","WATimeUtils","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a instanceof ArrayBuffer?new Uint8Array(a):a}var h=b("$InternalEnum").Mirrored(["NEEDS_BACKUP","COMPLETED","NEEDS_BACKUP_RETRY","PERMANENT_FAILURE","EXPIRED","THREAD_DELETED","DELETION_PURGED","MESSAGE_DELETED","UPLOADING"]);b=b("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});function c(a){return a}function i(a){var b=a.messageApplication,c=a.msgId,e=a.reportingMeta;a=a.sortOrderMs;var f=d("WAJids").authorToUserId(c.author,d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()));return d("encodeProtobuf").encodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,d("EncryptedBackupsUtils").asBackupMessage(f,c.externalId,a,e!=null?e:{frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},b)).readByteArrayView()}function e(a){return d("WAByteArray").uint8ArrayToBuffer(a)}function f(a){var b=a.attachmentContext,c=a.backupDirective,e=a.dbMsgType,f=a.instanceKey,g=a.isOpenEB,j=a.isRetroactiveUpload,k=a.legacyAttachmentContext,l=a.messageApplication,m=a.msgId,n=a.originalMsgProtocolId,o=a.reportingMeta,p=a.retryCount,q=a.senderId,r=a.serverTs,s=a.sortOrderMs,t=a.tags;a=a.triggerSource;l=i({messageApplication:l,msgId:m,reportingMeta:o,sortOrderMs:c.actionType===4?d("IGDWEBUploadMessageUtils").generateProtobufServerTs(m.externalId,r):s});o={backupActionType:c.actionType,backupDirective:c,dbMsgType:e,failTsMs:d("WATimeUtils").castToMillisTime(0),instanceKey:f,isOpenEB:g,isRetroactiveUpload:j,msgId:m,msgIdKey:d("EncryptedBackupsUtils").convertWAMsgIdToStringId(m),msgType:"text",originalMsgProtocolId:n,protobuf:l,retryCount:p,senderId:q,serverTs:r,sortOrderMs:s,supplementalKey:c.supplementalKey,tags:t,triggerSource:a,uploadStatus:h.NEEDS_BACKUP,uploadTsSec:d("WATimeUtils").unixTime()};b!=null&&(o=babelHelpers["extends"]({},o,{attachmentContext:b,legacyAttachmentContext:k,msgType:"media"}));return o}g.toEbBackupMessageBytes=a;g.EbUploadStatus=h;g.AttachmentContextMediaType=b;g.castToEBQueueId=c;g.encodeBackupMessage=i;g.getEbBackupMessageBytesBuffer=e;g.asEBUploadEntity=f}),98);
__d("LFUCache",["Cache","ExecutionEnvironment"],(function(a,b,c,d,e,f,g){"use strict";var h,i=15,j=1,k=6e4;a=function(a){function b(b,d){var e;e=a.call(this)||this;e.$LFUCache2=b&&b>0?b:i;e.$LFUCache3=d&&d>0?d:j;((h||(h=c("ExecutionEnvironment"))).canUseDOM||(h||(h=c("ExecutionEnvironment"))).isInWorker)&&e.$LFUCache4();return e}babelHelpers.inheritsLoose(b,a);var d=b.prototype;d.$LFUCache4=function(){clearTimeout(this.$LFUCache1),this.$LFUCache1=setTimeout(this.purge.bind(this),this.$LFUCache2*k)};d.destroy=function(){clearTimeout(this.$LFUCache1)};d.get=function(b,c){this.has(b)&&this.$LFUCache5(b);return a.prototype.get.call(this,b,c)};d.set=function(b,c,d,e){var f=this.has(b);c=a.prototype.set.call(this,b,c,d,e);c&&(f?this.$LFUCache5(b):this.$LFUCache6(b,this.$LFUCache3));return c};d.purge=function(){var a=this,b=Array.from(this.__keys());b.forEach(function(b){a.$LFUCache7(b)<a.$LFUCache3?a["delete"](b):a.$LFUCache6(b,0)});this.$LFUCache4()};d.$LFUCache5=function(a){var b=this.$LFUCache7(a)+1;this.$LFUCache6(a,b);return b};d.$LFUCache7=function(a){a=this.__getRaw(a);return a&&a.$LFUCache8?a.$LFUCache8:0};d.$LFUCache6=function(a,b){var c=this.__getRaw(a);c||(c=this.__getNewRawObject());c.$LFUCache8=b;this.__setRaw(a,c);return!0};return b}(c("Cache"));g["default"]=a}),98);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){var g=d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return!0},user:function(a){return!1}});return{authoritativeThreadKey:c,cannotReplyReason:a.cannotReplyReason,clientThreadKey:b,description:e,folder:a.folder,instanceKey:f,isGroup:g,jid:a.jid,lastReadTs:d("MAWTimeUtils").ensureValidMillisTime(a.lastReadMsgTs)||d("WATimeUtils").castToMillisTime(0)}}g.createBridgeThread=a}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWQplProxy","MAWThreadMappingQPL","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a!=null&&b!=null){var c=d("WATimeUtils").fromMillisTime(a),e=d("WATimeUtils").fromMillisTime(b);return d("WATimeUtils").castToMillisTime(Math.max(c,e))}return a!=null?a:b}function i(a,b){return a.threads.get({jid:b})}function j(a,b){return(c("gkx")("10029")?d("MAWDexieTable").dexieAll(b.map(function(b){return a.threads.get({jid:b})})).then(function(a){return a.filter(Boolean)}):a.threads.where("jid").anyOf(b).toArray()).then(function(a){var c=new Map();for(a of a)c.set(a.jid,a);return b.map(function(a){return c.get(a)})})}function a(a,b,e){var f=b.instanceKey,g=b.jid;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"get_or_create_thread_start",{instanceKey:f});e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_start",{instanceKey:e});return i(a,g).then(function(f){if(f==null){e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"create-1-1-thread-start",{instanceKey:e});return l(a,b,e).then(function(a){return{created:!0,thread:a}})}else return o(a,b,f).then(function(a){return{created:!1,thread:a}})}).then(function(a){d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"get_or_create_thread_end",{instanceKey:f});e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_end",{instanceKey:e});return a})}function b(a,b,c){c=c===void 0?{}:c;var e=c.logState;return j(a,b.map(function(a){a=a.jid;return a})).then(function(c){e==null||e("threadMapping2FetchedThreads");var f={},g=[],h=[];for(c of c.entries()){var i=c[0],j=c[1];j==null?g.push(b[i]):h.push({params:b[i],thread:j})}return d("MAWDexieTable").dexieAll([g.length?m(a,g):d("MAWDexieTable").dexieResolve([]),h.length?p(a,h):d("MAWDexieTable").dexieResolve([])]).then(function(a){var c=a[0];a=a[1];e==null||e("threadMapping3ThreadsUpdated");for(c of c){var d=c.adminMsgParams,g=c.thread;f[g.jid]={adminMsgParams:d,created:!0,thread:g}}for(d of a)f[d.jid]={adminMsgParams:null,created:!1,thread:d};return b.map(function(a){a=a.jid;return f[a]})})})}function k(a){var b=a.authoritativeThreadKey,c=a.clientThreadKey,e=a.createTs,f=a.deduplicationKey,g=a.folder,h=a.jid;a=a.lastActivityTimestamp;var i=d("WATimeUtils").millisTime();e=(a=a!=null?a:e)!=null?a:i;a={authoritativeThreadKey:b!=null?b:void 0,deduplicationKey:f,folder:g!=null?g:d("MAWFolderTypes").FOLDER_ID.INBOX,jid:h,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsgTs:e,oldestMsg:null,optimisticThreadKey:c!=null?c:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(e,h)};return a}function l(a,b,e){var f=b.authoritativeThreadKey,g=b.description,h=b.instanceKey,i=b.skipVerifyThread,j=k(b);return a.threads.add(j).then(function(b){b=babelHelpers["extends"]({},j,{chatId:b});i!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(b,b.optimisticThreadKey,f,g,h)});e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"write-e2ee-admin-msg-in-new-thread",{instanceKey:e});return d("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(a,b,e)})["catch"](function(a){a=c("getErrorSafe")(a);h!=null&&d("MAWThreadMappingQPL").endFailureInWorker("create_thread_failed",h,{string:{createThreadFailureReason:a.message}});a.message="Error creating thread: "+a.message;throw a})}function m(a,b){var e=b.map(k);return a.threads.bulkAdd(e,{allKeys:!0}).then(function(c){c=c.map(function(a,c){return{data:babelHelpers["extends"]({},e[c],{chatId:a}),params:b[c]}});for(var f of c)f.params.skipVerifyThread!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(f.data,f.data.optimisticThreadKey,f.params.authoritativeThreadKey,f.params.description,f.params.instanceKey)});return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns(a,c.map(function(a){return a.data}))})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk creating threads: "+a.message;throw a})}function n(a,b,c){var d=b.authoritativeThreadKey,e=b.clientThreadKey,f=b.deduplicationKey,g=b.folder;b=b.lastActivityTimestamp;d={authoritativeThreadKey:d!=null?d:a.authoritativeThreadKey,cannotReplyReason:g!=null||e!=null?null:a.cannotReplyReason,deduplicationKey:g!=null||e!=null?f:a.deduplicationKey,folder:g!=null?g:a.folder,newestMsgTs:h(c,b),optimisticThreadKey:e!=null?e:a.optimisticThreadKey};return babelHelpers["extends"]({},a,d)}function o(a,b,e){var f=b.authoritativeThreadKey,g=b.description,h=b.instanceKey,i=b.skipVerifyThread;return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,e.jid).then(function(j){var k=n(e,b,j);return a.threads.update(e.chatId,k).then(function(){var a;i!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(k,k.optimisticThreadKey,f,g,h)});d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(a=k==null?void 0:k.folder)!=null?a:d("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:k.jid})});return k})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error updating thread: "+a.message;throw a})})}function p(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.params,e=b.thread;return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,e.jid).then(function(a){a=n(e,c,a);return{params:c,thread:a}})})).then(function(b){return a.threads.bulkUpdate(b.map(function(a){a=a.thread;return{changes:a,key:a.chatId}})).then(function(){for(var a of b){var c=a.params,e=c.authoritativeThreadKey,f=c.description,g=c.instanceKey;c=c.skipVerifyThread;var h=a.thread;c!==!0&&d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(h,h.optimisticThreadKey,e,f,g)})}return b.map(function(a){a=a.thread;return a})})})["catch"](function(a){a=c("getErrorSafe")(a);a.message="Error bulk updating threads: "+a.message;throw a})}g.getExistingThread=i;g.bulkGetExistingThread=j;g.getOrCreateThread=a;g.bulkGetOrCreateThread=b;g.createThread=l;g.prepareUpdatedThreadData=n}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){var e=a.ts;e=d("WATimeUtils").castUnixTimeToMillisTime(e);c=d("MAWTimeUtils").ensureValidMillisTime(c)||d("WATimeUtils").castToMillisTime(0);e=e>c?e:c;return babelHelpers["extends"]({},b,{newestMsgTs:e,oldestMsg:a.msgId,snippetMsg:a.msgId,snippetMsgTs:d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(a)),threadOrder:d("MAWDbThread").craftThreadOrder(e,b.jid)})}function b(a,b){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"])));return}b=b.value;var e=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},b.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castMillisTimeToUnixTime(d("WATimeUtils").millisTime()));return d("MAWWriteMsgTxns").writeMsg(a,e,b).then(c("emptyFunction"))})}function e(a,b,c){return d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(a,[b],c).then(function(a){a=a[0];return a})}function f(a){var b=d("MAWDbMsg").craftE2eeAdminMsgAltIndex(a.chatId);b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},a.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castToUnixTime(0),b);return babelHelpers["extends"]({},b,{msgId:d("MAWDbMsg").craftMsgIdV2(a.chatId,1,b),sortOrderMs:0})}g.getUpdatedThreadForAdminMsg=a;g.writeReachabilityErrorAdminMsg=b;g.writeE2EEThreadDescriptionMsg=e;g.buildE2EEThreadDescriptionMsg=f}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","MAWBridgeMsg","MAWBridgeTrace","MAWDbMsg","MAWIndexedDb","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";c=b("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function a(a){var b=a.dbMsg,c=a.isFirstMsg,e=a.openMessageOtid,f=a.openMessageParticipantCount,g=a.participantCount,h=a.quotedReplyAttachmentMeta;a=a.updatedThread;var i=a.authoritativeThreadKey;a=a.jid;if(b.altIndex===d("MAWDbMsg").SPAM_ALT_INDEX||b.altIndex===d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX)return;d("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(b,a,d("ArmadilloDataTraceType").armadilloMessageSend,e,c,f,g,i)});d("MAWXMAUtils").isXMAStoryReply(b.xmaMessageType)||d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b,h)})}g.WriteMsgAfterTxnBumpThreadOption=c;g.writeMsgAfterTransaction=a}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWQplProxy","WALogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){var c=[],e=[],f=[],g=new Map(),i=new Map(),j=b.map(function(b){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){return g.set(b.jid,a)})}),k=b.map(function(b){return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,b.jid).then(function(a){return i.set(b.jid,a)})});return d("MAWDexieTable").dexieAll([j,k]).then(function(){b.forEach(function(a){a==null&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"])));var b=d("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(a);a=d("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(b,a,i.get(a.jid));c.push(b);f.push(a);e.push({dbMsg:b,isFirstMsg:!1,updatedThread:a})});return{afterTransactionSyncMsgsData:e,e2eeThreadAdminMsgs:c,threadsToUpdate:f}})}function a(a,b,c){return j(a,b,c).then(function(a){var b=a.afterTransactionSyncMsgsData;a=a.threadsToUpdate;var c=new Map();b.forEach(function(a){var b=a.updatedThread.jid;c.set(b,{externalId:a.dbMsg.externalId,msgId:a.dbMsg.msgId})});return a.map(function(a){return{adminMsgParams:c.get(a.jid),thread:a}})})}function b(a,b,c){return j(a,b,c).then(function(a){var b=a.afterTransactionSyncMsgsData;a=a.threadsToUpdate;b.forEach(function(a){return d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(a)});return a})}function j(a,b,e){return i(a,b).then(function(b){var f=b.afterTransactionSyncMsgsData,g=b.e2eeThreadAdminMsgs,h=b.threadsToUpdate;e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-start",{instanceKey:e});return d("MAWDexieTable").dexieAll([a.messages.bulkAdd(g),a.threads.bulkPut(h)]).then(function(){e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-end",{instanceKey:e});return{afterTransactionSyncMsgsData:f,threadsToUpdate:h}})})}g.writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns=a;g.writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns=b}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS;function a(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function b(a,b){var c=a.author;a=a.externalId;return{ack:d("MAWAckLevel").ACK.failed,altIndex:void 0,author:c,externalId:a,serverTs:b,ts:b,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(a,b){var c;return{ack:a.ack,author:a.author,externalId:a.externalId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(c=d("MAWDbMsg").getMsgContent(a))==null?void 0:c.content,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function e(a,b,c){return{ack:a.ack,altIndex:void 0,author:a.author,externalId:c.externalId,msgContent:d("MAWDbMsg").getMsgContent(a),originalTs:a.ts,revokedExternalId:c.revokedExternalId,threadJid:b.jid,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)}}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.buildUnstoredCiphertextMsg=a;g.buildUnstoredUnavailableMsg=b;g.buildUnstoredDeleteForMeMsg=c;g.buildUnstoredRevokedMsg=e}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWVault","MWFBLogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbEditMsgHistoryTxns"]);function a(a,b){var c=[];if(b.length===0)return d("MAWDexieTable").dexieResolve(c);b=b.filter(function(a){return a.editCount!=null&&a.editCount>0});var e=b.map(function(a){return[a.externalId,a.threadJid]});if(e.length===0)return d("MAWDexieTable").dexieResolve([]);var f=b.reduce(function(a,b){b.msgId!=null&&a.set(b.externalId,b.msgId);return a},new Map()),g=b.reduce(function(a,b){b.msgId!=null&&a.set(b.externalId,b);return a},new Map());return m(a,e).then(function(a){if(a.length===0){l.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No edit history found for the messages despite there being an editCount greater than 0"])));return[]}for(a of a){var b=f.get(a.originalMsgExternalId);b!=null&&c.push(babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(a.editMsgHistoryId),originalMsgId:b}));b=g.get(a.originalMsgExternalId);b!=null&&(a.threadJid!==b.threadJid&&l.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Edit history threadJid does not match original message threadJid"]))))}return c})}function m(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b).toArray()}function b(a,b){return b==null?d("MAWDexieTable").dexieResolve():a.editMsgHistory.get({editMsgHistoryId:b})}function e(a,b,c){return a.editMsgHistory.where("originalMsgExternalId").equals(c).filter(function(a){return a.editExternalId===b.externalId&&a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){if(a.length>1){var b=a.map(function(a){return""+a.editTs.toString()});b=new Set(b).size===1;!b?l.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"])),a.length):l.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"])))}return a[0]})}function f(a,b){return b==null?d("MAWDexieTable").dexieResolve([]):a.editMsgHistory.where("originalMsgExternalId").equals(b.externalId).filter(function(a){return a.author===b.author&&a.threadJid===b.chat}).toArray().then(function(a){var b=[];a.forEach(function(a){if(a==null)return;b.push(a)});return b})}function n(a,b){return a.editMsgHistory.bulkGet(b)}function o(a,b){return a.editMsgHistory.bulkAdd(b,{allKeys:!0}).then(function(a){return d("MAWDexieTable").dexieResolve(a)})}function p(a,b,c,d){return d.then(function(d){return q(a,b,c,d)})}function q(a,b,c,e){var f=[];return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===e&&a.author===c&&(a.sendStatus==null||a.sendStatus>=d("MAWAckLevel").ACK.sent)}).toArray().then(function(a){a.forEach(function(a){f.push({messageId:a.editExternalId,originalMessageId:a.originalMsgExternalId,text:d("MAWVault").unvault(a.msgContent.content),timestamp:a.editTs})});return f})}function r(a,b,d,e){return a.editMsgHistory.where("originalMsgExternalId").equals(b).filter(function(a){return a.threadJid===e&&a.author===d})["delete"]().then(c("emptyFunction"))}var s=function(a,b){return a.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(b)["delete"]().then(function(){return d("MAWDexieTable").dexieResolve(b.length)})};function t(a,b,c){return a.editMsgHistory.put(babelHelpers["extends"]({},b,{msgContent:c.msgContent})).then(function(){})}g.loadEditMsgHistory=a;g.getEditHistoryByOriginalMsgExternalIdAndThreadJid=m;g.maybeGetEditMsgHistoryFromEditMsgHistoryId=b;g.getEditHistoryMsgByEditedProtocolMsgId=e;g.maybeGetEditMsgHistoryFromProtocolMsgId=f;g.bulkGetEditMsgHistorys=n;g.bulkAddEditMsgHistory=o;g.getEditHistoryAsEchoWithJidPromise=p;g.getEditHistoryAsEcho=q;g.bulkRemoveEditHistory=r;g.deleteExpiredEditMsgHistory=s;g.updateEditMsgHistoryWithNewIncomingMsg=t}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(a,b,c,d,e,f,g){"use strict";var h="revoked",i="deleteForMe",j="deleteThread";b="Revoked";d="DeleteForMe";e="DeleteThread";f={DELETE_FOR_ME:d,DELETE_THREAD:e,REVOKED:b};function a(a){switch(a){case"Revoked":return h;case"DeleteForMe":return i;case"DeleteThread":return j;default:return c("WAAssertUnreachable")(a)}}g.PENDING_REVOKED=h;g.PENDING_DELETE_FOR_ME=i;g.REVOKED=b;g.DELETE_FOR_ME=d;g.PENDING_TYPE=f;g.getPendingSuffix=a}),98);
__d("MAWDeleteThreadUtil",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=[];a.forEach(function(a){if(a.pendingContent.type==="DeleteThread"){a=a.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;a!=null&&b.push(a)}});if(b.length===0)return null;b.sort(function(a,b){return b-a});a=b[0];return{lastMessageTimestamp:a}}function b(a,b){return b!=null&&b.lastMessageTimestamp>=a}f.getLatestDeleteThreadInfo=a;f.isMsgDeletedViaDeleteThread=b}),66);
__d("MAWMsgCleaner",["MAWLoggerUtils","MWFBLogger","Promise","WAAssertUnreachable","WAShiftTimer","WATimeUtils","WorkerScheduler","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a="Unsend";e="Ephemeral";f="DeleteForMe";var l="PendingStanza",m="Xma",n="IGDDM",o="Quote",p=d("MWFBLogger").MWLogger().tags([d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerUpdate]);f={DELETE_FOR_ME:f,EPHEMERAL:e,IGDDM:n,PENDING_STANZA:l,QUOTE:o,UNSEND:a,XMA:m};var q;function r(){q==null&&(q=d("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxConcurrency:1,maxThrottleMs:8e3}));return q}e=function(){function a(a,b){var e=this;this.$1=new(d("WAShiftTimer").ShiftTimer)(function(){c("promiseDone")(e.$2())});this.getNextTs=a.getNextTs;this.removeExpired=a.removeExpired;this.cleanerType=b;this.purgeEnabled=a.purgeEnabled;this.$1.forceRunNow()}var e=a.prototype;e.update=function(a){var b=s(this.cleanerType);p.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""])),b,a);this.$1.onOrBefore(d("WATimeUtils").cappedMillisecondsUntil(a))};e.$2=function(){var a=this,c=function(){if(!a.purgeEnabled())return(k||(k=b("Promise"))).resolve();var c=s(a.cleanerType);p.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"])),c);return a.removeExpired().then(function(b){b>0&&p.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"])),c,b);return a.getNextTs()}).then(function(b){b!=null&&a.update(b)})};if(this.$3!=null)return(k||(k=b("Promise"))).resolve();this.$3=r().task({fn:c,name:this.cleanerType,priority:d("WorkerScheduler").BACKGROUND_PRIORITY});return this.$3.run()["finally"](function(){a.$3=null})};return a}();function s(a){switch(a){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return c("WAAssertUnreachable")(a)}}n=e;g.CLEANER_TYPE=f;g.MsgCleaner=e;g.MSG_CLEANER_FOR_TESTING_ONLY=n}),98);
__d("MAWPendingStanzaCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function b(a){if(j==null){var b="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startPendingStanzaCleaner=a;g.addNewPendingStanzaCleanerTimestamp=b;g.getPendingStanzaCleaner_FOR_TESTING_ONLY=e;g.resetPendingStanzaCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c,e,f){var g=d("MAWDbPendingStanza").getPendingSuffix(f);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+g).filter(function(a){a=a.pendingContent;return a.type===f&&a.content.author===c&&a.content.threadJid===e}).first()}function a(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function b(a,b,c,e){return h(a,b,c,e,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function e(a,b){var e=b.map(function(a){a=a.expirationInSeconds;return d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+a)});b=b.map(function(a,b){var c=a.content,f=a.externalId;a=a.pendingStanzaType;return{deleteTs:e[b],externalIdWithType:f+"_"+d("MAWDbPendingStanza").getPendingSuffix(a),pendingContent:c}});return a.pendingStanzas.bulkAdd(b).then(function(){return e.forEach(d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(c("emptyFunction"))}function f(a,b,c,e,f){f=d("MAWDbPendingStanza").getPendingSuffix(f);var g=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+c);c={deleteTs:g,externalIdWithType:e+"_"+f,pendingContent:b};return a.pendingStanzas.add(c).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(g)})}function i(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return a.pendingStanzas.where("externalIdWithType").equals(b+"_"+c).toArray().then(function(a){return d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a)})}function j(a){return a.pendingStanzas.toArray()}function k(a,b){b=b.map(function(a){return a.rowId});return a.pendingStanzas.bulkDelete(b)}function l(a){var b,c;return(a==null||(b=a.pendingContent)==null?void 0:b.type)===d("MAWDbPendingStanza").PENDING_TYPE.REVOKED?a==null||(c=a.pendingContent)==null?void 0:c.content:null}function m(a,b){var c=d("MAWDbPendingStanza").getPendingSuffix(d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);b=b.map(function(a){return a+"_"+c});return a.pendingStanzas.where("externalIdWithType").anyOf(b).toArray().then(function(a){a=a.reduce(function(a,b){var c=a.get(b.externalIdWithType);c==null?a.set(b.externalIdWithType,[b]):c.push(b);return a},new Map());var b=new Map();a.forEach(function(a,c){c=d("WAJids").unsafeCoerceToChatJid(c.split("_")[0]);a=d("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(a);a!=null&&b.set(c,a)});return b})}g.maybeGetPendingStanzaByExternalId=h;g.maybeGetPendingRevokedStanza=a;g.maybeGetPendingDeletedStanza=b;g.bulkPutPendingStanzas=e;g.putPendingStanza=f;g.maybeGetDeleteThreadFromPendingStanza=i;g.getAllPendingStanzas=j;g.deletePendingStanzas=k;g.getRevokedContent=l;g.bulkGetDeleteThreadPendingStanzas=m}),98);
__d("MAWDeleteForMeMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function b(a){if(j==null){var b="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startDeleteForMeMsgContentCleaner=a;g.addNewDeleteForMeMsgContentCleanerTimestamp=b;g.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","MWFBLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("MWFBLogger").MWLogger().tags(["bridge",d("MAWLoggerUtils").Tag.Countdown]);function a(a){return{msgs:a.map(function(a){var b,c=a.messageExpirationTs;b=(b=a.ephemeralSetting)==null?void 0:b.ephemeralExpirationInSec;if(c==null||b==null)return;var e=d("WATimeUtils").cappedMillisecondsUntil(c);if(e<=0){j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"])));return}var f=b*1e3;e>f&&(e=f);j.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""])),a.msgId,c,e,b);return{countdownTs:c,millisecondsUntilCountdownTs:e,msgId:a.msgId,threadJid:a.threadJid,ts:d("MAWDbMsg").getCanonicalTsFromMsg(a)}}).filter(Boolean)}}function b(a,b){return{countdownTs:b,msgId:a}}g.createBridgeMsgsStartCountdown=a;g.createBridgeMsgClearCountdown=b}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i=null,j=d("MWFBLogger").MWLogger().tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.MsgCleaner,d("MAWLoggerUtils").Tag.CleanerTimestamp,"backend"]);function a(a){var b=a.backendFns;a=a.uiFns;if(i==null){var c;i={backend:new((c=d("MAWMsgCleaner")).MsgCleaner)(b,c.CLEANER_TYPE.EPHEMERAL),ui:new c.MsgCleaner(a,c.CLEANER_TYPE.EPHEMERAL)}}}function b(a,b){if(i==null)throw j.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");else{var c=i,d=c.backend;c=c.ui;j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for UI(",") and backend(",")"])),a,b);c.update(a);d.update(b)}}function c(){return i}function e(){i=null}g.startEphemeralCleaner=a;g.addNewEphemeralTimestamp=b;g.getEphemeralCleaner_FOR_TESTING_ONLY=c;g.resetEphemeralCleaner_FOR_TESTING_ONLY=e}),98);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=new Map();function i(a,b){h.set(a,b)}function a(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};return(a=h.get(a))!=null?a:b}async function b(a){var b={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").castToUnixTime(0)};if(!h.has(a)){var c=await d("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:a});i(a,c!=null?c:b)}}g.setEphemeralSettingCache=i;g.getEphemeralSettingCache=a;g.requestLSDBCacheForJid=b}),98);
__d("MAWEphemeralUtil",["FBLogger","MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){var c=b.ephemeralExpirationInSec!==a.ephemeralExpirationInSec&&b.ephemeralLastUpdatedOrSetTimestamp===a.ephemeralLastUpdatedOrSetTimestamp;return c||a.ephemeralLastUpdatedOrSetTimestamp>b.ephemeralLastUpdatedOrSetTimestamp}function b(a,b,c){if(a==null)return!0;a=a.ephemeralSetting;if(a!=null&&a.ephemeralExpirationInSec===b){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"])));return!1}if(a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>c){d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"])));return!1}return!0}function e(a){a={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:null}}function f(a,b){var e;switch(b){case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:e=d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw c("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type")}b={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:e},ts:a,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:b,unstoredDbReaction:void 0}}function j(a){return d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){throw c("FBLogger")("messenger_web").mustfixThrow("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(a){return a}})}function k(a){a!=null&&a.messageExpirationTs!=null&&a.ephemeralCounterStarted===!0&&d("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(a.msgId,a.messageExpirationTs)})}g.isLocalSettingOutdated=a;g.shouldUpdateForOutgoingUserEphemeralSettingChange=b;g.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=e;g.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=f;g.getUserJidForEphemeralSetting=j;g.maybeClearEphemeralMsgCountdown=k}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","MAWUserJidWrapper","MWFBLogger","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("MWFBLogger").MWLogger().tags(["maw_db","txn",(o=d("MAWLoggerUtils")).Tag.Ephemeral,o.Tag.SettingChange,o.Tag.Incoming]),q=d("MWFBLogger").MWLogger().tags(["maw_db","txn",o.Tag.Ephemeral,o.Tag.SettingChange,o.Tag.Outgoing]),r=null,s=90*d("DateConsts").SEC_PER_DAY;function a(a,b,c,e,f,g,l,m,n){if(c<0||c>s){l=d("WAJids").interpretAndValidateJid(g.jid).toString();throw p.mustfixThrow("EphemeralSetting duration is invalid "+c+", jidType: "+l)}m={ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:e};p.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",". Thread: ",", Author: ",""])),c,e,String(g),b);l=d("WAJids").interpretAsUserJid(g.jid);if(l==null){p.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"])));return d("MAWDexieTable").dexieResolve(r)}c=d("WAJids").isAuthorMe(b)?d("MAWUserJidWrapper").getMyUserJid():b;b=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(g.jid);var o=b==null?void 0:b.ephemeralExpirationInSec,q=b==null?void 0:b.ephemeralLastUpdatedOrSetTimestamp;if(n){if(b!=null&&!d("MAWEphemeralUtil").isLocalSettingOutdated(m,b))if(e!==q){p.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Sending Sync Response with duration ",", timestamp ",""])),o,q);return d("MAWDexieTable").dexieResolve({outOfSyncEphemeralSetting:{chatJid:g.jid,correctEphemeralExpirationInSec:b.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:b.ephemeralLastUpdatedOrSetTimestamp}})}else{p.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Ephemeral setting in sync"])));return d("MAWDexieTable").dexieResolve(r)}d("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:d("WAJids").userIdFromJid(c),chatJid:g.jid,ephemeralSettingArgs:m,isEphemeralSettingReset:f}});return d("MAWDexieTable").dexieResolve(r)}n={ephemeralSetting:m,ephemeralSyncResponseBackoffInfo:void 0,userJid:l};return a.ephemeralSettings.put(n).then(function(){return r})}function b(a,b,c,e,f){var g=c;if(g<0)throw q.mustfixThrow("Ephemeral duration should be 0 or more");var h=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return d("MAWDbThreadTxns").getThread(a,b).then(function(b){return!b.success?d("WAResultOrError").makeResult({shouldUpdateSetting:!1}):a.ephemeralSettings.get({userJid:h}).then(function(b){if(!d("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(b,g,e))return d("WAResultOrError").makeResult({shouldUpdateSetting:!1});b=b==null?{ephemeralSetting:{ephemeralExpirationInSec:g,ephemeralLastUpdatedOrSetTimestamp:e},userJid:h}:babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:g,ephemeralLastUpdatedOrSetTimestamp:e}});return a.ephemeralSettings.put(b).then(function(){return d("WAResultOrError").makeResult({shouldUpdateSetting:!0})})})})}function e(a,b,e){var f=d("MAWEphemeralUtil").getUserJidForEphemeralSetting(b);return a.ephemeralSettings.get({userJid:f}).then(function(b){if(b==null||b.ephemeralSetting==null){q.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"])),f,String(b),String(b==null?void 0:b.ephemeralSetting));throw q.mustfixThrow("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change")}b=babelHelpers["extends"]({},b,{ephemeralSetting:{ephemeralExpirationInSec:b.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e}});return a.ephemeralSettings.put(b).then(c("emptyFunction"))})}function f(a,b){a=d("WAJids").interpretAsUserJid(b);a==null&&q.mustfixThrow("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");a=d("MAWEphemeralSettingsCache").getEphemeralSettingCache(b);if(a.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").castToUnixTime(0))return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"));return a!=null&&a.ephemeralExpirationInSec>0?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:b,correctEphemeralExpirationInSec:a.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:a.ephemeralLastUpdatedOrSetTimestamp}})):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("no_ephemeral_setting"))}function t(a,b){return a.ephemeralSettings.get({userJid:b}).then(function(c){if((c==null?void 0:c.ephemeralSyncResponseBackoffInfo)==null){p.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""])),b);return d("WAResultOrError").makeResult()}c.ephemeralSyncResponseBackoffInfo=void 0;p.DEBUG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""])),b);return a.ephemeralSettings.put(c).then(function(){return d("WAResultOrError").makeResult()})})}g.handleAndWriteIncomingEphemeralSetting=a;g.handleAndWriteOutgoingUserEphemeralSettingChange=b;g.updateContactWhenEphemeralSettingChangeMarkedSent=e;g.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=f;g.maybeResetEphemeralSyncResponseBackoffInfo=t}),98);
__d("MAWEphemeralMsgTxns",["EBLogger","MAWBridgeMsgCountdown","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLoggerUtils","MAWODSProxy","MAWThreadSnippetUtils","MWFBLogger","WAJids","WAOdsEnums","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=d("MWFBLogger").MWLogger().tags([(f=d("MAWLoggerUtils")).Tag.Ephemeral,f.Tag.SettingSync,f.Tag.Incoming]),o=d("MWFBLogger").MWLogger().tags([f.Tag.Ephemeral,f.Tag.OnRead,f.Tag.Countdown]);function p(a,b,c){c===void 0&&(c=function(){return!0});return d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,b,!1,!0).filter(c).limit(1).toArray().then(function(a){return{needsUpdate:!0,value:(a=a[0])!=null?a:null}})}function q(a,b,c){return c.size===0?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;var e=b.value;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadOldestMessageId(a,e.jid),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e.jid)]).then(function(b){var f=b[0],g=b[1];if(f==null||g==null)return;b=d("MAWEphemeralMsgUtils").filterNonExpiredMsg(c);var h=c.has(f)?p(a,e.jid,b):d("MAWDexieTable").dexieResolve({needsUpdate:!1});b=c.has(g)?d("MAWDbMsgTxns").getThreadMessagesBySortOrder(a,e.jid,!0,!1).filter(b).reverse().limit(1).toArray().then(function(b){b=b[0];return b!=null&&d("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(b)?d("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(a,e,c).then(function(a){return{needsUpdate:!0,value:a!=null?a:null}}):{needsUpdate:!0,value:b!=null?b:null}}):d("MAWDexieTable").dexieResolve({needsUpdate:!1});return d("MAWDexieTable").dexieAll([h,b]).then(function(b){var c,h=b[0];b=b[1];if(!h.needsUpdate&&!b.needsUpdate)return;c=b.needsUpdate?(c=(c=b.value)==null?void 0:c.msgId)!=null?c:void 0:g;b=b.needsUpdate?b.value!=null?d("WATimeUtils").castUnixTimeToMillisTime(d("MAWDbMsg").getCanonicalTsFromMsg(b.value)):void 0:e.snippetMsgTs;h=babelHelpers["extends"]({},e,{oldestMsg:h.needsUpdate?(h=(h=h.value)==null?void 0:h.msgId)!=null?h:null:f,snippetMsg:c,snippetMsgTs:b});a.threads.put(h)})})})}function a(a,b,c){c===void 0&&(c=!0);if(b==null||b.ephemeralSetting==null||b.ephemeralSetting.ephemeralExpirationInSec===0)return d("MAWDexieTable").dexieResolve(b);var e=d("WATimeUtils").castToUnixTime(b.ts+b.ephemeralSetting.ephemeralExpirationInSec),f=d("WATimeUtils").castToUnixTime(e+d("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);b.ebTimestampMs!=null&&(d("EBLogger").EBLogger().tags(["eb_restore"]).WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Delete DM backup - S472027 follow up"]))),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"restore_dm_s472027"}));return r(a,[{messageDeleteTs:f,messageExpirationTs:e,msgId:b.msgId,readTsForLogging:b.ts}]).then(function(a){var b=a[0],e=a[1];a=a[2];a.length>0&&(o.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(a){return a.msgId}))),c&&d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)}));b!=null&&e!=null&&d("MAWEphemeralCleaner").addNewEphemeralTimestamp(b,e);return a[0]})}function r(a,b){var c=b.map(function(a){return a.msgId});return d("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(a,c).then(function(d){var e=new Map();b.forEach(function(a){e.set(a.msgId,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging});var b=d.get(a.msgId);b!=null&&e.set(b,{messageDeleteTs:a.messageDeleteTs,messageExpirationTs:a.messageExpirationTs,readTsForLogging:a.readTsForLogging})});var f=null,g=null,h=[],i=Array.from(new Set(c.concat(Array.from(d.values()))));return a.messages.where("msgId").anyOf(i).toArray().then(function(b){if(b.length===0)return;b.forEach(function(a){var b=a.messageExpirationTs,c=a.messageDeleteTs,d=e.get(a.msgId),i=d==null?void 0:d.messageExpirationTs;d=d==null?void 0:d.messageDeleteTs;o.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""])),a.msgId,b,c,i,d);if(i==null||d==null)return;if(a.ephemeralCounterStarted===!0)return;f==null?f=i:i<f&&(f=i);g==null?g=d:d<g&&(g=d);b=babelHelpers["extends"]({},a,{ephemeralCounterStarted:!0,messageDeleteTs:d,messageExpirationTs:i});h.push(b)});return a.messages.bulkPut(h)}).then(function(){return[f,g,h]})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();var e=[];b.forEach(function(b,c){e.push(q(a,c,b))});return d("MAWDexieTable").dexieAll(e).then(c("emptyFunction"))}function e(a,b,e,f,g){if(b==null)return d("MAWDexieTable").dexieResolve();n.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""])),e,f.jid,b.type);var h=d("MAWDexieTable").dexieResolve();if(b.ephemeralSetting==null)d("WAJids").switchOnMsgrChatJidType(f.jid,{group:function(){return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,e).then(c("emptyFunction"))},user:function(){d("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(b)&&(h=d("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(a,f.jid).then(function(a){var b;return a==null||(b=a.value)==null?void 0:b.outOfSyncEphemeralSetting}))}});else if(b.messageExpirationTs!=null&&b.messageDeleteTs!=null){var i=b.ephemeralSetting,j=b.messageDeleteTs,o=b.messageExpirationTs;n.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""])),i.ephemeralExpirationInSec,i.ephemeralLastUpdatedOrSetTimestamp);d("MAWEphemeralCleaner").addNewEphemeralTimestamp(o,j);h=d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,e,i.ephemeralExpirationInSec,i.ephemeralLastUpdatedOrSetTimestamp,!1,f,g,null,!0).then(function(a){return a==null?void 0:a.outOfSyncEphemeralSetting})}return h.then(function(b){if(b!=null)n.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""])),b.correctEphemeralExpirationInSec,b.correctEphemeralLastUpdatedOrSetTimestamp);else return d("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(a,e).then(c("emptyFunction"))})}g.markEphemeralMessageAsSent=a;g.bulkUpdateEphemeralMessageTimestamps=r;g.updateThreadsOnMessagesExpiredFromUi=b;g.syncEphemeralSettingOnIncomingMsg=e}),98);
__d("MAWExpiredQuoteCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.QUOTE))}function b(a){if(j==null){var b="Trying to add new addNewExpiredQuoteCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["ExpiredQuoteCleaner: Adding timestamps backend(",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startExpiredQuoteCleaner=a;g.addNewExpiredQuoteCleanerTimestamp=b;g.getExpiredQuoteCleaner_FOR_TESTING_ONLY=e;g.resetExpiredQuoteCleaner_FOR_TESTING_ONLY=f}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isMAWUniversalSearchEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("isE2EEConversationSearchEnabled")()||c("isMAWUniversalSearchEnabled")()}g["default"]=a}),98);
__d("MAWFTSTxns",["MAWDexieTable","isWAFTSContentSearchEnabled","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=c("justknobx")._("1146");function a(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeBacklog.put({externalId:b})}function b(a,b){return!c("isWAFTSContentSearchEnabled")()||!h?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.put({rowId:b})}function e(a,b){return!c("isWAFTSContentSearchEnabled")()||!h?d("MAWDexieTable").dexieResolve(null):a.ftsBackloggedMessages.bulkPut(b.map(function(a){return{rowId:a}}))}function f(a,b){return!c("isWAFTSContentSearchEnabled")()?d("MAWDexieTable").dexieResolve(null):a.ftsPurgeThreadBacklog.put({chatJid:b})}g.maybePutMessageToPurgeBacklog=a;g.maybePutMessageToBacklog=b;g.maybePutMessagesToBacklog=e;g.maybePutThreadToPurgeBacklog=f}),98);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.actionType,c=a.attachmentContext,d=a.attachmentContextArray,e=a.authTs,f=a.echoDocument,g=a.echoEncodingLatencyNs,i=a.errorCode,j=a.errorMessage,k=a.messageId,l=a.messageType,m=a.productType,n=a.protoMsg,o=a.sortOrderMs,p=a.threadId,q=a.traceId;a=a.uploadTrackingInstanceKey;c=h(c,m!=null?m:"msgr",d);return{actionType:b,attachmentBackupContext:c,authTs:e,echoDocument:f,echoEncodingLatencyNs:g,errorCode:i,errorMessage:j,messageId:k,messageType:l,protoMsg:n,sortOrderMs:o,threadId:p,traceId:q,uploadTrackingInstanceKey:a}}function b(a,b,c,d,e,f){return{actionType:f,echoDocument:e,folderType:b,threadId:a,transportKey:c,ts:d}}function c(a,b,c,d,e,f,g,h){return{deliveryObjectId:a,mediaType:b,messageId:c,productType:d,threadId:e,threadJid:f,traceId:h,ts:g}}function h(a,b,c){if(c==null)return void 0;else{a=c.map(function(a){return{attachmentTraceId:d("MAWMainTraceUtils").createTraceId(),mediaType:a.mediaType,zippyObjectId:a.mediaObjectId}});c={attachmentInfos:a,productType:b};return c}}g.createBridgeUploadMessage=a;g.createBridgeDeleteMessagesOfThread=b;g.createBridgeUploadAttachment=c;g.createBridgeUploadAttachmentBackupContext=h}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function i(a){switch(a){case d("MAWFolderTypes").FOLDER_ID.INBOX:return h.INBOX;case d("MAWFolderTypes").FOLDER_ID.PENDING:return h.PENDING;case d("MAWFolderTypes").FOLDER_ID.ARCHIVED:return h.ARCHIVED;default:return h.INBOX}}function a(a){return i(a).toString()}g.FolderType=h;g.getFolderTypeAsText=a}),98);
__d("MpsLogger",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return c("FBLogger")("mps",a)};g.MpsLogger=a}),98);
__d("WormMemoryDriver",["WAResolvable","WormStoreFunctions","err"],(function(a,b,c,d,e,f,g){"use strict";var h=0;function i(){h+=1;return h}function a(){h=0}b=function(){function a(a){this.$2={};this.$3=Promise.resolve();this.$1=a;for(a of Object.keys(a))this.$2[a]=new Map()}var b=a.prototype;b.getSchema=function(){return this.$1};b.runInTransaction=function(a,b,c,e){var f=this,g=new(d("WAResolvable").Resolvable)();this.$3=this.$3.then(async function(){var d={};for(var e of Object.keys(f.$1))d[e]=new Map(f.$2[e]);e=a.reduce(function(a,b){return babelHelpers.extends({},a,(a={},a[b]=new j(d[b],f.$1[b]),a))},{});e={abort:function(){},commit:function(){return g.promise.then(function(){})},stores:e};e=await c(e);b==="readwrite"&&(f.$2=d);g.resolve(e)}).catch(function(a){g.reject(a)});return g.promise};b.close=function(){};b.init=function(a){return Promise.resolve()};return a}();var j=function(){function a(a,b){var d=this;this.readIndexRange=function(a,b,e){var f=d.$2.indexes;if(f==null)throw c("err")("No indexes found");f=f[a];if(f==null)throw c("err")("Index not found");var g=Array.from(d.$1.values());if(b!=null){var h;g=l(g,(h=(h=b.lessThan)!=null?h:b.lessThanOrEqual)!=null?h:b.only,b.lessThanOrEqual!=null||b.only!=null,(h=(h=b.greaterThan)!=null?h:b.greaterThanOrEqual)!=null?h:b.only,b.greaterThanOrEqual!=null||b.only!=null,f)}return Promise.resolve(d.$4(g,e,a))};this.$1=a;this.$2=b}var b=a.prototype;b.bulkAdd=function(a){var b=this;for(var d of a){this.$2.autoIncrement===!0&&d[this.$2.primaryKey]===void 0&&(d[this.$2.primaryKey]=i());if(this.$1.has(d[this.$2.primaryKey]))throw c("err")("Item with key already exists");this.$3(d);this.$1.set(d[this.$2.primaryKey],d)}return Promise.resolve(a.map(function(a){return a[b.$2.primaryKey]}))};b.bulkPut=function(a){for(a of a)this.$3(a),this.$1.set(a[this.$2.primaryKey],a);return Promise.resolve()};b.$3=function(a){var b=this,d=this.$2.indexes;if(d==null)return;for(d of Object.values(d)){if(typeof d!=="object"||d==null)continue;var e=d.fields,f=d.unique;if(f===!1)continue;var g=e.map(function(b){return a[b]}).join(":");f=function(d){if(d[b.$2.primaryKey]===a[b.$2.primaryKey])return 1;var f=e.map(function(a){return d[a]}).join(":");if(g===f)throw c("err")("ConstraintError")};for(var h of this.$1.values())if(f(h))continue}};b.bulkGet=function(a){var b=this;return Promise.resolve(a.map(function(a){return b.$1.get(a)}))};b.get=function(a){return Promise.resolve(this.$1.get(a))};b.getByIndex=function(a,b,c){return d("WormStoreFunctions").getByIndex(this,a,b,c)};b.readByKeyRange=function(a,b){var c;c=k(Array.from(this.$1.values()),(c=a.lessThan)!=null?c:a.lessThanOrEqual,a.lessThanOrEqual!=null,(c=a.greaterThan)!=null?c:a.greaterThanOrEqual,a.greaterThanOrEqual!=null,this.$2.primaryKey);return Promise.resolve(this.$4(c,b))};b.bulkDelete=function(a){for(a of a)this.$1.delete(a);return Promise.resolve()};b.delete=function(a){this.$1.delete(a);return Promise.resolve()};b.bulkUpsert=function(a,b){return d("WormStoreFunctions").bulkUpsert(this,this.$2,a,b)};b.readKeysByIndexRange=function(a,b,c){var d=this;return this.readIndexRange(a,b,c).then(function(a){return a.map(function(a){return a[d.$2.primaryKey]})})};b.getIndexRangeIterator=function(a,b,c,e){return d("WormStoreFunctions").getIndexRangeIterator(this.readIndexRange,this.$2,a,b,c,e)};b.$4=function(a,b,c){a=a;(b==null?void 0:b.filter)!=null&&(a=a.filter(b.filter));(b==null?void 0:b.order)!=null&&c!=null&&(a=a.sort(function(a,d){a=a[c];d=d[c];if(a===d)return 0;if(b.order==="desc")return d>a?1:-1;else return a>d?1:-1}));(b==null?void 0:b.limit)!=null&&(a=a.slice(0,b.limit));return a};b.readIndex=function(a,b,d){var e=this.$2.indexes;if(e==null)throw c("err")("No indexes found");var f=e[a];if(f==null)throw c("err")("Index not found");e=Array.from(this.$1.values());b!=null&&(e=e.filter(function(a){for(var c=0;c<f.fields.length;c++)if(a[f.fields[c]]!==b[c])return!1;return!0}));return Promise.resolve(this.$4(e,d,a))};b.readIndexAnyOf=function(a,b,d){var e=this.$2.indexes;if(e==null)throw c("err")("No indexes found");var f=e[a];if(f==null)throw c("err")("Index not found");if(b.length===0)return Promise.resolve([]);e=Array.from(this.$1.values());e=e.filter(function(a){return b.some(function(b){for(var c=0;c<f.fields.length;c++)if(b[c]!==void 0&&a[f.fields[c]]!==b[c])return!1;return!0})});return Promise.resolve(this.$4(e,d,a))};b.readIndexKeys=function(a,b,c){var d=this;return this.readIndex(a,b,c).then(function(a){return a.map(function(a){return a[d.$2.primaryKey]})})};b.readAll=function(a){var b=this,c=Array.from(this.$1.values());(a==null?void 0:a.filter)!=null&&(c=c.filter(a.filter));(a==null?void 0:a.order)!=null&&(c=c.sort(function(c,d){c=c[b.$2.primaryKey];d=d[b.$2.primaryKey];if(c===d)return 0;if(a.order==="desc")return d>c?1:-1;else return c>d?1:-1}));(a==null?void 0:a.limit)!=null&&(c=c.slice(0,a.limit));return Promise.resolve(c)};b.readKeys=function(a){var b=this;return this.readAll(a).then(function(a){return a.map(function(a){return a[b.$2.primaryKey]})})};b.clear=function(){this.$1.clear();return Promise.resolve()};b.count=function(){return Promise.resolve(this.$1.size)};return a}();function k(a,b,c,d,e,f){return a.filter(function(a){if(d!=null&&d>a[f])return!1;if(b!=null&&b<a[f])return!1;if(b!=null&&c===!1&&a[f]===b)return!1;return d!=null&&e===!1&&a[f]===d?!1:!0})}function l(a,b,c,d,e,f){return a.filter(function(a){for(var g=0;g<f.fields.length;g++){if(d!=null&&d[g]>a[f.fields[g]])return!1;if(b!=null&&b[g]<a[f.fields[g]])return!1;if(g===f.fields.length-1){if(b!=null&&c===!1&&a[f.fields[g]]===b[g])return!1;if(d!=null&&e===!1&&a[f.fields[g]]===d[g])return!1}}return!0})}g.TEST_ONLY_resetPK=a;g.WormMemoryDriver=b;g.WormMemoryStore=j}),98);
__d("WebReverbSchema",["FBLogger","MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver","WormMemoryDriver"],(function(a,b,c,d,e,f,g){"use strict";e={autoIncrement:!0,indexes:{"[threadId+messageId]":{fields:["threadId","messageId"],unique:!0},"[threadId+timestampMs+messageId]":{fields:["threadId","timestampMs","messageId"],unique:!1},expiryTimestampMs:{fields:["expiryTimestampMs"],unique:!1},messageId:{fields:["messageId"],unique:!1},timestampMs:{fields:["timestampMs"],unique:!1}},nonEncryptedFields:["timestampMs","expiryTimestampMs","messageId","debugFlags"],primaryKey:"pk",secure:!0};f={autoIncrement:!0,indexes:{"[threadId+topLevelMessageId+supplementalKey]":{fields:["threadId","topLevelMessageId","supplementalKey"],unique:!0}},nonEncryptedFields:["topLevelMessageId"],primaryKey:"pk",secure:!0};var h={autoIncrement:!0,indexes:{"[threadId+deletedMessageId]":{fields:["threadId","deletedMessageId"],unique:!0},"[threadId+topLevelMessageId+supplementalKey]":{fields:["threadId","topLevelMessageId","supplementalKey"],unique:!1},deletionTimestampMs:{fields:["deletionTimestampMs"],unique:!1}},nonEncryptedFields:["topLevelMessageId","deletionTimestampMs"],primaryKey:"pk",secure:!0},i={autoIncrement:!0,indexes:{"[threadId+messageId+tag]":{fields:["threadId","messageId","tag"],unique:!0},"[threadId+tag+timestampMs]":{fields:["threadId","tag","timestampMs"],unique:!1}},nonEncryptedFields:["messageId","timestampMs","messagePk","tag"],primaryKey:"pk",secure:!0},j={autoIncrement:!1,indexes:{},primaryKey:"pk",secure:!0},k={dbMetadata:j,deleted:h,message:e,supplemental:f,tags:i};function a(a,b,e,f,g){b=d("WAHex").parseHex(b);var h="reverb";b=new(d("WormEAR").WormEAR)(k,h,b);var i=new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,h,k,b,d("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:e,onBlockingError:f,onTransactionError:function(a){if(a instanceof d("WormEAR").DecryptionError){var b=a;c("FBLogger")("mps").mustfix("EAR decryption error in store: %s. Dropping corrupted entity %s",b.store,b.maybeHashedPk);void i.runInTransaction([b.store],"readwrite",function(a){a=a.stores[b.store];return b.maybeHashedPk!=null?a["delete"](b.maybeHashedPk):a.clear()},"delete-corrupted-entity")}}}),g);return i}function b(a){return new(d("Worm").WormDatabase)(new(d("WormMemoryDriver").WormMemoryDriver)(k),a)}g.schema=k;g.makeWebReverbSchema=a;g.makeInMemoryReverbSchema_TEST_ONLY=b}),98);
__d("WebReverbDB",["MpsLogger","WAResolvable","WebReverbSchema","err","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new(d("WAResolvable").Resolvable)();async function a(a,b,e,f,g){try{a=d("WebReverbSchema").makeWebReverbSchema(a,b,e,f,g);h=a;await a.init();i.resolve(a);return a}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("Error performing WebReverb init");throw a}}function b(){if(h==null)throw c("err")("Reverb DB is not initialized");return h}function e(){return i.promise}function f(a){return"WebReverb - "+a}g.makeWebReverb=a;g.getWebReverbDB=b;g.getDbPromise=e;g.mpsOp=f}),98);
__d("MpsReverbDbDump",["WebReverbDB","WormDump"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("WebReverbDB").getWebReverbDB();return a.dump({dbMetadata:{customFields:{mawDBMigrationCurrentMessageId:(a=d("WormDump")).wormNonSensitiveField,mawDBMigrationCurrentThread:a.wormNonSensitiveField,mawDBMigrationStartMs:a.wormNonSensitiveField,mawDBMigrationState:a.wormNonSensitiveField,pk:a.wormNonSensitiveField}},deleted:{customFields:{deletedMessageId:a.wormNonSensitiveField,deletionMessageId:a.wormNonSensitiveField,deletionTimestampMs:a.wormNonSensitiveField,isLocalOnlyMessage:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,supplementalKey:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField,topLevelMessageId:a.wormNonSensitiveField},limit:1e3},message:{customFields:{debugFlags:a.wormNonSensitiveField,expiryTimestampMs:a.wormNonSensitiveField,isLocalOnlyMessage:a.wormNonSensitiveField,isTransportErrorPlaceholder:a.wormNonSensitiveField,messageId:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,senderId:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField},limit:2500},supplemental:{customFields:{messageId:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,supplementalKey:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField,topLevelMessageId:a.wormNonSensitiveField},limit:1e3},tags:{customFields:{messageId:a.wormNonSensitiveField,messagePk:a.wormNonSensitiveField,pk:a.wormNonSensitiveField,threadId:a.wormNonSensitiveField,timestampMs:a.wormNonSensitiveField},limit:1e3}})}g.debugGetReverbDbDump=a}),98);
__d("WAPromiseQueue",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=function(){function a(a){a===void 0&&(a=-1),this.$1=(g||(g=b("Promise"))).resolve(),this.$3=0,this.$2=a}var c=a.prototype;c.wait=function(){return this.$1};c.enqueueHandlers=function(a,b,c){var d=this;this.$3++;b=this.$1.then(function(){return a}).then(b,c);c=b.then();this.$1=h(b,this.$2)["finally"](function(){d.$3--});return c};c.enqueue=function(a){var b=this;this.$3++;a=this.$1.then(a);var c=a.then();this.$1=h(a,this.$2)["finally"](function(){b.$3--});return c};c.size=function(){return this.$3};return a}();c=function(){function a(a){a===void 0&&(a=-1),this.$1=new Map(),this.$2=a}var c=a.prototype;c.waitIfPending=function(a){return this.$1.get(a)};c.wait=function(a){return this.$1.get(a)||(g||(g=b("Promise"))).resolve()};c.enqueueHandlers=function(a,b,c,d){c=this.wait(a).then(function(){return b}).then(c,d);return this.$3(a,c)};c.enqueue=function(a,b){b=this.wait(a).then(b);return this.$3(a,b)};c.$3=function(a,b){var c=this,d=b.then(),e,f=function(){c.$1.get(a)===e&&c.$1["delete"](a)};e=h(b,this.$2).then(f,f);this.$1.set(a,e);return d};return a}();function h(a,c){if(c>=0)return new(g||(g=b("Promise")))(function(b){var d=function(){return void b()};a.then(d,d);setTimeout(d,c)});else return a.then(i,i)}function i(){}f.PromiseQueue=a;f.PromiseQueueMap=c}),66);
__d("WebMpsGetDistinctSupplementals",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=new Map(a),d=new Map();b.forEach(function(a,b){var e=c.get(b);if(e==null)c.set(b,a),d.set(b,a);else{e=e.timestampMs;var f=a.timestampMs;f>e&&(c.set(b,a),d.set(b,a))}});return{supplementals:c,supplementalsToWriteToReverb:d}}f.getDistinctSupplementals=a}),66);
__d("WebMpsGetDistinctMessages",["WebMpsGetDistinctSupplementals"],(function(a,b,c,d,e,f,g){"use strict";var h=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"],i=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function a(a,b){var c=new Map(),e=new Map();a.forEach(function(a){var b=a.reverbTopLevel;b.debugFlags;var d=b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b=babelHelpers.objectWithoutPropertiesLoose(b,h);e.set(a.reverbTopLevel.messageId,a);c.set(a.reverbTopLevel.messageId,{expiryTimestampMs:d,supplementalProtobufs:a.supplementalProtobufs,tags:a.tags,toplevelProtobuf:b})});var f=new Map(),g=new Map(),j=new Map();b.forEach(function(a){var b=a.supplementalProtobufs,h=a.tags,k=a.toplevelProtobuf,l=k.messageId,m=e.get(l);if(m==null||m.reverbTopLevel.isTransportErrorPlaceholder===!0)c.set(l,a),f.set(l,k),g.set(l,new Map(b)),j.set(l,h);else{a=m.supplementalProtobufs;k=d("WebMpsGetDistinctSupplementals").getDistinctSupplementals(a,b);h=k.supplementals;a=k.supplementalsToWriteToReverb;b=m.reverbTopLevel;b.debugFlags;k=b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b=babelHelpers.objectWithoutPropertiesLoose(b,i);c.set(l,{expiryTimestampMs:k,supplementalProtobufs:h,tags:m.tags,toplevelProtobuf:b});a.size>0&&g.set(l,new Map(a))}});return{messages:Array.from(c.values()),supplementalMessagesToWriteToReverb:g,tagsToWriteToReverb:j,topLevelMessagesToWriteToReverb:f}}g.getDistinctMessages=a}),98);
__d("WebMpsReverbWrites",[],(function(a,b,c,d,e,f){"use strict";function a(a,b,c,d,e,f,g){var h=[e,d,c];return g(async function(g){var i=await g.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",h);if(((i=i==null?void 0:i.timestampMs)!=null?i:0)>=f)return;i={messageId:a,payload:b,supplementalKey:c,threadId:e,timestampMs:f,topLevelMessageId:d};await g.stores.supplemental.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:i,selector:h}])})}function b(a,b,c){var d=a.messageId,e=a.threadId;return c(async function(c){var f,g=await c.stores.message.getByIndex("[threadId+messageId]",[e,d]);if(g!=null&&!g.isTransportErrorPlaceholder)return;if(g!=null&&g.isTransportErrorPlaceholder&&b.isTransportErrorPlaceholder)return;var h=await c.stores.deleted.getByIndex("[threadId+deletedMessageId]",[a.threadId,a.messageId]),i=babelHelpers.extends({},a,{debugFlags:b.debugFlags,expiryTimestampMs:b.expiryTimestampMs,isLocalOnlyMessage:b.isLocalOnly,isTransportErrorPlaceholder:b.isTransportErrorPlaceholder,timestampMs:(f=g==null?void 0:g.timestampMs)!=null?f:a.timestampMs});if(!h){f=await c.stores.message.bulkUpsert("[threadId+messageId]",[{item:i,selector:[e,d]}]);var j=f[0];f=await c.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[e,d]});f.length>0&&await c.stores.tags.bulkDelete(f.map(function(a){return a.pk}));b.tags.length>0&&await c.stores.tags.bulkAdd(b.tags.map(function(a){return{messageId:i.messageId,messagePk:j,tag:a,threadId:i.threadId,timestampMs:i.timestampMs}}))}else h.payload=i.payload,await c.stores.deleted.bulkPut([h]),g!=null&&(g.timestampMs=a.timestampMs,await c.stores.message.bulkPut([g]))})}f.upsertSupplementalToReverb=a;f.upsertTopLevelToReverb=b}),66);
__d("WebMpsPersistMessagesFromEb",["MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){if(a.length===0||a.every(function(a){return a.topLevelProtobufs.size===0&&a.supplementalProtobufs.size===0&&a.tags.size===0}))return;try{await d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(b){var c=a.map(function(a){var c=a.supplementalProtobufs,d=a.tags,e=a.threadId;a=a.topLevelProtobufs;return h(a,c,d,e,function(a){return a(b)})}).flat();return Promise.all(c)},"mps-persist-messages-from-eb")}catch(a){d("MpsLogger").MpsLogger().catching(a).mustfix("Runtime error performing persistMessagesFromEB");throw a}}function h(a,b,c,e,f){var g=[];a.forEach(function(a,b){g.push(d("WebMpsReverbWrites").upsertTopLevelToReverb(a,{actionType:d("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["EB"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:(a=c.get(b))!=null?a:[],targetMessageId:b},f))});b.forEach(function(a,b){a.forEach(function(a,c){g.push(d("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,c,b,e,a.timestampMs,f))})});return g}g.persistMessagesFromEB=a}),98);
__d("WebMpsBatchLoadMessage",["MpsLogger","WAGetSafeQPLError","WebMpsGetDistinctMessages","WebMpsPersistMessagesFromEb","WebReverbDB","err","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h=["pk","supplementalKey","threadId","topLevelMessageId"];async function i(a,b,e,f,g){try{g.metric.addPoint("load-message-from-reverb_start");var i=d("WebReverbDB").getWebReverbDB();i=await i.runInTransaction(["message","supplemental","tags"],"readonly",function(c){return Promise.all(b.map(function(b){var d=c.stores.message.readIndex("[threadId+messageId]",[a,b],{limit:1}),g=f?c.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[a,b]}):[],h=e?c.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[a,b]}):[];return Promise.all([b,d,h,g])}))},"mps-load-message");g.metric.addPoint("load-message-from-reverb_end");var j=new Map();i.forEach(function(a){var b=a[0],c=a[1];c=c[0];var d=a[2];a=a[3];if(c==null)return null;var e=new Map();d.forEach(function(a){a.pk;var b=a.supplementalKey;a.threadId;a.topLevelMessageId;a=babelHelpers.objectWithoutPropertiesLoose(a,h);e.set(b,a)});d=a.map(function(a){a=a.tag;return a});j.set(b,{reverbTopLevel:c,supplementalProtobufs:e,tags:d})});return j}catch(a){g.metric.addPoint("load-message-from-reverb_fail");d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("Runtime error performing loadMessageFromReverb");return new Map()}}async function j(a,b,e,f,g){try{var h=e.isEbEnabled(),i=h===!0?"true":h===!1?"false":"unset";g.metric.addAnnotations({string:{ebEnabled:i}});if(h!==!0)return new Map();g.metric.addPoint("load-message-from-eb_start");i=e.messagePointQuery;h=await i({ctx:g,messageIds:b,threadId:a});if(h.success===!1)return new Map();e=f(h.value,a);g.metric.addPoint("load-message-from-eb_end");return new Map(e.map(function(a){return[a.toplevelProtobuf.messageId,a]}))}catch(a){g.metric.addPoint("load-message-from-eb_fail");i=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(i).mustfix("Runtime error performing loadFromEB");return new Map()}}async function a(a,b,e,f,g){var h=e.decodeAndParseEbProtobufs,k=e.eb;e=f.persistToReverb;var l=f.shouldFetchSupplementals,m=f.shouldFetchTags;f=f.strategy;try{g.metric.addPoint("load-message_start");var n=function(){return i(a,b,l,m,g)},o=function(){return j(a,b,k,h,g)},p,q;switch(f){case"local-first":p=await n();var r=p.size===b.length;r?q=new Map():q=await o();break;case"full-fetch":r=await Promise.all([n(),o()]);p=r[0];q=r[1];break;case"local-only":p=await n();q=new Map();break;case"remote-only":p=new Map();q=await o();break;default:f;throw c("err")("empty strategy")}r=b.map(function(a){var b=p.get(a);a=q.get(a);return d("WebMpsGetDistinctMessages").getDistinctMessages([b].filter(Boolean),[a].filter(Boolean))});e==="persist"&&void d("WebMpsPersistMessagesFromEb").persistMessagesFromEB(r.map(function(b){var c=b.supplementalMessagesToWriteToReverb,d=b.tagsToWriteToReverb;b=b.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:c,tags:d,threadId:a,topLevelProtobufs:b}}));g.metric.addPoint("load-message_end");return r.map(function(a){return a.messages[0]})}catch(a){n=c("getErrorSafe")(a);g.metric.addPoint("load-message_fail",{string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(n)}});d("MpsLogger").MpsLogger().catching(n).mustfix("Runtime error performing loadMessage");throw n}}g.batchLoadMessage=a}),98);
__d("PackedMpsRange",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.packMpsRange=a}),66);
__d("WebMpsBatchLoadFromReverb",["MpsLogger","WebReverbDB","WebReverbSchema","WormRangeIterator","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h=["pk","supplementalKey","threadId","topLevelMessageId"];async function i(a,b,c,e,f,g,i,j,k){var l=c[0],m=c[1],n=j?function(a){return a.isLocalOnlyMessage===!1}:void 0,o="[threadId+timestampMs+messageId]";function p(){var c=a.stores.message.getIndexRangeIterator(o,e,{greaterThanOrEqual:[b],lessThanOrEqual:[b]},n),d=m==null?[b,l]:[b,l,m];return c.read(d,f)}async function q(c){var g="[threadId+tag+timestampMs]";c=await Promise.all(Array.from(c).map(function(c){return a.stores.tags.getIndexRangeIterator(g,e,{greaterThanOrEqual:[b],lessThanOrEqual:[b]}).read([b,c,l],f)}));c=d("WormRangeIterator").mergeRanges(c,g,d("WebReverbSchema").schema.tags,e,f);var h=await Promise.all(c.data.map(function(b){return a.stores.message.getByIndex("[threadId+messageId]",[b.threadId,b.messageId],{filter:n})})).then(function(a){return a.filter(Boolean)});c=d("WormRangeIterator").makeCursorInfoFromList(h,o,d("WebReverbSchema").schema.message,c.cursorInfo.hasNext,c.cursorInfo.hasPrevious);return{cursorInfo:c,data:h}}k!=="all"?c=await q(k):c=await p();j=c;q=j.cursorInfo;k=j.data;p=await Promise.all(k.map(async function(c){var d=g?await a.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[b,c.messageId]}):[],e=new Map();d.forEach(function(a){a.pk;var b=a.supplementalKey;a.threadId;a.topLevelMessageId;a=babelHelpers.objectWithoutPropertiesLoose(a,h);e.set(b,a)});d=i?await a.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[b,c.messageId]}):[];d=d.map(function(a){a=a.tag;return a});return{reverbTopLevel:c,supplementalProtobufs:e,tags:d}}));return{cursorInfo:{endCursor:q.endCursor!=null?[q.endCursor[1],q.endCursor[2]]:null,hasNext:q.hasNext,hasPrevious:q.hasPrevious,startCursor:q.startCursor!=null?[q.startCursor[1],q.startCursor[2]]:null},messages:p,threadId:b}}async function a(a,b,e,f,g,h){try{g.metric.addPoint("reverb_fetch_start");var j=d("WebReverbDB").getWebReverbDB();j=new Map(await j.runInTransaction(["message","supplemental","tags"],"readonly",function(c){return Promise.all(a.map(function(a){return i(c,a.threadId,a.from,a.direction,a.numMessages,b,e,f,h).then(function(b){return[a,b]})}))},"mps-load-messages"));g.metric.addPoint("reverb_fetch_end");return j}catch(a){j=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(j).mustfix("Runtime error performing WebMpsBatchLoadFromReverb");g.metric.addPoint("reverb_fetch_end",{bool:{reverbFail:!0}});return new Map()}}g.batchLoadMessagesFromReverb=a}),98);
__d("WebMpsLoadMessagesFromEb",["MpsLogger","WAGetSafeQPLError","WAPromiseDelays","WAResultOrError","getErrorSafe","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h={endCursor:null,hasNext:!1,hasPrevious:!1,startCursor:null};async function i(a,b,e,f,g){function h(){f.metric.addPoint("eb_fetch_timeout");throw d("MpsLogger").MpsLogger().mustfixThrow("Timed out waiting for EB Fetch")}var i=a.reduce(function(a,b){return a+b.numMessages},0);i=Math.min(Math.max((i-20)/180,0),1);i=c("justknobx")._("3429")*(1+i*2);b=await d("WAPromiseDelays").withTimeout(b.messageRangeQuery({ctx:f,ranges:a,tagsFilter:g}),i,h);g=b.map(function(b,c){c=a[c];c=c.threadId;if(b.success===!1)return b;b=b.value;var f=b.cursorInfo;b=b.messages;b=e(b,c);return d("WAResultOrError").makeResult({cursorInfo:f,messages:b,threadId:c})});f.metric.addPoint("eb_fetch_end");return g}async function a(a,b,e,f){var g=b.decodeAndParseEbProtobufs;b=b.eb;try{var j=b.isEbEnabled(),k=j===!0?"true":j===!1?"false":"unset";e.metric.addAnnotations({string:{ebEnabled:k}});if(j!==!0)return c("justknobx")._("1920")?new Map(a.map(function(a){return[a,d("WAResultOrError").makeResult({cursorInfo:h,messages:[],threadId:a.threadId})]})):new Map();k=!1;e.metric.addPoint("load-messages-from-eb_start");var l=await i(a,b,g,e,f);j=new Map(a.map(function(a,b){b=l[b];b.success===!1&&(k=!0);return[a,b]}));k&&e.metric.addAnnotations({bool:{ebFetchFailed:!0}});e.metric.addPoint("load-messages-from-eb_end");return j}catch(a){b=c("getErrorSafe")(a);e.metric.addPoint("load-messages-from-eb_fail",{string:{ebFetchFailReason:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}});d("MpsLogger").MpsLogger().catching(b).mustfix("Error fetching from EB");return new Map()}}g.loadMessagesFromEb=a}),98);
__d("WebMpsMergeMessageRangesFromDifferentSources",["WebMpsGetDistinctMessages","err","first","last"],(function(a,b,c,d,e,f,g){"use strict";var h=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function a(a,b,e,f,g){var i;i=d("WebMpsGetDistinctMessages").getDistinctMessages((i=b==null?void 0:b.messages)!=null?i:[],(i=a==null?void 0:a.messages)!=null?i:[]);var j=i.messages,k=i.supplementalMessagesToWriteToReverb,l=i.tagsToWriteToReverb;i=i.topLevelMessagesToWriteToReverb;if(b==null||a==null){var m=b!=null?babelHelpers["extends"]({},b,{messages:b.messages.map(function(a){var b=a.reverbTopLevel;a=a.supplementalProtobufs;b.debugFlags;var c=b.expiryTimestampMs;b.isLocalOnlyMessage;b.isTransportErrorPlaceholder;b.pk;b=babelHelpers.objectWithoutPropertiesLoose(b,h);return{expiryTimestampMs:c,supplementalProtobufs:a,tags:[],toplevelProtobuf:b}})}):a;if(m==null)throw c("err")("data-fetching-error");return{range:m,supplementalMessagesToWriteToReverb:k,tagsToWriteToReverb:l,topLevelMessagesToWriteToReverb:i}}m=a;a=[].concat(j).sort(function(a,b){return e==="asc"?a.toplevelProtobuf.timestampMs-b.toplevelProtobuf.timestampMs:b.toplevelProtobuf.timestampMs-a.toplevelProtobuf.timestampMs});j=a.slice(0,f);a=c("first")(j);f=c("last")(j);a=a!=null?[a.toplevelProtobuf.timestampMs,a.toplevelProtobuf.messageId]:void 0;f=f!=null?[f.toplevelProtobuf.timestampMs,f.toplevelProtobuf.messageId]:void 0;var n=f!=null?m.cursorInfo.hasNext||b.cursorInfo.hasNext:!1;m=a!=null?m.cursorInfo.hasPrevious||b.cursorInfo.hasPrevious:!1;return{range:{cursorInfo:{endCursor:f,hasNext:n,hasPrevious:m,startCursor:a},messages:j,threadId:g},supplementalMessagesToWriteToReverb:k,tagsToWriteToReverb:l,topLevelMessagesToWriteToReverb:i}}g.mergeMessageRangesFromDifferentSources=a}),98);
__d("WebMpsEbCache",["MpsTypes","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g){b=d("WAJids").validateChatJid(b);if(b==null)return[];a=a.getMetadataFromCache({chatJid:b,direction:c,numberOfMessages:e,referenceMessage:g,referenceTimestamp:f==null?null:d("WATimeUtils").castToMillisTime(f)});return a.success===!1?[]:a.value.map(function(a){var b=a.offlineThreadingId;a=a.sortOrderMs;return{offlineThreadingId:b,sortOrderMs:d("MpsTypes").toTimestamp(a)}})}function b(a,b){if(a==null)return"no-match";if(b.length===0)return"no-match";if(a.cursorInfo.hasNext!==!0)return"reverb-cursor-ended";var c=new Set(a.messages.map(function(a){return a.reverbTopLevel.messageId})),d=new Set(b.map(function(a){return a.offlineThreadingId}));if(c.size!==d.size)return"no-match";if(Array.from(c).every(function(a){return d.has(a)}))return"match";c=a.messages.map(function(a){return a.reverbTopLevel.timestampMs}).sort(function(a,b){return b-a});a=b.map(function(a){return a.sortOrderMs}).sort(function(a,b){return b-a});b=0;for(var e=0;e<c.length;e++){var f=c[e],g=a[b];if(f<g)return"no-match";if(f>g)continue;b++}return"reverb-newer"}g.loadEBMetadataCache=a;g.compareReverbVsMetadataCache=b}),98);
__d("WebMpsValidateReverbViaCacheAndFetchFromEb",["MpsLogger","WebMpsEbCache","WebMpsLoadMessagesFromEb"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e,f){var g=await b;if(f!=="all"){e.metric.addAnnotations({string:{ebMetadataCache:"skip"}});return{eb:await d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(a,c,e,f),reverb:g}}b=a.filter(function(a){var b=a.direction,f=a.from,h=a.numMessages,i=a.threadId;i=d("WebMpsEbCache").loadEBMetadataCache(c.eb,i,b,h,f[0],f[1]);h=d("WebMpsEbCache").compareReverbVsMetadataCache(g.get(a),i);e.metric.addAnnotations({string:{ebMetadataCache:h}});d("MpsLogger").MpsLogger().debug("MPS Range query metadata comparison: ",h);if(h==="match")return!1;return b==="desc"&&h==="reverb-newer"?!1:!0});return b.length===0?{eb:new Map(),reverb:g}:{eb:await d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(b,c,e,f),reverb:g}}g.validateReverbViaCacheAndFetchFromEb=a}),98);
__d("WebMpsBatchLoadMessages",["MpsLogger","PackedMpsRange","WAGetSafeQPLError","WebMpsBatchLoadFromReverb","WebMpsLoadMessagesFromEb","WebMpsMergeMessageRangesFromDifferentSources","WebMpsPersistMessagesFromEb","WebMpsValidateReverbViaCacheAndFetchFromEb","err","getErrorSafe","gkx"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,e,f){var g=e.persistToReverb,h=e.shouldFetchSupplementals,i=e.shouldFetchTags,j=e.shouldIgnoreLocalOnly,k=e.strategy,l=e.tagsFilter,m=a.map(function(a){return d("PackedMpsRange").packMpsRange(a)});try{f.metric.addPoint("mps_fetch_start");e=function(){return d("WebMpsBatchLoadFromReverb").batchLoadMessagesFromReverb(m,h,i,j,f,l)};var n,o;switch(k){case"full-fetch":if(c("gkx")("15592")===!0){a=await d("WebMpsValidateReverbViaCacheAndFetchFromEb").validateReverbViaCacheAndFetchFromEb(m,e(),b,f,l);n=a.reverb;o=a.eb}else{a=await Promise.all([e(),d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(m,b,f,l)]);n=a[0];o=a[1]}break;case"local-only":n=await e();o=new Map();break;case"remote-only":o=await d("WebMpsLoadMessagesFromEb").loadMessagesFromEb(m,b,f,l);n=new Map();break;default:k;throw c("err")("empty strategy")}a=m.map(function(a){var b=a.direction,c=a.numMessages,e=a.threadId,f=n.get(a);a=(a=o.get(a))==null?void 0:a.value;if(f==null&&a==null)return;a=d("WebMpsMergeMessageRangesFromDifferentSources").mergeMessageRangesFromDifferentSources(a,f,b,c,e);f=a.range;b=a.supplementalMessagesToWriteToReverb;c=a.tagsToWriteToReverb;a=a.topLevelMessagesToWriteToReverb;return{range:f,supplementalMessagesToWriteToReverb:b,tagsToWriteToReverb:c,threadId:e,topLevelMessagesToWriteToReverb:a}}).filter(Boolean);g==="persist"&&void d("WebMpsPersistMessagesFromEb").persistMessagesFromEB(a.map(function(a){var b=a.supplementalMessagesToWriteToReverb,c=a.tagsToWriteToReverb,d=a.threadId;a=a.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:b,tags:c,threadId:d,topLevelProtobufs:a}}));return a.map(function(a){a=a.range;return a})}catch(a){e=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(e).mustfix("Runtime error performing loadMessages");f.metric.addAnnotations({string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(e)}});throw e}}g.batchLoadMessages=a}),98);
__d("WebMpsInsertionFlow",["MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","err","justknobx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){if(c("justknobx")._("4336"))try{await d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",async function(b){for(var c of a)await i(c,function(a){return a(b)})},"mps-insertion-flow-shared");return new Map()}catch(a){d("MpsLogger").MpsLogger().catching(a).mustfix("Failed to persist messages")}return h(a)}async function h(a){var b=new Map(),c=async function(a){await i(a,function(a){return d("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(b){return a(b)},"mps-insertion-flow-separate")}).catch(function(c){b.set(a.message.messageId,c)})};for(a of a)await c(a);return b}function i(a,b){switch(a.directive.actionType){case d("MpsTypes").ActionType.UpsertTopLevel:return j(a,b);case d("MpsTypes").ActionType.UpsertSupplemental:return k(a,b);case d("MpsTypes").ActionType.DeleteTopLevel:return l(a,b);case d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return m(a,b);case d("MpsTypes").ActionType.DeleteSupplemental:return n(a,b);case d("MpsTypes").ActionType.DeleteThread:return o(a,b);case d("MpsTypes").ActionType.Noop:return Promise.resolve();case d("MpsTypes").ActionType.Unknown:case d("MpsTypes").ActionType.Preprocess:return Promise.reject(c("err")("this should not happen"))}}async function j(a,b){var c=a.directive;a=a.message;await d("WebMpsReverbWrites").upsertTopLevelToReverb(a,c,b)}async function k(a,b){var e=a.directive;a=a.message;var f=c("nullthrows")(e.supplementalKey);await d("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,f,e.targetMessageId,a.threadId,a.timestampMs,b)}function l(a,b){var c=a.message,d=a.directive.targetMessageId,e=[c.threadId,d];return b(async function(a){var b=await a.stores.message.getByIndex("[threadId+messageId]",e),f=await a.stores.deleted.getByIndex("[threadId+deletedMessageId]",e);if(((f=f==null?void 0:f.deletionTimestampMs)!=null?f:0)>=c.timestampMs)return;f={deletedMessageId:d,deletionMessageId:c.messageId,deletionMessagePayload:c.payload,deletionTimestampMs:c.timestampMs,isLocalOnlyMessage:!1,payload:b==null?void 0:b.payload,threadId:c.threadId,timestampMs:b==null?void 0:b.timestampMs};await a.stores.deleted.bulkUpsert("[threadId+deletedMessageId]",[{item:f,selector:e}]);b&&await a.stores.message.bulkDelete([b.pk])})}function m(a,b){var c=a.directive;a=a.message;return d("WebMpsReverbWrites").upsertTopLevelToReverb(a,c,b)}function n(a,b){var d=a.message,e=c("nullthrows")(a.directive.supplementalKey),f=a.directive.targetMessageId,g=[d.threadId,f,e];return b(async function(b){var c=await b.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",g);if(c==null)return;var h=await b.stores.deleted.getByIndex("[threadId+topLevelMessageId+supplementalKey]",g,{filter:function(a){return a.deletionTimestampMs>=d.timestampMs}});if(h)return;h={deletedMessageId:c.messageId,deletionMessageId:d.messageId,deletionMessagePayload:d.payload,deletionTimestampMs:d.timestampMs,isLocalOnlyMessage:a.directive.isLocalOnly,payload:c.payload,supplementalKey:e,threadId:d.threadId,timestampMs:c.timestampMs,topLevelMessageId:f};await b.stores.deleted.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:h,selector:g}]);await b.stores.supplemental.bulkDelete([c.pk])})}function o(a,b){var c=a.message;return b(async function(a){var b=await a.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[c.threadId]});await a.stores.supplemental.bulkDelete(b);b=await a.stores.message.readIndexRange("[threadId+messageId]",{only:[c.threadId]});await a.stores.message.bulkDelete(b.map(function(a){return a.pk}));var d=await a.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:[c.threadId]});await a.stores.tags.bulkDelete(d);d=await a.stores.deleted.readKeysByIndexRange("[threadId+deletedMessageId]",{only:[c.threadId]});await a.stores.deleted.bulkDelete(d);await a.stores.deleted.bulkAdd(b.map(function(a){return{deletedMessageId:a.messageId,deletionMessageId:c.messageId,deletionMessagePayload:c.payload,deletionTimestampMs:c.timestampMs,isLocalOnlyMessage:a.isLocalOnlyMessage,payload:a.payload,threadId:a.threadId,timestampMs:a.timestampMs}}))})}g.persistNewMessages=a}),98);
__d("MpsLogProcessorErrors",["MpsLogger","WAGetSafeQPLError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g){d("MpsLogger").MpsLogger().catching(a).mustfix(b+" %s failed for message %s (source %s)",c,e,f);g.metric.addAnnotations({string:(b={},b[c.toLowerCase()+"Error"]=d("WAGetSafeQPLError").getSafeQPLErrorMessage(a),b)})}g.logProcessorError=a}),98);
__d("WebMpsPostprocess",["MpsLogProcessorErrors","MpsLogger"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e){var f=a,g=new Map();a=async function(a){var b=await a.process(f,c);b.size>0&&(b.forEach(function(b,f){g.set(f,b),d("MpsLogProcessorErrors").logProcessorError(b,"Postprocessor",a.name,f,e,c)}),f=f.filter(function(a){return!b.has(a.message.messageId)}))};for(b of b)await a(b);return{errors:g,msgs:f}}async function b(a,b,c){await Promise.all(b.map(async function(b){b=await b.process(a,c).catch(function(a){d("MpsLogger").MpsLogger().catching(a).mustfix("PostProcessor Runtime failure")});b!=null&&b.size>0&&b.forEach(function(a){d("MpsLogger").MpsLogger().catching(a).mustfix("PostProcessor fails")})}))}g.runCriticalPostprocessor=a;g.runNonCriticalPostprocessor=b}),98);
__d("WebMpsPreprocess",["MpsLogProcessorErrors"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e){var f=a,g=new Map();a=async function(a){var b=a.process!=null?a.process(f,c):await a.processAsync(f,c);f=b.payload;b.errors.forEach(function(b,f){g.set(f,b),d("MpsLogProcessorErrors").logProcessorError(b,"Preprocessor",a.name,f,e,c)})};for(b of b)await a(b);return{errors:g,msgs:f}}g.preprocess=a}),98);
__d("WebMpsPurgeDeletions",["DateConsts","MpsTypes","QPLUserFlow","WebReverbDB","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=30*d("DateConsts").MS_PER_DAY;function a(){var a=c("qpl")._(521474688,"2714"),b={instanceKey:Date.now()};c("QPLUserFlow").start(a,b);try{return d("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(e){var f=d("MpsTypes").toTimestamp(Date.now()-h);f=await e.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[f]});var g=f.map(function(a){return[a.threadId,a.deletedMessageId]});c("QPLUserFlow").addAnnotations(a,{int:{num_deletions:f.length}},b);var i=Promise.all(g.map(function(a){return e.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:a})})).then(function(a){return a.flat()}).then(function(a){return e.stores.supplemental.bulkDelete(a)});g=Promise.all(g.map(function(a){return e.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:a})})).then(function(a){return a.flat()}).then(function(a){return e.stores.tags.bulkDelete(a)});f=e.stores.deleted.bulkDelete(f.map(function(a){return a.pk}));await Promise.all([i,g,f]);c("QPLUserFlow").endSuccess(a,b)},"web-mps-purge-deletions")}catch(d){c("QPLUserFlow").endFailure(a,d,b);throw d}}g.purgeDeletions=a}),98);
__d("WebMpsPurgeExpiredMessages",["MpsTypes","QPLUserFlow","WebReverbDB","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=c("qpl")._(521484777,"2715"),b={instanceKey:Date.now()};c("QPLUserFlow").start(a,b);try{return d("WebReverbDB").getWebReverbDB().runInTransaction(["message","deleted"],"readwrite",async function(e){var f=d("MpsTypes").toTimestamp(Date.now()),g=await e.stores.message.readIndexRange("expiryTimestampMs",{lessThanOrEqual:[f]});c("QPLUserFlow").addAnnotations(a,{int:{num_expired_messages:g.length}},b);var h=await Promise.all(g.map(async function(a){var b=a.messageId;if(b!=null){a=await e.stores.deleted.getByIndex("[threadId+deletedMessageId]",[a.threadId,b]);return a==null?void 0:a.pk}return null})).then(function(a){return a.filter(Boolean)});await e.stores.deleted.bulkDelete(h);h=g.map(function(a){return{deletedMessageId:a.messageId,deletionMessageId:a.messageId,deletionMessagePayload:a.payload,deletionTimestampMs:f,isLocalOnlyMessage:!0,payload:a.payload,threadId:a.threadId,timestampMs:a.timestampMs}});await e.stores.deleted.bulkAdd(h);await e.stores.message.bulkDelete(g.map(function(a){return a.pk}));c("QPLUserFlow").endSuccess(a,b)},"web-mps-purge-deletions")}catch(d){c("QPLUserFlow").endFailure(a,d,b);throw d}}g.purgeExpiredMessages=a}),98);
__d("WebMpsScheduler",["WorkerScheduler","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){if(h==null){var a;h=d("WorkerScheduler").makeScheduler("MPS",{concurrency:(a=c("justknobx"))._("4338"),defaultSamplingRate:a._("4540"),maxConcurrency:a._("4338"),maxThrottleMs:a._("4339"),timeToStuckMs:a._("4337")})}return h}g.mpsScheduler=a}),98);
__d("memoizeWithArgsLFUCache",["LFUCache"],(function(a,b,c,d,e,f,g){function a(a,b,d,e){var f;function g(){f||(f=new(c("LFUCache"))(d));return f}function h(){f=null}e&&e(h);e=function(){var c=g(),d=b.apply(void 0,arguments);c.has(d)||c.set(d,a.apply(void 0,arguments));var e=c.get(d);return e};return e}g["default"]=a}),98);
__d("mergeMaps",[],(function(a,b,c,d,e,f){"use strict";function a(){var a=new Map();for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];for(var e=0;e<c.length;e++){var f=c[e].keys(),g;while(!(g=f.next()).done)a.set(g.value,c[e].get(g.value))}return a}f["default"]=a}),66);
__d("schedulePeriodicTask",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=async function(){try{await a()}finally{globalThis.setTimeout(c,b)}};globalThis.setTimeout(c,0)}f.schedulePeriodicTask=a}),66);
__d("WebMps",["DateConsts","MpsLogger","MpsReverbDbDump","MpsTypes","WAPromiseQueue","WAResultOrError","WATimeUtils","WAWaitForUserUnblocked","WebMpsBatchLoadMessage","WebMpsBatchLoadMessages","WebMpsInsertionFlow","WebMpsPostprocess","WebMpsPreprocess","WebMpsPurgeDeletions","WebMpsPurgeExpiredMessages","WebMpsScheduler","WebReverbDB","WorkerScheduler","err","getErrorSafe","justknobx","memoizeWithArgsLFUCache","mergeMaps","nullthrows","schedulePeriodicTask"],(function(a,b,c,d,e,f,g){"use strict";var h=["debug"],i=["debug"],j;async function a(a){var b=a.db,e=a.dependencies;a=a.extensionConfiguration;if(j!=null)throw c("err")("MPS already initialised");await d("WebReverbDB").makeWebReverb(b.name,b.strEncKey,b.blockingErrorThreshold,b.onBlockingError,b.qplEvent);b=new k(a,e);j=b;return b}var k=function(){function a(a,b){var e=this;this.$2=[];this.$4=new(d("WAPromiseQueue").PromiseQueue)();this.batchLoadMessage=function(a){var b=a.config,f=a.debug,g=a.messageIds,h=a.threadId;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4538"),fn:function(a){var c;return d("WebMpsBatchLoadMessage").batchLoadMessage(h,g,e.$1,{persistToReverb:(c=b==null?void 0:b.persistToReverb)!=null?c:"persist",shouldFetchSupplementals:(c=b==null?void 0:b.shouldFetchSupplementals)!=null?c:!0,shouldFetchTags:(c=b==null?void 0:b.shouldFetchTags)!=null?c:!0,strategy:(c=b==null?void 0:b.strategy)!=null?c:"full-fetch"},a)},name:"batch-load-message",priority:d("WorkerScheduler").BLOCKING_PRIORITY}).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.$7=c("memoizeWithArgsLFUCache")(function(a){var b=a.config,f=a.debug,g=a.messageId,h=a.threadId;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4536"),fn:function(a){var c;return d("WebMpsBatchLoadMessage").batchLoadMessage(h,[g],e.$1,{persistToReverb:(c=b==null?void 0:b.persistToReverb)!=null?c:"persist",shouldFetchSupplementals:(c=b==null?void 0:b.shouldFetchSupplementals)!=null?c:!0,shouldFetchTags:(c=b==null?void 0:b.shouldFetchTags)!=null?c:!0,strategy:(c=b==null?void 0:b.strategy)!=null?c:"full-fetch"},a).then(function(a){a.length>1&&d("MpsLogger").MpsLogger().mustfix("loadMessage returned more than one message");return a.at(0)})},name:"load-message",priority:d("WorkerScheduler").BLOCKING_PRIORITY})},function(a){a.debug;a=babelHelpers.objectWithoutPropertiesLoose(a,h);return JSON.stringify(babelHelpers.extends({},a,{ebEnabled:e.$1.eb.isEbEnabled()}))},1,function(a){e.$2.push(a)});this.loadMessage=function(a){return e.$7(a).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){e.$5();a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.$8=function(a){var b=a.config,f=a.debug,g=a.ranges;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4538"),fn:function(a){var c;return d("WebMpsBatchLoadMessages").batchLoadMessages(g.map(function(a){var b=a.direction,c=a.from,e=a.numMessages;a=a.threadId;return{direction:b,from:[d("MpsTypes").toTimestamp(d("WATimeUtils").miAdjustTimestamp(c[0])),c[1]],numMessages:e,threadId:a}}),e.$1,{persistToReverb:(c=b==null?void 0:b.persistToReverb)!=null?c:"persist",shouldFetchSupplementals:(c=b==null?void 0:b.shouldFetchSupplementals)!=null?c:!0,shouldFetchTags:(c=b==null?void 0:b.shouldFetchTags)!=null?c:!0,shouldIgnoreLocalOnly:(c=b==null?void 0:b.shouldIgnoreLocalOnly)!=null?c:!1,strategy:(c=b==null?void 0:b.strategy)!=null?c:"full-fetch",tagsFilter:(c=b==null?void 0:b.tagsFilter)!=null?c:"all"},a)},name:"thread-range-query",priority:d("WorkerScheduler").BLOCKING_PRIORITY})};this.batchLoadMessages=function(a){return e.$8(a).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.$9=c("memoizeWithArgsLFUCache")(function(a){var b=a.config,f=a.debug,g=a.direction,h=a.from,i=a.numMessages,j=a.threadId;return d("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:f.purpose,strategy:(a=b==null?void 0:b.strategy)!=null?a:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4538"),fn:function(a){var f;return d("WebMpsBatchLoadMessages").batchLoadMessages([{direction:g,from:[d("MpsTypes").toTimestamp(d("WATimeUtils").miAdjustTimestamp(h[0])),h[1]],numMessages:i,threadId:j}],e.$1,{persistToReverb:(f=b==null?void 0:b.persistToReverb)!=null?f:"persist",shouldFetchSupplementals:(f=b==null?void 0:b.shouldFetchSupplementals)!=null?f:!0,shouldFetchTags:(f=b==null?void 0:b.shouldFetchTags)!=null?f:!0,shouldIgnoreLocalOnly:(f=b==null?void 0:b.shouldIgnoreLocalOnly)!=null?f:!1,strategy:(f=b==null?void 0:b.strategy)!=null?f:"full-fetch",tagsFilter:(f=b==null?void 0:b.tagsFilter)!=null?f:"all"},a).then(function(a){a.length>1&&d("MpsLogger").MpsLogger().mustfix("loadMessages returned more than one range");a=a.at(0);if(a==null)throw c("err")("loadMessages returned no result. Likely this is the result of both reverb and EB queries failing");return a})},name:"load-messages",priority:d("WorkerScheduler").BLOCKING_PRIORITY})},function(a){a.debug;a=babelHelpers.objectWithoutPropertiesLoose(a,i);return JSON.stringify(babelHelpers.extends({},a,{ebEnabled:e.$1.eb.isEbEnabled()}))},10/60,function(a){e.$2.push(a)});this.loadMessages=function(a){return e.$9(a).then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){e.$5();a=c("getErrorSafe")(a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)})};this.extensionConfiguration=a;this.$1=b;this.$3()}var b=a.prototype;b.saveNewMessages=function(a,b){var e=this,f=d("WebMpsScheduler").mpsScheduler().task({annotations:{string:{source:b.source}},customFlags:{runtimeReliability:!0},eventSamplingRate:c("justknobx")._("4535"),fn:async function(f){e.$5();f.metric.addPoint("preprocess_start");var g=await d("WebMpsPreprocess").preprocess(a,e.extensionConfiguration.preprocessors,f,b.source),h=g.errors;g=g.msgs;f.metric.addPoint("preprocess_end");g=g.map(function(a){return babelHelpers.extends({},a,{directive:c("nullthrows")(a.directive,"Preprocessed messages must have a directive")})});f.metric.addPoint("persist_start");var i=await d("WebMpsInsertionFlow").persistNewMessages(g);f.metric.addPoint("persist_end");f.metric.addPoint("postprocess_start");g=await e.$6(g,f,b.source);f.metric.addPoint("postprocess_end");return c("mergeMaps")(h,i,g)},name:"save-new-messages",priority:d("WorkerScheduler").BLOCKING_PRIORITY});return this.$4.enqueue(function(){return f.run()})};b.$6=async function(a,b,e){var f,g;try{a=await d("WebMpsPostprocess").runCriticalPostprocessor(a,this.extensionConfiguration.postProcessors.critical,b,e);f=a.errors;g=a.msgs}catch(a){e=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(e).mustfix("Message postprocessor failed with runtime error");throw e}d("WebMpsPostprocess").runNonCriticalPostprocessor(g,this.extensionConfiguration.postProcessors.nonCritical,b).catch(function(a){a=c("getErrorSafe")(a);d("MpsLogger").MpsLogger().catching(a).mustfix("Non-critical postprocessor failed with runtime error")});return f};b.purgeDeletions=async function(){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked(),await d("WebMpsScheduler").mpsScheduler().runTask({fn:d("WebMpsPurgeDeletions").purgeDeletions,name:"purge-deletions",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running purgeDeletions")}};b.purgeExpiredMessages=async function(){try{await d("WAWaitForUserUnblocked").waitForUserUnblocked(),await d("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:c("justknobx")._("4539"),fn:d("WebMpsPurgeExpiredMessages").purgeExpiredMessages,name:"purge-expired-messages",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})}catch(a){d("MpsLogger").MpsLogger().catching(c("getErrorSafe")(a)).mustfix("failed running purgeExpiredMessages")}};b.debugDbDump=function(){return d("MpsReverbDbDump").debugGetReverbDbDump()};b.$5=function(){this.$2.forEach(function(a){return a()})};b.$3=function(){var a=this;d("schedulePeriodicTask").schedulePeriodicTask(function(){return a.purgeDeletions()},d("DateConsts").MS_PER_MIN*20);d("schedulePeriodicTask").schedulePeriodicTask(function(){return a.purgeExpiredMessages()},d("DateConsts").MS_PER_MIN*10)};return a}();function b(){if(j==null)throw c("err")("MPS not initialised");return j}function e(){j=void 0}g.makeMps=a;g.mps=b;g.resetMps_TEST_ONLY=e}),98);
__d("MAWBridgeEventTransmitter",["EBAPI","EBLogger","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWJobDefinitions","MAWUploadThreadTxns","MpsTypes","WAJids","WALogger","WATimeUtils","WebMps"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,e,f){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Issuing point query for message: ",""])),a);if(c("EBAPI").isEBEnabled()===!1)return;void d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"full-fetch"},debug:{purpose:"issuePointQueryOutsideTxn"},messageId:d("MpsTypes").toMessageId(a),threadId:d("MpsTypes").toThreadId(f)}).then(function(a){a=a.value;if(a==null)return;void d("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:f,decryptedMessagesProtobufs:[d("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage(a)],hasMoreAfter:!1,hasMoreBefore:!1,isPointQuery:!0,taskSource:(i||(i=d("LSIntEnum"))).ofNumber(e!=null?e:c("LSMEBTaskCreationSource").UNKNOWN),threadId:b}}]})["catch"](function(a){return d("EBLogger").EBLogger().tags(["eventTransmitter","mps"]).catching(a).warn("failure while executing UI update")})})}function b(a,b){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:d("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(d("WAJids").threadIdForChatJid(a.jid),d("MAWUploadThreadTxns").getFolderTypeAsText(a.folder),"AdvancedCrypto",b!=null?b:d("WATimeUtils").castToMillisTime(1),null,2)})}function e(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:d("MAWBridgeTrace").createBridgeStartTraceData(a,b,c)}]})}function f(a,b,c){d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:a,folder:b,threadJid:c})}]})}g.issuePointQueryOutsideTxn=a;g.deleteMessagesOfThreadAfterTxn=b;g.startTraceOutsideTxn=e;g.updateThreadOutsideTxn=f}),98);
__d("MAWQuotedMsgUtils",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.content.type==="NoteReply"?a.content.msgContent==null?a:babelHelpers["extends"]({},a,{content:babelHelpers["extends"]({},a.content,{msgContent:void 0})}):a}function a(a){return a.content.expirationTs==null||a.content.expirationTs>d("WATimeUtils").unixTime()?a:h(a)}g.dbQuotedMsgWithoutExpirableContent=h;g.dbQuotedMsgWithoutExpiredContent=a}),98);
__d("MAWGetMsgQuoteTxn",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWQuotedMsgUtils","MAWTransactionMode","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a){return a==null||a===d("WAJids").AUTHOR_SYSTEM?null:d("WAJids").authorAsUserJid(a)};function i(a,b,e,f){var g=b.quote;b=(g==null?void 0:g.content)||{};var i=b.author;b=b.externalId;if(i==null)return d("MAWDexieTable").dexieResolve(null);i=d("WAJids").isAuthorMe(i)?d("WAJids").AUTHOR_ME:h(i);if(g==null||i==null||b==null)return d("MAWDexieTable").dexieResolve(null);var j={author:i,chat:e,externalId:b};if(g.content.type==="NoteReply")return d("MAWDexieTable").dexieResolve({quote:d("MAWQuotedMsgUtils").dbQuotedMsgWithoutExpiredContent(g),quoteExternalId:g.content.externalId});var k=f!=null&&f==="ebrestore"?c("LSMEBTaskCreationSource").EB_POINT_QUERY_RESTORE_PROTOBUF:c("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT;return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,j).then(function(b){d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(j.externalId,d("WAJids").threadIdForChatJid(j.chat),k,j.chat);if(b==null||!d("MAWMsgType").isQuotedMsgType(b.type))return{quote:g,quoteExternalId:g.content.externalId};d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b,null,!0)});var a=b.author,c=b.externalId,e=b.mediaId,f=b.msgContent,h=b.msgId,i=b.plaintextHash,l=b.specialTextSize,m=b.ts,n=b.type,o=b.xmaMessageType;a={author:a,externalId:c,mediaId:e,msgContent:f,msgId:h,plaintextHash:i,specialTextSize:l,ts:m,type:n,xmaMessageType:o};b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(a=babelHelpers["extends"]({},a,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL}));return{quote:babelHelpers["extends"]({},g,{content:a}),quoteExternalId:b.externalId}})}function a(a,b,c){return i(a,b,c).then(function(a){return babelHelpers["extends"]({},b,{quote:a==null?void 0:a.quote,quoteExpirationTs:a==null?void 0:a.quote.content.expirationTs,quoteExternalId:a==null?void 0:a.quoteExternalId})})}function j(a,b){return a.messages.where("quoteExternalId").anyOf(b).toArray()}b=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return j.apply(void 0,[a].concat(c))}});g.getMsgQuoteInfo=i;g.enhanceMsgWithQuoteInfo=a;g.maybeBatchGetMsgsByQuoteExternalId=j;g.maybeBatchGetMsgsByQuoteExternalIdWithTransaction=b}),98);
__d("MAWThreadEventConst",[],(function(a,b,c,d,e,f){"use strict";a="placeholderConvertSubscription";f.PLACEHOLDER_CONVERT_SUBSCRIPTION=a}),66);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e,f,g,h){var i=d("MAWAuthor").getAuthorUserJid(e);return a.messages.where("quoteExternalId").equals(c).toArray().then(function(c){if(c.length===0)return;var e=c;(h==null||!h)&&(e=c.filter(function(a){var c=a.quote;a=a.threadJid;return d("MAWAuthor").getAuthorUserJid(c==null?void 0:c.content.author)===i&&a===b}));var j=e.map(function(a){var b;b=Object.assign({},(b=a.quote)==null?void 0:b.content,f.content);b=babelHelpers["extends"]({},a.quote,f,{content:b});b.content.msgId==null&&g!=null&&(b.content.msgId=g);return babelHelpers["extends"]({},a,{quote:b})});return a.messages.bulkPut(j).then(function(){return j})})},i=function(a,b,c,e,f){f===void 0&&(f=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);f={content:{mediaId:void 0,msgContent:void 0,type:f}};return h(a,b,c,e,f).then(function(a){if(a==null)return;a.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})})})};b=function(a,b,c){c===void 0&&(c=d("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=b.author,f=b.chat,g=b.externalId;return a.threads.get({jid:f}).then(function(b){if(b==null)return;return i(a,b.jid,g,e,c)})};var j=function(a,b,c,e){var f=c.author,g=c.externalId,i=c.mediaId,j=c.msgContent,k=c.msgId,l=c.plaintextHash,m=c.ts,n=c.type;if(d("WAJids").isAuthorSystem(f))return d("MAWDexieTable").dexieResolve();var o={author:f,chat:b,externalId:g};if(!d("MAWMsgType").isQuotedMsgType(n))return d("MAWDexieTable").dexieResolve();var p=d("MAWDexieTable").dexieResolve(null);c.type===d("MAWMsgType").MSG_TYPE.XMA&&(p=d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,o).then(function(a){return a.success===!1?d("MAWDexieTable").dexieResolve(null):d("MAWDexieTable").dexieResolve(a.value)}));return p.then(function(c){var d,o,p,q;d={author:f,externalId:g,mediaId:(d=c==null||(o=c.defaultPreview)==null?void 0:o.mediaId)!=null?d:i,msgContent:j,plaintextHash:(d=c==null||(p=c.defaultPreview)==null?void 0:p.plaintextHash)!=null?d:l,ts:m,type:n,xmaMessageType:c==null||(q=c.xma)==null?void 0:q.targetType};return h(a,b,g,f,{content:d},k,e)})};function a(a,b,c){return d("MAWDexieTable").dexieAll([j(a,c,b),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)]).then(function(c){var e=c[0];c=c[1];if(e!=null)return d("MAWDexieTable").dexieResolve(k(b,c)).then(function(){d("MAWDexieTable").dexieAll(e.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b).then(function(a){k(b,a);return b})}))});else return d("MAWDexieTable").dexieResolve([])})}function k(a,b){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,b)})}g.disassociateQuotedMsg=i;g.disassociateQuotedMessageByProtocolMsgId=b;g.associateQuotedMessage=j;g.associateAllReplies=a;g.issueReplyMsgUpdate=k}),98);
__d("MAWCreateE2EEMetadataThreadFromThreadActivityUpdate",["FBLogger","MAWAuthoritativeThreadsCache","MAWDbThreadTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=b.bumpTimestampMs,e=b.chatJid;b=b.source;var f=h(b);return d("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.has(e)||f==="invalid_source"?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,e).then(function(a){var b;a=a.value;if((a==null?void 0:a.authoritativeThreadKey)!=null){d("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.add(a.jid);return}d("MAWIndexedDb").afterTransaction({tag:"CreateE2EEMetadataThreadV2",value:{bumpTimestampMs:c,creationSource:f,folderId:(b=a==null?void 0:a.folder)!=null?b:d("MAWFolderTypes").INBOX,jid:e,optimisticThreadKey:a==null?void 0:a.optimisticThreadKey}})})}function h(a){switch(a){case"outgoing_msg":return"outgoing_message";case"incoming_msg":return"incoming_message";case"inserted_admin_msg":case"eb_restore":case"deleted_msg":return"invalid_source";default:a;throw c("FBLogger")("messenger_web").mustfixThrow("Unknown thread update source")}}g.maybeCallCreateE2EEMetadataThreadHandler=a}),98);
__d("MAWThreadLatestTimestampCache",["I64","MAWGetBumpTimestampMs"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.isLatestTs=function(a,b){a=this.$1.get(a);b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);return a==null||(h||(h=d("I64"))).ge(b,a)};b.isNewerThanLatestTs=function(a,b){a=this.$1.get(a);b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);return a==null||(h||(h=d("I64"))).gt(b,a)};b.monotonicIncrease=function(a,b){b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);var c=this.$1.get(a);(c==null||(h||(h=d("I64"))).gt(b,c))&&this.$1.set(a,b)};b.get=function(a){return this.$1.get(a)};b.set=function(a,b){b=d("MAWGetBumpTimestampMs").getBumpTimestampMs(b);this.$1.set(a,b)};b.clear=function(){this.$1.clear()};return a}();b=new a();g.ThreadLatestTimestampCache=a;g.ThreadLastActivityTsCache=b}),98);
__d("MAWUpdateThreadActivity",["FBLogger","MAWCreateE2EEMetadataThreadFromThreadActivityUpdate","MAWDexieTable","MAWGetBumpTimestampMs","MAWGetThreadUpdateType","MAWIndexedDb","MAWMpsGating","MAWThreadLatestTimestampCache","MAWThreadNewestMsgOrReactionUtils","MAWTransactionMode","MAWUpdateThreadListItemUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({threads:(a=d("MAWTransactionMode")).READONLY},"updateThreadActivityFromInsertion",function(a){return function(b,c,d){return h(a,b,c,d)}});function h(a,b,e,f){d("MAWMpsGating").isMpsThreadsConsistencyEnabled()&&c("FBLogger")("wmi").mustfix("Thread consistency uses MAW DB mechanism instead of new one");if(!j(e,b,f))return d("MAWDexieTable").dexieResolve();d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.monotonicIncrease(e,b);var g={bumpTimestampMs:d("MAWGetBumpTimestampMs").getBumpTimestampMs(b),chatJid:e,source:f};return d("MAWCreateE2EEMetadataThreadFromThreadActivityUpdate").maybeCallCreateE2EEMetadataThreadHandler(a,g).then(function(){return d("MAWIndexedDb").afterTransaction({tag:"UpdateThreadActivity",value:{bumpTimestampMs:g.bumpTimestampMs,chatJid:e,source:g.source}})})}e=d("MAWIndexedDb").makeMsgrTransactor({messages:a.READONLY,reactions:a.READONLY,threads:a.READONLY},"updateThreadActivityFromDeletion",function(a){return function(b,c){return i(a,b,c)}});function i(a,b,e){if(!j(e,b,"deleted_msg"))return d("MAWDexieTable").dexieResolve();d("MAWMpsGating").isMpsThreadsConsistencyEnabled()&&c("FBLogger")("wmi").mustfix("Thread consistency uses MAW DB mechanism instead of new one");return d("MAWThreadNewestMsgOrReactionUtils").getNewestMsgOrReactionForBump(a,e).then(function(a){if(a==null)return;d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.set(e,a);d("MAWIndexedDb").afterTransaction({tag:"UpdateThreadActivity",value:{bumpTimestampMs:d("MAWGetBumpTimestampMs").getBumpTimestampMs(a),chatJid:e,source:"deleted_msg"}})})}function j(a,b,e){if(!d("MAWGetThreadUpdateType").isThreadUpdateTypeEligibleForBump(b)||d("MAWUpdateThreadListItemUtils").isSpamMessage(b)||d("MAWUpdateThreadListItemUtils").isOptimisticMessage(b))return!1;switch(e){case"outgoing_msg":return!0;case"incoming_msg":return d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.isNewerThanLatestTs(a,b)&&(b.author!==d("WAJids").AUTHOR_ME||d("MAWUpdateThreadListItemUtils").isRTCXMAMessage(b));case"eb_restore":return!1;case"inserted_admin_msg":return!1;case"deleted_msg":return d("MAWThreadLatestTimestampCache").ThreadLastActivityTsCache.isLatestTs(a,b);default:e;throw c("FBLogger")("messenger_web").mustfixThrow("Unknown thread update source")}}g.updateThreadActivityFromInsertion=b;g.updateThreadActivityFromInsertionTxn=h;g.updateThreadActivityFromDeletion=e;g.updateThreadActivityFromDeletionTxn=i}),98);
__d("MAWUseProtocolMsgIdForMsgId",[],(function(a,b,c,d,e,f){"use strict";function a(){return!0}f.shouldUseProtocolMsgIdForMsgId=a}),66);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.deliveredWatermarkTs,c=a.threadJid,e=a.type;a=a.userJid;return babelHelpers["extends"]({deliveredWatermarkTs:b||d("WATimeUtils").castToUnixTime(0),fbid:d("WAJids").extractUserId(a)},d("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(e),{lastReadActionTs:d("WATimeUtils").castToUnixTime(0),readWatermarkTs:d("WATimeUtils").castToUnixTime(0),threadJid:c})}function a(a){return{participants:a.map(function(a){return h(a)})}}g.createBridgeParticipant=h;g.createBridgeParticipants=a}),98);
__d("MAWDbParticipantTxns",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWUserJidWrapper","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a,b,c,d){d===void 0&&(d=!0);return n(a,c.map(function(a){return babelHelpers["extends"]({},a,{chatJid:b})}),d)}function l(a,b){d("WAJids").switchOnMsgrChatJidType(a.threadJid,{group:c("emptyFunction"),user:function(c){a.userJid!==c&&a.userJid!==d("MAWUserJidWrapper").getMyUserJid()&&d("MWFBLogger").MWLogger().tags(["db","txn"]).mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",b)}})}function m(a){var b=a.addressable,c=a.chatJid,e=a.type;a=a.userJid;return{addressable:b,deliveredWatermarkTs:d("WATimeUtils").castToUnixTime(0),id:d("MAWDbParticipant").craftParticipantId(c,a),lastReadWatermarkTs:d("WATimeUtils").castToUnixTime(0),threadJid:c,type:e!=null?e:"participant",userJid:a}}function n(a,b,c){c===void 0&&(c=!0);if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var e=b.map(function(a){return m(a)});e.forEach(function(a){return l(a,"bulkAddParticipantsInThreads")});return a.participants.bulkPut(e).then(function(){c&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(e)});return e})}function o(a,b,c,e){e===void 0&&(e=!0);var f=new Set([b,d("MAWUserJidWrapper").getMyUserJid()]);b=c.filter(function(a){a=a.userJid;return!f.has(a)}).map(function(a){var b=a.threadJid;a=a.userJid;return[b,a]});b.length>0&&d("MAWODSProxy").odsBumpEntityKey({amount:1,entity:d("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:d("MAWCurrentUser").isEmployee()?"employee":"public"});return q(a,b,e)}function p(a,b,c,e){e===void 0&&(e=!0);var f=Array.from(new Set([b,d("MAWUserJidWrapper").getMyUserJid()])),g=new Set(c.map(function(a){return a.userJid})),h=f.filter(function(a){return!g.has(a)});h=h.map(function(a){return{type:"participant",userJid:a}});return k(a,b,h,e).then(function(a){var b=f.reduce(function(b,d){var e=a.find(function(a){return a.userJid===d}),f=c.find(function(a){return a.userJid===d});e!=null&&f==null?b.push(e):f!=null&&b.push(f);return b},[]);return b})}function a(a,b,c){c===void 0&&(c=!0);return u(a,b).then(function(d){return o(a,b,d,c).then(function(e){return p(a,b,d,c)})})}function b(a,b){b.forEach(function(a){return l(a,"bulkUpdateParticipants")});return a.participants.bulkPut(b).then(function(){b.length>0&&d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(b)});return b})}function e(a,b,c){if(c.length===0)return d("MAWDexieTable").dexieResolve();c=c.map(function(a){return[b,a]});return q(a,c)}function f(a,b,c){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=b.map(function(a){return[a,c]});return q(a,b)}function q(a,b,c){c===void 0&&(c=!0);return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(b){return a.participants.bulkDelete(b.map(function(a){return a.id})).then(function(){c&&b.forEach(function(a){var b=a.threadJid;a=a.userJid;return d("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:b,userId:d("WAJids").extractUserId(a)}})})})})}function r(a,b){return a.participants.where("threadJid").equals(b)["delete"]()}function s(a,b,c,d,e){return t(a,[{deliveredWatermarkTs:c,lastReadActionTs:e,lastReadWatermarkTs:d,participantKey:b}]).then(function(a){return a[0]})}function t(a,b,c){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var e=new Map(),f=[];b.forEach(function(a){f.push(a.participantKey),e.set(JSON.stringify(a.participantKey),a)});return a.participants.where(["threadJid","userJid"]).anyOf(f).toArray().then(function(b){b.length!==f.length&&(c!=null&&c.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing participants "," vs ",""])),b.length,f.length));var g=[],k=[];b.forEach(function(a){var b=e.get(JSON.stringify([a.threadJid,a.userJid]));if(b==null){c!=null&&c.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing tsData for participant ",", ",""])),a.threadJid,a.userJid);return}var d=b.deliveredWatermarkTs,f=b.lastReadActionTs;b=b.lastReadWatermarkTs;var h=a.deliveredWatermarkTs,l=a.lastReadWatermarkTs,m=a.lastReadActionTs,n=d>h,o=b>l,p=m==null||f>m;c!=null&&c.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: participant ",", "," deliveredWatermarkTs: ",", lastReadWatermarkTs: ",", lastReadActionTs: ",""])),a.threadJid,a.userJid,d,b,f);if(!n&&!o&&!p){k.push(a);return}g.push(babelHelpers["extends"]({},a,{deliveredWatermarkTs:n?d:h,lastReadActionTs:p?f:m,lastReadWatermarkTs:o?b:l}))});g.forEach(function(a){return l(a,"bulkUpdateParticipantTimestamps")});return a.participants.bulkPut(g).then(function(){g.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:d("MAWBridgeTypesCreators").createBridgeReceivedReceipt(a.threadJid,d("WAJids").extractUserId(a.userJid),a.deliveredWatermarkTs)})});return[].concat(g,k)})})}function u(a,b){return a.participants.where("threadJid").equals(b).toArray()}function v(a,b){return a.participants.where("threadJid").anyOf(b).toArray()}function w(a,b){return u(a,b).then(function(a){return a.filter(function(a){return a.type==="invitedParticipant"})})}function x(a,b,c){return a.participants.where(["threadJid","userJid"]).equals([b,c]).first().then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function y(a,b){return a.participants.where(["threadJid","userJid"]).anyOf(b).toArray().then(function(a){var c=new Map(a.map(function(a){return[JSON.stringify([a.threadJid,a.userJid]),a]}));return b.map(function(a){return c.get(JSON.stringify(a))})})}g.bulkAddParticipants=k;g.logIfIllegalParticipant=l;g.bulkAddParticipantsInThreads=n;g.deleteIncorrectParticipantsInOneToOneThread=o;g.addMissingParticipantsInOneToOneThread=p;g.bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread=a;g.bulkUpdateParticipants=b;g.bulkDeleteParticipantsInThread=e;g.bulkDeleteParticipantAcrossThreads=f;g.bulkDeleteParticipants=q;g.deleteAllParticipantsForThread=r;g.updateParticipantTimestamps=s;g.bulkUpdateParticipantTimestamps=t;g.getParticipantsInThread=u;g.getParticipantsInThreads=v;g.getInvitedParticipantsInThread=w;g.getParticipant=x;g.bulkGetParticipants=y}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWDbMsg").getCanonicalTsFromMsg(b),e=b.author;return e!=="@me"&&e!=="@system"?d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[b.threadJid,e],c,c,c):d("MAWDexieTable").dexieResolve()}g.updateParticipantTimestampsForMsg=a}),98);
__d("MAWWriteMsgTxns",["FBLogger","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBuildIncomingMsgs","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEphemeralMsgTxns","MAWExpiredQuoteCleaner","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWGetThreadUpdateTypeForAdminMsg","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWLocalizationType","MAWLocalizationUtils","MAWMessageSortOrderUtils","MAWMpsGating","MAWMsgType","MAWThreadEventConst","MAWThreadUpdateType","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWUpdateThreadActivity","MAWUseProtocolMsgIdForMsgId","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","ODS","WAJids","WALogger","WATimeUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";var h=["rowId"],i,j,k;function l(a,b,e,f){var g=e.ts;g=[d("WATimeUtils").castUnixTimeToMillisTime(g),e.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN];var h=g[0],i=g[1];return d("MAWGetOrCreateThreadTxns").getExistingThread(a,b.jid).then(function(b){if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");var g=d("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(a,b.jid),j=d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,b.jid);return d("MAWDexieTable").dexieAll([g,j]).then(function(a){var c,g,j,k=a[0];a=a[1];var l=d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?null:a==null?1:d("MAWDbMsg").getInChatMsgIdFromMsgId(a.msgId)+1;c=d("WATimeUtils").castToMillisTime((c=a==null?void 0:a.sortOrderMs)!=null?c:0);c=h>c&&!i?h:c;g=(g=d("MAWTimeUtils").ensureValidMillisTime(b.lastReadMsgTs))!=null?g:0;j=d("WATimeUtils").castToMillisTime((j=a==null?void 0:a.sortOrderMs)!=null?j:0);g=g<j;j=e.author===d("WAJids").AUTHOR_ME||e.type===d("MAWMsgType").MSG_TYPE.ADMIN&&d("MAWLocalizationUtils").isParticipantChangeAdminMsg(e.msgContent.adminType)&&!g;g=babelHelpers["extends"]({},e,{msgId:l!=null?d("MAWDbMsg").craftMsgIdV2(b.chatId,l,e):d("MAWJidUtils").formatProtocolMsgIdFromMsg(e)});l=d("MAWDbMsgTxns").calculateOldestMsg(k,a,g,f);a=l.oldestMsg;return{isOldestMsgUpdated:k!=null&&a!==k.msgId,msgId:g.msgId,prevOldestMsg:k,updatedSnippet:void 0,updatedThread:babelHelpers["extends"]({},b,{lastReadMsg:j?g.msgId:b.lastReadMsg,lastReadMsgTs:j?c:b.lastReadMsgTs,newestMsgTs:c,oldestMsg:a,snippetMsg:b.snippetMsg,snippetMsgTs:b.snippetMsgTs,threadOrder:d("MAWDbThread").craftThreadOrder(c,b.jid)})}})})}function a(a,b,c,e){return a.messages.where(["threadJid","sortOrderMs"]).equals([c.jid,e]).filter(function(a){return a.type!==d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&a.type!==d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:a.type===b.type&&a.msgContent.adminType===b.msgContent.adminType}).first().then(function(d){return d!=null?d:n(a,b,c)})}function b(a,b,c,e){return a.messages.where(["threadJid","sortOrderMs"]).equals([c.jid,e]).filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&a.msgContent.adminType===b.msgContent.adminType}).first().then(function(e){if(e!=null){(k||(k=d("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",b.msgContent.adminType);return e}return n(a,b,c)})}function e(a,b,c){return a.messages.where("threadJid").equals(c.jid).filter(function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN&&(a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED||a.msgContent.adminType===d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT)}).first().then(function(e){if(e!=null){(k||(k=d("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",b.msgContent.adminType);return e}return n(a,b,c)})}function m(a,b){return a.messages.add(b).then(function(a){return babelHelpers["extends"]({},b,{rowId:a})})}function n(a,b,c,e){e===void 0&&(e={});e=e;var f=e.isFirstMsg,g=f===void 0?!1:f;f=e.isOutgoing;var h=f===void 0?!1:f,j=e.openMessageOtid,k=e.openMessageParticipantCount,n=e.optimisticMsg,o=e.participantCount,p=e.quotedReplyAttachmentMeta;f=e.shouldUpdateUi;var q=f===void 0?!0:f;f=e.sortOrderMs;return l(a,c,b,f).then(function(c){c.isOldestMsgUpdated;var e=c.msgId;c.prevOldestMsg;var f=c.updatedThread;c=babelHelpers["extends"]({},b,{msgId:e,sortOrderMs:d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(b)});return d("MAWDexieTable").dexieAll([m(a,c),a.threads.put(f),d("MAWFTSTxns").maybePutMessageToBacklog(a,c.externalId)]).then(function(b){var c=b[0];b[1];h&&d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""])),c.sortOrderMs);q&&d("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:c,isFirstMsg:g,openMessageOtid:j,openMessageParticipantCount:k,optimisticMsg:n,participantCount:o,quotedReplyAttachmentMeta:p,updatedThread:f});b=c.type===d("MAWMsgType").MSG_TYPE.ADMIN&&!d("MAWMpsGating").isMpsThreadsConsistencyEnabled()?d("MAWUpdateThreadActivity").updateThreadActivityFromInsertionTxn(a,c,c.threadJid,u(c)):d("MAWDexieTable").dexieResolve();return b.then(function(){return c})})})}function o(a,b,e){return d("MAWGetOrCreateThreadTxns").getExistingThread(a,e.jid).then(function(f){if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");return(d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?d("MAWDexieTable").dexieResolve(null):d("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(a,f)).then(function(c){var g=babelHelpers["extends"]({},b,{msgId:c!=null?d("MAWDbMsg").craftUnrenderedMsgId(f.chatId,c):d("MAWJidUtils").formatProtocolMsgIdFromExternalId(e.jid,b.externalId)});return d("MAWDexieTable").dexieAll([a.unrenderedMessages.add(g),a.threads.put(f)]).then(function(a){var b=a[0];a[1];return babelHelpers["extends"]({},g,{rowId:b})})})})}function f(a,b,c){return d("MAWDexieTable").dexieAll([p(a,b,c),d("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(a,[[b.externalId,c.jid]]).then(function(a){return{editMsgHistories:a,originalEditMsgHistory:a.find(function(a){return a.editExternalId===b.externalId})}})]).then(function(a){var b=a[0];a=a[1];var c=a.editMsgHistories;a=a.originalEditMsgHistory;return babelHelpers["extends"]({},b,{editMsgHistories:c,existingEditMsgHistory:a!=null?a:null})})}function p(a,b,c){c=[b.externalId,c.jid,b.author];var e=c[0],f=c[1];c=c[2];return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,e,c,f),d("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(a,e,c,f),d("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(a,f).then(function(a){return d("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(b.ts,a)})]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3];a=a[4];return{existingMsg:b!=null?b:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:e,pendingDeleteForMeStanza:d!=null?d:null,pendingRevokedStanza:c!=null?c:null}})}function q(a,b,c,e,f){e===void 0&&(e=!0);return d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,b.externalId,b.author,c.jid).then(function(g){if(g!=null)return t(a,b,c,g,!0);g=b.author;d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""])),b.type,g,c.jid);var h=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{threadJid:c.jid}));c.folder===d("MAWFolderTypes").FOLDER_ID.OTHER&&(h.altIndex=h.altIndex===d("MAWDbMsg").FUTUREPROOF_ALT_INDEX?d("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:d("MAWDbMsg").SPAM_ALT_INDEX);return d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,h,c.jid,f).then(function(b){b!=null&&(h=babelHelpers["extends"]({},h,{quote:b==null?void 0:b.quote,quoteExpirationTs:b==null?void 0:b.quote.content.expirationTs,quoteExternalId:b==null?void 0:b.quoteExternalId}));b=h.quoteExpirationTs;b!=null&&b>d("WATimeUtils").unixTime()&&d("MAWExpiredQuoteCleaner").addNewExpiredQuoteCleanerTimestamp(b);return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,c.jid,h),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,h),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,h)]).then(function(b){var f=b[0],g=b[1],i=b[2];return n(a,h,c,{quotedReplyAttachmentMeta:g,shouldUpdateUi:e}).then(function(b){return d("MAWDexieTable").dexieAll([d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,h),d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,b,e)]).then(function(a){a=a[1];f!=null&&(e&&f.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,i)})}));return a||b})})})})})}function r(a,b,c,e,f,g){var i=babelHelpers["extends"]({},babelHelpers["extends"]({},b,{msgId:c.msgId,protocolMsgId:c.protocolMsgId,rowId:c.rowId,serverTs:c.serverTs,sortOrderMs:c.sortOrderMs,threadJid:e.jid,ts:c.ts}));return d("MAWDexieTable").dexieAll([d("MAWUpdateQuotedMsgTxns").associateQuotedMessage(a,e.jid,i),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,i),d("MAWLoadReplyMediaTxns").getReplyMediaForMsg(a,i),d("MAWGetMsgQuoteTxn").getMsgQuoteInfo(a,i,e.jid,g),d("MAWDbMsgTxns").getThreadNewestMessageId(a,e.jid)]).then(function(g){var j=g[0],k=g[1],l=g[2],m=g[3],n=g[4];i=babelHelpers["extends"]({},i,{quote:m==null?void 0:m.quote,quoteExternalId:m==null?void 0:m.quoteExternalId});return((g=c.editCount)!=null?g:0)>0&&f!=null&&b.type===d("MAWMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(a,f,b).then(function(){return c}):a.messages.put(i).then(function(){return d("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(a,i)}).then(function(b){if(b){i.altIndex=d("MAWDbMsg").craftToBeReadAltIndex(e.chatId);return a.messages.put(i)}}).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(i,l)});d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(i,k)});d("MAWIndexedDb").afterTransactionThreadEvent({chatJid:e.jid,msgId:i.msgId},d("MAWThreadEventConst").PLACEHOLDER_CONVERT_SUBSCRIPTION);j!=null&&j.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a,l)})});if(i.msgId===n){var b=i;b.rowId;b=babelHelpers.objectWithoutPropertiesLoose(b,h);d("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(a,b)}return i})})}function s(a,b,c,e){var f=d("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(b,c);return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:f.author,chatJid:f.threadJid,externalId:f.externalId}]),o(a,f,c),a.pendingStanzas["delete"](e.rowId),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(a){a[0];a=a[1];d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(f.messageDeleteForMeTs);return babelHelpers["extends"]({},f,{msgId:a.msgId,rowId:a.rowId})})}function t(a,b,e,f,g){g===void 0;g=d("MAWDbPendingStanzaTxns").getRevokedContent(f);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("missing revoked content");b=d("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(b,e,g);return d("MAWDexieTable").dexieAll([n(a,b,e),a.pendingStanzas["delete"](f.rowId)]).then(function(b){var c=b[0];return d("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(a,c,e).then(function(){return c})})}function u(a){if(c("qex")._("1849")!==!0)return"inserted_admin_msg";a=d("MAWGetThreadUpdateTypeForAdminMsg").getThreadUpdateTypeForAdminMsg((a=a.msgContent)==null?void 0:a.adminType)===d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD;return a?"incoming_msg":"outgoing_msg"}g.writeDedupedEphemeralSettingAdminMessage=a;g.writeDedupedAdminMessage=b;g.writeDedupedUsersConnectedAdminMessage=e;g.writeMsg=n;g.writeUnrenderedMsg=o;g.prepareTextMsgWriteData=f;g.prepareMsgWriteData=p;g.writeNewIncomingMsg=q;g.writeCiphertextUpdate=r;g.handleDeleteForMeMessage=s;g.handleOutOfOrderRevokedMessage=t}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});f.DbDeletedMsgReasonEnum=a}),66);
__d("MAWMediaManagerDeferred",["promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("MAWMediaManager").__setRef("MAWMediaManagerDeferred");function a(a){c("promiseDone")(h.load().then(function(b){b.getMawMediaManager().dequeueDownload(a)}))}g.dequeueDownload=a}),98);
__d("MAWUnsendMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function b(a){if(j==null){var b="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startUnsendMsgContentCleaner=a;g.addNewUnsendMsgContentCleanerTimestamp=b;g.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=e;g.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWWriteDeleteMessageTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMediaManagerDeferred","MAWMpsGating","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWUpdateThreadActivity","MAWXMAUtils","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b){var c=b.protocolMsgId,e=c.author;b=c.chat;var f=c.externalId;return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b),a.unrenderedMessages.get({externalId:f}),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,f)]).then(function(b){var g=b[0];b=b[1];if(!g.success)return d("WAResultOrError").makeError("missing_thread");return b!=null&&b.threadJid===g.value.jid&&b.author===e?d("WAResultOrError").makeError("duplicate_delete_for_me"):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c).then(function(b){if(b==null){var h={ack:d("MAWAckLevel").ACK.received,author:e,externalId:f,threadJid:g.value.jid,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i);h={deleteTs:k,externalIdWithType:f+"_"+d("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:h,type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return a.pendingStanzas.add(h).then(function(){d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);return d("WAResultOrError").makeResult()})}return d("MAWDexieTable").dexieResolve(j(a,b,e,c.chat,g.value)).then(function(){return d("WAResultOrError").makeResult()})})})}function j(a,b,e,f,g){var i,j=d("MAWDexieTable").dexieResolve();d("MAWXMAUtils").isXMAStoryReply((i=b.quote)==null?void 0:i.content.xmaMessageType)&&(j=k(a,b));var m={ack:b.ack,author:e,externalId:b.externalId,mediaId:b.mediaId,messageDeleteForMeTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h),msgContent:(i=d("MAWDbMsg").getMsgContent(b))==null?void 0:i.content,msgId:b.msgId,quote:b.quote,reportingMeta:b.reportingMeta,serverTs:void 0,threadJid:f,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:b.xmaMessageType};i=d("MAWDexieTable").dexieAll([l(a,b.author,b.externalId,b.threadJid),d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId),j]).then(function(){if(d("MAWDbMsg").isMediaMsg(b)){var e=b.mediaId,f=b.plaintextHash;e!=null&&(f!=null?(d("MAWMediaManagerDeferred").dequeueDownload(f),d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,plaintextHash:f,threadJid:b.threadJid}})):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:b.msgId,threadJid:b.threadJid}}))}return d("MAWDexieTable").dexieAll([d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,g),d("MAWMpsGating").isMpsThreadsConsistencyEnabled()?d("MAWDexieTable").dexieResolve():d("MAWUpdateThreadActivity").updateThreadActivityFromDeletionTxn(a,b,b.threadJid)]).then(c("emptyFunction"))});return i.then(function(){return d("MAWDexieTable").dexieAll([a.unrenderedMessages.add(m),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:e,chatJid:b.threadJid,externalId:b.externalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,b.threadJid,b.externalId,b.author,d("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return d("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(a,g.jid,b.msgId,b.sortOrderMs).then(function(){d("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(m.messageDeleteForMeTs);return d("WAResultOrError").makeResult()})})})}function k(a,b){return d("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(a,b.msgId).then(function(b){return d("MAWDbMsgTxns").maybeGetMsg(a,b==null?void 0:b.msgId).then(function(b){if(b!=null)return d("MAWDbMsgTxns").deleteDbMsg(a,b.rowId)})})}function l(a,b,c,e){return a.messages.where("quoteExternalId").equals(c).filter(function(a){var c;return a.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE&&((c=a.quote)==null?void 0:c.content.author)===b&&a.threadJid===e}).toArray().then(function(b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);var c=b.map(function(a){return a.rowId});return d("MAWDbMsgTxns").bulkDeleteDbMsg(a,c).then(function(){return b})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.handleDeleteForMe=a;g.deleteXMAStoryReplyMsg=k;g.deleteBumpMsgs=l}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbProtocolMsgIdMiddleware","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=6*d("WATimeUtils").HOUR_SECONDS,i=30*d("WATimeUtils").DAY_SECONDS;function a(a,b,e,f,g,h){if(h!=null&&f==null){h=babelHelpers["extends"]({},b,{originalTs:d("WATimeUtils").castMilliSecondsToUnixTime(h),threadJid:e.jid,unsendMsgContentDeleteTs:(h=b.serverTs)!=null?h:b.ts});return d("MAWWriteMsgTxns").writeMsg(a,h,e).then(function(a){return a.type==="Revoked"?a:null})}var k=d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+i),m=b.author,n=b.externalId,o=b.revokedExternalId,p=g!=null?l(a,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f==null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,b.revokedExternalId,e.jid,b.author):d("MAWDexieTable").dexieResolve(f),d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,n)]).then(function(g){var h=g[0];(f==null||h!=null)&&c("FBLogger")("messenger_web").warn("Revoked message missing originalMsg incorrectly");if(h==null){g={deleteTs:k,externalIdWithType:o+"_"+d("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:m,externalId:n,revokedExternalId:o,threadJid:e.jid,ts:b.ts,type:"Revoked"},type:d("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return d("MAWDexieTable").dexieAll([a.pendingStanzas.add(g),p]).then(function(b){b[0];b=b[1];d("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(k);d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(o,d("WAJids").threadIdForChatJid(e.jid),c("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,e.jid);b===!0&&d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e)})}return p.then(function(){return j(a,h,e,b.externalId,b.revokedExternalId,b.serverTs,b.ts,!1)})})}function j(a,b,c,e,f,g,i,j){var l=babelHelpers["extends"]({},b,{altIndex:void 0,externalId:e,msgContent:d("MAWDbMsg").getMsgContent(b),originalTs:(e=b.serverTs)!=null?e:b.ts,revokedExternalId:f,serverTs:g,threadJid:c.jid,ts:i,type:"Revoked",unsendMsgContentDeleteTs:d("WATimeUtils").castToUnixTime(d("WATimeUtils").unixTime()+h)});d("MAWDbProtocolMsgIdMiddleware").appendProtocolMsgId(l);return j?d("MAWDexieTable").dexieResolve(l):k(a,b,l,c).then(function(){return l})}function k(a,b,c,e){var f,g=d("MAWXMAUtils").isXMAStoryReply((f=b.quote)==null?void 0:f.content.xmaMessageType)?d("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(a,b):d("MAWDexieTable").dexieResolve();f=d("MAWJidUtils").toProtocolMsgId(b);var h=f!=null?a.deletedMessages.add(babelHelpers["extends"]({},f,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWWriteDeleteMessageTxns").deleteBumpMsgs(a,b.author,b.externalId,b.threadJid).then(function(){return d("MAWDexieTable").dexieAll([a.messages.put(c),d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:c.author,chatJid:c.threadJid,externalId:c.revokedExternalId}]),d("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(a,c.threadJid,c.revokedExternalId,c.author,d("MAWMsgType").MSG_TYPE.REVOKED),g,h,d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,b.externalId)]).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(c)});if(b!=null&&d("MAWDbMsg").isMediaMsg(b)){var f=b.mediaId,g=b.plaintextHash;f!=null&&(g!=null?(d("MAWMediaManagerDeferred").dequeueDownload(g),d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:f,msgId:b.msgId,plaintextHash:g,threadJid:b.threadJid}})):d("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:f,msgId:b.msgId,threadJid:b.threadJid}}))}d("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(b);return d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e)})})}function b(a,b,e){if(b.type!==d("MAWMsgType").MSG_TYPE.REVOKED)throw c("FBLogger")("messenger_web").mustfixThrow("Cant mark unrevoked message revoked");var f=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.revokedExternalId),g=f!=null?a.deletedMessages.add(babelHelpers["extends"]({},f,{reason:d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):d("MAWDexieTable").dexieResolve();return d("MAWWriteDeleteMessageTxns").deleteBumpMsgs(a,b.author,b.revokedExternalId,b.threadJid).then(function(c){c.length>0&&d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,c)});return d("MAWDexieTable").dexieAll([d("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(a,[{author:b.author,chatJid:b.threadJid,externalId:b.revokedExternalId}]),d("MAWThreadSnippetBuildTxns").refreshThreadSnippet(a,e),g]).then(function(){d("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(b.unsendMsgContentDeleteTs),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(b)})})})}function l(a,b){return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?a.messages["delete"](b.rowId).then(function(){d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])});return!0}):d("MAWDexieTable").dexieResolve(!1)}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=h;g.writeIncomingRevokeMsg=a;g.revokeUnstoredMsg=j;g.markExistingMsgRevoked=k;g.markIncomingMessageRevoked=b}),98);
__d("MAWCastToMsgrServerMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a,b){b===void 0&&(b=!1);if(b&&a==="image")return"xma";switch(a){case"image":case"video":case"gif":case"sticker":return a;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";case"preview":return"preview";default:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"])),a);return null}}function b(a,b){b===void 0&&(b=!1);if(b&&a===d("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(a){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"file";case"Ptt":return"audio";default:d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"])),a);return null}}function c(a){switch(a){case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return"image";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return"video";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return"gif";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER:return"sticker";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return"file";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return"audio";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA:return"xma";case d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW:return"preview";default:d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["invalid attachment mediaType: "," for castMediaAttachmentTypeToServerMediaType method"])),a);return null}}g.castToMsgrServerMediaType=a;g.castClientMediaTypeToServerMediaType=b;g.castMediaAttachmentTypeToServerMediaType=c}),98);
__d("WADbDeviceRegistration",["gkx"],(function(a,b,c,d,e,f,g){"use strict";a=25;b=6;d=b;e="https://reg-e2ee.facebook.com";f=c("gkx")("13108")?"https://reg-e2ee.messenger.com":e;c="https://v.whatsapp.net";var h="https://reg-e2ee.instagram.com",i="/v2/fb_icdc_fetch",j="/v2/fb_register_v2",k="Device has already been registered to WA servers",l="Device registration finished successfully",m="Device registration retries failed "+b+" times. No longer attempting registration.",n="Device registration response was null",o="Current user id is zero",p="CryptoAuthToken is empty",q="CryptoAuthToken is expired",r={failed:"failed",finished:"finished"};g.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=a;g.MAX_DEVICE_REGISTRATION_RETRIES=b;g.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=d;g.REG_FB_DOMAIN=e;g.REG_MSGR_DOMAIN=f;g.REG_WA_DOMAIN=c;g.REG_IGD_DOMAIN=h;g.ICDC_ENDPOINT=i;g.REGISTRATION_ENDPOINT=j;g.DEVICE_ALREADY_REGISTERED=k;g.DEVICE_SUCCESSFULLY_REGISTERED=l;g.FAILED_REGISTRATION_RETRIES=m;g.NULL_RESPONSE_FROM_SERVER=n;g.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=o;g.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=p;g.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=q;g.RegistrationStatesEnum=r}),98);
__d("WorkerUtils",[],(function(a,b,c,d,e,f){"use strict";function b(){try{return"WorkerGlobalScope"in a&&a instanceof a.WorkerGlobalScope}catch(a){return!1}}function c(){try{return"SharedWorkerGlobalScope"in a&&a instanceof a.SharedWorkerGlobalScope}catch(a){return!1}}f.isWorkerContext=b;f.isSharedWorkerContext=c}),66);
__d("getOrchestratorVersion",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("263"))!=null?a:"default"}g["default"]=a}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1;a={S508658PreventOldSessionLookupAndPromote:function(){return c("gkx")("12674")},armadilloWebProcessFutureproof:function(){return c("MAWGK").armadillo_web_process_futureproof},getSignalFutureMessagesMax:function(){return c("justknobx")._("847")},icdcAlertTriggerFailureCounter:function(){return c("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return c("justknobx")._("1971")},icdcIntervalInMinutes:function(){return c("justknobx")._("1972")},isDocumentReceiveEnabled:function(){return!c("gkx")("23924")},isFrankingDropOnInvalid:function(){return c("gkx")("23973")},isFrankingDropOnMissing:function(){return c("gkx")("23974")},isICDCErrorEnabled:function(){return c("gkx")("23975")},isMetaAiInvocationMessageRenderEnabled:function(){return c("gkx")("12661")},isPollsEnabled:function(){return c("qex")._("3169")===!0},isProgressiveJpegSendEnabled:function(){return c("justknobx")._("2412")},isSharedWorkerContext:function(){return(h||(h=d("WorkerUtils"))).isSharedWorkerContext()},isStickerEnabled:function(){return!0},isStickerReceiverFetchEnabled:function(){return c("justknobx")._("3677")},jpegThumbnailTargetByteSizeKB:function(){return c("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return d("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},offlineQueueStuckTimeoutMs:function(){return c("justknobx")._("3264")},orchestratorVersion:function(){return c("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return c("justknobx")._("67")},sessionDropIfTooOld:function(){return c("justknobx")._("2240")},skipProcessingGroupInvite:function(){return c("justknobx")._("3899")},waDanglingQueue:function(){return!0}};b={productTypeForEBAttachments:"msgr",shouldFallbackToPreviewForFailedProgressiveJpeg:function(){return c("gkx")("2909")},supportedTypesVersion:function(){return c("MAWGK").armadillo_web_process_futureproof?i+1:i},supportedXMATargetTypes:function(){return d("MAWParseXMAFBConfig").FB_FULLY_SUPPORTED_TARGET_TYPES}};g.waConfig=a;g.mawConfig=b}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWMainWebWorkerConfig").mawConfig;function a(){return h}function b(a){h=a}g.getConfig=a;g.setConfig=b}),98);
__d("MAWJobsIndexedDb",["FBLogger","MAWCurrentUser","MAWErrorObject","MAWIndexedDbMetadata","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","emptyFunction","promiseDone","qex","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null,k=null,l="jobs";function m(){return c("qex")._("940")}function n(){if(j==null)throw c("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return j}function o(){if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return k.then(function(){return n()})}function a(){return j!=null}var p=[function(a){a=a.target.result;a=a.createObjectStore(l,{autoIncrement:!0,keyPath:"jobId"});a.createIndex("uniqKey","uniqKey")},c("emptyFunction"),c("emptyFunction")];function e(a){k=null;j=null;return q(a).then(function(){return j.version})}function q(a){if(k!=null)return k;if(j!=null)return(i||(i=b("Promise"))).resolve();var e=d("MAWCurrentUser").getID(),f=d("MAWIndexedDbMetadata").jobsDbName(e),g=(e=a!=null?a:m())!=null?e:p.length,l=c("qpl")._(25310776,"6155");k=new(i||(i=b("Promise")))(function(a,b){var c=indexedDB.open(f,g);c.onupgradeneeded=function(a){for(var b=0;b<p.length;b++){var c=p[b],d=b+1;r(a,d)&&c(a)}};c.onsuccess=function(b){var c=b.target.result;c.onversionchange=function(){var a;d("MAWQplProxy").sendQplPointThroughBridge(l,"database_jobs_db_versionchange");d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."])));c.close();(a=d("WAWorkerGlobalScope").workerGlobalScope.location)==null||a.reload==null||a.reload()};j=c;d("MAWQplProxy").sendQplPointThroughBridge(l,"database_jobs_db_ready");a()};c.onerror=function(){d("MAWQplProxy").sendQplPointThroughBridge(l,"database_jobs_db_failed"),b(c.error)}});return k}function r(a,b){var c=a.newVersion;a=a.oldVersion;return a<b&&c>=b}function s(a){return a===d("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function f(a,b,e,f){var g=s(b);return function(b){return function(){for(var h=arguments.length,i=new Array(h),l=0;l<h;l++)i[l]=arguments[l];var m=f!=null?d("MAWQplProxy").startQplUserFlow(f):null,n=function(f){return o().then(function(c){var e=function(b){b=c.transaction(a,b!=null?s(b):g,{durability:"relaxed"});d("WAExceededStorageQuota").listenToQuotaExceededError(b);return b.objectStore(a)};return b.apply(void 0,[e].concat(i))}).then(function(a){m==null||m.endSuccess();return a})["catch"](function(b){m==null||m.endFail("job_transaction_fail");b=d("MAWErrorObject").getErrorObject(b);if((b==null?void 0:b.name)==="InvalidStateError"&&f===1){k=null;j=null;c("promiseDone")(q());return n(f-1)}if(b instanceof Error)throw c("FBLogger")("maw_db").catching(b).mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",e,a);throw c("FBLogger")("maw_db").mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",e,a)})};return n(1)}}}g.getJobsDbVersion=m;g.getJobDB=n;g.isJobDBInitted=a;g.dbMigrations=p;g.makeJobsDbIgnoringPreviousCreations=e;g.makeJobsDb=q;g.makeJobsTransactor=f}),98);
__d("MAWMediaBackupTxns",["FBLogger","MAWDbMediaTxns","MAWDexieTable","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=1;function m(a,b,e,f,g,n){n===void 0&&(n=0);return f==null?d("MAWDexieTable").dexieResolve():d("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(a,f).then(function(o){if(o==null){var p={mediaId:b,msgId:e,objectId:f};g!=null&&(p=babelHelpers["extends"]({},p,{fbid:g}));return a.mediaBackup.add(p).then(function(a){return babelHelpers["extends"]({},p,{mediaBackupId:a})})["catch"](function(j){if(j.name==="ConstraintError"){if(n<l){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""])),j);return m(a,b,e,f,g,n+1)}throw c("FBLogger")("messenger_web").mustfixThrow("Failed to add mediaBackup entry. Original error: %s, %s",j.name,j.message)}d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""])),j);throw j})}else if(o.mediaId!==b||o.msgId!==e){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"])));return o}else{if(o.fbid==null&&g!=null){var q=babelHelpers["extends"]({},o,{fbid:g});return a.mediaBackup.put(q).then(function(a){return q})}else d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"])));return o}})}g.linkMediaBackup=m}),98);
__d("MAWUnsafeCoerce",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.unsafeCoerce=a}),66);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=b("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),i=":";function a(a,b){return""+a+i+b}function c(a){return a.split(i)[1]}function j(a,b){b=b.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");b=new RegExp("^"+b,"i");return b.test(a)}function e(a){return j(a,h.REACTION)}function f(a){return j(a,h.EDIT)}function k(a){return j(a,h.RAVEN_ACTION_MESSAGE)}function l(a){var b=a.split(i);if(b.length===1)return{rawIdentifierString:a,type:"poll_update"};var c=b[0];if(b.length<2||b.length>3)return{prefix:c,rawIdentifierString:a,type:"unknown"};var e=b[1];e=d("MAWJids").toUserJid(e);if(c===h.REACTION)return{senderJid:e,type:"reaction"};b=b.length===3?d("WATimeUtils").castToMillisTime(Number(b[2])):null;if(c===h.RAVEN_ACTION_MESSAGE)return{senderJid:e,type:"raven_action_message"};if(b==null)return{prefix:c,rawIdentifierString:a,type:"unknown"};return c===h.EDIT?{senderJid:e,ts:b,type:"edit"}:{prefix:c,rawIdentifierString:a,type:"unknown"}}function m(a){switch(a.type){case"edit":return""+h.EDIT+i+d("WAJids").extractUserId(a.senderJid)+i+a.ts.toString();case"reaction":return""+h.REACTION+i+d("WAJids").extractUserId(a.senderJid);case"raven_action_message":return""+h.RAVEN_ACTION_MESSAGE+i+d("WAJids").extractUserId(a.senderJid);case"poll_update":return a.rawIdentifierString}}function n(a){var b;if(d("WAJids").isAuthorMe(a))b=d("WAGlobals").getMyUserJid();else{a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")b=a.userJid;else return null}a=d("WAJids").userIdFromJid(b);return""+h.REACTION+i+a}function o(a,b){var c;if(d("WAJids").isAuthorMe(a))c=d("WAGlobals").getMyUserJid();else{a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")c=a.userJid;else return null}a=d("WAJids").userIdFromJid(c);return""+h.EDIT+i+a+i+b.toString()}g.SupplementalKeyPrefix=h;g.SUPPLEMENTAL_KEY_DELIMITER=i;g.createMessageSupplementalKey_DEPRECATED=a;g.getSupplementalSenderId_DEPRECATED=c;g.isSupplementalProtobufAReaction=e;g.isSupplementalProtobufAnEdit=f;g.isSupplementalProtobufARavenAction=k;g.parseIdentifierString=l;g.toIdentifierString=m;g.createReactionSupplementalKey=n;g.createEditSupplementalKey=o}),98);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(a,b,c,d,e,f,g){"use strict";b={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:["priority","stanzaId"],primaryKey:"stanzaQueueId",secure:!0};c={autoIncrement:!0,indexes:{},nonEncryptedFields:["uploadStatus","uploadTsSec","backupActionType"],primaryKey:"queueId",secure:!0};e={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0};f={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0};var h={danglingQueue:e,ebSenderUploadQueueV3:f,ebUploadQueue:c,stanzaQueue:b};function a(a,b,c,e,f,g){b=d("WAHex").parseHex(b);var i="pqdb";b=new(d("WormEAR").WormEAR)(h,i,b);return new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,i,h,b,d("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:c,onBlockingError:e,onTransactionError:f}),g)}g.makePersistedQueueSchema=a}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","WAResolvable","WormEAR","err","getErrorSafe","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new(d("WAResolvable").Resolvable)();async function a(a){var b=a.blockingErrorThreshold,e=a.dbName,f=a.onBlockingError,g=a.qplEvent;a=a.strEncKey;try{e=d("PersistedQueuesSchema").makePersistedQueueSchema(e,a,b,f,function(a){if(a instanceof d("WormEAR").DecryptionError){var b=a;c("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",b.store);c("promiseDone")((a=(a=h)==null?void 0:a.runInTransaction([b.store],"readwrite",function(a){a=a.stores[b.store];return b.maybeHashedPk!=null?a.delete(b.maybeHashedPk):a.clear()},"delete-corrupted-entity"))!=null?a:Promise.resolve())}},g);h=e;await e.init();i.resolve(e);return e}catch(a){c("FBLogger")("messenger_web").catching(c("getErrorSafe")(a)).mustfix("Error performing PersistedQueue init");throw a}}function b(){if(h==null)throw c("err")("PersistedQueue is not initialized");return h}function e(){return i.promise}g.makePersistedQueues=a;g.getPersistedQueues=b;g.getDbPromise=e}),98);
__d("WAThrottle",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=null,e;function f(){var f=Date.now(),g=f-c;for(var h=arguments.length,i=new Array(h),j=0;j<h;j++)i[j]=arguments[j];e=i;g>=b?(clearTimeout(d),d=null,a.apply(void 0,i),c=Date.now()):d==null&&(d=setTimeout(function(){return a.apply(void 0,e)},b-g))}return f}f.throttle=a}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle"],(function(a,b,c,d,e,f,g){"use strict";var h;b=1e3*60*60;var i=function(a,b){return"PersistedQueue:"+a+":"+b};function a(){return{ack:l,clear:m,delete:n,get:j,index:k,keys:p,read:o,write:q}}function j(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){c=c.stores[a];return c.get(b)},i(a,"get"))}function k(a,b){return{equals:function(c){return{read:function(e){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(d){return d.stores[a].readIndexRange(b,{only:c},e)},i(a,"index-equal"))}}},keys:function(){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){return c.stores[a].readIndexKeys(b)},"index-keys")},read:async function(c){var e=await d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(d){return d.stores[a].readIndex(b,void 0,c)},i(a,"index-read"));return e}}}function l(a,b){return n(a,b)}function m(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(b){return b.stores[a].clear()},i(a,"clear"))}function n(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",async function(c){c=c.stores[a];await c.bulkDelete(b);s(a)},i(a,"delete"))}function o(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(c){return c.stores[a].readAll(b)},i(a,"read"))}function p(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readonly",function(b){return b.stores[a].readKeys()},i(a,"keys"))}function q(a,b){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",function(c){return c.stores[a].bulkAdd(b)},i(a,"write"))}function r(a){return d("PersistedQueueDB").getPersistedQueues().runInTransaction([a],"readwrite",async function(b){b=b.stores[a];var c=await b.readAll({limit:1});c.length===0&&await b.clear()},i(a,"ClearIfEmpty"))}var s=d("WAThrottle").throttle(function(a){r(a).catch(function(b){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""])),a,b)})},b);g.persistedQueueApi=a;g.persistedQueueGet=j;g.persistedQueueIndex=k;g.persistedQueueAck=l;g.persistedQueueClear=m;g.persistedQueueDelete=n;g.persistedQueueRead=o;g.persistedQueueKeys=p;g.persistedQueueWrite=q;g.clearIfEmpty=r}),98);
__d("WAMsgIdToMessageKey",["WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.author,c=a.externalId;a=a.chat;var e=d("WAJids").isAuthorMe(b),f=d("WAJids").interpretAsGroupJid(a);b=e?d("WAGlobals").getMyUserJid():b;a=a;f=f!=null?b:void 0;return{fromMe:e,id:c,remoteJid:a,participant:f}}g.msgIdToMessageKey=a}),98);
__d("WAAsConsumerApplication",["WAAssertUnreachable","WAConsumerApplication.pb","WAMsgIdToMessageKey","WAMsgType","err"],(function(a,b,c,d,e,f,g){"use strict";b="image/jpeg";e="video/mp4";f="audio/wav";var h="image/gif",i="image/webp";function a(a){switch(a.type){case d("WAMsgType").MSG_TYPE.TEXT:return j(a);case d("WAMsgType").MSG_TYPE.REACTION:return k(a);case d("WAMsgType").MSG_TYPE.REVOKED:return l(a);default:return c("WAAssertUnreachable")(a.type)}}function j(a){var b={payload:{content:{messageText:{mentionedJid:[],text:a.msgContent.content}}}};if(a.specialTextSize!=null){a=a.specialTextSize===1?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:a.specialTextSize===2?d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:d("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;b.metadata={specialTextSize:a}}return b}function k(a){if(a.reactToMsgId==null)throw c("err")("cannot send reaction that reacts to no message");var b=d("WAMsgIdToMessageKey").msgIdToMessageKey(a.reactToMsgId);b={groupingKey:a.groupingKey==null?void 0:a.groupingKey,key:b,senderTimestampMs:a.ts,text:a.reaction==null?void 0:a.reaction};return{payload:{content:{reactionMessage:b}}}}function l(a){a={remoteJid:a.id.chat,fromMe:!0,id:a.revokedExternalId};return{payload:{applicationData:{revoke:{key:a}}}}}g.IMAGE_MIME_TYPE=b;g.VIDEO_MIME_TYPE=e;g.AUDIO_MIME_TYPE=f;g.GIF_MIME_TYPE=h;g.STICKER_MIME_TYPE=i;g.asConsumerApplication=a;g.encodeTextMessage=j;g.encodeReactionMessage=k}),98);
__d("WAFranking",["$InternalEnum","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";var h=32,i=0,j=b("$InternalEnum").Mirrored(["KEEP","DROP"]);function a(){var a=new Uint8Array(h);d("WACryptoDependencies").getCrypto().getRandomValues(a);return d("WAFrankingTypes").castToFrankingKey(a)}function c(a){return a!=null?a:i}function e(a,b){return d("WACryptoHmac").hmacSha256(a,b).then(function(a){return d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a))})}async function k(a,b,c,e){switch(e){case void 0:case 0:e=await d("WACryptoHmac").hmacSha256(b,a);return d("WACryptoUtils").uint8ArraysEqual(new Uint8Array(e),c);default:return!0}}async function f(a,b){var c,e=d("WAGlobals").getConfig().isFrankingDropOnInvalid();if((b==null?void 0:b.frankingTag)!=null&&((c=a.metadata)==null?void 0:c.frankingKey)==null){b.frankingTag=null;b.reportingTag=null;return{decision:j.KEEP,updatedReportingMeta:b}}if((b==null?void 0:b.frankingTag)!=null&&a.version==="v3"&&a.type==="subprotocol"&&((c=a.metadata)==null?void 0:c.frankingKey)!=null&&a.frankingContent!=null){c=b.frankingTag;var f=a.frankingContent,g=a.metadata.frankingVersion;a=d("WAFrankingTypes").castToFrankingKey(new Uint8Array(a.metadata.frankingKey));var h=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.FRANKING_VALIDATION);if(a==null){h.endFail("tagButNoKey");return e?{decision:j.DROP,updatedReportingMeta:b}:{decision:j.KEEP,updatedReportingMeta:b}}if(!await k(new Uint8Array(f),a,c,g)){h.endFail("tagMismatch");return e?{decision:j.DROP,updatedReportingMeta:b}:{decision:j.KEEP,updatedReportingMeta:b}}b.frankingKey=a;b.reportingContent=f;h.endSuccess();return{decision:j.KEEP,updatedReportingMeta:b}}return d("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:j.DROP,updatedReportingMeta:b}:{decision:j.KEEP,updatedReportingMeta:b}}g.FrankingDecision=j;g.createFrankingKey=a;g.getFrankingVersion=c;g.genFrankingTag=e;g.validateFrankingTag=k;g.handleAndValidateFrankingFromIncomingMsg=f}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b;switch(a.type){default:b=d("WAAsConsumerApplication").asConsumerApplication(a)}var c=a.forwardingScore!=null?a.forwardingScore:0;a=a.isForwarded!=null?a.isForwarded:!1;c={metadata:{chatEphemeralSetting:null,forwardingScore:c,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion(),isForwarded:a,quotedMessage:null}};if(b!=null){a=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);c.payload={subProtocol:{consumerMessage:{payload:a.readBuffer(),version:1}}}}return d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,c).readByteArrayView()}function b(a){return a}function c(a){return a.buffer}g.asMessageApplication=a;g.castToMessageApplicationBytes=b;g.castMessageApplicationBytesToBytes=c}),98);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return"Missing";if(d("WATimeUtils").isInFuture(a))switch(!0){case d("WATimeUtils").happenedWithin(a,1*d("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case d("WATimeUtils").happenedWithin(a,7*d("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case d("WATimeUtils").happenedWithin(a,1*d("WATimeUtils").DAY_SECONDS):return"< 1 day";case d("WATimeUtils").happenedWithin(a,7*d("WATimeUtils").DAY_SECONDS):return"1-7 days";case d("WATimeUtils").happenedWithin(a,14*d("WATimeUtils").DAY_SECONDS):return"7-14 days";case d("WATimeUtils").happenedWithin(a,21*d("WATimeUtils").DAY_SECONDS):return"14-21 days";case d("WATimeUtils").happenedWithin(a,30*d("WATimeUtils").DAY_SECONDS):return"21-30 days";case d("WATimeUtils").happenedWithin(a,40*d("WATimeUtils").DAY_SECONDS):return"30-40 days";case d("WATimeUtils").happenedWithin(a,50*d("WATimeUtils").DAY_SECONDS):return"40-50 days";case d("WATimeUtils").happenedWithin(a,60*d("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}g.getAgeBucketForMediaKeyTimestamp=a}),98);
__d("WAIsMediaExpiredError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){switch(a){case"signature-expired":return!0;case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return!1;default:a;return!0}};f.isMediaExpiredError=a}),66);
__d("WAJobRequirement",["Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;c=function(){function a(a){var c=this;this.$1=(i||(i=b("Promise"))).resolve();this.$2=!0;this.$3=null;this.$4=function(){var a=c.$3;if(a!=null){c.$3=null;return(i||(i=b("Promise"))).all(a).then(c.$4)}c.$2=!0};this.name=a}var c=a.prototype;c.addBlocker=function(a){var c=this;a=a["catch"](function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""])),c.name,a).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(i||(i=b("Promise"))).all([this.$1,a]).then(this.$4);else{var e=this.$3;e!=null?e.push(a):this.$3=[a]}};c.waitUntilSatisfied=function(){return this.$1};c.isSatisfied=function(){return this.$2};c.isSatisfiable=function(){return!0};return a}();e=function(a){function c(c){c=a.call(this,c)||this;a.prototype.addBlocker.call(c,new(i||(i=b("Promise")))(function(){}));return c}babelHelpers.inheritsLoose(c,a);var d=c.prototype;d.addBlocker=function(){};d.isSatisfiable=function(){return!1};return c}(c);function a(a,c){var d=a.filter(function(a){return!a.isSatisfiable()});if(d.length>0){var e=d.map(function(a){return a.name});return function(a){c==null||c("unsatisfiable",e,a);return d[0].waitUntilSatisfied()}}var f=a.map(function(){return(i||(i=b("Promise"))).resolve()}),g=(i||(i=b("Promise"))).resolve(),h=null,j=function(){if(f.every(function(b,c){return b===a[c].waitUntilSatisfied()})){h=null;return}var c=[],d=a.map(function(a){var b=a.waitUntilSatisfied();a.isSatisfied()||(c.push(a.name),void b.then(function(){var b=c.indexOf(a.name);c.splice(b,1)}));return b});f=d;h=c;return(i||(i=b("Promise"))).all(d).then(j)};return function(a){if(h==null){var b=j();b!=null&&(g=g.then(function(){return b}))}c==null||c(h==null?"satisfied":"unsatisfied",h,a);return g}}g.JobRequirement=c;g.UnsatisfiableJobRequirement=e;g.joinRequirements=a}),98);
__d("WAPromiseBackoffs",["Promise","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){if(a===0)return 0;var c=o(b.algo);for(var d=1;d<a;d++)c();return j(b,c())}function i(a){var b=a.relativeDelay,c=b===void 0?!1:b,d=null,e=o(a.algo);return function(){var b=d;if(b==null){d=c?Date.now():0;return 0}var f=j(a,e());if(c){var g=Date.now();b=g-b;b>0&&(f=Math.max(0,f-b));d=g}return f}}function d(a){var c=i(a);return function(a){return new(h||(h=b("Promise")))(function(b){var d=c();d>0?setTimeout(b,d,a):b(a)})}}function j(a,b){var c=a.max,d=a.min;a=a.jitter;a=a===void 0?.1:a;b=b;c!=null&&b>c&&(b=c);d!=null&&b<d&&(b=d);a!==0&&(b=Math.ceil(b*(1+a*Math.random())));return b}function k(a){var b=a.second-a.first,c=a.first-b;return function(){var a=b+c;c=b;b=a;return a}}function l(a){var b=a.base,c=b===void 0?2:b,d=a.first;return function(){var a=d;d*=c;return a}}function m(a){var b=a.delay;return function(){return b}}function n(a){var b=a.toMs;a=a.backoff;var c=o(a);return function(){return b(c())}}function o(a){switch(a.type){case"fibonacci":return k(a);case"exponential":return l(a);case"constant":return m(a);case"adjust":return n(a);default:a;throw c("err")("makeTimeFunc unrecognized backoff "+a.type)}}g.getDelay=a;g.createTimer=i;g.createPromiseTimer=d}),98);
__d("WAPersistedJobManager",["WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K=1,L=function(){function a(a){this.feature=a}var b=a.prototype;b.toString=function(){return"RequiresPage: "+this.feature};return a}(),M=function(){function a(a){this.backoffOptions=a}var b=a.prototype;b.toString=function(){return"RetryOnBackoff"};return a}();a=function(a){function b(){return a.apply(this,arguments)||this}babelHelpers.inheritsLoose(b,a);var c=b.prototype;c.toString=function(){return"NonRetryableError"};return b}(babelHelpers.wrapNativeSuper(Error));var N=function(a){this.result=a},O="$unstarted",P="$finished";b=function(){function a(a){var b=this,c=a.isRestartAfterCrash,e=a.accessors,f=a.unfinishedJobEntries,g=new Map();f=f.then(function(a){var f=[],j=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?f.push(a):j.push(a)});return Promise.all(f.map(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),R(a),a.step).devConsole(Q(a)).sendLogs("job-stuck-"+a.type);return e.deletePersistedJob(a.jobId)})).then(function(){j.forEach(function(a){if(g.has(a.jobId))return;d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"])),Q(a));g.set(a.jobId,b.$1(a,c))})})});this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=e;this.activeJobs=g;this.initialJobsPromise=f;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs}var b=a.prototype;b.loadAndRunJobFromId=function(a){var b=this.activeJobs.get(a);if(b!=null)return b;b=this.$2(a);this.activeJobs.set(a,b);return b};b.$2=async function(a){var b=this.initialJobsPromise,c=this.accessors;await b;b=await c.readPersistedJob(a);if(!b){d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["No entry for job ",""])),a);d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"])));return null}return this.$1(b,!1)};b.$3=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};b.$4=function(a,b){if(b==null||b.length===0)return Promise.resolve();var c=this.stepBlockers,e=c.get(b);e==null&&(e=d("WAJobRequirement").joinRequirements(b.map(function(a){return a()}),T),c.set(b,e));return e(a)};b.$5=function(a,b,c,e){var f=this;c===void 0&&(c=!1);var g=a.step,h=b.findIndex(function(a){return a.stepName===g}),i=b[h].info(a.current,a.original,U(a,c)),j=i.requirements,k=i.code;i=this.$4(a,j);e&&(i=i.then(e));return i.then(function(){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),S(a));return k(a.current,a.original,U(a,c))}).then(function(e){if(e instanceof N){d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),S(a));return e.result}var g=h+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return f.accessors.updatePersistedJob(a).then(function(){return f.$5(a,b,c)})})};b.$1=async function(a,b){var c=this,e=this.accessors,f=this.activeJobs,g=this.deprecatedJobs,h=this.listeners,i=h.onJobFinished;h=h.onJobStarted;var j=await this.$3(a.type);g=g[a.type];if(!j){if(!g){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),a.type).sendLogs("missing-job-implementation");await e.deletePersistedJob(a.jobId);return null}else if(g==="NOOP"){d("WALogger").WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),a.type);await e.deletePersistedJob(a.jobId);return null}j=await g()}var k=j;g&&d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),a.type);var l=(g=a.stepFirstStartTime)!=null?g:d("WATimeUtils").unixTime();a.stepFirstStartTime=l;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(a.step===P){g=a.waitUntil;var m=d("WATimeUtils").secondsUntil(l);g!=null&&d("WATimeUtils").isInFuture(g)&&m>0&&(d("WALogger").LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),Q(a)),g=d("WATimeUtils").castToUnixTime(g-m),d("WATimeUtils").isInFuture(g)&&(a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(l-m),a.waitUntil=g,await this.accessors.updatePersistedJob(a)));(g==null||!d("WATimeUtils").isInFuture(g))&&(d("WALogger").LOG(r||(r=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),Q(a)),await e.deletePersistedJob(a.jobId));f.delete(a.jobId);return a.current}m=a.step!==O?j.find(function(b){return b.stepName===a.step}):j[0];if(!m){d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),a.type,a.step).sendLogs("missing-job-step");await e.deletePersistedJob(a.jobId);return null}a.step=m.stepName;var E=function(){var e=a.waitUntil,f=Promise.resolve();if(e!=null){var g=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);e>g?(d("WALogger").LOG(t||(t=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),S(a),e,g),a.waitUntil=g,f=c.accessors.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(g)})):(d("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),S(a),e),f=d("WATimeUtils").delayUntil(e))}return f.then(function(){var e=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(l,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return c.accessors.updatePersistedJob(a)};return c.$5(a,k,b,e).catch(function(b){if(b instanceof L){d("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"])),S(a));a.stepHardStartCountAfterTimeout>0&&(--a.stepHardStartCountAfterTimeout,c.accessors.updatePersistedJob(a));return new Promise(function(){})}else if(b instanceof M){d("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),S(a));var e=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,b.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(e/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return c.accessors.updatePersistedJob(a).then(E)}else if(a.stepUnexpectedErrorCount<K){d("WALogger").WARN(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),S(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),S(a),b);a.stepUnexpectedErrorCount++;return c.accessors.updatePersistedJob(a).then(E)}throw b})})},F=E();g=F.then(async function(b){d("WALogger").LOG(z||(z=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),S(a));var g=null;try{g=i(a.jobId,a.type,a.original,b)}catch(b){d("WALogger").ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),a.type,b).sendLogs("onJobFinished-threw")}g!=null&&g>0?(a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(g/1e3)),a.step=P,a.current=b,a.stepFirstStartTime=d("WATimeUtils").unixTime(),await c.accessors.updatePersistedJob(a)):(await e.deletePersistedJob(a.jobId),f.delete(a.jobId))},async function(c){d("WALogger").ERROR(B||(B=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),a.type,c).sendLogs("job-threw-exception-"+a.type);c=k.find(function(b){return b.stepName===a.step});if(!c)d("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),a.type,a.step);else{c=c.info(a.current,a.original,U(a,b));c.stopRetryIf!=null&&await c.stopRetryIf.onStopRetry(a.current,a.original,U(a,b))}await e.deletePersistedJob(a.jobId);f.delete(a.jobId)});try{h(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),a.type,b).sendLogs("onJobStarted-threw")}return g.then(function(){return F})};b.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(F||(F=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"])),a);c.set(a,b)};b.fireAndForget=function(a){var b=this;this.accessors.maybeCreateJob(a).then(function(a){a=a.id;return b.loadAndRunJobFromId(a)})};b.waitUntilPersisted=function(a){var b=this;return this.accessors.maybeCreateJob(a).then(function(a){a=a.id;b.loadAndRunJobFromId(a)})};b.waitUntilCompleted=function(a){var b=this;return this.accessors.maybeCreateJob(a).then(function(a){a=a.id;return b.loadAndRunJobFromId(a)})};b.fireAndForgetNonPersisted=function(a){d("WALogger").LOG(G||(G=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"])))};b.waitUntilCompletedNonPersisted=function(a){return Promise.resolve(function(){return d("WALogger").LOG(H||(H=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"])))})};return a}();function Q(a){return"Job["+a.jobId+"] ("+a.type+")"}function R(a){return"[Job "+a.type+"] "}function S(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function T(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),S(c),b):a==="unsatisfied"?d("WALogger").LOG(J||(J=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),S(c),b):a}function U(a,b){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:V}}function V(a){return new N(a)}g.RequiresPage=L;g.RetryOnBackoff=M;g.NonRetryableError=a;g.InterruptJob=N;g.UNSTARTED_JOB=O;g.FINISHED_JOB=P;g.PersistedJobManager=b}),98);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){var e=d("WATagsLogger").TAGS(["PersistedQueue",a,"cache"]),f=[],g=new(d("WAResolvable").Resolvable)(),i=c!=null?c:{},j=new(d("WAShiftTimer").ShiftTimer)(function(){void m()});return{commit:function(){return m()},add:function(a){f.push(a);a=g;k();l();return a.promise},config:function(a){i=a}};function k(){i.cacheSize!=null&&f.length>=i.cacheSize&&void m()}function l(){if(i.maxDelay!=null){var a=i.maxDelay;j.cancel();j.onOrAfter(a)}}async function m(){if(f.length===0)return;j.cancel();var a=f;f=[];var c=g;g=new(d("WAResolvable").Resolvable)();try{await b(a),c.resolve()}catch(a){e.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""])),a);c.reject(a);throw a}}}g.makePersistedQueueCache=a}),98);
__d("WAPersistedQueue",["WALogger","WAPersistedQueueCache","WAPubSub"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=function(){function a(a,b,c){var e=this;this.$1=d("WAPubSub").simplePubSub();this.$3=a;this.$4=b;this.$2=d("WAPersistedQueueCache").makePersistedQueueCache(a,function(c){return b.write(a,c).then(function(){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"])),c.length),e.$1.publish({type:"flush"})})},c)}var b=a.prototype;b.subscribe=function(a){return this.$1.subscribe(a)};b.index=function(a){return this.$4.index(this.$3,a)};b.keys=function(){return this.$4.keys(this.$3)};b.get=function(a){return this.$4.get(this.$3,a)};b.read=function(a){return this.$4.read(this.$3,a)};b.addAndCommit=function(a){var b=this;d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] new entry & commit"])));this.$1.publish({type:"new_entity"});return this.$4.write(this.$3,a).then(function(){d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"])),a.length),b.$1.publish({type:"flush"})})};b.commit=function(){return this.$2.commit()};b.ack=function(a){return this.$4.ack(this.$3,a)};b["delete"]=function(a){return this.$4["delete"](this.$3,a)};b.clear=function(){return this.$4.clear(this.$3)};return a}();function a(a,b,c){return new k(a,b,c)}g.PersistedQueue=k;g.initPersistedQueue=a}),98);
__d("WASortedLists",[],(function(a,b,c,d,e,f){"use strict";function a(){return[]}function b(){return[]}function c(a,b){return a.filter(b)}function d(a,b){return l(a.map(b))}function e(a,b){var c=a.length===b.length;for(var d=0;c&&d<a.length;d++)a[d]!==b[d]&&(c=!1);return c}function g(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return a;return a.concat([b]).sort()}function h(a,b){if(a.length<b.length)return!1;var c=!0;for(var d=0,e=0;c&&e<b.length;e++)do c=a[d]===b[e];while(!c&&++d<a.length);return c}function i(a,b){var c=[];for(var d=0,e=0;d<a.length;d++){var f=a[d];while(e<b.length&&f>b[e])e++;(e===b.length||f<b[e])&&c.push(f)}return c}function j(a,b){var c=[],d=0,e=0;while(d<a.length&&e<b.length){var f=a[d],g=b[e];f<g?d++:f===g?(c.push(f),d++,e++):e++}return c}function k(a,b){var c=[],d=0,e=0;while(d<a.length&&e<b.length)a[d]<b[e]?c.push(a[d++]):a[d]===b[e]?(c.push(a[d++]),e++):c.push(b[e++]);while(d<a.length)c.push(a[d++]);while(e<b.length)c.push(b[e++]);return c}function l(a){return m(a.slice().sort())}function m(a){var b=!1;for(var c=0;c<a.length-1;c++)a[c]===a[c+1]&&(b=!0);if(!b)return a;c=[];for(b=0;b<a.length-1;b++)a[b]!==a[b+1]&&c.push(a[b]);c.push(a[a.length-1]);return c}function n(a){return Array.from(a).sort()}function o(a){return a.slice().sort()}function p(a,b,c){var d=null;for(var e=0;!d&&e<a.length;e++)a[e]===b&&(d=a.slice(),d[e]=c,d=m(d.sort()));return d||a}function q(a){return[a]}function r(a){return a.length<1}function s(a,b,c){return a.slice(b,c)}f.emptySet=a;f.emptyList=b;f.filter=c;f.map=d;f.areEqual=e;f.addToSet=g;f.contains=h;f.subtract=i;f.intersect=j;f.joinUniq=k;f.sortAndDedupe=l;f.asSortedSet=n;f.sort=o;f.swapIn=p;f.singleElement=q;f.isEmpty=r;f.slice=s}),66);
__d("WAStartMediaDownloadQplFlow",["WAGetPlatformFromStanzaId","WAGetStorageQplAnnotations","WAJids","WAMediaUtils","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.downloadEntry,c=a.msgType,e=a.triggerUIView,f=a.protocolMsgId,g=a.isPreview;a=a.xmaMediaType;var h=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.MEDIA_DOWNLOAD,{bool:{isTransformStreamSupported:d("WAMediaUtils").isTransformStreamSupported()},string:{chat_type:f==null?null:d("WAJids").switchOnMsgrChatJidType(f.chat,{group:function(){return"group"},user:function(){return"user"}}),downloadEntry:g===!0?b+"-preview":b,e2eePlatform:f==null?null:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(f.externalId),msgType:c,trigger_ui_view:e,xmaMediaType:a!=null?a:void 0}},void 0,d("WAPREMetrics").QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS);void d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){h.addAnnotations(a)});return babelHelpers["extends"]({},h,{downloadEntry:b,triggerUIView:e})}g.startMediaDownloadQplFlow=a}),98);
__d("WAWaitForComms",["WACommsConnectionState","WAResolvable"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAResolvable").Resolvable)();function a(){return h.promise}function b(){d("WACommsConnectionState").WACommsConnectionState.set(!1),h.isSettled&&(h=new(d("WAResolvable").Resolvable)())}function c(){d("WACommsConnectionState").WACommsConnectionState.set(!0),h.resolve()}function e(){return!h.resolveWasCalled()}function f(a){return h.reject(a)}g.waitForComms=a;g.commsConnectionLost=b;g.unblockComms=c;g.isStillWaitingForComms=e;g.failComms=f}),98);/*FB_PKG_DELIM*/
/**
 * License: https://www.facebook.com/legal/license/yKsQCAUqcFZ/
 */
__d("dexie-4.0.1",[],(function(a,b,c,d,e,f){"use strict";var g={},h={exports:g};function i(){(function(b,c){typeof g==="object"&&typeof h!=="undefined"?h.exports=c():(b=typeof globalThis!=="undefined"?globalThis:b||self,b.Dexie=c())})(this,function(){var b=function(a,c){b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c])};return b(a,c)};function c(a,c){if(typeof c!=="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");b(a,c);function d(){this.constructor=a}a.prototype=c===null?Object.create(c):(d.prototype=c.prototype,new d())}var d=function(){d=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++){b=arguments[c];for(var e in b)Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e])}return a};return d.apply(this,arguments)};function e(a,b,c){if(c||arguments.length===2)for(var d=0,e=b.length,f;d<e;d++)(f||!(d in b))&&(f||(f=Array.prototype.slice.call(b,0,d)),f[d]=b[d]);return a.concat(f||Array.prototype.slice.call(b))}var f=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:typeof window!=="undefined"?window:a,g=Object.keys,h=Array.isArray;typeof Promise!=="undefined"&&!f.Promise&&(f.Promise=Promise);function i(a,b){if(typeof b!=="object")return a;g(b).forEach(function(c){a[c]=b[c]});return a}var j=Object.getPrototypeOf,k={}.hasOwnProperty;function l(a,b){return k.call(a,b)}function m(a,b){typeof b==="function"&&(b=b(j(a))),(typeof Reflect==="undefined"?g:Reflect.ownKeys)(b).forEach(function(c){o(a,c,b[c])})}var n=Object.defineProperty;function o(a,b,c,d){n(a,b,i(c&&l(c,"get")&&typeof c.get==="function"?{get:c.get,set:c.set,configurable:!0}:{value:c,configurable:!0,writable:!0},d))}function p(a){return{from:function(b){a.prototype=Object.create(b.prototype);o(a.prototype,"constructor",a);return{extend:m.bind(null,a.prototype)}}}}var q=Object.getOwnPropertyDescriptor;function r(a,b){var c=q(a,b);return c||(c=j(a))&&r(c,b)}var s=[].slice;function t(a,b,c){return s.call(a,b,c)}function u(a,b){return b(a)}function v(a){if(!a)throw new Error("Assertion Failed")}function aa(a){f.setImmediate?setImmediate(a):setTimeout(a,0)}function ba(a,b){return a.reduce(function(a,c,d){c=b(c,d);c&&(a[c[0]]=c[1]);return a},{})}function w(a,b){if(typeof b==="string"&&l(a,b))return a[b];if(!b)return a;if(typeof b!=="string"){var c=[];for(var d=0,e=b.length;d<e;++d){var f=w(a,b[d]);c.push(f)}return c}f=b.indexOf(".");if(f!==-1){d=a[b.substr(0,f)];return d==null?void 0:w(d,b.substr(f+1))}return void 0}function x(a,b,c){if(!a||b===void 0)return;if("isFrozen"in Object&&Object.isFrozen(a))return;if(typeof b!=="string"&&"length"in b){v(typeof c!=="string"&&"length"in c);for(var d=0,e=b.length;d<e;++d)x(a,b[d],c[d])}else{d=b.indexOf(".");if(d!==-1){e=b.substr(0,d);d=b.substr(d+1);if(d==="")c===void 0?h(a)&&!isNaN(parseInt(e))?a.splice(e,1):delete a[e]:a[e]=c;else{var f=a[e];(!f||!l(a,e))&&(f=a[e]={});x(f,d,c)}}else c===void 0?h(a)&&!isNaN(parseInt(b))?a.splice(b,1):delete a[b]:a[b]=c}}function ca(a,b){typeof b==="string"?x(a,b,void 0):"length"in b&&[].map.call(b,function(b){x(a,b,void 0)})}function da(a){var b={};for(var c in a)l(a,c)&&(b[c]=a[c]);return b}var ea=[].concat;function fa(a){return ea.apply([],a)}var y="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(fa([8,16,32,64].map(function(a){return["Int","Uint","Float"].map(function(b){return b+a+"Array"})}))).filter(function(a){return f[a]}),ga=new Set(y.map(function(a){return f[a]}));function ha(a){var b={};for(var c in a)if(l(a,c)){var d=a[c];b[c]=!d||typeof d!=="object"||ga.has(d.constructor)?d:ha(d)}return b}function ia(a){for(var b in a)if(l(a,b))return!1;return!0}var ja=null;function z(a){ja=new WeakMap();a=ka(a);ja=null;return a}function ka(a){if(!a||typeof a!=="object")return a;var b=ja.get(a);if(b)return b;if(h(a)){b=[];ja.set(a,b);for(var c=0,d=a.length;c<d;++c)b.push(ka(a[c]))}else if(ga.has(a.constructor))b=a;else{c=j(a);b=c===Object.prototype?{}:Object.create(c);ja.set(a,b);for(d in a)l(a,d)&&(b[d]=ka(a[d]))}return b}var la={}.toString;function ma(a){return la.call(a).slice(8,-1)}var na=typeof Symbol!=="undefined"?Symbol.iterator:"@@iterator",oa=typeof na==="symbol"?function(a){var b;return a!=null&&(b=a[na])&&b.apply(a)}:function(){return null};function A(a,b){b=a.indexOf(b);b>=0&&a.splice(b,1);return b>=0}var pa={};function B(a){var b,c,d,e;if(arguments.length===1){if(h(a))return a.slice();if(this===pa&&typeof a==="string")return[a];if(e=oa(a)){c=[];while(d=e.next(),!d.done)c.push(d.value);return c}if(a==null)return[a];b=a.length;if(typeof b==="number"){c=new Array(b);while(b--)c[b]=a[b];return c}return[a]}b=arguments.length;c=new Array(b);while(b--)c[b]=arguments[b];return c}var qa=typeof Symbol!=="undefined"?function(a){return a[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1};y=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"];var C=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"];y=y.concat(C);var ra={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function sa(a,b){this.name=a,this.message=b}p(sa).from(Error).extend({toString:function(){return this.name+": "+this.message}});function ta(a,b){return a+". Errors: "+Object.keys(b).map(function(a){return b[a].toString()}).filter(function(a,b,c){return c.indexOf(a)===b}).join("\n")}function ua(a,b,c,d){this.failures=b,this.failedKeys=d,this.successCount=c,this.message=ta(a,b)}p(ua).from(sa);function va(a,b){this.name="BulkError",this.failures=Object.keys(b).map(function(a){return b[a]}),this.failuresByPos=b,this.message=ta(a,this.failures)}p(va).from(sa);var wa=y.reduce(function(a,b){return a[b]=b+"Error",a},{}),xa=sa,D=y.reduce(function(b,c){var d=c+"Error";function a(a,b){this.name=d,!a?(this.message=ra[c]||d,this.inner=null):typeof a==="string"?(this.message="".concat(a).concat(b?"\n "+b:""),this.inner=b||null):typeof a==="object"&&(this.message="".concat(a.name," ").concat(a.message),this.inner=a)}p(a).from(xa);b[c]=a;return b},{});D.Syntax=SyntaxError;D.Type=TypeError;D.Range=RangeError;var ya=C.reduce(function(a,b){a[b+"Error"]=D[b];return a},{});function za(a,b){if(!a||a instanceof sa||a instanceof TypeError||a instanceof SyntaxError||!a.name||!ya[a.name])return a;b=new ya[a.name](b||a.message,a);"stack"in a&&o(b,"stack",{get:function(){return this.inner.stack}});return b}C=y.reduce(function(a,b){["Syntax","Type","Range"].indexOf(b)===-1&&(a[b+"Error"]=D[b]);return a},{});C.ModifyError=ua;C.DexieError=sa;C.BulkError=va;function E(){}function Aa(a){return a}function Ba(a,b){return a==null||a===Aa?b:function(c){return b(a(c))}}function F(a,b){return function(){a.apply(this,arguments),b.apply(this,arguments)}}function Ca(a,b){return a===E?b:function(){var c=a.apply(this,arguments);c!==void 0&&(arguments[0]=c);var d=this.onsuccess,e=this.onerror;this.onsuccess=null;this.onerror=null;var f=b.apply(this,arguments);d&&(this.onsuccess=this.onsuccess?F(d,this.onsuccess):d);e&&(this.onerror=this.onerror?F(e,this.onerror):e);return f!==void 0?f:c}}function Da(a,b){return a===E?b:function(){a.apply(this,arguments);var c=this.onsuccess,d=this.onerror;this.onsuccess=this.onerror=null;b.apply(this,arguments);c&&(this.onsuccess=this.onsuccess?F(c,this.onsuccess):c);d&&(this.onerror=this.onerror?F(d,this.onerror):d)}}function Ea(a,b){return a===E?b:function(c){var d=a.apply(this,arguments);i(c,d);var e=this.onsuccess,f=this.onerror;this.onsuccess=null;this.onerror=null;var g=b.apply(this,arguments);e&&(this.onsuccess=this.onsuccess?F(e,this.onsuccess):e);f&&(this.onerror=this.onerror?F(f,this.onerror):f);return d===void 0?g===void 0?void 0:g:i(d,g)}}function Fa(a,b){return a===E?b:function(){return b.apply(this,arguments)===!1?!1:a.apply(this,arguments)}}function Ga(a,b){return a===E?b:function(){var c=a.apply(this,arguments);if(c&&typeof c.then==="function"){var d=this,e=arguments.length,f=new Array(e);while(e--)f[e]=arguments[e];return c.then(function(){return b.apply(d,f)})}return b.apply(this,arguments)}}var G=typeof location!=="undefined"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function Ha(a,b){G=a}var Ia={},Ja=100;y=typeof Promise==="undefined"?[]:function(){var a=Promise.resolve();if(typeof crypto==="undefined"||!crypto.subtle)return[a,j(a),a];var b=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[b,j(b),a]}();var Ka=y[0],H=y[1];y=y[2];H=H&&H.then;var La=Ka&&Ka.constructor,Ma=!!y;function Na(){queueMicrotask(db)}var Oa=function(a,b){Ua.push([a,b]),Qa&&(Na(),Qa=!1)},Pa=!0,Qa=!0,Ra=[],Sa=[],Ta=Aa,I={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:E,pgp:!1,env:{},finalize:E},J=I,Ua=[],Va=0,Wa=[];function K(a){if(typeof this!=="object")throw new TypeError("Promises must be constructed via new");this._listeners=[];this._lib=!1;var b=this._PSD=J;if(typeof a!=="function"){if(a!==Ia)throw new TypeError("Not a function");this._state=arguments[1];this._value=arguments[2];this._state===!1&&$a(this,this._value);return}this._state=null;this._value=null;++b.ref;Za(this,a)}var Xa={get:function(){var a=J,b=ob;function c(c,d){var e=this,f=!a.global&&(a!==J||b!==ob),g=f&&!O(),h=new K(function(b,h){bb(e,new Ya(wb(c,a,f,g),wb(d,a,f,g),b,h,a))});this._consoleTask&&(h._consoleTask=this._consoleTask);return h}c.prototype=Ia;return c},set:function(a){o(this,"then",a&&a.prototype===Ia?Xa:{get:function(){return a},set:Xa.set})}};m(K.prototype,{then:Xa,_then:function(a,b){bb(this,new Ya(null,null,a,b,J))},"catch":function(b){if(arguments.length===1)return this.then(null,b);var a=arguments[0],c=arguments[1];return typeof a==="function"?this.then(null,function(b){return b instanceof a?c(b):kb(b)}):this.then(null,function(b){return b&&b.name===a?c(b):kb(b)})},"finally":function(a){return this.then(function(b){return K.resolve(a()).then(function(){return b})},function(b){return K.resolve(a()).then(function(){return kb(b)})})},timeout:function(a,b){var c=this;return a<Infinity?new K(function(d,e){var f=setTimeout(function(){return e(new D.Timeout(b))},a);c.then(d,e)["finally"](clearTimeout.bind(null,f))}):this}});typeof Symbol!=="undefined"&&Symbol.toStringTag&&o(K.prototype,Symbol.toStringTag,"Dexie.Promise");I.env=ub();function Ya(a,b,c,d,e){this.onFulfilled=typeof a==="function"?a:null,this.onRejected=typeof b==="function"?b:null,this.resolve=c,this.reject=d,this.psd=e}m(K,{all:function(){var a=B.apply(null,arguments).map(rb);return new K(function(b,c){a.length===0&&b([]);var d=a.length;a.forEach(function(e,f){return K.resolve(e).then(function(c){a[f]=c,--d||b(a)},c)})})},resolve:function(a){if(a instanceof K)return a;if(a&&typeof a.then==="function")return new K(function(b,c){a.then(b,c)});var b=new K(Ia,!0,a);return b},reject:kb,race:function(){var a=B.apply(null,arguments).map(rb);return new K(function(b,c){a.map(function(a){return K.resolve(a).then(b,c)})})},PSD:{get:function(){return J},set:function(a){return J=a}},totalEchoes:{get:function(){return ob}},newPSD:N,usePSD:vb,scheduler:{get:function(){return Oa},set:function(a){Oa=a}},rejectionMapper:{get:function(){return Ta},set:function(a){Ta=a}},follow:function(a,b){return new K(function(c,d){return N(function(b,c){var d=J;d.unhandleds=[];d.onunhandled=c;d.finalize=F(function(){var a=this;hb(function(){a.unhandleds.length===0?b():c(a.unhandleds[0])})},d.finalize);a()},b,c,d)})}});La&&(La.allSettled&&o(K,"allSettled",function(){var a=B.apply(null,arguments).map(rb);return new K(function(b){a.length===0&&b([]);var c=a.length,d=new Array(c);a.forEach(function(a,e){return K.resolve(a).then(function(a){return d[e]={status:"fulfilled",value:a}},function(a){return d[e]={status:"rejected",reason:a}}).then(function(){return--c||b(d)})})})}),La.any&&typeof AggregateError!=="undefined"&&o(K,"any",function(){var a=B.apply(null,arguments).map(rb);return new K(function(b,c){a.length===0&&c(new AggregateError([]));var d=a.length,e=new Array(d);a.forEach(function(a,f){return K.resolve(a).then(function(a){return b(a)},function(a){e[f]=a,--d||c(new AggregateError(e))})})})}));function Za(a,b){try{b(function(b){if(a._state!==null)return;if(b===a)throw new TypeError("A promise cannot be resolved with itself.");var c=a._lib&&eb();b&&typeof b.then==="function"?Za(a,function(a,c){b instanceof K?b._then(a,c):b.then(a,c)}):(a._state=!0,a._value=b,ab(a));c&&fb()},$a.bind(null,a))}catch(b){$a(a,b)}}function $a(a,b){Sa.push(b);if(a._state!==null)return;var c=a._lib&&eb();b=Ta(b);a._state=!1;a._value=b;ib(a);ab(a);c&&fb()}function ab(a){var b=a._listeners;a._listeners=[];for(var c=0,d=b.length;c<d;++c)bb(a,b[c]);c=a._PSD;--c.ref||c.finalize();Va===0&&(++Va,Oa(function(){--Va===0&&gb()},[]))}function bb(a,b){if(a._state===null){a._listeners.push(b);return}var c=a._state?b.onFulfilled:b.onRejected;if(c===null)return(a._state?b.resolve:b.reject)(a._value);++b.psd.ref;++Va;Oa(cb,[c,a,b])}function cb(a,b,c){try{var d,e=b._value;!b._state&&Sa.length&&(Sa=[]);d=G&&b._consoleTask?b._consoleTask.run(function(){return a(e)}):a(e);!b._state&&Sa.indexOf(e)===-1&&jb(b);c.resolve(d)}catch(a){c.reject(a)}finally{--Va===0&&gb(),--c.psd.ref||c.psd.finalize()}}function db(){vb(I,function(){eb()&&fb()})}function eb(){var a=Pa;Pa=!1;Qa=!1;return a}function fb(){var a,b,c;do while(Ua.length>0){a=Ua;Ua=[];c=a.length;for(b=0;b<c;++b){var d=a[b];d[0].apply(null,d[1])}}while(Ua.length>0);Pa=!0;Qa=!0}function gb(){var a=Ra;Ra=[];a.forEach(function(a){a._PSD.onunhandled.call(null,a._value,a)});a=Wa.slice(0);var b=a.length;while(b)a[--b]()}function hb(a){function b(){a(),Wa.splice(Wa.indexOf(b),1)}Wa.push(b);++Va;Oa(function(){--Va===0&&gb()},[])}function ib(a){Ra.some(function(b){return b._value===a._value})||Ra.push(a)}function jb(a){var b=Ra.length;while(b)if(Ra[--b]._value===a._value){Ra.splice(b,1);return}}function kb(a){return new K(Ia,!1,a)}function L(a,b){var c=J;return function(){var d=eb(),e=J;try{P(c,!0);return a.apply(this,arguments)}catch(a){b&&b(a)}finally{P(e,!1),d&&fb()}}}var M={awaits:0,echoes:0,id:0},lb=0,mb=[],nb=0,ob=0,pb=0;function N(b,a,c,d){var e=J,f=Object.create(e);f.parent=e;f.ref=0;f.global=!1;f.id=++pb;I.env;f.env=Ma?{Promise:K,PromiseProp:{value:K,configurable:!0,writable:!0},all:K.all,race:K.race,allSettled:K.allSettled,any:K.any,resolve:K.resolve,reject:K.reject}:{};a&&i(f,a);++e.ref;f.finalize=function(){--this.parent.ref||this.parent.finalize()};a=vb(f,b,c,d);f.ref===0&&f.finalize();return a}function qb(){M.id||(M.id=++lb);++M.awaits;M.echoes+=Ja;return M.id}function O(){if(!M.awaits)return!1;--M.awaits===0&&(M.id=0);M.echoes=M.awaits*Ja;return!0}(""+H).indexOf("[native code]")===-1&&(qb=O=E);function rb(a){if(M.echoes&&a&&a.constructor===La){qb();return a.then(function(a){O();return a},function(a){O();return Q(a)})}return a}function sb(a){++ob,(!M.echoes||--M.echoes===0)&&(M.echoes=M.awaits=M.id=0),mb.push(J),P(a,!0)}function tb(){var a=mb[mb.length-1];mb.pop();P(a,!1)}function P(a,b){var c=J;(b?M.echoes&&(!nb++||a!==J):nb&&(!--nb||a!==J))&&queueMicrotask(b?sb.bind(null,a):tb);if(a===J)return;J=a;c===I&&(I.env=ub());if(Ma){b=I.env.Promise;var d=a.env;(c.global||a.global)&&(Object.defineProperty(f,"Promise",d.PromiseProp),b.all=d.all,b.race=d.race,b.resolve=d.resolve,b.reject=d.reject,d.allSettled&&(b.allSettled=d.allSettled),d.any&&(b.any=d.any))}}function ub(){var a=f.Promise;return Ma?{Promise:a,PromiseProp:Object.getOwnPropertyDescriptor(f,"Promise"),all:a.all,race:a.race,allSettled:a.allSettled,any:a.any,resolve:a.resolve,reject:a.reject}:{}}function vb(a,b,c,d,e){var f=J;try{P(a,!0);return b(c,d,e)}finally{P(f,!1)}}function wb(a,b,c,d){return typeof a!=="function"?a:function(){var e=J;c&&qb();P(b,!0);try{return a.apply(this,arguments)}finally{P(e,!1),d&&queueMicrotask(O)}}}function xb(a){Promise===La&&M.echoes===0?nb===0?a():enqueueNativeMicroTask(a):setTimeout(a,0)}var Q=K.reject;function yb(a,b,c,d){if(!a.idbdb||!a._state.openComplete&&!J.letThrough&&!a._vip){if(a._state.openComplete)return Q(new D.DatabaseClosed(a._state.dbOpenError));if(!a._state.isBeingOpened){if(!a._state.autoOpen)return Q(new D.DatabaseClosed());a.open()["catch"](E)}return a._state.dbReadyPromise.then(function(){return yb(a,b,c,d)})}else{var e=a._createTransaction(b,c,a._dbSchema);try{e.create(),a._state.PR1398_maxLoop=3}catch(e){if(e.name===wa.InvalidState&&a.isOpen()&&--a._state.PR1398_maxLoop>0){a.close({disableAutoOpen:!1});return a.open().then(function(){return yb(a,b,c,d)})}return Q(e)}return e._promise(b,function(a,b){return N(function(){J.trans=e;return d(a,b,e)})}).then(function(a){if(b==="readwrite")try{e.idbtrans.commit()}catch(a){}return b==="readonly"?a:e._completion.then(function(){return a})})}}Ka="4.0.1";var zb=String.fromCharCode(65535),Ab=-Infinity,R="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Bb="String expected.",Cb=[],Db="__dbnames",Eb="readonly",Fb="readwrite";function Gb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}var Hb={type:3,lower:-Infinity,lowerOpen:!1,upper:[[]],upperOpen:!1};function Ib(a){return typeof a==="string"&&!/\./.test(a)?function(b){b[a]===void 0&&a in b&&(b=z(b),delete b[a]);return b}:function(a){return a}}function Jb(){throw D.Type()}function S(a,b){try{var c=Mb(a),d=Mb(b);if(c!==d){if(c==="Array")return 1;if(d==="Array")return-1;if(c==="binary")return 1;if(d==="binary")return-1;if(c==="string")return 1;if(d==="string")return-1;if(c==="Date")return 1;return d!=="Date"?NaN:-1}switch(c){case"number":case"Date":case"string":return a>b?1:a<b?-1:0;case"binary":return Lb(Nb(a),Nb(b));case"Array":return Kb(a,b)}}catch(a){}return NaN}function Kb(a,b){var c=a.length,d=b.length,e=c<d?c:d;for(var f=0;f<e;++f){var g=S(a[f],b[f]);if(g!==0)return g}return c===d?0:c<d?-1:1}function Lb(a,b){var c=a.length,d=b.length,e=c<d?c:d;for(var f=0;f<e;++f)if(a[f]!==b[f])return a[f]<b[f]?-1:1;return c===d?0:c<d?-1:1}function Mb(a){var b=typeof a;if(b!=="object")return b;if(ArrayBuffer.isView(a))return"binary";b=ma(a);return b==="ArrayBuffer"?"binary":b}function Nb(a){if(a instanceof Uint8Array)return a;return ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a)}var Ob=function(){function a(){}a.prototype._trans=function(b,c,d){var e=this._tx||J.trans,f=this.name,a=G&&typeof console!=="undefined"&&console.createTask&&console.createTask("Dexie: ".concat(b==="readonly"?"read":"write"," ").concat(this.name));function g(b,d,a){if(!a.schema[f])throw new D.NotFound("Table "+f+" not part of transaction");return c(a.idbtrans,a)}var h=eb();try{var i=e&&e.db._novip===this.db._novip?e===J.trans?e._promise(b,g,d):N(function(){return e._promise(b,g,d)},{trans:e,transless:J.transless||J}):yb(this.db,b,[this.name],g);a&&(i._consoleTask=a,i=i["catch"](function(a){console.trace(a);return Q(a)}));return i}finally{h&&fb()}};a.prototype.get=function(a,b){var c=this;if(a&&a.constructor===Object)return this.where(a).first(b);return a==null?Q(new D.Type("Invalid argument to Table.get()")):this._trans("readonly",function(b){return c.core.get({trans:b,key:a}).then(function(a){return c.hook.reading.fire(a)})}).then(b)};a.prototype.where=function(a){if(typeof a==="string")return new this.db.WhereClause(this,a);if(h(a))return new this.db.WhereClause(this,"[".concat(a.join("+"),"]"));var b=g(a);if(b.length===1)return this.where(b[0]).equals(a[b[0]]);var c=this.schema.indexes.concat(this.schema.primKey).filter(function(a){if(a.compound&&b.every(function(b){return a.keyPath.indexOf(b)>=0})){for(var c=0;c<b.length;++c)if(b.indexOf(a.keyPath[c])===-1)return!1;return!0}return!1}).sort(function(a,b){return a.keyPath.length-b.keyPath.length})[0];if(c&&this.db._maxKey!==zb){var d=c.keyPath.slice(0,b.length);return this.where(d).equals(d.map(function(b){return a[b]}))}!c&&G&&!1;var e=this.schema.idxByName,f=this.db._deps.indexedDB;function i(a,b){return f.cmp(a,b)===0}d=b.reduce(function(b,c){var d=b[0];b=b[1];var f=e[c],g=a[c];return[d||f,d||!f?Gb(b,f&&f.multi?function(a){a=w(a,c);return h(a)&&a.some(function(a){return i(g,a)})}:function(a){return i(g,w(a,c))}):b]},[null,null]);var j=d[0];d=d[1];return j?this.where(j.name).equals(a[j.keyPath]).filter(d):c?this.filter(d):this.where(b).equals("")};a.prototype.filter=function(a){return this.toCollection().and(a)};a.prototype.count=function(a){return this.toCollection().count(a)};a.prototype.offset=function(a){return this.toCollection().offset(a)};a.prototype.limit=function(a){return this.toCollection().limit(a)};a.prototype.each=function(a){return this.toCollection().each(a)};a.prototype.toArray=function(a){return this.toCollection().toArray(a)};a.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))};a.prototype.orderBy=function(a){return new this.db.Collection(new this.db.WhereClause(this,h(a)?"[".concat(a.join("+"),"]"):a))};a.prototype.reverse=function(){return this.toCollection().reverse()};a.prototype.mapToClass=function(a){var b=this,d=b.db,e=b.name;this.schema.mappedClass=a;a.prototype instanceof Jb&&(a=function(a){c(b,a);function b(){return a!==null&&a.apply(this,arguments)||this}Object.defineProperty(b.prototype,"db",{get:function(){return d},enumerable:!1,configurable:!0});b.prototype.table=function(){return e};return b}(a));var f=new Set();for(b=a.prototype;b;b=j(b))Object.getOwnPropertyNames(b).forEach(function(a){return f.add(a)});b=function(b){if(!b)return b;var c=Object.create(a.prototype);for(var d in b)if(!f.has(d))try{c[d]=b[d]}catch(a){}return c};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);this.schema.readHook=b;this.hook("reading",b);return a};a.prototype.defineClass=function(){function a(a){i(this,a)}return this.mapToClass(a)};a.prototype.add=function(a,b){var c=this,d=this.schema.primKey,e=d.auto,f=d.keyPath,g=a;f&&e&&(g=Ib(f)(a));return this._trans("readwrite",function(a){return c.core.mutate({trans:a,type:"add",keys:b!=null?[b]:null,values:[g]})}).then(function(a){return a.numFailures?K.reject(a.failures[0]):a.lastResult}).then(function(b){if(f)try{x(a,f,b)}catch(a){}return b})};a.prototype.update=function(a,b){if(typeof a==="object"&&!h(a)){var c=w(a,this.schema.primKey.keyPath);return c===void 0?Q(new D.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(c).modify(b)}else return this.where(":id").equals(a).modify(b)};a.prototype.put=function(a,b){var c=this,d=this.schema.primKey,e=d.auto,f=d.keyPath,g=a;f&&e&&(g=Ib(f)(a));return this._trans("readwrite",function(a){return c.core.mutate({trans:a,type:"put",values:[g],keys:b!=null?[b]:null})}).then(function(a){return a.numFailures?K.reject(a.failures[0]):a.lastResult}).then(function(b){if(f)try{x(a,f,b)}catch(a){}return b})};a.prototype["delete"]=function(a){var b=this;return this._trans("readwrite",function(c){return b.core.mutate({trans:c,type:"delete",keys:[a]})}).then(function(a){return a.numFailures?K.reject(a.failures[0]):void 0})};a.prototype.clear=function(){var a=this;return this._trans("readwrite",function(b){return a.core.mutate({trans:b,type:"deleteRange",range:Hb})}).then(function(a){return a.numFailures?K.reject(a.failures[0]):void 0})};a.prototype.bulkGet=function(a){var b=this;return this._trans("readonly",function(c){return b.core.getMany({keys:a,trans:c}).then(function(a){return a.map(function(a){return b.hook.reading.fire(a)})})})};a.prototype.bulkAdd=function(b,c,d){var e=this,a=Array.isArray(c)?c:void 0;d=d||(a?void 0:c);var f=d?d.allKeys:void 0;return this._trans("readwrite",function(c){var d=e.schema.primKey,g=d.auto;d=d.keyPath;if(d&&a)throw new D.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(a&&a.length!==b.length)throw new D.InvalidArgument("Arguments objects and keys must have the same length");var h=b.length;g=d&&g?b.map(Ib(d)):b;return e.core.mutate({trans:c,type:"add",keys:a,values:g,wantResults:f}).then(function(a){var b=a.numFailures,c=a.results,d=a.lastResult;a=a.failures;c=f?c:d;if(b===0)return c;throw new va("".concat(e.name,".bulkAdd(): ").concat(b," of ").concat(h," operations failed"),a)})})};a.prototype.bulkPut=function(b,c,d){var e=this,a=Array.isArray(c)?c:void 0;d=d||(a?void 0:c);var f=d?d.allKeys:void 0;return this._trans("readwrite",function(c){var d=e.schema.primKey,g=d.auto;d=d.keyPath;if(d&&a)throw new D.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(a&&a.length!==b.length)throw new D.InvalidArgument("Arguments objects and keys must have the same length");var h=b.length;g=d&&g?b.map(Ib(d)):b;return e.core.mutate({trans:c,type:"put",keys:a,values:g,wantResults:f}).then(function(a){var b=a.numFailures,c=a.results,d=a.lastResult;a=a.failures;c=f?c:d;if(b===0)return c;throw new va("".concat(e.name,".bulkPut(): ").concat(b," of ").concat(h," operations failed"),a)})})};a.prototype.bulkUpdate=function(b){var c=this,d=this.core,a=b.map(function(a){return a.key}),e=b.map(function(a){return a.changes}),f=[];return this._trans("readwrite",function(g){return d.getMany({trans:g,keys:a,cache:"clone"}).then(function(h){var i=[],j=[];b.forEach(function(a,b){var d=a.key;a=a.changes;var e=h[b];if(e){for(var g=0,k=Object.keys(a);g<k.length;g++){var l=k[g],m=a[l];if(l===c.schema.primKey.keyPath){if(S(m,d)!==0)throw new D.Constraint("Cannot update primary key in bulkUpdate()")}else x(e,l,m)}f.push(b);i.push(d);j.push(e)}});var k=i.length;return d.mutate({trans:g,type:"put",keys:i,values:j,updates:{keys:a,changeSpecs:e}}).then(function(a){var b=a.numFailures;a=a.failures;if(b===0)return k;for(var d=0,e=Object.keys(a);d<e.length;d++){var g=e[d],h=f[Number(g)];if(h!=null){var i=a[g];delete a[g];a[h]=i}}throw new va("".concat(c.name,".bulkUpdate(): ").concat(b," of ").concat(k," operations failed"),a)})})})};a.prototype.bulkDelete=function(a){var b=this,c=a.length;return this._trans("readwrite",function(c){return b.core.mutate({trans:c,type:"delete",keys:a})}).then(function(a){var d=a.numFailures,e=a.lastResult;a=a.failures;if(d===0)return e;throw new va("".concat(b.name,".bulkDelete(): ").concat(d," of ").concat(c," operations failed"),a)})};return a}();function Pb(a){var b={},c=function(d,e){if(e){var c=arguments.length,f=new Array(c-1);while(--c)f[c-1]=arguments[c];b[d].subscribe.apply(null,f);return a}else if(typeof d==="string")return b[d]};c.addEventType=f;for(var d=1,e=arguments.length;d<e;++d)f(arguments[d]);return c;function f(a,d,e){if(typeof a==="object")return i(a);d||(d=Fa);e||(e=E);var f={subscribers:[],fire:e,subscribe:function(a){f.subscribers.indexOf(a)===-1&&(f.subscribers.push(a),f.fire=d(f.fire,a))},unsubscribe:function(a){f.subscribers=f.subscribers.filter(function(b){return b!==a}),f.fire=f.subscribers.reduce(d,e)}};b[a]=c[a]=f;return f}function i(a){g(a).forEach(function(b){var c=a[b];if(h(c))f(b,a[b][0],a[b][1]);else if(c==="asap")var d=f(b,Aa,function(){var a=arguments.length,b=new Array(a);while(a--)b[a]=arguments[a];d.subscribers.forEach(function(a){aa(function(){a.apply(null,b)})})});else throw new D.InvalidArgument("Invalid event config")})}}function Qb(a,b){p(b).from({prototype:a});return b}function Rb(a){return Qb(Ob.prototype,function(b,c,d){this.db=a,this._tx=d,this.name=b,this.schema=c,this.hook=a._allTables[b]?a._allTables[b].hook:Pb(null,{creating:[Ca,E],reading:[Ba,Aa],updating:[Ea,E],deleting:[Da,E]})})}function Sb(a,b){return!(a.filter||a.algorithm||a.or)&&(b?a.justLimit:!a.replayFilter)}function Tb(a,b){a.filter=Gb(a.filter,b)}function Ub(a,b,c){var d=a.replayFilter;a.replayFilter=d?function(){return Gb(d(),b())}:b;a.justLimit=c&&!d}function Vb(a,b){a.isMatch=Gb(a.isMatch,b)}function Wb(a,b){if(a.isPrimKey)return b.primaryKey;var c=b.getIndexByKeyPath(a.index);if(!c)throw new D.Schema("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return c}function Xb(a,b,c){var d=Wb(a,b.schema);return b.openCursor({trans:c,values:!a.keysOnly,reverse:a.dir==="prev",unique:!!a.unique,query:{index:d,range:a.range}})}function Yb(a,b,c,d){var e=a.replayFilter?Gb(a.filter,a.replayFilter()):a.filter;if(!a.or)return Zb(Xb(a,d,c),Gb(a.algorithm,e),b,!a.keysOnly&&a.valueMapper);else{var f={},g=function(a,c,d){if(!e||e(c,d,function(a){return c.stop(a)},function(a){return c.fail(a)})){var g=c.primaryKey,h=""+g;h==="[object ArrayBuffer]"&&(h=""+new Uint8Array(g));l(f,h)||(f[h]=!0,b(a,c,d))}};return Promise.all([a.or._iterate(g,c),Zb(Xb(a,d,c),a.algorithm,g,!a.keysOnly&&a.valueMapper)])}}function Zb(a,b,c,d){var e=d?function(a,b,e){return c(d(a),b,e)}:c,f=L(e);return a.then(function(a){if(a)return a.start(function(){var c=function(){return a["continue"]()};(!b||b(a,function(a){return c=a},function(b){a.stop(b),c=E},function(b){a.fail(b),c=E}))&&f(a.value,a,function(a){return c=a});c()})})}y=Symbol();var $b=function(){function a(a){Object.assign(this,a)}a.prototype.execute=function(a){var b;b=(b=this.replacePrefix)===null||b===void 0?void 0:b[0];return b&&typeof a==="string"&&a.startsWith(b)?this.replacePrefix[1]+a.substring(b.length):a};return a}(),ac=function(){function a(){}a.prototype._read=function(a,b){var c=this._ctx;return c.error?c.table._trans(null,Q.bind(null,c.error)):c.table._trans("readonly",a).then(b)};a.prototype._write=function(a){var b=this._ctx;return b.error?b.table._trans(null,Q.bind(null,b.error)):b.table._trans("readwrite",a,"locked")};a.prototype._addAlgorithm=function(a){var b=this._ctx;b.algorithm=Gb(b.algorithm,a)};a.prototype._iterate=function(a,b){return Yb(this._ctx,a,b,this._ctx.table.core)};a.prototype.clone=function(a){var b=Object.create(this.constructor.prototype),c=Object.create(this._ctx);a&&i(c,a);b._ctx=c;return b};a.prototype.raw=function(){this._ctx.valueMapper=null;return this};a.prototype.each=function(a){var b=this._ctx;return this._read(function(c){return Yb(b,a,c,b.table.core)})};a.prototype.count=function(a){var b=this;return this._read(function(a){var c=b._ctx,d=c.table.core;if(Sb(c,!0))return d.count({trans:a,query:{index:Wb(c,d.schema),range:c.range}}).then(function(a){return Math.min(a,c.limit)});else{var e=0;return Yb(c,function(){++e;return!1},a,d).then(function(){return e})}}).then(a)};a.prototype.sortBy=function(a,b){var c=a.split(".").reverse(),d=c[0],e=c.length-1;function f(a,b){return b?f(a[c[b]],b-1):a[d]}var g=this._ctx.dir==="next"?1:-1;function h(a,b){a=f(a,e);b=f(b,e);return a<b?-g:a>b?g:0}return this.toArray(function(a){return a.sort(h)}).then(b)};a.prototype.toArray=function(a){var b=this;return this._read(function(a){var c=b._ctx;if(c.dir==="next"&&Sb(c,!0)&&c.limit>0){var d=c.valueMapper,e=Wb(c,c.table.core.schema);return c.table.core.query({trans:a,limit:c.limit,values:!0,query:{index:e,range:c.range}}).then(function(a){a=a.result;return d?a.map(d):a})}else{var f=[];return Yb(c,function(a){return f.push(a)},a,c.table.core).then(function(){return f})}},a)};a.prototype.offset=function(a){var b=this._ctx;if(a<=0)return this;b.offset+=a;Sb(b)?Ub(b,function(){var b=a;return function(a,c){if(b===0)return!0;if(b===1){--b;return!1}c(function(){a.advance(b),b=0});return!1}}):Ub(b,function(){var b=a;return function(){return--b<0}});return this};a.prototype.limit=function(a){this._ctx.limit=Math.min(this._ctx.limit,a);Ub(this._ctx,function(){var b=a;return function(a,c,d){--b<=0&&c(d);return b>=0}},!0);return this};a.prototype.until=function(a,b){Tb(this._ctx,function(c,d,e){if(a(c.value)){d(e);return b}else return!0});return this};a.prototype.first=function(a){return this.limit(1).toArray(function(a){return a[0]}).then(a)};a.prototype.last=function(a){return this.reverse().first(a)};a.prototype.filter=function(a){Tb(this._ctx,function(b){return a(b.value)});Vb(this._ctx,a);return this};a.prototype.and=function(a){return this.filter(a)};a.prototype.or=function(a){return new this.db.WhereClause(this._ctx.table,a,this)};a.prototype.reverse=function(){this._ctx.dir=this._ctx.dir==="prev"?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this};a.prototype.desc=function(){return this.reverse()};a.prototype.eachKey=function(a){var b=this._ctx;b.keysOnly=!b.isMatch;return this.each(function(b,c){a(c.key,c)})};a.prototype.eachUniqueKey=function(a){this._ctx.unique="unique";return this.eachKey(a)};a.prototype.eachPrimaryKey=function(a){var b=this._ctx;b.keysOnly=!b.isMatch;return this.each(function(b,c){a(c.primaryKey,c)})};a.prototype.keys=function(a){var b=this._ctx;b.keysOnly=!b.isMatch;var c=[];return this.each(function(a,b){c.push(b.key)}).then(function(){return c}).then(a)};a.prototype.primaryKeys=function(a){var b=this._ctx;if(b.dir==="next"&&Sb(b,!0)&&b.limit>0)return this._read(function(a){var c=Wb(b,b.table.core.schema);return b.table.core.query({trans:a,values:!1,limit:b.limit,query:{index:c,range:b.range}})}).then(function(a){a=a.result;return a}).then(a);b.keysOnly=!b.isMatch;var c=[];return this.each(function(a,b){c.push(b.primaryKey)}).then(function(){return c}).then(a)};a.prototype.uniqueKeys=function(a){this._ctx.unique="unique";return this.keys(a)};a.prototype.firstKey=function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)};a.prototype.lastKey=function(a){return this.reverse().firstKey(a)};a.prototype.distinct=function(){var a=this._ctx;a=a.index&&a.table.schema.idxByName[a.index];if(!a||!a.multi)return this;var b={};Tb(this._ctx,function(a){a=a.primaryKey.toString();var c=l(b,a);b[a]=!0;return!c});return this};a.prototype.modify=function(a){var b=this,c=this._ctx;return this._write(function(d){var e;if(typeof a==="function")e=a;else{var f=g(a),h=f.length;e=function(b){var c=!1;for(var d=0;d<h;++d){var e=f[d],g=a[e],i=w(b,e);g instanceof $b?(x(b,e,g.execute(i)),c=!0):i!==g&&(x(b,e,g),c=!0)}return c}}var i=c.table.core,j=i.schema.primaryKey,k=j.outbound,l=j.extractKey,m=b.db._options.modifyChunkSize||200,n=[],o=0,p=[],q=function(a,b){var c=b.failures;b=b.numFailures;o+=a-b;for(a=0,b=g(c);a<b.length;a++){var d=b[a];n.push(c[d])}};return b.clone().primaryKeys().then(function(b){var f=function(g){var h=Math.min(m,b.length-g);return i.getMany({trans:d,keys:b.slice(g,g+h),cache:"immutable"}).then(function(j){var n=[],o=[],p=k?[]:null,r=[];for(var s=0;s<h;++s){var t=j[s],u={value:z(t),primKey:b[g+s]};e.call(u,u.value,u)!==!1&&(u.value==null?r.push(b[g+s]):!k&&S(l(t),l(u.value))!==0?(r.push(b[g+s]),n.push(u.value)):(o.push(u.value),k&&p.push(b[g+s])))}var v=Sb(c)&&c.limit===Infinity&&(typeof a!=="function"||a===bc)&&{index:c.index,range:c.range};return Promise.resolve(n.length>0&&i.mutate({trans:d,type:"add",values:n}).then(function(a){for(var b in a.failures)r.splice(parseInt(b),1);q(n.length,a)})).then(function(){return(o.length>0||v&&typeof a==="object")&&i.mutate({trans:d,type:"put",keys:p,values:o,criteria:v,changeSpec:typeof a!=="function"&&a}).then(function(a){return q(o.length,a)})}).then(function(){return(r.length>0||v&&a===bc)&&i.mutate({trans:d,type:"delete",keys:r,criteria:v}).then(function(a){return q(r.length,a)})}).then(function(){return b.length>g+h&&f(g+m)})})};return f(0).then(function(){if(n.length>0)throw new ua("Error modifying one or more objects",n,o,p);return b.length})})})};a.prototype["delete"]=function(){var a=this._ctx,b=a.range;return Sb(a)&&(a.isPrimKey||b.type===3)?this._write(function(c){var d=a.table.core.schema.primaryKey,e=b;return a.table.core.count({trans:c,query:{index:d,range:e}}).then(function(b){return a.table.core.mutate({trans:c,type:"deleteRange",range:e}).then(function(a){var c=a.failures;a.lastResult;a.results;a=a.numFailures;if(a)throw new ua("Could not delete some values",Object.keys(c).map(function(a){return c[a]}),b-a);return b-a})})}):this.modify(bc)};return a}(),bc=function(a,b){return b.value=null};function cc(a){return Qb(ac.prototype,function(b,c){this.db=a;var d=Hb,e=null;if(c)try{d=c()}catch(a){e=a}c=b._ctx;b=c.table;var f=b.hook.reading.fire;this._ctx={table:b,index:c.index,isPrimKey:!c.index||b.schema.primKey.keyPath&&c.index===b.schema.primKey.name,range:d,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:Infinity,error:e,or:c.or,valueMapper:f!==Aa?f:null}})}function dc(a,b){return a<b?-1:a===b?0:1}function ec(a,b){return a>b?-1:a===b?0:1}function T(a,b,c){a=a instanceof lc?new a.Collection(a):a;a._ctx.error=c?new c(b):new TypeError(b);return a}function fc(a){return new a.Collection(a,function(){return kc("")}).limit(0)}function gc(a){return a==="next"?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function hc(a){return a==="next"?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function ic(b,c,d,e,a,f){var g=Math.min(b.length,e.length),h=-1;for(var i=0;i<g;++i){var j=c[i];if(j!==e[i]){if(a(b[i],d[i])<0)return b.substr(0,i)+d[i]+d.substr(i+1);if(a(b[i],e[i])<0)return b.substr(0,i)+e[i]+d.substr(i+1);return h>=0?b.substr(0,h)+c[h]+d.substr(h+1):null}a(b[i],j)<0&&(h=i)}if(g<e.length&&f==="next")return b+d.substr(b.length);return g<b.length&&f==="prev"?b.substr(0,d.length):h<0?null:b.substr(0,h)+e[h]+d.substr(h+1)}function jc(a,b,c,d){var e,f,g,h,i,j,k,l=c.length;if(!c.every(function(a){return typeof a==="string"}))return T(a,Bb);function m(a){e=gc(a);f=hc(a);g=a==="next"?dc:ec;var b=c.map(function(a){return{lower:f(a),upper:e(a)}}).sort(function(a,b){return g(a.lower,b.lower)});h=b.map(function(a){return a.upper});i=b.map(function(a){return a.lower});j=a;k=a==="next"?"":d}m("next");a=new a.Collection(a,function(){return U(h[0],i[l-1]+d)});a._ondirectionchange=function(a){m(a)};var n=0;a._addAlgorithm(function(a,c,d){var e=a.key;if(typeof e!=="string")return!1;var m=f(e);if(b(m,i,n))return!0;else{var o=null;for(var p=n;p<l;++p){var q=ic(e,m,h[p],i[p],g,j);q===null&&o===null?n=p+1:(o===null||g(o,q)>0)&&(o=q)}o!==null?c(function(){a["continue"](o+k)}):c(d);return!1}});return a}function U(a,b,c,d){return{type:2,lower:a,upper:b,lowerOpen:c,upperOpen:d}}function kc(a){return{type:1,lower:a,upper:a}}var lc=function(){function a(){}Object.defineProperty(a.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0});a.prototype.between=function(a,b,c,d){c=c!==!1;d=d===!0;try{return this._cmp(a,b)>0||this._cmp(a,b)===0&&(c||d)&&!(c&&d)?fc(this):new this.Collection(this,function(){return U(a,b,!c,!d)})}catch(a){return T(this,R)}};a.prototype.equals=function(a){return a==null?T(this,R):new this.Collection(this,function(){return kc(a)})};a.prototype.above=function(a){return a==null?T(this,R):new this.Collection(this,function(){return U(a,void 0,!0)})};a.prototype.aboveOrEqual=function(a){return a==null?T(this,R):new this.Collection(this,function(){return U(a,void 0,!1)})};a.prototype.below=function(a){return a==null?T(this,R):new this.Collection(this,function(){return U(void 0,a,!1,!0)})};a.prototype.belowOrEqual=function(a){return a==null?T(this,R):new this.Collection(this,function(){return U(void 0,a)})};a.prototype.startsWith=function(a){return typeof a!=="string"?T(this,Bb):this.between(a,a+zb,!0,!0)};a.prototype.startsWithIgnoreCase=function(a){return a===""?this.startsWith(a):jc(this,function(a,b){return a.indexOf(b[0])===0},[a],zb)};a.prototype.equalsIgnoreCase=function(a){return jc(this,function(a,b){return a===b[0]},[a],"")};a.prototype.anyOfIgnoreCase=function(){var a=B.apply(pa,arguments);return a.length===0?fc(this):jc(this,function(a,b){return b.indexOf(a)!==-1},a,"")};a.prototype.startsWithAnyOfIgnoreCase=function(){var a=B.apply(pa,arguments);return a.length===0?fc(this):jc(this,function(a,b){return b.some(function(b){return a.indexOf(b)===0})},a,zb)};a.prototype.anyOf=function(){var a=this,b=B.apply(pa,arguments),c=this._cmp;try{b.sort(c)}catch(a){return T(this,R)}if(b.length===0)return fc(this);var d=new this.Collection(this,function(){return U(b[0],b[b.length-1])});d._ondirectionchange=function(d){c=d==="next"?a._ascending:a._descending,b.sort(c)};var e=0;d._addAlgorithm(function(a,d,f){var g=a.key;while(c(g,b[e])>0){++e;if(e===b.length){d(f);return!1}}if(c(g,b[e])===0)return!0;else{d(function(){a["continue"](b[e])});return!1}});return d};a.prototype.notEqual=function(a){return this.inAnyRange([[Ab,a],[a,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})};a.prototype.noneOf=function(){var a=B.apply(pa,arguments);if(a.length===0)return new this.Collection(this);try{a.sort(this._ascending)}catch(a){return T(this,R)}var b=a.reduce(function(a,b){return a?a.concat([[a[a.length-1][1],b]]):[[Ab,b]]},null);b.push([a[a.length-1],this.db._maxKey]);return this.inAnyRange(b,{includeLowers:!1,includeUppers:!1})};a.prototype.inAnyRange=function(c,d){var e=this,a=this._cmp,f=this._ascending,g=this._descending,h=this._min,i=this._max;if(c.length===0)return fc(this);if(!c.every(function(a){return a[0]!==void 0&&a[1]!==void 0&&f(a[0],a[1])<=0}))return T(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",D.InvalidArgument);var j=!d||d.includeLowers!==!1,k=d&&d.includeUppers===!0;function b(b,c){var d=0,e=b.length;for(;d<e;++d){var f=b[d];if(a(c[0],f[1])<0&&a(c[1],f[0])>0){f[0]=h(f[0],c[0]);f[1]=i(f[1],c[1]);break}}d===e&&b.push(c);return b}var l=f;function m(a,b){return l(a[0],b[0])}var n;try{n=c.reduce(b,[]),n.sort(m)}catch(a){return T(this,R)}var o=0,p=k?function(a){return f(a,n[o][1])>0}:function(a){return f(a,n[o][1])>=0},q=j?function(a){return g(a,n[o][0])>0}:function(a){return g(a,n[o][0])>=0};function r(a){return!p(a)&&!q(a)}var s=p;d=new this.Collection(this,function(){return U(n[0][0],n[n.length-1][1],!j,!k)});d._ondirectionchange=function(a){a==="next"?(s=p,l=f):(s=q,l=g),n.sort(m)};d._addAlgorithm(function(a,b,c){var d=a.key;while(s(d)){++o;if(o===n.length){b(c);return!1}}if(r(d))return!0;else if(e._cmp(d,n[o][1])===0||e._cmp(d,n[o][0])===0)return!1;else{b(function(){l===f?a["continue"](n[o][0]):a["continue"](n[o][1])});return!1}});return d};a.prototype.startsWithAnyOf=function(){var a=B.apply(pa,arguments);if(!a.every(function(a){return typeof a==="string"}))return T(this,"startsWithAnyOf() only works with strings");return a.length===0?fc(this):this.inAnyRange(a.map(function(a){return[a,a+zb]}))};return a}();function mc(a){return Qb(lc.prototype,function(b,c,d){this.db=a;this._ctx={table:b,index:c===":id"?null:c,or:d};this._cmp=this._ascending=S;this._descending=function(a,b){return S(b,a)};this._max=function(a,b){return S(a,b)>0?a:b};this._min=function(a,b){return S(a,b)<0?a:b};this._IDBKeyRange=a._deps.IDBKeyRange;if(!this._IDBKeyRange)throw new D.MissingAPI()})}function V(a){return L(function(b){nc(b);a(b.target.error);return!1})}function nc(a){a.stopPropagation&&a.stopPropagation(),a.preventDefault&&a.preventDefault()}var oc="storagemutated",pc="x-storagemutated-1",W=Pb(null,oc),qc=function(){function a(){}a.prototype._lock=function(){v(!J.global);++this._reculock;this._reculock===1&&!J.global&&(J.lockOwnerFor=this);return this};a.prototype._unlock=function(){v(!J.global);if(--this._reculock===0){J.global||(J.lockOwnerFor=null);while(this._blockedFuncs.length>0&&!this._locked()){var a=this._blockedFuncs.shift();try{vb(a[1],a[0])}catch(a){}}}return this};a.prototype._locked=function(){return this._reculock&&J.lockOwnerFor!==this};a.prototype.create=function(a){var b=this;if(!this.mode)return this;var c=this.db.idbdb,d=this.db._state.dbOpenError;v(!this.idbtrans);if(!a&&!c)switch(d&&d.name){case"DatabaseClosedError":throw new D.DatabaseClosed(d);case"MissingAPIError":throw new D.MissingAPI(d.message,d);default:throw new D.OpenFailed(d)}if(!this.active)throw new D.TransactionInactive();v(this._completion._state===null);a=this.idbtrans=a||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):c.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}));a.onerror=L(function(c){nc(c),b._reject(a.error)});a.onabort=L(function(c){nc(c),b.active&&b._reject(new D.Abort(a.error)),b.active=!1,b.on("abort").fire(c)});a.oncomplete=L(function(){b.active=!1,b._resolve(),"mutatedParts"in a&&W.storagemutated.fire(a.mutatedParts)});return this};a.prototype._promise=function(a,b,c){var d=this;if(a==="readwrite"&&this.mode!=="readwrite")return Q(new D.ReadOnly("Transaction is readonly"));if(!this.active)return Q(new D.TransactionInactive());if(this._locked())return new K(function(e,f){d._blockedFuncs.push([function(){d._promise(a,b,c).then(e,f)},J])});else if(c)return N(function(){var a=new K(function(a,c){d._lock();var e=b(a,c,d);e&&e.then&&e.then(a,c)});a["finally"](function(){return d._unlock()});a._lib=!0;return a});else{var e=new K(function(a,c){var e=b(a,c,d);e&&e.then&&e.then(a,c)});e._lib=!0;return e}};a.prototype._root=function(){return this.parent?this.parent._root():this};a.prototype.waitFor=function(a){var b=this._root(),c=K.resolve(a);if(b._waitingFor)b._waitingFor=b._waitingFor.then(function(){return c});else{b._waitingFor=c;b._waitingQueue=[];var d=b.idbtrans.objectStore(b.storeNames[0]);(function a(){++b._spinCount;while(b._waitingQueue.length)b._waitingQueue.shift()();b._waitingFor&&(d.get(-Infinity).onsuccess=a)})()}var e=b._waitingFor;return new K(function(a,d){c.then(function(c){return b._waitingQueue.push(L(a.bind(null,c)))},function(a){return b._waitingQueue.push(L(d.bind(null,a)))})["finally"](function(){b._waitingFor===e&&(b._waitingFor=null)})})};a.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new D.Abort()))};a.prototype.table=function(a){var b=this._memoizedTables||(this._memoizedTables={});if(l(b,a))return b[a];var c=this.schema[a];if(!c)throw new D.NotFound("Table "+a+" not part of transaction");c=new this.db.Table(a,c,this);c.core=this.db.core.table(a);b[a]=c;return c};return a}();function rc(a){return Qb(qc.prototype,function(b,c,d,e,f){var g=this;this.db=a;this.mode=b;this.storeNames=c;this.schema=d;this.chromeTransactionDurability=e;this.idbtrans=null;this.on=Pb(this,"complete","error","abort");this.parent=f||null;this.active=!0;this._reculock=0;this._blockedFuncs=[];this._resolve=null;this._reject=null;this._waitingFor=null;this._waitingQueue=null;this._spinCount=0;this._completion=new K(function(a,b){g._resolve=a,g._reject=b});this._completion.then(function(){g.active=!1,g.on.complete.fire()},function(a){var b=g.active;g.active=!1;g.on.error.fire(a);g.parent?g.parent._reject(a):b&&g.idbtrans&&g.idbtrans.abort();return Q(a)})})}function sc(a,b,c,d,e,f,g){return{name:a,keyPath:b,unique:c,multi:d,auto:e,compound:f,src:(c&&!g?"&":"")+(d?"*":"")+(e?"++":"")+tc(b)}}function tc(a){return typeof a==="string"?a:a?"["+[].join.call(a,"+")+"]":""}function uc(a,b,c){return{name:a,primKey:b,indexes:c,mappedClass:null,idxByName:ba(c,function(a){return[a.name,a]})}}function vc(a){return a.length===1?a[0]:a}var wc=function(a){try{a.only([[]]);wc=function(){return[[]]};return[[]]}catch(a){wc=function(){return zb};return zb}};function xc(a){if(a==null)return function(){return void 0};else if(typeof a==="string")return yc(a);else return function(b){return w(b,a)}}function yc(a){var b=a.split(".");if(b.length===1)return function(b){return b[a]};else return function(b){return w(b,a)}}function zc(a){return[].slice.call(a)}var Ac=0;function Bc(a){return a==null?":id":typeof a==="string"?a:"[".concat(a.join("+"),"]")}function Cc(a,b,c){function d(a,b){var c=zc(a.objectStoreNames);return{schema:{name:a.name,tables:c.map(function(a){return b.objectStore(a)}).map(function(a){var b=a.keyPath,c=a.autoIncrement,d=h(b),e=b==null,f={};e={name:a.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:e,compound:d,keyPath:b,autoIncrement:c,unique:!0,extractKey:xc(b)},indexes:zc(a.indexNames).map(function(b){return a.index(b)}).map(function(b){var c=b.name,d=b.unique,e=b.multiEntry;b=b.keyPath;var a=h(b);c={name:c,compound:a,keyPath:b,unique:d,multiEntry:e,extractKey:xc(b)};f[Bc(b)]=c;return c}),getIndexByKeyPath:function(a){return f[Bc(a)]}};f[":id"]=e.primaryKey;b!=null&&(f[Bc(b)]=e.primaryKey);return e})},hasGetAll:c.length>0&&"getAll"in b.objectStore(c[0])&&!(typeof navigator!=="undefined"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}function e(a){if(a.type===3)return null;if(a.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var c=a.lower,d=a.upper,e=a.lowerOpen;a=a.upperOpen;c=c===void 0?d===void 0?null:b.upperBound(d,!!a):d===void 0?b.lowerBound(c,!!e):b.bound(c,d,!!e,!!a);return c}function f(b){var c=b.name;function d(d){var f=d.trans,b=d.type,a=d.keys,g=d.values,h=d.range;return new Promise(function(d,i){d=L(d);i=f.objectStore(c);var j=i.keyPath==null,k=b==="put"||b==="add";if(!k&&b!=="delete"&&b!=="deleteRange")throw new Error("Invalid operation type: "+b);var l=(a||g||{length:1}).length;if(a&&g&&a.length!==g.length)throw new Error("Given keys array must have same length as given values array.");if(l===0)return d({numFailures:0,failures:{},results:[],lastResult:void 0});var m,n=[],o=[],p=0,q=function(a){++p,nc(a)};if(b==="deleteRange"){if(h.type===4)return d({numFailures:p,failures:o,results:[],lastResult:void 0});h.type===3?n.push(m=i.clear()):n.push(m=i["delete"](e(h)))}else{j=k?j?[g,a]:[g,null]:[a,null];var r=j[0];j=j[1];if(k)for(k=0;k<l;++k)n.push(m=j&&j[k]!==void 0?i[b](r[k],j[k]):i[b](r[k])),m.onerror=q;else for(k=0;k<l;++k)n.push(m=i[b](r[k])),m.onerror=q}var s=function(c){c=c.target.result;n.forEach(function(a,b){return a.error!=null&&(o[b]=a.error)});d({numFailures:p,failures:o,results:b==="delete"?a:n.map(function(a){return a.result}),lastResult:c})};m.onerror=function(a){q(a),s(a)};m.onsuccess=s})}function a(b){var d=b.trans,f=b.values,a=b.query,g=b.reverse,h=b.unique;return new Promise(function(b,i){b=L(b);var j=a.index,k=a.range,l=d.objectStore(c);l=j.isPrimaryKey?l:l.index(j.name);j=g?h?"prevunique":"prev":h?"nextunique":"next";var m=f||!("openKeyCursor"in l)?l.openCursor(e(k),j):l.openKeyCursor(e(k),j);m.onerror=V(i);m.onsuccess=L(function(a){var c=m.result;if(!c){b(null);return}c.___id=++Ac;c.done=!1;var e=c["continue"].bind(c),f=c.continuePrimaryKey;f&&(f=f.bind(c));var g=c.advance.bind(c);a=function(){throw new Error("Cursor not started")};var h=function(){throw new Error("Cursor not stopped")};c.trans=d;c.stop=c["continue"]=c.continuePrimaryKey=c.advance=a;c.fail=L(i);c.next=function(){var a=this,b=1;return this.start(function(){return b--?a["continue"]():a.stop()}).then(function(){return a})};c.start=function(a){var b=new Promise(function(a,b){a=L(a),m.onerror=V(b),c.fail=b,c.stop=function(b){c.stop=c["continue"]=c.continuePrimaryKey=c.advance=h,a(b)}}),d=function(){if(m.result)try{a()}catch(a){c.fail(a)}else c.done=!0,c.start=function(){throw new Error("Cursor behind last entry")},c.stop()};m.onsuccess=L(function(a){m.onsuccess=d,d()});c["continue"]=e;c.continuePrimaryKey=f;c.advance=g;d();return b};b(c)},i)})}function f(a){return function(b){return new Promise(function(f,g){f=L(f);var h=b.trans,i=b.values,j=b.limit,d=b.query,k=j===Infinity?void 0:j,l=d.index;d=d.range;h=h.objectStore(c);h=l.isPrimaryKey?h:h.index(l.name);l=e(d);if(j===0)return f({result:[]});if(a){d=i?h.getAll(l,k):h.getAllKeys(l,k);d.onsuccess=function(a){return f({result:a.target.result})};d.onerror=V(g)}else{var m=0,n=i||!("openKeyCursor"in h)?h.openCursor(l):h.openKeyCursor(l),o=[];n.onsuccess=function(a){a=n.result;if(!a)return f({result:o});o.push(i?a.value:a.primaryKey);if(++m===j)return f({result:o});a["continue"]()};n.onerror=V(g)}})}}return{name:c,schema:b,mutate:d,getMany:function(b){var d=b.trans,a=b.keys;return new Promise(function(b,e){b=L(b);var f=d.objectStore(c),g=a.length,h=new Array(g),i=0,j=0,k=function(a){a=a.target;(h[a._pos]=a.result)!=null;++j===i&&b(h)};e=V(e);for(var l=0;l<g;++l){var m=a[l];m!=null&&(m=f.get(a[l]),m._pos=l,m.onsuccess=k,m.onerror=e,++i)}i===0&&b(h)})},get:function(a){var b=a.trans,d=a.key;return new Promise(function(a,e){a=L(a);var f=b.objectStore(c);f=f.get(d);f.onsuccess=function(b){return a(b.target.result)};f.onerror=V(e)})},query:f(g),openCursor:a,count:function(b){var a=b.query,d=b.trans,f=a.index,g=a.range;return new Promise(function(a,b){var h=d.objectStore(c);h=f.isPrimaryKey?h:h.index(f.name);var i=e(g);i=i?h.count(i):h.count();i.onsuccess=L(function(b){return a(b.target.result)});i.onerror=V(b)})}}}d=d(a,c);c=d.schema;var g=d.hasGetAll;d=c.tables.map(function(a){return f(a)});var i={};d.forEach(function(a){return i[a.name]=a});return{stack:"dbcore",transaction:a.transaction.bind(a),table:function(a){var b=i[a];if(!b)throw new Error("Table '".concat(a,"' not found"));return i[a]},MIN_KEY:-Infinity,MAX_KEY:wc(b),schema:c}}function Dc(a,b){return b.reduce(function(a,b){b=b.create;return d(d({},a),b(a))},a)}function Ec(a,b,c,d){var e=c.IDBKeyRange;c.indexedDB;c=Dc(Cc(b,e,d),a.dbcore);return{dbcore:c}}function Fc(a,b){var c=b.db;c=Ec(a._middlewares,c,a._deps,b);a.core=c.dbcore;a.tables.forEach(function(b){var c=b.name;a.core.schema.tables.some(function(a){return a.name===c})&&(b.core=a.core.table(c),a[c]instanceof a.Table&&(a[c].core=b.core))})}function Gc(a,b,c,d){c.forEach(function(c){var e=d[c];b.forEach(function(b){var d=r(b,c);(!d||"value"in d&&d.value===void 0)&&(b===a.Transaction.prototype||b instanceof a.Transaction?o(b,c,{get:function(){return this.table(c)},set:function(a){n(this,c,{value:a,writable:!0,configurable:!0,enumerable:!0})}}):b[c]=new a.Table(c,e))})})}function Hc(a,b){b.forEach(function(b){for(var c in b)b[c]instanceof a.Table&&delete b[c]})}function Ic(a,b){return a._cfg.version-b._cfg.version}function Jc(a,b,c,d){var e=a._dbSchema;c.objectStoreNames.contains("$meta")&&!e.$meta&&(e.$meta=uc("$meta",Wc("")[0],[]),a._storeNames.push("$meta"));var f=a._createTransaction("readwrite",a._storeNames,e);f.create(c);f._completion["catch"](d);var h=f._reject.bind(f),i=J.transless||J;N(function(){J.trans=f;J.transless=i;if(b===0)g(e).forEach(function(a){Oc(c,a,e[a].primKey,e[a].indexes)}),Fc(a,c),K.follow(function(){return a.on.populate.fire(f)})["catch"](h);else{Fc(a,c);return Lc(a,f,b).then(function(b){return Mc(a,b,f,c)})["catch"](h)}})}function Kc(a,b){Pc(a._dbSchema,b);b.db.version%10===0&&!b.objectStoreNames.contains("$meta")&&b.db.createObjectStore("$meta").add(Math.ceil(b.db.version/10-1),"version");var c=Sc(a,a.idbdb,b);Vc(a,a._dbSchema,b);c=Nc(c,a._dbSchema);a=function(a){if(a.change.length||a.recreate)return{value:void 0};var c=b.objectStore(a.name);a.add.forEach(function(a){G&&!1,Rc(c,a)})};for(var d=0,c=c.change;d<c.length;d++){var e=c[d];e=a(e);if(typeof e==="object")return e.value}}function Lc(a,b,c){if(b.storeNames.includes("$meta"))return b.table("$meta").get("version").then(function(a){return a!=null?a:c});else return K.resolve(c)}function Mc(a,b,c,d){var e=[],f=a._versions,h=a._dbSchema=Sc(a,a.idbdb,d);f=f.filter(function(a){return a._cfg.version>=b});if(f.length===0)return K.resolve();f.forEach(function(f){e.push(function(){var e=h,i=f._cfg.dbschema;Vc(a,e,d);Vc(a,i,d);h=a._dbSchema=i;var j=Nc(e,i);j.add.forEach(function(a){Oc(d,a[0],a[1].primKey,a[1].indexes)});j.change.forEach(function(a){if(a.recreate)throw new D.Upgrade("Not yet support for changing primary key");else{var b=d.objectStore(a.name);a.add.forEach(function(a){return Rc(b,a)});a.change.forEach(function(a){b.deleteIndex(a.name),Rc(b,a)});a.del.forEach(function(a){return b.deleteIndex(a)})}});var k=f._cfg.contentUpgrade;if(k&&f._cfg.version>b){Fc(a,d);c._memoizedTables={};var l=da(i);j.del.forEach(function(a){l[a]=e[a]});Hc(a,[a.Transaction.prototype]);Gc(a,[a.Transaction.prototype],g(l),l);c.schema=l;var m=qa(k);m&&qb();var n;i=K.follow(function(){n=k(c);if(n&&m){var a=O.bind(null,null);n.then(a,a)}});return n&&typeof n.then==="function"?K.resolve(n):i.then(function(){return n})}}),e.push(function(b){var d=f._cfg.dbschema;Qc(d,b);Hc(a,[a.Transaction.prototype]);Gc(a,[a.Transaction.prototype],a._storeNames,a._dbSchema);c.schema=a._dbSchema}),e.push(function(b){a.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(a.idbdb.version/10)===f._cfg.version?(a.idbdb.deleteObjectStore("$meta"),delete a._dbSchema.$meta,a._storeNames=a._storeNames.filter(function(a){return a!=="$meta"})):b.objectStore("$meta").put(f._cfg.version,"version"))})});function i(){return e.length?K.resolve(e.shift()(c.idbtrans)).then(i):K.resolve()}return i().then(function(){Pc(h,d)})}function Nc(a,b){var c={del:[],add:[],change:[]},d;for(d in a)b[d]||c.del.push(d);for(d in b){var e=a[d],f=b[d];if(!e)c.add.push([d,f]);else{var g={name:d,def:f,recreate:!1,del:[],add:[],change:[]};if(""+(e.primKey.keyPath||"")!==""+(f.primKey.keyPath||"")||e.primKey.auto!==f.primKey.auto)g.recreate=!0,c.change.push(g);else{e=e.idxByName;f=f.idxByName;var h;for(h in e)f[h]||g.del.push(h);for(h in f){var i=e[h],j=f[h];!i?g.add.push(j):i.src!==j.src&&g.change.push(j)}(g.del.length>0||g.add.length>0||g.change.length>0)&&c.change.push(g)}}}return c}function Oc(a,b,c,d){var e=a.db.createObjectStore(b,c.keyPath?{keyPath:c.keyPath,autoIncrement:c.auto}:{autoIncrement:c.auto});d.forEach(function(a){return Rc(e,a)});return e}function Pc(a,b){g(a).forEach(function(c){b.db.objectStoreNames.contains(c)||(G&&!1,Oc(b,c,a[c].primKey,a[c].indexes))})}function Qc(a,b){[].slice.call(b.db.objectStoreNames).forEach(function(c){return a[c]==null&&b.db.deleteObjectStore(c)})}function Rc(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function Sc(a,b,c){var d={};a=t(b.objectStoreNames,0);a.forEach(function(a){var b=c.objectStore(a),e=b.keyPath,f=sc(tc(e),e||"",!0,!1,!!b.autoIncrement,e&&typeof e!=="string",!0),g=[];for(var h=0;h<b.indexNames.length;++h){var i=b.index(b.indexNames[h]);e=i.keyPath;i=sc(i.name,e,!!i.unique,!!i.multiEntry,!1,e&&typeof e!=="string",!1);g.push(i)}d[a]=uc(a,f,g)});return d}function Tc(a,b,c){a.verno=b.version/10;c=a._dbSchema=Sc(a,b,c);a._storeNames=t(b.objectStoreNames,0);Gc(a,[a._allTables],g(c),c)}function Uc(a,b){b=Sc(a,a.idbdb,b);b=Nc(b,a._dbSchema);return!(b.add.length||b.change.some(function(a){return a.add.length||a.change.length}))}function Vc(a,b,c){var d=c.db.objectStoreNames;for(var e=0;e<d.length;++e){var g=d[e],h=c.objectStore(g);a._hasGetAll="getAll"in h;for(var i=0;i<h.indexNames.length;++i){var j=h.indexNames[i],k=h.index(j).keyPath;k=typeof k==="string"?k:"["+t(k).join("+")+"]";if(b[g]){var l=b[g].idxByName[k];l&&(l.name=j,delete b[g].idxByName[k],b[g].idxByName[j]=l)}}}typeof navigator!=="undefined"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&f.WorkerGlobalScope&&f instanceof f.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(a._hasGetAll=!1)}function Wc(a){return a.split(",").map(function(a,b){a=a.trim();var c=a.replace(/([&*]|\+\+)/g,""),d=/^\[/.test(c)?c.match(/^\[(.*)\]$/)[1].split("+"):c;return sc(c,d||null,/\&/.test(a),/\*/.test(a),/\+\+/.test(a),h(d),b===0)})}var Xc=function(){function a(){}a.prototype._parseStoresSpec=function(a,b){g(a).forEach(function(c){if(a[c]!==null){var d=Wc(a[c]),e=d.shift();e.unique=!0;if(e.multi)throw new D.Schema("Primary key cannot be multi-valued");d.forEach(function(a){if(a.auto)throw new D.Schema("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new D.Schema("Index must have a name and cannot be an empty string")});b[c]=uc(c,e,d)}})};a.prototype.stores=function(a){var b=this.db;this._cfg.storesSource=this._cfg.storesSource?i(this._cfg.storesSource,a):a;a=b._versions;var c={},d={};a.forEach(function(a){i(c,a._cfg.storesSource),d=a._cfg.dbschema={},a._parseStoresSpec(c,d)});b._dbSchema=d;Hc(b,[b._allTables,b,b.Transaction.prototype]);Gc(b,[b._allTables,b,b.Transaction.prototype,this._cfg.tables],g(d),d);b._storeNames=g(d);return this};a.prototype.upgrade=function(a){this._cfg.contentUpgrade=Ga(this._cfg.contentUpgrade||E,a);return this};return a}();function Yc(a){return Qb(Xc.prototype,function(b){this.db=a,this._cfg={version:b,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}function Zc(a,b){var c=a._dbNamesDB;c||(c=a._dbNamesDB=new Y(Db,{addons:[],indexedDB:a,IDBKeyRange:b}),c.version(1).stores({dbnames:"name"}));return c.table("dbnames")}function $c(a){return a&&typeof a.databases==="function"}function ad(a){var b=a.indexedDB;a=a.IDBKeyRange;return $c(b)?Promise.resolve(b.databases()).then(function(a){return a.map(function(a){return a.name}).filter(function(a){return a!==Db})}):Zc(b,a).toCollection().primaryKeys()}function bd(a,b){var c=a.indexedDB;a=a.IDBKeyRange;!$c(c)&&b!==Db&&Zc(c,a).put({name:b})["catch"](E)}function cd(a,b){var c=a.indexedDB;a=a.IDBKeyRange;!$c(c)&&b!==Db&&Zc(c,a)["delete"](b)["catch"](E)}function dd(a){return N(function(){J.letThrough=!0;return a()})}function ed(){var a=!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent);if(!a||!indexedDB.databases)return Promise.resolve();var b;return new Promise(function(a){var c=function(){return indexedDB.databases()["finally"](a)};b=setInterval(c,100);c()})["finally"](function(){return clearInterval(b)})}function fd(a){return!("from"in a)}var X=function(a,b){if(this)i(this,arguments.length?{d:1,from:a,to:arguments.length>1?b:a}:{d:0});else{var c=new X();a&&"d"in a&&i(c,a);return c}};m(X.prototype,(H={add:function(a){hd(this,a);return this},addKey:function(a){gd(this,a,a);return this},addKeys:function(a){var b=this;a.forEach(function(a){return gd(b,a,a)});return this}},H[na]=function(){return jd(this)},H));function gd(a,b,c){var d=S(b,c);if(isNaN(d))return;if(d>0)throw RangeError();if(fd(a))return i(a,{from:b,to:c,d:1});d=a.l;var e=a.r;if(S(c,a.from)<0){d?gd(d,b,c):a.l={from:b,to:c,d:1,l:null,r:null};return kd(a)}if(S(b,a.to)>0){e?gd(e,b,c):a.r={from:b,to:c,d:1,l:null,r:null};return kd(a)}S(b,a.from)<0&&(a.from=b,a.l=null,a.d=e?e.d+1:1);S(c,a.to)>0&&(a.to=c,a.r=null,a.d=a.l?a.l.d+1:1);b=!a.r;d&&!a.l&&hd(a,d);e&&b&&hd(a,e)}function hd(a,b){function c(a,b){var d=b.from,e=b.to,f=b.l;b=b.r;gd(a,d,e);f&&c(a,f);b&&c(a,b)}fd(b)||c(a,b)}function id(a,b){b=jd(b);var c=b.next();if(c.done)return!1;var d=c.value;a=jd(a);var e=a.next(d.from),f=e.value;while(!c.done&&!e.done){if(S(f.from,d.to)<=0&&S(f.to,d.from)>=0)return!0;S(d.from,f.from)<0?d=(c=b.next(f.from)).value:f=(e=a.next(d.from)).value}return!1}function jd(a){var b=fd(a)?null:{s:0,n:a};return{next:function(a){var c=arguments.length>0;while(b)switch(b.s){case 0:b.s=1;if(c)while(b.n.l&&S(a,b.n.from)<0)b={up:b,n:b.n.l,s:1};else while(b.n.l)b={up:b,n:b.n.l,s:1};case 1:b.s=2;if(!c||S(a,b.n.to)<=0)return{value:b.n,done:!1};case 2:if(b.n.r){b.s=3;b={up:b,n:b.n.r,s:0};continue}case 3:b=b.up}return{done:!0}}}}function kd(a){var b;b=(((b=a.r)===null||b===void 0?void 0:b.d)||0)-(((b=a.l)===null||b===void 0?void 0:b.d)||0);b=b>1?"r":b<-1?"l":"";if(b){var c=b==="r"?"l":"r",e=d({},a),f=a[b];a.from=f.from;a.to=f.to;a[b]=f[b];e[b]=f[c];a[c]=e;e.d=ld(e)}a.d=ld(a)}function ld(a){var b=a.r;a=a.l;return(b?a?Math.max(b.d,a.d):b.d:a?a.d:0)+1}function md(a,b){g(b).forEach(function(c){a[c]?hd(a[c],b[c]):a[c]=ha(b[c])});return a}function nd(a,b){return a.all||b.all||Object.keys(a).some(function(c){return b[c]&&id(b[c],a[c])})}var od={},pd={},qd=!1;function rd(a,b){md(pd,a),qd||(qd=!0,setTimeout(function(){qd=!1;var a=pd;pd={};sd(a,!1)},0))}function sd(a,b){b===void 0&&(b=!1);var c=new Set();if(a.all)for(var d=0,e=Object.values(od);d<e.length;d++){var f=e[d];td(f,a,c,b)}else for(e in a){d=/^idb\:\/\/(.*)\/(.*)\//.exec(e);if(d){var g=d[1];d=d[2];var f=od["idb://".concat(g,"/").concat(d)];f&&td(f,a,c,b)}}c.forEach(function(a){return a()})}function td(a,b,c,d){var e=[];for(var f=0,g=Object.entries(a.queries.query);f<g.length;f++){var h=g[f],i=h[0];h=h[1];var j=[];for(var k=0,h=h;k<h.length;k++){var l=h[k];nd(b,l.obsSet)?l.subscribers.forEach(function(a){return c.add(a)}):d&&j.push(l)}d&&e.push([i,j])}if(d)for(l=0,k=e;l<k.length;l++){h=k[l];var i=h[0],j=h[1];a.queries.query[i]=j}}function ud(a){var b=a._state,c=a._deps.indexedDB;if(b.isBeingOpened||a.idbdb)return b.dbReadyPromise.then(function(){return b.dbOpenError?Q(b.dbOpenError):a});b.isBeingOpened=!0;b.dbOpenError=null;b.openComplete=!1;var d=b.openCanceller,e=Math.round(a.verno*10),f=!1;function g(){if(b.openCanceller!==d)throw new D.DatabaseClosed("db.open() was cancelled")}var h=b.dbReadyResolve,i=null,j=!1,k=function(){return new K(function(d,h){g();if(!c)throw new D.MissingAPI();var l=a.name,m=b.autoSchema||!e?c.open(l):c.open(l,e);if(!m)throw new D.MissingAPI();m.onerror=V(h);m.onblocked=L(a._fireOnBlocked);m.onupgradeneeded=L(function(d){i=m.transaction;if(b.autoSchema&&!a._options.allowEmptyDB){m.onerror=nc;i.abort();m.result.close();var e=c.deleteDatabase(l);e.onsuccess=e.onerror=L(function(){h(new D.NoSuchDatabase("Database ".concat(l," doesnt exist")))})}else{i.onerror=V(h);e=d.oldVersion>Math.pow(2,62)?0:d.oldVersion;j=e<1;a.idbdb=m.result;f&&Kc(a,i);Jc(a,e/10,i,h)}},h);m.onsuccess=L(function(){i=null;var c=a.idbdb=m.result,g=t(c.objectStoreNames);if(g.length>0)try{g=c.transaction(vc(g),"readonly");if(b.autoSchema)Tc(a,c,g);else{Vc(a,a._dbSchema,g);if(!Uc(a,g)&&!f){c.close();e=c.version+1;f=!0;return d(k())}}Fc(a,g)}catch(a){}Cb.push(a);c.onversionchange=L(function(c){b.vcFired=!0,a.on("versionchange").fire(c)});c.onclose=L(function(b){a.on("close").fire(b)});j&&bd(a._deps,l);d()},h)})["catch"](function(a){switch(a===null||a===void 0?void 0:a.name){case"UnknownError":if(b.PR1398_maxLoop>0){b.PR1398_maxLoop--;return k()}break;case"VersionError":if(e>0){e=0;return k()}break}return K.reject(a)})};return K.race([d,(typeof navigator==="undefined"?K.resolve():ed()).then(k)]).then(function(){g();b.onReadyBeingFired=[];return K.resolve(dd(function(){return a.on.ready.fire(a.vip)})).then(function c(){if(b.onReadyBeingFired.length>0){var d=b.onReadyBeingFired.reduce(Ga,E);b.onReadyBeingFired=[];return K.resolve(dd(function(){return d(a.vip)})).then(c)}})})["finally"](function(){b.openCanceller===d&&(b.onReadyBeingFired=null,b.isBeingOpened=!1)})["catch"](function(c){b.dbOpenError=c;try{i&&i.abort()}catch(a){}d===b.openCanceller&&a._close();return Q(c)})["finally"](function(){b.openComplete=!0,h()}).then(function(){if(j){var b={};a.tables.forEach(function(c){c.schema.indexes.forEach(function(d){d.name&&(b["idb://".concat(a.name,"/").concat(c.name,"/").concat(d.name)]=new X(-Infinity,[[[]]]))}),b["idb://".concat(a.name,"/").concat(c.name,"/")]=b["idb://".concat(a.name,"/").concat(c.name,"/:dels")]=new X(-Infinity,[[[]]])});W(oc).fire(b);sd(b,!0)}return a})}function vd(a){var b=function(b){return a.next(b)},c=function(b){return a["throw"](b)},d=f(b),e=f(c);function f(a){return function(b){b=a(b);var c=b.value;return b.done?c:!c||typeof c.then!=="function"?h(c)?Promise.all(c).then(d,e):d(c):c.then(d,e)}}return f(b)()}function wd(a,b,c){var d=arguments.length;if(d<2)throw new D.InvalidArgument("Too few arguments");var e=new Array(d-1);while(--d)e[d-1]=arguments[d];c=e.pop();var f=fa(e);return[a,f,c]}function xd(a,b,c,d,e){return K.resolve().then(function(){var f=J.transless||J,g=a._createTransaction(b,c,a._dbSchema,d);g.explicit=!0;f={trans:g,transless:f};if(d)g.idbtrans=d.idbtrans;else try{g.create(),g.idbtrans._explicit=!0,a._state.PR1398_maxLoop=3}catch(d){if(d.name===wa.InvalidState&&a.isOpen()&&--a._state.PR1398_maxLoop>0){a.close({disableAutoOpen:!1});return a.open().then(function(){return xd(a,b,c,null,e)})}return Q(d)}var h=qa(e);h&&qb();var i;f=K.follow(function(){i=e.call(g,g);if(i)if(h){var a=O.bind(null,null);i.then(a,a)}else typeof i.next==="function"&&typeof i["throw"]==="function"&&(i=vd(i))},f);return(i&&typeof i.then==="function"?K.resolve(i).then(function(a){return g.active?a:Q(new D.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):f.then(function(){return i})).then(function(a){d&&g._resolve();return g._completion.then(function(){return a})})["catch"](function(a){g._reject(a);return Q(a)})})}function yd(a,b,c){a=h(a)?a.slice():[a];for(var d=0;d<c;++d)a.push(b);return a}function zd(a){return d(d({},a),{table:function(b){var c=a.table(b);b=c.schema;var e={},f=[];function g(a,b,c){var h=Bc(a),i=e[h]=e[h]||[],j=a==null?0:typeof a==="string"?1:a.length,k=b>0;h=d(d({},c),{name:k?"".concat(h,"(virtual-from:").concat(c.name,")"):c.name,lowLevelIndex:c,isVirtual:k,keyTail:b,keyLength:j,extractKey:xc(a),unique:!k&&c.unique});i.push(h);h.isPrimaryKey||f.push(h);if(j>1){k=j===2?a[0]:a.slice(0,j-1);g(k,b+1,c)}i.sort(function(a,b){return a.keyTail-b.keyTail});return h}var h=g(b.primaryKey.keyPath,0,b.primaryKey);e[":id"]=[h];for(var i=0,j=b.indexes;i<j.length;i++){var k=j[i];g(k.keyPath,0,k)}function l(a){a=e[Bc(a)];return a&&a[0]}function m(b,c){return{type:b.type===1?2:b.type,lower:yd(b.lower,b.lowerOpen?a.MAX_KEY:a.MIN_KEY,c),lowerOpen:!0,upper:yd(b.upper,b.upperOpen?a.MIN_KEY:a.MAX_KEY,c),upperOpen:!0}}function n(b){var a=b.query.index;return a.isVirtual?d(d({},b),{query:{index:a.lowLevelIndex,range:m(b.query.range,a.keyTail)}}):b}k=d(d({},c),{schema:d(d({},b),{primaryKey:h,indexes:f,getIndexByKeyPath:l}),count:function(a){return c.count(n(a))},query:function(a){return c.query(n(a))},openCursor:function(d){var b=d.query.index,e=b.keyTail,f=b.isVirtual,g=b.keyLength;if(!f)return c.openCursor(d);function h(b){function c(c){c!=null?b["continue"](yd(c,d.reverse?a.MAX_KEY:a.MIN_KEY,e)):d.unique?b["continue"](b.key.slice(0,g).concat(d.reverse?a.MIN_KEY:a.MAX_KEY,e)):b["continue"]()}c=Object.create(b,{"continue":{value:c},continuePrimaryKey:{value:function(d,c){b.continuePrimaryKey(yd(d,a.MAX_KEY,e),c)}},primaryKey:{get:function(){return b.primaryKey}},key:{get:function(){var a=b.key;return g===1?a[0]:a.slice(0,g)}},value:{get:function(){return b.value}}});return c}return c.openCursor(n(d)).then(function(a){return a&&h(a)})}});return k}})}var Ad={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:zd};function Bd(a,b,c,d){c=c||{};d=d||"";g(a).forEach(function(e){if(!l(b,e))c[d+e]=void 0;else{var f=a[e],g=b[e];if(typeof f==="object"&&typeof g==="object"&&f&&g){var h=ma(f),i=ma(g);h!==i?c[d+e]=b[e]:h==="Object"?Bd(f,g,c,d+e+"."):f!==g&&(c[d+e]=b[e])}else f!==g&&(c[d+e]=b[e])}});g(b).forEach(function(e){l(a,e)||(c[d+e]=b[e])});return c}function Cd(a,b){return b.type==="delete"?b.keys:b.keys||b.values.map(a.extractKey)}var Dd={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(a){return d(d({},a),{table:function(b){var c=a.table(b),f=c.schema.primaryKey,g=d(d({},c),{mutate:function(a){var g=J.trans,h=g.table(b).hook,i=h.deleting,j=h.creating,k=h.updating;switch(a.type){case"add":if(j.fire===E)break;return g._promise("readwrite",function(){return m(a)},!0);case"put":if(j.fire===E&&k.fire===E)break;return g._promise("readwrite",function(){return m(a)},!0);case"delete":if(i.fire===E)break;return g._promise("readwrite",function(){return m(a)},!0);case"deleteRange":if(i.fire===E)break;return g._promise("readwrite",function(){return n(a)},!0)}return c.mutate(a);function m(b){var g=J.trans,a=b.keys||Cd(f,b);if(!a)throw new Error("Keys missing");b=b.type==="add"||b.type==="put"?d(d({},b),{keys:a}):d({},b);b.type!=="delete"&&(b.values=e([],b.values,!0));b.keys&&(b.keys=e([],b.keys,!0));return Ed(c,b,a).then(function(d){var e=a.map(function(a,c){var e=d[c],h={onerror:null,onsuccess:null};if(b.type==="delete")i.fire.call(h,a,e,g);else if(b.type==="add"||e===void 0){var m=j.fire.call(h,a,b.values[c],g);a==null&&m!=null&&(a=m,b.keys[c]=a,f.outbound||x(b.values[c],f.keyPath,a))}else{m=Bd(e,b.values[c]);var n=k.fire.call(h,m,a,e,g);if(n){var o=b.values[c];Object.keys(n).forEach(function(a){l(o,a)?o[a]=n[a]:x(o,a,n[a])})}}return h});return c.mutate(b).then(function(c){var f=c.failures,g=c.results,h=c.numFailures;c=c.lastResult;for(var i=0;i<a.length;++i){var j=g?g[i]:a[i],k=e[i];j==null?k.onerror&&k.onerror(f[i]):k.onsuccess&&k.onsuccess(b.type==="put"&&d[i]?b.values[i]:j)}return{failures:f,results:g,numFailures:h,lastResult:c}})["catch"](function(a){e.forEach(function(b){return b.onerror&&b.onerror(a)});return Promise.reject(a)})})}function n(a){return o(a.trans,a.range,1e4)}function o(a,b,e){return c.query({trans:a,values:!1,query:{index:f,range:b},limit:e}).then(function(c){var f=c.result;return m({type:"delete",keys:f,trans:a}).then(function(c){if(c.numFailures>0)return Promise.reject(c.failures[0]);if(f.length<e)return{failures:[],numFailures:0,lastResult:void 0};else return o(a,d(d({},b),{lower:f[f.length-1],lowerOpen:!0}),e)})})}}});return g}})}};function Ed(a,b,c){return b.type==="add"?Promise.resolve([]):a.getMany({trans:b.trans,keys:c,cache:"immutable"})}function Fd(a,b,c){try{if(!b)return null;if(b.keys.length<a.length)return null;var d=[];for(var e=0,f=0;e<b.keys.length&&f<a.length;++e){if(S(b.keys[e],a[f])!==0)continue;d.push(c?z(b.values[e]):b.values[e]);++f}return d.length===a.length?d:null}catch(a){return null}}var Gd={stack:"dbcore",level:-1,create:function(a){return{table:function(b){var c=a.table(b);return d(d({},c),{getMany:function(a){if(!a.cache)return c.getMany(a);var b=Fd(a.keys,a.trans._cache,a.cache==="clone");return b?K.resolve(b):c.getMany(a).then(function(b){a.trans._cache={keys:a.keys,values:a.cache==="clone"?z(b):b};return b})},mutate:function(a){a.type!=="add"&&(a.trans._cache=null);return c.mutate(a)}})}}}};function Hd(a,b){return a.trans.mode==="readonly"&&!!a.subscr&&!a.trans.explicit&&a.trans.db._options.cache!=="disabled"&&!b.schema.primaryKey.outbound}function Id(a,b){switch(a){case"query":return b.values&&!b.unique;case"get":return!1;case"getMany":return!1;case"count":return!1;case"openCursor":return!1}}var Jd={stack:"dbcore",level:0,name:"Observability",create:function(a){var b=a.schema.name,c=new X(a.MIN_KEY,a.MAX_KEY);return d(d({},a),{transaction:function(b,c,d){if(J.subscr&&c!=="readonly")throw new D.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(J.querier));return a.transaction(b,c,d)},table:function(e){var f=a.table(e),i=f.schema,j=i.primaryKey,k=j.extractKey,l=j.outbound,m=d(d({},f),{mutate:function(g){var k=g.trans,l=g.mutatedParts||(g.mutatedParts={}),m=function(a){a="idb://".concat(b,"/").concat(e,"/").concat(a);return l[a]||(l[a]=new X())},n=m(""),o=m(":dels"),d=g.type,p=g.type==="deleteRange"?[g.range]:g.type==="delete"?[g.keys]:g.values.length<50?[Cd(j,g).filter(function(a){return a}),g.values]:[],a=p[0];p=p[1];var q=g.trans._cache;if(h(a)){n.addKeys(a);d=d==="delete"||a.length===p.length?Fd(a,q):null;d||o.addKeys(a);(d||p)&&Kd(m,i,d,p)}else if(a){q={from:a.lower,to:a.upper};o.add(q);n.add(q)}else n.add(c),o.add(c),i.indexes.forEach(function(a){return m(a.name).add(c)});return f.mutate(g).then(function(b){a&&(g.type==="add"||g.type==="put")&&n.addKeys(b.results);k.mutatedParts=md(k.mutatedParts||{},l);return b})}}),n=function(b){b=b.query;var c=b.index;b=b.range;return[c,new X((c=b.lower)!==null&&c!==void 0?c:a.MIN_KEY,(c=b.upper)!==null&&c!==void 0?c:a.MAX_KEY)]},o={get:function(a){return[j,new X(a.key)]},getMany:function(a){return[j,new X().addKeys(a.keys)]},count:n,query:n,openCursor:n};g(o).forEach(function(a){m[a]=function(g){var h=J.subscr,i=!!h,j=Hd(J,f)&&Id(a,g),m=j?g.obsSet={}:h;if(i){var n=function(a){a="idb://".concat(b,"/").concat(e,"/").concat(a);return m[a]||(m[a]=new X())},p=n(""),q=n(":dels"),r=o[a](g),s=r[0],t=r[1];a==="query"&&s.isPrimaryKey&&!g.values?q.add(t):n(s.name||"").add(t);if(!s.isPrimaryKey)if(a==="count")q.add(c);else{var u=a==="query"&&l&&g.values&&f.query(d(d({},g),{values:!1}));return f[a].apply(this,arguments).then(function(b){if(a==="query"){if(l&&g.values)return u.then(function(a){a=a.result;p.addKeys(a);return b});var c=g.values?b.result.map(k):b.result;g.values?p.addKeys(c):q.addKeys(c)}else if(a==="openCursor"){var d=b,e=g.values;return d&&Object.create(d,{key:{get:function(){q.addKey(d.primaryKey);return d.key}},primaryKey:{get:function(){var a=d.primaryKey;q.addKey(a);return a}},value:{get:function(){e&&p.addKey(d.primaryKey);return d.value}}})}return b})}}return f[a].apply(this,arguments)}});return m}})}};function Kd(a,b,c,d){function e(b){var e=a(b.name||"");function f(a){return a!=null?b.extractKey(a):null}var g=function(a){return b.multiEntry&&h(a)?a.forEach(function(a){return e.addKey(a)}):e.addKey(a)};(c||d).forEach(function(a,b){a=c&&f(c[b]);b=d&&f(d[b]);S(a,b)!==0&&(a!=null&&g(a),b!=null&&g(b))})}b.indexes.forEach(e)}function Ld(a,b,c){if(c.numFailures===0)return b;if(b.type==="deleteRange")return null;a=b.keys?b.keys.length:"values"in b&&b.values?b.values.length:1;if(c.numFailures===a)return null;a=d({},b);h(a.keys)&&(a.keys=a.keys.filter(function(a,b){return!(b in c.failures)}));"values"in a&&h(a.values)&&(a.values=a.values.filter(function(a,b){return!(b in c.failures)}));return a}function Md(a,b){return b.lower===void 0?!0:b.lowerOpen?S(a,b.lower)>0:S(a,b.lower)>=0}function Nd(a,b){return b.upper===void 0?!0:b.upperOpen?S(a,b.upper)<0:S(a,b.upper)<=0}function Od(a,b){return Md(a,b)&&Nd(a,b)}function Pd(a,b,c,d,e,f){if(!c||c.length===0)return a;var g=b.query.index,i=g.multiEntry,j=b.query.range;d=d.schema.primaryKey;var k=d.extractKey,l=g.extractKey,m=(g.lowLevelIndex||g).extractKey;d=c.reduce(function(a,c){var d=a,e=c.type==="add"||c.type==="put"?c.values.filter(function(a){a=l(a);return i&&h(a)?a.some(function(a){return Od(a,j)}):Od(a,j)}).map(function(a){a=z(a);f&&Object.freeze(a);return a}):[];switch(c.type){case"add":d=a.concat(b.values?e:e.map(function(a){return k(a)}));break;case"put":var g=new X().addKeys(c.values.map(function(a){return k(a)}));d=a.filter(function(a){a=b.values?k(a):a;return!id(new X(a),g)}).concat(b.values?e:e.map(function(a){return k(a)}));break;case"delete":var m=new X().addKeys(c.keys);d=a.filter(function(a){a=b.values?k(a):a;return!id(new X(a),m)});break;case"deleteRange":var n=c.range;d=a.filter(function(a){return!Od(k(a),n)});break}return d},a);if(d===a)return a;d.sort(function(a,b){return S(m(a),m(b))||S(k(a),k(b))});b.limit&&b.limit<Infinity&&(d.length>b.limit?d.length=b.limit:a.length===b.limit&&d.length<b.limit&&(e.dirty=!0));return f?Object.freeze(d):d}function Qd(a,b){return S(a.lower,b.lower)===0&&S(a.upper,b.upper)===0&&!!a.lowerOpen===!!b.lowerOpen&&!!a.upperOpen===!!b.upperOpen}function Rd(a,b,c,d){if(a===void 0)return b!==void 0?-1:0;if(b===void 0)return 1;a=S(a,b);if(a===0){if(c&&d)return 0;if(c)return 1;if(d)return-1}return a}function Sd(a,b,c,d){if(a===void 0)return b!==void 0?1:0;if(b===void 0)return-1;a=S(a,b);if(a===0){if(c&&d)return 0;if(c)return-1;if(d)return 1}return a}function Td(a,b){return Rd(a.lower,b.lower,a.lowerOpen,b.lowerOpen)<=0&&Sd(a.upper,b.upper,a.upperOpen,b.upperOpen)>=0}function Ud(b,c,a,d){b=od["idb://".concat(b,"/").concat(c)];if(!b)return[];c=b.queries[a];if(!c)return[null,!1,b,null];var e=d.query?d.query.index.name:null;c=c[e||""];if(!c)return[null,!1,b,null];switch(a){case"query":e=c.find(function(a){return a.req.limit===d.limit&&a.req.values===d.values&&Qd(a.req.query.range,d.query.range)});if(e)return[e,!0,b,c];a=c.find(function(a){var b="limit"in a.req?a.req.limit:Infinity;return b>=d.limit&&(d.values?a.req.values:!0)&&Td(a.req.query.range,d.query.range)});return[a,!1,b,c];case"count":e=c.find(function(a){return Qd(a.req.query.range,d.query.range)});return[e,!!e,b,c]}}function Vd(a,b,c,d){a.subscribers.add(c),d.addEventListener("abort",function(){a.subscribers["delete"](c),a.subscribers.size===0&&Wd(a,b)})}function Wd(a,b){setTimeout(function(){a.subscribers.size===0&&A(b,a)},3e3)}var Xd={stack:"dbcore",level:0,name:"Cache",create:function(a){var b=a.schema.name,c=d(d({},a),{transaction:function(c,d,e){var f=a.transaction(c,d,e);if(d==="readwrite"){var g=new AbortController();e=g.signal;var h=function(e){return function(){g.abort();if(d==="readwrite"){var h=new Set();for(var i=0,j=c;i<j.length;i++){var k=j[i],l=od["idb://".concat(b,"/").concat(k)];if(l){k=a.table(k);var m=l.optimisticOps.filter(function(a){return a.trans===f});if(f._explicit&&e&&f.mutatedParts)for(var n=0,o=Object.values(l.queries.query);n<o.length;n++){var p=o[n];for(var q=0,r=p.slice();q<r.length;q++){var s=r[q];nd(s.obsSet,f.mutatedParts)&&(A(p,s),s.subscribers.forEach(function(a){return h.add(a)}))}}else if(m.length>0){l.optimisticOps=l.optimisticOps.filter(function(a){return a.trans!==f});for(q=0,r=Object.values(l.queries.query);q<r.length;q++){var p=r[q];for(n=0,o=p.slice();n<o.length;n++){var s=o[n];if(s.res!=null&&f.mutatedParts)if(e&&!s.dirty){l=Object.isFrozen(s.res);l=Pd(s.res,s.req,m,k,s,l);s.dirty?(A(p,s),s.subscribers.forEach(function(a){return h.add(a)})):l!==s.res&&(s.res=l,s.promise=K.resolve({result:l}))}else s.dirty&&A(p,s),s.subscribers.forEach(function(a){return h.add(a)})}}}}}h.forEach(function(a){return a()})}}};f.addEventListener("abort",h(!1),{signal:e});f.addEventListener("error",h(!1),{signal:e});f.addEventListener("complete",h(!0),{signal:e})}return f},table:function(c){var e=a.table(c),f=e.schema.primaryKey,g=d(d({},e),{mutate:function(a){var g=J.trans;if(f.outbound||g.db._options.cache==="disabled"||g.explicit)return e.mutate(a);var h=od["idb://".concat(b,"/").concat(c)];if(!h)return e.mutate(a);g=e.mutate(a);(a.type==="add"||a.type==="put")&&(a.values.length>=50||Cd(f,a).some(function(a){return a==null}))?g.then(function(b){var c=d(d({},a),{values:a.values.map(function(a,c){var e;e=((e=f.keyPath)===null||e===void 0?void 0:e.includes("."))?z(a):d({},a);x(e,f.keyPath,b.results[c]);return e})});c=Ld(h,c,b);h.optimisticOps.push(c);queueMicrotask(function(){return a.mutatedParts&&rd(a.mutatedParts)})}):(h.optimisticOps.push(a),a.mutatedParts&&rd(a.mutatedParts),g.then(function(b){if(b.numFailures>0){A(h.optimisticOps,a);b=Ld(h,a,b);b&&h.optimisticOps.push(b);a.mutatedParts&&rd(a.mutatedParts)}}),g["catch"](function(){A(h.optimisticOps,a),a.mutatedParts&&rd(a.mutatedParts)}));return g},query:function(a){var d;if(!Hd(J,e)||!Id("query",a))return e.query(a);var f=((d=J.trans)===null||d===void 0?void 0:d.db._options.cache)==="immutable";d=J;var g=d.requery;d=d.signal;var h=Ud(b,c,"query",a),i=h[0],j=h[1],k=h[2],l=h[3];if(i&&j)i.obsSet=a.obsSet;else{h=e.query(a).then(function(a){var b=a.result;i&&(i.res=b);if(f){for(var c=0,d=b.length;c<d;++c)Object.freeze(b[c]);Object.freeze(b)}else a.result=z(b);return a})["catch"](function(a){l&&i&&A(l,i);return Promise.reject(a)});i={obsSet:a.obsSet,promise:h,subscribers:new Set(),type:"query",req:a,dirty:!1};l?l.push(i):(l=[i],k||(k=od["idb://".concat(b,"/").concat(c)]={queries:{query:{},count:{}},objs:new Map(),optimisticOps:[],unsignaledParts:{}}),k.queries.query[a.query.index.name||""]=l)}Vd(i,l,g,d);return i.promise.then(function(b){return{result:Pd(b.result,a,k===null||k===void 0?void 0:k.optimisticOps,e,i,f)}})}});return g}});return c}};function Yd(a,b){return new Proxy(a,{get:function(a,c,d){return c==="db"?b:Reflect.get(a,c,d)}})}var Y=function(){function a(b,c){var e=this;this._middlewares={};this.verno=0;var f=a.dependencies;this._options=c=d({addons:a.addons,autoOpen:!0,indexedDB:f.indexedDB,IDBKeyRange:f.IDBKeyRange,cache:"cloned"},c);this._deps={indexedDB:c.indexedDB,IDBKeyRange:c.IDBKeyRange};f=c.addons;this._dbSchema={};this._versions=[];this._storeNames=[];this._allTables={};this.idbdb=null;this._novip=this;var g={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:E,dbReadyPromise:null,cancelOpen:E,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:c.autoOpen};g.dbReadyPromise=new K(function(a){g.dbReadyResolve=a});g.openCanceller=new K(function(a,b){g.cancelOpen=b});this._state=g;this.name=b;this.on=Pb(this,"populate","blocked","versionchange","close",{ready:[Ga,E]});this.on.ready.subscribe=u(this.on.ready.subscribe,function(b){return function(c,d){a.vip(function(){var a=e._state;if(a.openComplete)a.dbOpenError||K.resolve().then(c),d&&b(c);else if(a.onReadyBeingFired)a.onReadyBeingFired.push(c),d&&b(c);else{b(c);var f=e;d||b(function a(){f.on.ready.unsubscribe(c),f.on.ready.unsubscribe(a)})}})}});this.Collection=cc(this);this.Table=Rb(this);this.Transaction=rc(this);this.Version=Yc(this);this.WhereClause=mc(this);this.on("versionchange",function(a){a.newVersion>0?!1:!1,e.close({disableAutoOpen:!1})});this.on("blocked",function(a){!a.newVersion||a.newVersion<a.oldVersion?!1:!1});this._maxKey=wc(c.IDBKeyRange);this._createTransaction=function(a,b,c,d){return new e.Transaction(a,b,c,e._options.chromeTransactionDurability,d)};this._fireOnBlocked=function(a){e.on("blocked").fire(a),Cb.filter(function(a){return a.name===e.name&&a!==e&&!a._state.vcFired}).map(function(b){return b.on("versionchange").fire(a)})};this.use(Gd);this.use(Xd);this.use(Jd);this.use(Ad);this.use(Dd);var h=new Proxy(this,{get:function(a,b,c){if(b==="_vip")return!0;if(b==="table")return function(a){return Yd(e.table(a),h)};var d=Reflect.get(a,b,c);if(d instanceof Ob)return Yd(d,h);if(b==="tables")return d.map(function(a){return Yd(a,h)});return b==="_createTransaction"?function(){var a=d.apply(this,arguments);return Yd(a,h)}:d}});this.vip=h;f.forEach(function(a){return a(e)})}a.prototype.version=function(a){if(isNaN(a)||a<.1)throw new D.Type("Given version is not a positive number");a=Math.round(a*10)/10;if(this.idbdb||this._state.isBeingOpened)throw new D.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=this._versions,c=b.filter(function(b){return b._cfg.version===a})[0];if(c)return c;c=new this.Version(a);b.push(c);b.sort(Ic);c.stores({});this._state.autoSchema=!1;return c};a.prototype._whenReady=function(a){var b=this;return this.idbdb&&(this._state.openComplete||J.letThrough||this._vip)?a():new K(function(a,c){if(b._state.openComplete)return c(new D.DatabaseClosed(b._state.dbOpenError));if(!b._state.isBeingOpened){if(!b._state.autoOpen){c(new D.DatabaseClosed());return}b.open()["catch"](E)}b._state.dbReadyPromise.then(a,c)}).then(a)};a.prototype.use=function(a){var b=a.stack,c=a.create,d=a.level;a=a.name;a&&this.unuse({stack:b,name:a});var e=this._middlewares[b]||(this._middlewares[b]=[]);e.push({stack:b,create:c,level:d==null?10:d,name:a});e.sort(function(a,b){return a.level-b.level});return this};a.prototype.unuse=function(a){var b=a.stack,c=a.name,d=a.create;b&&this._middlewares[b]&&(this._middlewares[b]=this._middlewares[b].filter(function(a){return d?a.create!==d:c?a.name!==c:!1}));return this};a.prototype.open=function(){var a=this;return vb(I,function(){return ud(a)})};a.prototype._close=function(){var a=this._state,b=Cb.indexOf(this);b>=0&&Cb.splice(b,1);if(this.idbdb){try{this.idbdb.close()}catch(a){}this.idbdb=null}a.isBeingOpened||(a.dbReadyPromise=new K(function(b){a.dbReadyResolve=b}),a.openCanceller=new K(function(b,c){a.cancelOpen=c}))};a.prototype.close=function(a){a=a===void 0?{disableAutoOpen:!0}:a;a=a.disableAutoOpen;var b=this._state;a?(b.isBeingOpened&&b.cancelOpen(new D.DatabaseClosed()),this._close(),b.autoOpen=!1,b.dbOpenError=new D.DatabaseClosed()):(this._close(),b.autoOpen=this._options.autoOpen||b.isBeingOpened,b.openComplete=!1,b.dbOpenError=null)};a.prototype["delete"]=function(a){var b=this;a===void 0&&(a={disableAutoOpen:!0});var c=arguments.length>0&&typeof arguments[0]!=="object",d=this._state;return new K(function(e,f){var g=function(){b.close(a);var c=b._deps.indexedDB.deleteDatabase(b.name);c.onsuccess=L(function(){cd(b._deps,b.name),e()});c.onerror=V(f);c.onblocked=b._fireOnBlocked};if(c)throw new D.InvalidArgument("Invalid closeOptions argument to db.delete()");d.isBeingOpened?d.dbReadyPromise.then(g):g()})};a.prototype.backendDB=function(){return this.idbdb};a.prototype.isOpen=function(){return this.idbdb!==null};a.prototype.hasBeenClosed=function(){var a=this._state.dbOpenError;return a&&a.name==="DatabaseClosed"};a.prototype.hasFailed=function(){return this._state.dbOpenError!==null};a.prototype.dynamicallyOpened=function(){return this._state.autoSchema};Object.defineProperty(a.prototype,"tables",{get:function(){var a=this;return g(this._allTables).map(function(b){return a._allTables[b]})},enumerable:!1,configurable:!0});a.prototype.transaction=function(){var a=wd.apply(this,arguments);return this._transaction.apply(this,a)};a.prototype._transaction=function(a,b,c){var d=this,e=J.trans;(!e||e.db!==this||a.indexOf("!")!==-1)&&(e=null);var f=a.indexOf("?")!==-1;a=a.replace("!","").replace("?","");var g,h;try{h=b.map(function(a){a=a instanceof d.Table?a.name:a;if(typeof a!=="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return a});if(a=="r"||a===Eb)g=Eb;else if(a=="rw"||a==Fb)g=Fb;else throw new D.InvalidArgument("Invalid transaction mode: "+a);if(e){if(e.mode===Eb&&g===Fb)if(f)e=null;else throw new D.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");e&&h.forEach(function(a){if(e&&e.storeNames.indexOf(a)===-1)if(f)e=null;else throw new D.SubTransaction("Table "+a+" not included in parent transaction.")});f&&e&&!e.active&&(e=null)}}catch(a){return e?e._promise(null,function(b,c){c(a)}):Q(a)}var i=xd.bind(null,this,g,h,e,c);return e?e._promise(g,i,"lock"):J.trans?vb(J.transless,function(){return d._whenReady(i)}):this._whenReady(i)};a.prototype.table=function(a){if(!l(this._allTables,a))throw new D.InvalidTable("Table ".concat(a," does not exist"));return this._allTables[a]};return a}(),Zd=typeof Symbol!=="undefined"&&"observable"in Symbol?Symbol.observable:"@@observable",$d=function(){function a(a){this._subscribe=a}a.prototype.subscribe=function(a,b,c){return this._subscribe(!a||typeof a==="function"?{next:a,error:b,complete:c}:a)};a.prototype[Zd]=function(){return this};return a}(),ae;try{ae={indexedDB:f.indexedDB||f.mozIndexedDB||f.webkitIndexedDB||f.msIndexedDB,IDBKeyRange:f.IDBKeyRange||f.webkitIDBKeyRange}}catch(a){ae={indexedDB:null,IDBKeyRange:null}}function be(a){var b=!1,c,d=new $d(function(d){var e=qa(a);function f(b){var c=eb();try{e&&qb();b=N(a,b);e&&(b=b["finally"](O));return b}finally{c&&fb()}}var g=!1,h,i={},j={},k={get closed(){return g},unsubscribe:function(){if(g)return;g=!0;h&&h.abort();l&&W.storagemutated.unsubscribe(o)}};d.start&&d.start(k);var l=!1,m=function(){return xb(p)};function n(){return nd(j,i)}var o=function(a){md(i,a),n()&&m()},p=function(){if(g||!ae.indexedDB)return;i={};var e={};h&&h.abort();h=new AbortController();var k={subscr:e,signal:h.signal,requery:m,querier:a,trans:null},n=f(k);Promise.resolve(n).then(function(a){b=!0;c=a;if(g||k.signal.aborted)return;i={};j=e;!ia(j)&&!l&&(W(oc,o),l=!0);xb(function(){return!g&&d.next&&d.next(a)})},function(a){b=!1,["DatabaseClosedError","AbortError"].includes(a===null||a===void 0?void 0:a.name)||(g||xb(function(){if(g)return;d.error&&d.error(a)}))})};setTimeout(m,0);return k});d.hasValue=function(){return b};d.getValue=function(){return c};return d}var ce=Y;m(ce,d(d({},C),{"delete":function(a){a=new ce(a,{addons:[]});return a["delete"]()},exists:function(a){return new ce(a,{addons:[]}).open().then(function(a){a.close();return!0})["catch"]("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(a){try{return ad(ce.dependencies).then(a)}catch(a){return Q(new D.MissingAPI())}},defineClass:function(){function a(a){i(this,a)}return a},ignoreTransaction:function(a){return J.trans?vb(J.transless,a):a()},vip:dd,async:function(a){return function(){try{var b=vd(a.apply(this,arguments));return!b||typeof b.then!=="function"?K.resolve(b):b}catch(a){return Q(a)}}},spawn:function(a,b,c){try{a=vd(a.apply(c,b||[]));return!a||typeof a.then!=="function"?K.resolve(a):a}catch(a){return Q(a)}},currentTransaction:{get:function(){return J.trans||null}},waitFor:function(a,b){a=K.resolve(typeof a==="function"?ce.ignoreTransaction(a):a).timeout(b||6e4);return J.trans?J.trans.waitFor(a):a},Promise:K,debug:{get:function(){return G},set:function(a){Ha(a)}},derive:p,extend:i,props:m,override:u,Events:Pb,on:W,liveQuery:be,extendObservabilitySet:md,getByKeyPath:w,setByKeyPath:x,delByKeyPath:ca,shallowClone:da,deepClone:z,getObjectDiff:Bd,cmp:S,asap:aa,minKey:Ab,addons:[],connections:Cb,errnames:wa,dependencies:ae,cache:od,semVer:Ka,version:Ka.split(".").map(function(a){return parseInt(a)}).reduce(function(a,b,c){return a+b/Math.pow(10,c*2)})}));ce.maxKey=wc(ce.dependencies.IDBKeyRange);typeof dispatchEvent!=="undefined"&&typeof addEventListener!=="undefined"&&(W(oc,function(a){if(!Z){a=new CustomEvent(pc,{detail:a});Z=!0;dispatchEvent(a);Z=!1}}),addEventListener(pc,function(a){a=a.detail;Z||de(a)}));function de(a){var b=Z;try{Z=!0,W.storagemutated.fire(a),sd(a,!0)}finally{Z=b}}var Z=!1,$,ee=function(){};typeof BroadcastChannel!=="undefined"&&(ee=function(){$=new BroadcastChannel(pc),$.onmessage=function(a){return a.data&&de(a.data)}},ee(),typeof $.unref==="function"&&$.unref(),W(oc,function(a){Z||$.postMessage(a)}));typeof addEventListener!=="undefined"&&(addEventListener("pagehide",function(a){if(!Y.disableBfCache&&a.persisted){G&&!1;$===null||$===void 0?void 0:$.close();for(var a=0,b=Cb;a<b.length;a++){var c=b[a];c.close({disableAutoOpen:!1})}}}),addEventListener("pageshow",function(a){!Y.disableBfCache&&a.persisted&&(G&&!1,ee(),de({all:new X(-Infinity,[[]])}))}));function fe(a,b){return new $b({replacePrefix:[a,b]})}K.rejectionMapper=za;Ha(G);H=Object.freeze({__proto__:null,Dexie:Y,liveQuery:be,Entity:Jb,cmp:S,PropModSymbol:y,PropModification:$b,replacePrefix:fe,"default":Y,RangeSet:X,mergeRanges:hd,rangesOverlap:id});d(Y,H,{"default":Y});return Y})}var j=!1;function k(){j||(j=!0,i());return h.exports}function b(a){switch(a){case void 0:return k()}}e.exports=b}),null);
__d("dexie_maw-next",["dexie-4.0.1"],(function(a,b,c,d,e,f){e.exports=b("dexie-4.0.1")()}),null);
/**
 * License: https://www.facebook.com/legal/license/t3hOLs8wlXy/
 */
__d("remove-accents-0.4.2",[],(function(a,b,c,d,e,f){"use strict";b={};var g={exports:b};function h(){var a={"\xc0":"A","\xc1":"A","\xc2":"A","\xc3":"A","\xc4":"A","\xc5":"A","\u1ea4":"A","\u1eae":"A","\u1eb2":"A","\u1eb4":"A","\u1eb6":"A","\xc6":"AE","\u1ea6":"A","\u1eb0":"A","\u0202":"A","\xc7":"C","\u1e08":"C","\xc8":"E","\xc9":"E","\xca":"E","\xcb":"E","\u1ebe":"E","\u1e16":"E","\u1ec0":"E","\u1e14":"E","\u1e1c":"E","\u0206":"E","\xcc":"I","\xcd":"I","\xce":"I","\xcf":"I","\u1e2e":"I","\u020a":"I","\xd0":"D","\xd1":"N","\xd2":"O","\xd3":"O","\xd4":"O","\xd5":"O","\xd6":"O","\xd8":"O","\u1ed0":"O","\u1e4c":"O","\u1e52":"O","\u020e":"O","\xd9":"U","\xda":"U","\xdb":"U","\xdc":"U","\xdd":"Y","\xe0":"a","\xe1":"a","\xe2":"a","\xe3":"a","\xe4":"a","\xe5":"a","\u1ea5":"a","\u1eaf":"a","\u1eb3":"a","\u1eb5":"a","\u1eb7":"a","\xe6":"ae","\u1ea7":"a","\u1eb1":"a","\u0203":"a","\xe7":"c","\u1e09":"c","\xe8":"e","\xe9":"e","\xea":"e","\xeb":"e","\u1ebf":"e","\u1e17":"e","\u1ec1":"e","\u1e15":"e","\u1e1d":"e","\u0207":"e","\xec":"i","\xed":"i","\xee":"i","\xef":"i","\u1e2f":"i","\u020b":"i","\xf0":"d","\xf1":"n","\xf2":"o","\xf3":"o","\xf4":"o","\xf5":"o","\xf6":"o","\xf8":"o","\u1ed1":"o","\u1e4d":"o","\u1e53":"o","\u020f":"o","\xf9":"u","\xfa":"u","\xfb":"u","\xfc":"u","\xfd":"y","\xff":"y","\u0100":"A","\u0101":"a","\u0102":"A","\u0103":"a","\u0104":"A","\u0105":"a","\u0106":"C","\u0107":"c","\u0108":"C","\u0109":"c","\u010a":"C","\u010b":"c","\u010c":"C","\u010d":"c","C\u0306":"C","c\u0306":"c","\u010e":"D","\u010f":"d","\u0110":"D","\u0111":"d","\u0112":"E","\u0113":"e","\u0114":"E","\u0115":"e","\u0116":"E","\u0117":"e","\u0118":"E","\u0119":"e","\u011a":"E","\u011b":"e","\u011c":"G","\u01f4":"G","\u011d":"g","\u01f5":"g","\u011e":"G","\u011f":"g","\u0120":"G","\u0121":"g","\u0122":"G","\u0123":"g","\u0124":"H","\u0125":"h","\u0126":"H","\u0127":"h","\u1e2a":"H","\u1e2b":"h","\u0128":"I","\u0129":"i","\u012a":"I","\u012b":"i","\u012c":"I","\u012d":"i","\u012e":"I","\u012f":"i","\u0130":"I","\u0131":"i","\u0132":"IJ","\u0133":"ij","\u0134":"J","\u0135":"j","\u0136":"K","\u0137":"k","\u1e30":"K","\u1e31":"k","K\u0306":"K","k\u0306":"k","\u0139":"L","\u013a":"l","\u013b":"L","\u013c":"l","\u013d":"L","\u013e":"l","\u013f":"L","\u0140":"l","\u0141":"l","\u0142":"l","\u1e3e":"M","\u1e3f":"m","M\u0306":"M","m\u0306":"m","\u0143":"N","\u0144":"n","\u0145":"N","\u0146":"n","\u0147":"N","\u0148":"n","\u0149":"n","N\u0306":"N","n\u0306":"n","\u014c":"O","\u014d":"o","\u014e":"O","\u014f":"o","\u0150":"O","\u0151":"o","\u0152":"OE","\u0153":"oe","P\u0306":"P","p\u0306":"p","\u0154":"R","\u0155":"r","\u0156":"R","\u0157":"r","\u0158":"R","\u0159":"r","R\u0306":"R","r\u0306":"r","\u0212":"R","\u0213":"r","\u015a":"S","\u015b":"s","\u015c":"S","\u015d":"s","\u015e":"S","\u0218":"S","\u0219":"s","\u015f":"s","\u0160":"S","\u0161":"s","\u0162":"T","\u0163":"t","\u021b":"t","\u021a":"T","\u0164":"T","\u0165":"t","\u0166":"T","\u0167":"t","T\u0306":"T","t\u0306":"t","\u0168":"U","\u0169":"u","\u016a":"U","\u016b":"u","\u016c":"U","\u016d":"u","\u016e":"U","\u016f":"u","\u0170":"U","\u0171":"u","\u0172":"U","\u0173":"u","\u0216":"U","\u0217":"u","V\u0306":"V","v\u0306":"v","\u0174":"W","\u0175":"w","\u1e82":"W","\u1e83":"w","X\u0306":"X","x\u0306":"x","\u0176":"Y","\u0177":"y","\u0178":"Y","Y\u0306":"Y","y\u0306":"y","\u0179":"Z","\u017a":"z","\u017b":"Z","\u017c":"z","\u017d":"Z","\u017e":"z","\u017f":"s","\u0192":"f","\u01a0":"O","\u01a1":"o","\u01af":"U","\u01b0":"u","\u01cd":"A","\u01ce":"a","\u01cf":"I","\u01d0":"i","\u01d1":"O","\u01d2":"o","\u01d3":"U","\u01d4":"u","\u01d5":"U","\u01d6":"u","\u01d7":"U","\u01d8":"u","\u01d9":"U","\u01da":"u","\u01db":"U","\u01dc":"u","\u1ee8":"U","\u1ee9":"u","\u1e78":"U","\u1e79":"u","\u01fa":"A","\u01fb":"a","\u01fc":"AE","\u01fd":"ae","\u01fe":"O","\u01ff":"o","\xde":"TH","\xfe":"th","\u1e54":"P","\u1e55":"p","\u1e64":"S","\u1e65":"s","X\u0301":"X","x\u0301":"x","\u0403":"\u0413","\u0453":"\u0433","\u040c":"\u041a","\u045c":"\u043a","A\u030b":"A","a\u030b":"a","E\u030b":"E","e\u030b":"e","I\u030b":"I","i\u030b":"i","\u01f8":"N","\u01f9":"n","\u1ed2":"O","\u1ed3":"o","\u1e50":"O","\u1e51":"o","\u1eea":"U","\u1eeb":"u","\u1e80":"W","\u1e81":"w","\u1ef2":"Y","\u1ef3":"y","\u0200":"A","\u0201":"a","\u0204":"E","\u0205":"e","\u0208":"I","\u0209":"i","\u020c":"O","\u020d":"o","\u0210":"R","\u0211":"r","\u0214":"U","\u0215":"u","B\u030c":"B","b\u030c":"b","\u010c\u0323":"C","\u010d\u0323":"c","\xca\u030c":"E","\xea\u030c":"e","F\u030c":"F","f\u030c":"f","\u01e6":"G","\u01e7":"g","\u021e":"H","\u021f":"h","J\u030c":"J","\u01f0":"j","\u01e8":"K","\u01e9":"k","M\u030c":"M","m\u030c":"m","P\u030c":"P","p\u030c":"p","Q\u030c":"Q","q\u030c":"q","\u0158\u0329":"R","\u0159\u0329":"r","\u1e66":"S","\u1e67":"s","V\u030c":"V","v\u030c":"v","W\u030c":"W","w\u030c":"w","X\u030c":"X","x\u030c":"x","Y\u030c":"Y","y\u030c":"y","A\u0327":"A","a\u0327":"a","B\u0327":"B","b\u0327":"b","\u1e10":"D","\u1e11":"d","\u0228":"E","\u0229":"e","\u0190\u0327":"E","\u025b\u0327":"e","\u1e28":"H","\u1e29":"h","I\u0327":"I","i\u0327":"i","\u0197\u0327":"I","\u0268\u0327":"i","M\u0327":"M","m\u0327":"m","O\u0327":"O","o\u0327":"o","Q\u0327":"Q","q\u0327":"q","U\u0327":"U","u\u0327":"u","X\u0327":"X","x\u0327":"x","Z\u0327":"Z","z\u0327":"z"},b=Object.keys(a).join("|"),c=new RegExp(b,"g"),d=new RegExp(b,"");b=function(b){return b.replace(c,function(b){return a[b]})};var e=function(a){return!!a.match(d)};g.exports=b;g.exports.has=e;g.exports.remove=b}var i=!1;function j(){i||(i=!0,h());return g.exports}function a(a){switch(a){case void 0:return j()}}e.exports=a}),null);
__d("remove-accents",["remove-accents-0.4.2"],(function(a,b,c,d,e,f){e.exports=b("remove-accents-0.4.2")()}),null);/*FB_PKG_DELIM*/
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a,b,c;return{deletePersistedJob:(a=d("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(b=d("MAWTransactionMode")).READWRITE,"deletePersistedJob")((c=d("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:a.makeJobsTransactor("jobs",b.READONLY,"loadAllJobs")(c.readAllPersistedJobs),maybeCreateJob:a.makeJobsTransactor("jobs",b.READWRITE,"maybeCreateJob")(c.maybeCreateJob),readPersistedJob:a.makeJobsTransactor("jobs",b.READONLY,"readPersistedJob")(c.readPersistedJob),updatePersistedJob:a.makeJobsTransactor("jobs",b.READWRITE,"updatePersistedJob")(c.updatePersistedJob)}}g.getJobPersistenceAccessors=a}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(){function a(a){this.tasks=[];this.pendingTasks=[];this.lastJobStartedTimestampMs=null;this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}}var b=a.prototype;b.updateConfig=function(a){this.jobMaxConcurrency=(a=a.jobMaxConcurrencyMap)!=null?a:{}};b.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(a,b){var c;c=(c=a[b.jobName])!=null?c:0;a[b.jobName]=c+1;return a},{})};b.next=function(){var a=this;if(this.tasks.length===0)return null;var b=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.tasks.filter(function(c){var e;return((e=b.get(c.jobName))!=null?e:0)<((e=a.jobMaxConcurrency[c.jobName])!=null?e:d("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return c.length>0?[c[0]]:null};b.add=function(a,b,c,d){c={jobId:c,jobInfo:b,jobName:a,run:d};this.tasks.push(c);return c};b.markJobTaskPending=function(a){this.pendingTasks.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(a),this.tasks=this.tasks.filter(function(b){return b.jobId!==a.jobId})};b.markJobTaskDone=function(a){this.pendingTasks=this.pendingTasks.filter(function(b){return b.jobId!==a}),this.tasks.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),a).sendLogs("JobOrchestrator::markJobTaskDone")};b.count=function(){return this.tasks.length};b.pendingCount=function(){return this.pendingTasks.length};b.clearWaitingTasks=function(){this.tasks=[]};b.clear=function(){this.tasks=[],this.pendingTasks=[]};b.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs};return a}();b=function(a){function b(){return a.apply(this,arguments)||this}babelHelpers.inheritsLoose(b,a);var c=b.prototype;c.next=function(){var a=this,b,c;if(this.tasks.length===0)return null;var d=this.pendingTasks.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),e=this.tasks.filter(function(b){var c;return((c=d.get(b.jobName))!=null?c:0)<((c=a.jobMaxConcurrency[b.jobName])!=null?c:1)});if(e.length===0)return null;b=(b=this.jobMaxConcurrency[e[0].jobName])!=null?b:1;c=(c=d.get(e[0].jobName))!=null?c:0;if(b>1&&c<b){var f=e.filter(function(a){return a.jobName===e[0].jobName});b=Math.min(f.length,b-c);return f.slice(0,b)}return[e[0]]};return b}(a);g.BaseJobBucket=a;g.LowJobBucket=b}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=d("WATimeUtils").performanceAbsoluteNow();return new(h||(h=b("Promise")))(function(b){setTimeout(function(){b(d("WATimeUtils").performanceAbsoluteNow()-a)},0)})}g.getEventLoopDelay=a}),98);
__d("WAConcurrentBucketJobQueue",["WABase64","WACryptoDependencies","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=30,k=new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);function l(a){a=new Uint8Array(a);d("WACryptoDependencies").getCrypto().getRandomValues(a);return d("WABase64").encodeB64(a)}a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map(),this.$6=new Map(),this.$7=new Map(),this.$9=0}var b=a.prototype;b.init=function(a,b){var e,f,g;if(this.$1)throw c("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=a==null?void 0:a.bestEffortWaitTimeoutSec)!=null?e:j;this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$8=b;this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota);this.$6=new Map(this.$7);this.$5=new Map();this.$9=Date.now();b=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});e=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(e=a.maxConcurrencyPerJob)!=null?e:{}});f=new(d("WAJobPriorityBucket").LowJobBucket)({jobMaxConcurrencyMap:(f=a.maxConcurrencyPerJob)!=null?f:{}});g=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(g=a.maxConcurrencyPerJob)!=null?g:{}});a=new(d("WAJobPriorityBucket").BaseJobBucket)({jobMaxConcurrencyMap:(a=a.maxConcurrencyPerJob)!=null?a:{}});this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,b);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,g);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,a);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,e);this.$5.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,f);this.$1=!0};b.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2,this.$2=a.maxConcurrency,this.$5.forEach(function(b){return b.updateConfig({jobMaxConcurrencyMap:(b=a.maxConcurrencyPerJob)!=null?b:{}})}),this.$7=this.$11(a==null?void 0:a.jobPrioritiesQuota),d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"])))};b.isInitialized=function(){return this.$1};b.clearQueue=function(){if(!this.$1)throw c("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(a){return a.clear()})};b.clearQueueByPriority=function(a){if(!this.$1)throw c("err")("WAConcurrentBucketJobQueue not initialized");(a=this.$5.get(a))==null||a.clearWaitingTasks()};b.getIntStats=function(){var a=this,b=function(b){var c;b=a.$5.get(b);return((c=b==null?void 0:b.count())!=null?c:0)+((c=b==null?void 0:b.pendingCount())!=null?c:0)};return{highPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};b.getStringStats=function(){var a=this,b=function(b){var c=(b=(b=a.$5.get(b))==null?void 0:b.getStats())!=null?b:{};b=Object.keys(c).reduce(function(a,b){var d=a[0];a=a[1];var e=c[b];return e>d?[e,b]:[d,a]},[0,null]);b=b[1];return b};return{highPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:b(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}};b.enqueue=function(a,b,e,f){var g,h=this;if(!this.$1)return Promise.reject(c("err")("WAConcurrentBucketJobQueue not initialized"));var i,j,k=new Promise(function(a,b){i=a,j=b}),m=babelHelpers.extends({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},e),n=this.getJobBucketByType(m.priority);if(!n)return Promise.reject(c("err")("WAConcurrentBucketJobQueue no bucket for job with name "+a+" was found."));void d("WAMetrics").getEventLoopDelay().then(function(a){f!=null&&f.isActive()&&(f==null||f.addPoint("measure_event_loop_delay",{int:{eventLoopDelay:a}}))});f==null||f.addPoint("scheduling_job",{string:babelHelpers.extends({},this.getStringStats(),{priority:m.priority}),int:babelHelpers.extends({},this.getIntStats(),{maxTimeoutMs:(g=e==null?void 0:e.maxTimeoutMs)!=null?g:0})});var o=m.priority+"-"+a+"-"+((g=e==null?void 0:e.jobId)!=null?g:l(8));g=n.add(a,m,o,async function(){try{h.$8.logJobStarted(o);var a=await h.$12(b(),e==null?void 0:e.maxTimeoutMs);h.$8.logJobCompleted(o);i(a)}catch(a){a instanceof d("WACustomError").TimeoutError?h.$8.logJobTimeout(o):h.$8.logJobError(o),j(a)}});this.$8.logJobCreated({jobId:o,jobName:a,jobPriority:m.priority,pendingJobsCount:n.count()});e&&e.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&void this.$13(g);this.$14();return k};b.getAvailableThreadsCount=function(){return this.$3};b.getJobQuotaConfig=function(){return this.$7};b.getRemainingJobCountMap=function(){return this.$6};b.getJobBucketByType=function(a){return this.$5.get(a)};b.getSnapshot=function(a){a=this.getJobBucketByType(a);return!a?null:a.getStats()};b.$11=function(a){var b;!a?b=new Map(k):b=new Map(a);b.set(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0);return b};b.$15=function(a){return(a=this.$6.get(a))!=null?a:0};b.$16=function(){this.$6=new Map(this.$7)};b.$17=function(a){var b=this;a===void 0&&(a=!0);var c=0,e=null,f=0;this.$5.forEach(function(a,d){c+=a==null?void 0:a.count();f+=b.$15(d);if(e!=null)return;a.count()>0&&b.$15(d)>0&&(e=a)});var g=e==null||f===0;g&&this.$16();if(this.$18(c,g))return this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);return e==null&&a?this.$17(!1):e};b.$18=function(a,b){var c=this;function e(a,b){var c=Date.now();return a>c?!1:c-a<b*1e3}function f(a,b){a=Math.ceil(a-Date.now())+b*1e3;return a>0?a:0}var g=this.getJobBucketByType(d("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT);a=a-((a=g==null?void 0:g.count())!=null?a:0);var h=g==null?void 0:g.getLastJobStartedTimestamp();if((g==null?void 0:g.count())===0)return!1;if(h==null&&e(this.$9,this.$4)){if(this.$10==null){g=f(this.$9,this.$4);this.$10=setTimeout(function(){c.$14(),c.$10=null},g)}return!1}return a>0&&h!=null&&e(h,this.$4)?!1:b};b.$19=function(a){a=this.$20(a);return c("WANullthrows")(this.$5.get(a))};b.$20=function(a){var b=a.split("-")[0];b=d("WAJobOrchestratorTypes").JOB_PRIORITY.cast(b);if(!b)throw c("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+a);return b};b.$21=function(a){a=this.$20(a);this.$15(a)>0?this.$6.set(a,this.$15(a)-1):this.$6.set(a,0)};b.$14=function(){var a=this;while(this.$3>0){var b=this.$17();b=b==null?void 0:b.next();if(b==null)break;b.forEach(function(b){a.$21(b.jobId),void a.$13(b)})}};b.$12=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};b.$13=async function(a){var b=this,c=this.$19(a.jobId);this.$3--;c.markJobTaskPending(a);var e=a.run,f=a.jobId,g=a.jobName;try{await this.$12(e(),((e=a.jobInfo)==null?void 0:e.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(a){if(a instanceof d("WACustomError").TimeoutError)this.$8.logJobTimeout(f),d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),g);else throw a}finally{this.$3++,c.markJobTaskDone(f),this.$3>0&&setTimeout(function(){return b.$14()},0)}};return a}();g.WAConcurrentBucketJobQueue=a}),98);
__d("WAConcurrentPreemptiveJobQueue",["WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a=function(){function a(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var b=a.prototype;b.init=function(a,b){if(this.$1)throw c("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=a.maxConcurrency;this.$3=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};this.$7=b;this.$1=!0};b.updateConfig=function(a){this.$3+=a.maxConcurrency-this.$2;this.$2=a.maxConcurrency;this.$4=(a=a.maxConcurrencyPerJob)!=null?a:{};d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"])))};b.isInitialized=function(){return this.$1};b.clearQueueByPriority=function(a){if(!this.$1)throw c("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(b){return((b=b.jobInfo)==null?void 0:b.priority)!==a})};b.clearQueue=function(){if(!this.$1)throw c("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[];this.$6=[]};b.enqueue=function(a,b,e){var f,g=this;if(!this.$1)return Promise.reject(c("err")("ConcurrentPreemptiveJobQueue not initialized"));var h,i,j=new Promise(function(a,b){h=a,i=b}),k=babelHelpers.extends({priority:d("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},e),l=(f=e==null?void 0:e.jobId)!=null?f:d("WARandomHex").randomHex(8).substr(0,64);f=this.$8(a,k,l,async function(){try{g.$7.logJobStarted(l);var a=await g.$9(b(),e==null?void 0:e.maxTimeoutMs);g.$7.logJobCompleted(l);h(a)}catch(a){a instanceof d("WACustomError").TimeoutError?g.$7.logJobTimeout(l):g.$7.logJobError(l),i(a)}});e&&e.priority===d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(f);this.$11();return j};b.getAvailableThreadsCount=function(){return this.$3};b.getJobMaxConcurrency=function(){return this.$4};b.getSnapshot=function(a){};b.$11=function(){while(this.$3>0){var a=this.$12();if(a==null)break;this.$10(a)}};b.$9=function(a,b){return b!==void 0?d("WAPromiseTimeout").promiseTimeout(a,b):a};b.$10=async function(a){var b=this;this.$3--;this.$13(a);var c=a.run,e=a.jobId,f=a.jobName;try{await this.$9(c(),((c=a.jobInfo)==null?void 0:c.maxTimeoutMs)===void 0?d("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(a){if(a instanceof d("WACustomError").TimeoutError)this.$7.logJobTimeout(e),d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),f);else throw a}finally{this.$3++,this.$14(e),setTimeout(function(){return b.$11()},0)}};b.$8=function(a,b,c,d){d={jobId:c,jobInfo:b,jobName:a,run:d};this.$7.logJobCreated({jobId:c,jobName:a,jobPriority:b.priority,pendingJobsCount:this.$5.length});this.$5.push(d);return d};b.$13=function(a){this.$6.includes(function(b){return b.jobId===a.jobId})&&d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),a.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(a),this.$5=this.$5.filter(function(b){return b.jobId!==a.jobId})};b.$14=function(a){this.$6=this.$6.filter(function(b){return b.jobId!==a}),this.$5.includes(function(b){return b.jobId===a})&&d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),a).sendLogs("JobOrchestrator::markJobTaskDone")};b.$12=function(){var a=this;if(this.$5.length===0)return null;var b=this.$6.reduce(function(a,b){var c;c=(c=a.get(b.jobName))!=null?c:0;a.set(b.jobName,c+1);return a},new Map()),c=this.$5.filter(function(c){var d;return((d=b.get(c.jobName))!=null?d:0)<((d=a.$4[c.jobName])!=null?d:1)});return c[0]};return a}();g.WAConcurrentPreemptiveJobQueue=a}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","err"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(){this.$2=!1}var b=a.prototype;b.init=function(a,b){if(this.$2)throw c("err")("DefaultNoQueue has already initialized");this.$1=b;this.$2=!0};b.updateConfig=function(a){};b.isInitialized=function(){return this.$2};b.clearQueue=function(){};b.clearQueueByPriority=function(a){};b.getSnapshot=function(){throw c("err")("getSnapshot is not implemented for DefaultNoQueue")};b.enqueue=async function(a,b,c){var e;e=(e=c==null?void 0:c.jobId)!=null?e:d("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:e,jobName:a,jobPriority:(a=c==null?void 0:c.priority)!=null?a:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(e);c=await b();this.$1.logJobCompleted(e);return c}catch(a){this.$1.logJobError(e);throw a}};return a}();g.WADefaultJobNoQueue=a}),98);
__d("WAOrchestratorJobStatsLogger",["WAGlobals","WAPREList","WAPREMetrics"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){function a(a,b,c){this.jobName=a,this.pendingJobsCount=c,this.jobPriority=b}var b=a.prototype;b.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR,{string:{name:this.jobName,jobPriority:this.jobPriority,orchestratorVersion:d("WAGlobals").getConfig().orchestratorVersion()},"int":{pendingJobsCount:this.pendingJobsCount,addedAt:this.webcJobAddedT}})};b.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{"int":{startedAt:this.webcJobStartedT}})};b.logJobCompleted=function(a){this.webcJobCompletedT=Date.now();this.jobResultType=a;var b={"int":{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};a==="completed"?this.eventFlow.endSuccess(b):this.eventFlow.endFail(a,b)};return a}();a=function(){function a(){this.$1=new Map()}var b=a.prototype;b.logJobCreated=function(a){var b=a.jobName,c=a.jobId,d=a.jobPriority;a=a.pendingJobsCount;b=new h(b,d,a);b.logJobAdded();this.$1.set(c,b)};b.logJobStarted=function(a){a=this.$1.get(a);a==null||a.logJobStarted()};b.logJobCompleted=function(a){this.$2(a,"completed")};b.logJobError=function(a){this.$2(a,"error")};b.logJobTimeout=function(a){this.$2(a,"timeout")};b.logJobAborted=function(a){this.$2(a,"aborted")};b.$2=function(a,b){var c=this.$1.get(a);c==null||c.logJobCompleted(b);this.$1["delete"](a)};return a}();g.JobInfoEvent=h;g.JobStatsLogger=a}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a={maxConcurrency:1},b="default",c={},e=a,f=new(d("WAOrchestratorJobStatsLogger").JobStatsLogger)();return function(g,j){var k;g===void 0&&(g=!1);g=g?b:d("WAGlobals").getConfig().orchestratorVersion();k=(k=i())!=null?k:a;var l;j==null||j.addPoint("get_orchestrator",{string:{orchestrator:g},"int":{maxConcurrency:k.maxConcurrency,highPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?j:0,lowPriorityQuota:(j=(j=k.jobPrioritiesQuota)==null?void 0:j.get(d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?j:0}});if(c[g]){h(e,k)&&(e=k,c[g].updateConfig(k));return c[g]}switch(g){case"preemptive":l=new(d("WAConcurrentPreemptiveJobQueue").WAConcurrentPreemptiveJobQueue)();break;case"bucket":l=new(d("WAConcurrentBucketJobQueue").WAConcurrentBucketJobQueue)();break;default:l=new(d("WADefaultJobNoQueue").WADefaultJobNoQueue)();break}l.init(k,f);c[g]=l;e=k;return l}}function h(a,b){var c;if(a.maxConcurrency!==b.maxConcurrency)return!0;if(((c=a.jobPrioritiesQuota)==null?void 0:c.size)!==((c=b.jobPrioritiesQuota)==null?void 0:c.size))return!0;return Object.keys((c=a.maxConcurrencyPerJob)!=null?c:{}).length!==Object.keys((c=b.maxConcurrencyPerJob)!=null?c:{}).length?!0:JSON.stringify(a)!==JSON.stringify(b)}function i(){var a={jobPrioritiesQuota:new Map([[d("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return a}g.getInstanceDelegate=a}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){var a=-1,c=new Map();return{deletePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c["delete"](a))},loadAllJobs:function(){return(h||(h=b("Promise"))).resolve(Array.from(c.values()))},maybeCreateJob:function(e){var f,g=JSON.stringify([e.type,(f=e.uniqKey)!=null?f:d("WARandomHex").randomHex(32)]),i={backedOffCount:0,current:e.args,original:e.args,startTime:d("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:e.type,uniqKey:g,version:e.version,waitUntil:null,scheduleConfig:e.scheduleConfig};f=function(){var d=a--,e=babelHelpers["extends"]({},i,{jobId:d});c.set(d,e);return(h||(h=b("Promise"))).resolve({id:d,newlyCreated:!0})};if(e.uniqKey!=null){e=Array.from(c.values()).filter(function(a){return a.uniqKey===g});if(e.length===0)return f();var j=null;e.forEach(function(a){a.step!=="$finished"?j=a:c["delete"](a.jobId)});return j!=null?(h||(h=b("Promise"))).resolve({id:j.jobId,newlyCreated:!1}):f()}return f()},readPersistedJob:function(a){a=c.get(a);return(h||(h=b("Promise"))).resolve(a&&babelHelpers["extends"]({},a))},updatePersistedJob:function(a){return(h||(h=b("Promise"))).resolve(c.set(a.jobId,babelHelpers["extends"]({},a)))}}}g.getJobInMemoryAccessors=a}),98);
__d("WAPersistedJobManagerV2",["WAGlobals","WAJids","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPREList","WAPREMetrics","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=1;function N(a){var b=a.code,c=a.annotations;c=c===void 0?{}:c;a=a.eventFlow;var d=a===void 0?O(c):a;return b(d).then(function(a){d.endSuccess();return a}).catch(function(a){d.endFail("error",{string:{error:""+a}});throw a})}function O(a){a===void 0&&(a={});return d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.WA_JOB_MANAGER,babelHelpers.extends({},a,{string:babelHelpers.extends({},(a=(a=a)==null?void 0:a.string)!=null?a:{},{userHash:d("WAGlobals").getDependencies().isEmployee()&&d("WAGlobals").getDependencies().isUseridAnnotationEnabled()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null})}))}a=function(){function a(a){var b=this;this.$1=[];var c=a.isRestartAfterCrash,e=a.accessors,f=a.unfinishedJobEntries,g=a.ignoreForceNonPersistedJobList;this.getOrchestratorDelegate=d("WAOrchestrator").getInstanceDelegate();this.activeJobs=new Map();this.implementationLoaders=new Map();this.implementations=new Map();this.stepBlockers=new WeakMap();this.accessors=e;this.isRestartAfterCrash=c||!1;this.listeners=a.listeners;this.deprecatedJobs=a.deprecatedJobs;this.inMemoryAccessors=d("WaJobInMemoryAccessors").getJobInMemoryAccessors();this.offlineQueueMode=!0;this.$1=g;a.offlineQueueCompletePromise!=null?a.offlineQueueCompletePromise.finally(function(){b.offlineQueueMode=!1}):this.offlineQueueMode=!1;this.initialJobsPromise=f.then(function(a){var c=[],e=[];a.forEach(function(a){a.stepHardStartCountAfterTimeout>=5?c.push(a):e.push(a)});return Promise.all(c.map(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),Q(a),a.step).devConsole(P(a)).sendLogs("job-stuck-"+a.type);return b.accessors.deletePersistedJob(a.jobId)})).then(function(){e.forEach(function(a){var c=b.$2(a.jobId);if(c.alreadyActive===!0){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"])));return}c.deferred.resolve(N({code:function(c){return b.$3(a,b.accessors,{eventFlow:c})},annotations:{string:{name:a.type},bool:{offlineQueueMode:b.offlineQueueMode}}}))})})})}var b=a.prototype;b.$4=async function(a,b,e){var f;e===void 0&&(e={});var g=this.$2(a);(f=e.eventFlow)==null||f.addPoint("start_load_and_run",{bool:{skipped:g.alreadyActive}});if(g.alreadyActive===!0)return g.deferred;f=await b.readPersistedJob(a);if(f==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))).sendLogs("missing-job-entry");throw c("err")("Persisted job missing for given ID "+a)}g.deferred.resolve(this.$3(f,b,e));return g.deferred.promise};b.$3=function(a,b,c){var e;c===void 0&&(c={});(e=c.eventFlow)==null||e.addPoint("enqueueing_job",{string:{name:a.type}});return this.getOrchestratorDelegate(((e=a.scheduleConfig)==null?void 0:e.priority)===d("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,c.eventFlow).enqueue(a.type,this.$5(a,b,c),a.scheduleConfig,c.eventFlow)};b.$6=function(a,b,c){var d=this;c===void 0&&(c={});return b.maybeCreateJob(a).then(function(a){var e;a=a.id;(e=c.eventFlow)==null||e.addPoint("job_persisted",{int:{jobId:a},bool:{nonPersisted:b===d.inMemoryAccessors}});return a})};b.$2=function(a){var b=this.activeJobs.get(a);if(b!=null)return{alreadyActive:!0,deferred:b};b=new(d("WAResolvable").Resolvable)();this.activeJobs.set(a,b.promise);return{alreadyActive:!1,deferred:b}};b.$5=function(a,b,c){var d=this;return function(){return d.$7(a,b,c)}};b.$8=function(a){var b=this.implementations,c=this.implementationLoaders,d=b.get(a);if(d)return d;d=c.get(a);if(!d)return null;c=d();b.set(a,c);return c};b.$9=function(a,b){if(b==null||b.length===0)return Promise.resolve();var c=this.stepBlockers,e=c.get(b);e==null&&(e=d("WAJobRequirement").joinRequirements(b.map(function(a){return a()}),S),c.set(b,e));return e(a)};b.$10=function(a,b,c,e,f){var g,h=this;f===void 0&&(f={});var i=a.step;(g=f.eventFlow)==null||g.addPoint("start_step");var j=b.findIndex(function(a){return a.stepName===i});g=b[j].info(a.current,a.original,T(a,this.isRestartAfterCrash));var m=g.requirements,n=g.code;g=this.$9(a,m);e&&(g=g.then(e));return g.then(function(){var b;d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),R(a));(b=f.eventFlow)==null||b.addPoint("run_step");return n(a.current,a.original,T(a,h.isRestartAfterCrash,f.eventFlow))}).then(function(e){var g;(g=f.eventFlow)==null||g.addPoint("step_is_complete");if(e instanceof d("WAPersistedJobManager").InterruptJob){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),R(a));return e.result}g=j+1;if(g>=b.length)return e;g=b[g];a.step=g.stepName;a.current=e;a.stepHardStartCountAfterTimeout=0;a.stepFirstStartTime=d("WATimeUtils").unixTime();a.stepUnexpectedErrorCount=0;a.waitUntil=null;a.backedOffCount=0;return c.updatePersistedJob(a).then(function(){return h.$10(a,b,c,void 0,f)})})};b.$7=async function(a,b,c){var e,f=this;c===void 0&&(c={});var g=this.activeJobs,h=this.deprecatedJobs,i=this.listeners,j=i.onJobFinished;i=i.onJobStarted;(e=c.eventFlow)==null||e.addPoint("run_job");e=await this.$8(a.type);h=h[a.type];if(!e){if(!h){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),a.type).sendLogs("missing-job-implementation");await b.deletePersistedJob(a.jobId);return null}else if(h==="NOOP"){d("WALogger").WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),a.type);await b.deletePersistedJob(a.jobId);return null}e=await h()}var k=e;h&&d("WALogger").LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),a.type);var l=(h=a.stepFirstStartTime)!=null?h:d("WATimeUtils").unixTime();a.stepFirstStartTime=l;a.stepUnexpectedErrorCount=a.stepUnexpectedErrorCount||0;a.backedOffCount=a.backedOffCount||0;if(a.step===d("WAPersistedJobManager").FINISHED_JOB){h=a.waitUntil;var C=d("WATimeUtils").secondsUntil(l);h!=null&&d("WATimeUtils").isInFuture(h)&&C>0&&(d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),P(a)),h=d("WATimeUtils").castToUnixTime(h-C),d("WATimeUtils").isInFuture(h)&&(a.stepFirstStartTime=d("WATimeUtils").castToUnixTime(l-C),a.waitUntil=h,await b.updatePersistedJob(a)));(h==null||!d("WATimeUtils").isInFuture(h))&&(d("WALogger").LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),P(a)),await b.deletePersistedJob(a.jobId));g.delete(a.jobId);return a.current}C=a.step!==d("WAPersistedJobManager").UNSTARTED_JOB?e.find(function(b){return b.stepName===a.step}):e[0];if(!C){d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),a.type,a.step).sendLogs("missing-job-step");await b.deletePersistedJob(a.jobId);return null}a.step=C.stepName;var D=function(){var e=a.waitUntil,g=Promise.resolve();if(e!=null){var h=d("WATimeUtils").futureUnixTime(d("WATimeUtils").DAY_SECONDS);e>h?(d("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),R(a),e,h),a.waitUntil=h,g=b.updatePersistedJob(a).then(function(){return d("WATimeUtils").delayUntil(h)})):(d("WALogger").LOG(t||(t=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),R(a),e),g=d("WATimeUtils").delayUntil(e))}return g.then(function(){var e=function(){a.waitUntil=null;d("WATimeUtils").happenedWithin(l,d("WATimeUtils").DAY_SECONDS)||a.stepHardStartCountAfterTimeout++;return b.updatePersistedJob(a)};return f.$10(a,k,b,e,c).catch(function(e){if(e instanceof d("WAPersistedJobManager").RetryOnBackoff){var f;d("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),R(a));(f=c.eventFlow)==null||f.addPoint("retry_on_backoff");f=d("WAPromiseBackoffs").getDelay(++a.backedOffCount,e.backoffOptions);a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(f/1e3));a.stepHardStartCountAfterTimeout>0&&--a.stepHardStartCountAfterTimeout;return b.updatePersistedJob(a).then(D)}else{if(!(e instanceof d("WAPersistedJobManager").NonRetryableError)&&a.stepUnexpectedErrorCount<M){(f=c.eventFlow)==null||f.addPoint("retry_on_unexpected_error");d("WALogger").WARN(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),R(a),a.stepUnexpectedErrorCount);d("WALogger").WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),R(a),e);a.stepUnexpectedErrorCount++;return b.updatePersistedJob(a).then(D)}throw e}})})},E=D();h=E.then(async function(c){d("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),R(a));var e=null;try{e=j(a.jobId,a.type,a.original,c)}catch(b){d("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),a.type,b).sendLogs("onJobFinished-threw")}e!=null&&e>0?(a.waitUntil=d("WATimeUtils").futureUnixTime(Math.ceil(e/1e3)),a.step=d("WAPersistedJobManager").FINISHED_JOB,a.current=c,a.stepFirstStartTime=d("WATimeUtils").unixTime(),await b.updatePersistedJob(a)):(await b.deletePersistedJob(a.jobId),g.delete(a.jobId))},async function(c){d("WALogger").ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),a.type,c).sendLogs("job-threw-exception-"+a.type);c=k.find(function(b){return b.stepName===a.step});if(!c)d("WALogger").ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),a.type,a.step);else{c=c.info(a.current,a.original,T(a,f.isRestartAfterCrash));c.stopRetryIf!=null&&await c.stopRetryIf.onStopRetry(a.current,a.original,T(a,f.isRestartAfterCrash))}await b.deletePersistedJob(a.jobId);g.delete(a.jobId)});try{i(a.jobId,a.type,a.original)}catch(b){d("WALogger").ERROR(B||(B=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),a.type,b).sendLogs("onJobStarted-threw")}return h.then(function(){return E})};b.addPersistedJobImplementation=function(a,b){var c=this.implementationLoaders,e=this.deprecatedJobs;if(c.has(a)){d("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),a).sendLogs("repeat-job-loader");return}e&&e[a]&&d("WALogger").DEV(D||(D=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"])),a);c.set(a,b)};b.fireAndForget=function(a){var b=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),a.type);this.fireAndForgetNonPersisted(a);return}d("WALogger").LOG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),a.type);N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.accessors,d).then(function(a){return b.$4(a,b.accessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};b.waitUntilPersisted=async function(a){var b=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(G||(G=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),a.type);this.fireAndForgetNonPersisted(a);return Promise.resolve()}d("WALogger").LOG(H||(H=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),a.type);var c=O({string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}});await this.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return this.$6(a,this.accessors,{eventFlow:c}).then(function(a){N({code:function(c){c={eventFlow:c};return b.$4(a,b.accessors,c)},eventFlow:c})}).catch(function(a){c.endFail("error",{string:{error:""+a}});throw a})};b.waitUntilCompleted=function(a){var b=this;if(this.$1.indexOf(a.type)===-1){d("WALogger").LOG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),a.type);return this.waitUntilCompletedNonPersisted(a)}d("WALogger").LOG(J||(J=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),a.type);return N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.accessors,d).then(function(a){return b.$4(a,b.accessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};b.fireAndForgetNonPersisted=function(a){var b=this;N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.inMemoryAccessors,d).then(function(a){return b.$4(a,b.inMemoryAccessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};b.waitUntilCompletedNonPersisted=function(a){var b=this;return N({code:async function(c){var d={eventFlow:c};await b.initialJobsPromise;c.addPoint("initial_jobs_promise_fulfilled");return b.$6(a,b.inMemoryAccessors,d).then(function(a){return b.$4(a,b.inMemoryAccessors,d)})},annotations:{string:{name:a.type},bool:{offlineQueueMode:this.offlineQueueMode}}})};return a}();function P(a){return"Job["+a.jobId+"] ("+a.type+")"}function Q(a){return"[Job "+a.type+"] "}function R(a){return"Job["+a.jobId+"] ("+a.type+"."+a.step+")"}function S(a,b,c){a==="unsatisfiable"?d("WALogger").LOG(K||(K=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),R(c),b):a==="unsatisfied"?d("WALogger").LOG(L||(L=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),R(c),b):a}function T(a,b,c){b===void 0&&(b=!1);return{jobStartTime:a.startTime,afterCrash:b,interruptJob:U,eventFlow:c}}function U(a){return new(d("WAPersistedJobManager").InterruptJob)(a)}g.PersistedJobManager=a}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=new(d("WAPersistedJobManagerV2").PersistedJobManager)({accessors:d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(a,b,c,e){d("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:a,originalArgs:c,result:e,type:b},!0);return null},onJobStarted:c("emptyFunction")},offlineQueueCompletePromise:d("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:d("WAWaitForComms").waitForComms().then(function(){return d("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function a(){return d("MAWDefinePersistedJob").persistedJobsApi}function b(){return h}g.getPersistedJobsApi=a;g.getJobManager=b}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){function a(a){this.steps=a}var b=a.prototype;b.step=function(a,b){return this.$1(a,typeof b==="function"?{code:b}:b)};b.$1=function(b,c){var e=c.stopRetryIf,f=c.requirements;c=c.code;f=k(f,c,e);if(e){var g=e.timePassedSeconds;c=e.appCrashed;var h=e.onStopRetry;h=k(null,l(h),e);g!=null&&(f=j(function(a,b,c){a=c.jobStartTime;return d("WATimeUtils").happenedWithin(a,g)},f,h));c&&(f=j(function(a,b,c){a=c.afterCrash;return!a},f,h))}return new a([].concat(this.steps,[{stepName:b,info:f}]))};b.finalStep=function(a,b){var c=this.step(a,b);return{end:function(){return c.steps}}};return a}();function a(){return new i([])}function j(a,b,c){return function(d,e,f){return a(d,e,f)?b(d,e,f):c(d,e,f)}}function k(a,b,c){var d={requirements:a,code:b,stopRetryIf:c};return function(){return d}}function l(a){return function(c,e,f){return(h||(h=b("Promise"))).resolve(a(c,e,f)).then(function(a){return a instanceof d("WAPersistedJobManager").InterruptJob?a:new(d("WAPersistedJobManager").InterruptJob)(a)})}}g.JobBuilder=i;g.definePersistedJob=a}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(a,b,c,d,e,f,g){"use strict";var h;e={definePersistedJob:function(){return d("WAJobBuilder").definePersistedJob()}};function a(a){var c=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(d){var e=a[d];c.addPersistedJobImplementation(d,function(){return(h||(h=b("Promise"))).resolve(e)})})}function c(a){var b=d("MAWJobManager").getJobManager();Object.keys(a).forEach(function(c){var d=a[c];b.addPersistedJobImplementation(c,d)})}g.persistedJobsApi=e;g.setMsgrJobImplementations=a;g.setMsgrDeferredJobImplementations=c}),98);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){c("QPLUserFlow").start(c("qpl")._(521484676,"2684"),{annotations:b,instanceKey:a})}function b(a,b,d){c("QPLUserFlow").endFailure(c("qpl")._(521484676,"2684"),b,{annotations:d,instanceKey:a})}function d(a,b){c("QPLUserFlow").endSuccess(c("qpl")._(521484676,"2684"),{annotations:b,instanceKey:a})}function e(a,b,d){d&&c("QPLUserFlow").addAnnotations(c("qpl")._(521484676,"2684"),d,{instanceKey:a}),c("QPLUserFlow").addPoint(c("qpl")._(521484676,"2684"),b,{instanceKey:a})}g.startQplUserFlow=a;g.endFailure=b;g.endSuccess=d;g.addPoint=e}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=["originalTs","threadJid","unsendMsgContentDeleteTs"],i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;function A(a,b){if(a==="@me"||a==="@system")return b;else return a}function B(a,b,c,e,f){var g=[];if(a.reactionXOfflineThreadingIds!=null)for(var h=0;h<a.reactionXOfflineThreadingIds.length;++h){var i=d("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(b,c,e,null,f,a);i=i.map(function(a){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:a,unstoredDbReceiverFetchInfo:void 0},stanza:E(a.externalId,a.ts,A(a.author,c),b,"reaction")}});g.push.apply(g,i)}return g}function C(a,b,c,e,f){return e.map(function(e){if(e.messageId==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""])),a);f!=null&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(f,"getUnstoredDbEditsFromEcho_messageId_missing");return null}var g=e.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:d("MAWAckLevel").ACK.sent,author:c,editMsgContent:{content:e.text},externalId:d("WAStanzaUtils").toStanzaId(g),originalMsgExternalId:a,serverTs:d("WATimeUtils").castToUnixTime(e.timestamp),ts:d("WATimeUtils").castToUnixTime(e.timestamp),type:d("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:E(d("WAStanzaUtils").toStanzaId(g),d("WATimeUtils").castToUnixTime(e.timestamp),c,b,"text")}}).filter(Boolean)}function a(a,b){return a.map(J).filter(Boolean).map(function(a){return D(a,b)})}function D(a,b){var e,f=d("MAWUserJidWrapper").getMyUserJid(),g=a.from,h=d("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(a);if(g==null||h==null)return[];h=a.xOfflineThreadingId;if(h==null){c("FBLogger")("wmi_eb").warn("xOfflineThreadingId is null for Echo message");return[]}h=d("WAStanzaUtils").toStanzaId(h);e=d("WATimeUtils").castToUnixTime(((e=a.authoritativeTimestampMs)!=null?e:a.sortOrderMs)/1e3);g=d("MAWJids").toUserJid(g.localKey);var i=I(a,b,f,h,"echo_content");if(i.success===!1)return[];i=i.value;f=B(a,b,f,h,g);var j=a.contentType===d("EchoMessage").EchoMessageContentType.TEXT||a.contentType===d("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media";a=C(h,b,g,a.editHistory);return[{decodedMsg:i,stanza:E(h,e,g,b,j)}].concat(f,a)}function E(a,b,c,e,f){var g={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"};g={folder:null,id:{author:c,chat:e,externalId:a},msg:g,recipientsCount:null,reportingMeta:null,ts:b,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:e,message:{decrypted:g,details:{count:0,externalId:a,from:d("WAJids").switchOnMsgrChatJidType(e,{group:function(a){return{author:d("WAJids").defaultDeviceJidForUser(c),chat:a,groupJid:a,type:"group"}},user:function(a){return{author:d("WAJids").defaultDeviceJidForUser(c),chat:a,deviceJid:d("WAJids").defaultDeviceJidForUser(c),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:b,type:f}},priority:d("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:a,stanzaQueueId:d("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function F(a){if(a.mediaData==null)return d("WAResultOrError").makeResult(null);var b=a.previewMediaData,c=a.sortOrderMs,e=a.xOfflineThreadingId,f=a.mediaData,g=f.attachmentObjectId,h=f.backupEntFbid,i=f.directPath,l=f.encryptedHash,m=f.filename,n=f.height,o=f.mediaContentType,p=f.mediaKey,q=f.mediaKeyTimestamp,r=f.mediaPlayableDuration,s=f.plaintextHash,t=f.previewContentHeight,u=f.previewContentWidth,v=f.size;f=f.width;var w=a.contentType===d("EchoMessage").EchoMessageContentType.XMA;o=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(o||"",w);w=o.mediaType;o=o.serverMediaType;var x=d("WAHashUtils").stringToPlaintextHash(d("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(s)),y=null;if(b!=null)try{y=d("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(b),y!=null&&y.objectId==null&&d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"])))}catch(b){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""])),b,e,a.serializationOrigin)}if(p==null)return d("WAResultOrError").makeError("missing_media_key");if(l==null)return d("WAResultOrError").makeError("missing_encrypted_hash");b=d("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(x,l,p,i,q,o,m,h,g,y,v);e=d("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:m,height:n,mediaPlayableDuration:r,mediaType:w,previewContentHeight:t,previewContentWidth:u,width:f});a=e.validatedAudioInfo;x=e.validatedDocumentFileInfo;l=e.validatedImageInfo;p=e.validatedVideoInfo;return d("WAResultOrError").makeResult({mediaEntry:b,mediaType:w,msgIds:d("WASortedLists").asSortedSet(new Set()),plaintextHash:d("WAHashUtils").stringToPlaintextHash(s),size:v||0,ts:q!=null?d("WATimeUtils").castToUnixTime(q):d("WATimeUtils").castMilliSecondsToUnixTime(c),validatedAudioInfo:a,validatedDocumentFileInfo:x,validatedImageInfo:l,validatedVideoInfo:p})}function G(a,b){if(a.xmaData==null||a.from==null||a.xOfflineThreadingId==null)return d("WAResultOrError").makeResult(null);var c=a.from,e=a.serializationOrigin,f=a.xmaData;a=a.xOfflineThreadingId;var g=f.xmaContentRef,h=f.xmaDataclass,i=f.xmaDefaultCTA,j=f.xmaGatingType,k=f.xmaHeaderSubtitle,n=f.xmaHeaderTitle,o=f.xmaIsTombstoned,p=f.xmaLayoutType,q=f.xmaMaxSubtitleNumLines,r=f.xmaMaxTitleNumLines,s=f.xmaSubtitleText,t=f.xmaTargetExpiry,u=f.xmaTargetId,v=f.xmaTargetType,w=f.xmaTargetUsername;f=f.xmaTitleText;if(v==null){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""])),e);return d("WAResultOrError").makeError("xma_mandatory_fields_missing")}v=d("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(v);var x;i!=null&&(x=d("MAWHandleEchoXMARestoreV2").getDefaultCTA(i));if(x!=null&&!d("MAWParseXMAProtocol").isValidCTA(x,v,!0)){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""])),e);return d("WAResultOrError").makeError("xma_cta_validation_failure")}var y;j!=null&&(y=d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(j));var z;t!=null&&(z=d("WATimeUtils").castToUnixTime(t));var A;p!=null&&(A=d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(p));return d("WAResultOrError").makeResult({unstoredDbXMA:{author:d("MAWJids").toUserJid(c.localKey),contentRef:g,ctas:[],defaultCTA:x,externalId:d("WAStanzaUtils").toStanzaId(a),headerTitle:n,isTombstoned:o,maxSubtitleNumOfLines:q,maxTitleNumOfLines:r,overlayDescription:k,overlayIconGlyph:y,overlayTitle:n,subtitleText:s,targetExpiringAtSec:z,targetId:u,targetType:v,targetUsername:w,threadJid:b,titleText:f,xmaDataclass:h,xmaLayoutType:A}})}function H(a){if(a.receiverFetchId==null||a.receiverFetchData==null)return d("WAResultOrError").makeResult(null);var b=a.receiverFetchData,c=a.receiverFetchId;if(b.type!=="sticker"){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""])),b.type,a.serializationOrigin);return d("WAResultOrError").makeError("unsupported_message_type")}return d("WAResultOrError").makeResult({mimetype:b.mimetype,previewHeight:b.previewHeight,previewWidth:b.previewWidth,receiverFetchId:c,type:b.type})}function I(a,b,c,e,f){c=d("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(a,b,c,e,void 0,f);if(c.success===!1)return d("WAResultOrError").makeError(c.error);e=c.value;e.originalTs;e.threadJid;e.unsendMsgContentDeleteTs;f=babelHelpers.objectWithoutPropertiesLoose(e,h);f.sortOrderMs=a.sortOrderMs;c=F(a);if(c.success===!1)return c;e=G(a,b);if(e.success===!1)return d("WAResultOrError").makeError(e.error);b=e.value;e=H(a);if(e.success===!1)return d("WAResultOrError").makeError(e.error);a=e.value;return d("WAResultOrError").makeResult({unstoredDbMedia:c.value,unstoredDbMsg:f,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:a!=null?a:void 0,unstoredXMA:b!=null?b:void 0})}function J(a){try{return d("EchoMessage").decodeEchoMessage(a)}catch(a){d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""])),a);return null}}function b(a,b){if(!d("EBAPIWorkerCheck").runningInWorker())throw c("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var e=a.map(function(a){return K(a,b)}).filter(Boolean);d("MAWODSProxy").odsBumpEntityKey({amount:e.length,entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"});e.length!==a.length&&(d("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""])),b,a.length,e.length),d("MAWODSProxy").odsBumpEntityKey({amount:a.length-e.length,entity:d("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"}));return e}function K(a,b){var e=c("Random").uint32();d("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(e);a=J(a);if(a==null){d("WALogger").ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"])));d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"echo_decode_failure");return null}var f=d("WAGlobals").getMyUserJid(),g=a.from,h=a.sortOrderMs,i=a.xOfflineThreadingId;h=d("WATimeUtils").castToMillisTime(h);if(i==null||g==null){d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""])),a.serializationOrigin);d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"mandatory_fields_missing");return null}var j=d("MAWJids").toUserJid(g.localKey);g=d("WAStanzaUtils").toStanzaId(i);i=I(a,b,f,g,"first_edit_content");if(i.success===!1){d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""])),i.error);d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"echo_message_parsing_failure_"+i.error);return null}if(i.value.unstoredDbMsg==null){d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"])));d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing");return null}i=i.value;var k=i.unstoredDbMedia,l=i.unstoredDbMsg,m=i.unstoredDbReceiverFetchInfo;i=i.unstoredXMA;var n={author:j,chat:b,externalId:g};l!=null&&(l.msgId=d("MAWDbMsg").stanzaIdToMsgId(g));(i==null?void 0:i.unstoredDbXMA)!=null&&(i.unstoredDbXMA.msgId=d("MAWDbMsg").stanzaIdToMsgId(g));k!=null&&(k.msgIds=d("WASortedLists").asSortedSet(new Set([d("MAWDbMsg").stanzaIdToMsgId(g)])));var o;(i==null?void 0:i.unstoredDbXMA)!=null&&(o={associatedMessage:null,defaultPreview:k!=null?k:null,favicon:null,header:k!=null?k:null,previews:k!=null?[k]:null,xma:i.unstoredDbXMA});var p={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},A;try{A={decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeMessageApplication(l,k,null,o,b,c("justknobx")._("3632")?m:null),msgId:n,reportingMeta:p,sortOrderMs:h})),protobufTimestampMS:h}}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").endFailure(e,"top_level_protobuf_encoding_failure");d("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""])),a);return null}var D=new Map();i=C(g,b,j,a.editHistory).map(function(a){return(a=a.decodedMsg)==null?void 0:a.unstoredDbEditActionMsg}).filter(Boolean).filter(function(a){return a.externalId!==a.originalMsgExternalId}).map(function(a){return d("MAWBulkEditMsgsTxns").getMessageHistory(a,b)});i.length>0&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"convert_edits");i.forEach(function(a){var c=a.author,f=a.editTs;c=d("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(c,d("WATimeUtils").castUnixTimeToMillisTime(f));if(c==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_key_generation_failure");d("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"])));return}if(a.editExternalId==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_key_generation_failure");d("WALogger").ERROR(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"])));return}var g=a.editExternalId;try{D.set(c,{decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeEditMessageApplication(a),msgId:{author:j,chat:b,externalId:g},reportingMeta:p,sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(a.editTs)})),protobufTimestampMS:d("WATimeUtils").castUnixTimeToMillisTime(f)})}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"edit_supplemental_protobuf_encoding_failure"),d("WALogger").ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""])),a)}});l=B(a,b,f,g,j).map(function(a){return(a=a.decodedMsg)==null?void 0:a.unstoredDbReaction}).filter(Boolean);l.length>0&&d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"convert_reactions");l.forEach(function(a){var c=a.author,f=a.senderTimestampMs,g=a.ts;f=f!=null?d("WATimeUtils").castToMillisTime(d("WALongInt").numberOrThrowIfTooLarge(f)):d("WATimeUtils").castUnixTimeToMillisTime(g);g=d("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(c);if(g==null){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"reaction_supplemental_key_generation_failure");d("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"])));return}try{D.set(g,{decryptedProtobuf:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("MAWAsMessageApplication").encodeReactionMessageApplication(a),msgId:{author:j,chat:b,externalId:a.externalId},reportingMeta:p,sortOrderMs:f})),protobufTimestampMS:f})}catch(a){d("MAWEchoToProtobufConversionLoggingUtils").addPoint(e,"reaction_supplemental_protobuf_encoding_failure"),d("WALogger").ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""])),a)}});d("MAWEchoToProtobufConversionLoggingUtils").endSuccess(e);return{otid:g,supplementalProtobufs:D,toplevelProtobuf:A}}g.convertEchoMessages=a;g.convertEchoMessagesToEBProtobufs=b}),98);
__d("MAWEBUnstoredDbMsgUtils",["EBLogger","MAWHandleEBRestoreWithHIM","MAWHandleEchoProtobufsRestoreApi","MAWMessageSortOrderUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("EBLogger").EBLogger().tags(["restore","MAWEBUnstoredDbMsgUtils"]);function a(a,b,c,e){var f=c!=null?c:b!=null?d("WAJids").unsafeCoerceToChatJid(b):void 0;if(f==null){j.mustfix("threadId and chatJid are both null - cannot convert protobuf to unstoredDbMsg");return[]}return d("MAWHandleEchoProtobufsRestoreApi").decodeProtobufArray(a,e,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0).map(function(a){var b;if((a==null||(b=a.metadata)==null?void 0:b.messageId)!=null)try{var c=d("MAWHandleEchoProtobufsRestoreApi").createUnstoredDbContentFromProtobufObject(a,f,e,new Map(),void 0);if(c!=null&&c.unstoredDbContent.unstoredDbMsg!=null){c=c.unstoredDbContent.unstoredDbMsg;var g=d("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(c);c.sortOrderMs=g;return c}}catch(b){j.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert protobuf to unstored db message: type: "," error: ",""])),a.msgType,b.message)}return null}).filter(Boolean)}function b(a,b){return d("MAWHandleEBRestoreWithHIM").convertEchoMessages(a,b).map(function(a){var b;if(a==null||a.length===0||((b=a[0].decodedMsg)==null?void 0:b.unstoredDbMsg)==null){j!=null&&j.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert echo message to unstored db message"])));return null}return(b=a[0].decodedMsg)==null?void 0:b.unstoredDbMsg}).filter(Boolean)}g.getUnstoredDbMsgFromProtobuf=a;g.getUnstoredDbMsgFromEcho=b}),98);
__d("MAWUpdateClientRestoreStatusOperationType",[],(function(a,b,c,d,e,f){"use strict";a=0;b=1;f.upsertClientRestoreStatus=a;f.markCompleteClientRestoreStatus=b}),66);/*FB_PKG_DELIM*/
__d("MAWMessageDropError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){function b(b){var c;c=a.call(this,b)||this;c.name="MAWMessageDropError";c.message=b;return c}babelHelpers.inheritsLoose(b,a);return b}(babelHelpers.wrapNativeSuper(Error));f.MAWMessageDropError=a}),66);
__d("MAWMessageParseError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){function b(b){var c;c=a.call(this,b)||this;c.name="MAWMessageParseError";c.message=b;return c}babelHelpers.inheritsLoose(b,a);return b}(babelHelpers.wrapNativeSuper(Error));f.MAWMessageParseError=a}),66);
__d("WAMessageKey",["WAGlobals","WAJids","WAStanzaUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a===d("WAJids").AUTHOR_ME||a==d("WAGlobals").getMyUserJid()}function a(a,b,e){if(e==null)throw c("err")("messageKey is null");var f=e.id,g=e.remoteJid;if(f==null)throw c("err")("messageKey.id is null");else if(g==null)throw c("err")("messageKey.remoteJid is null");g=d("WAJids").interpretAndValidateJid(g);if(g.jidType==="unknown")throw c("err")("messageKey.remoteJid is invalid");var i,j=d("WAJids").AUTHOR_ME;if(g.jidType==="group"){i=g.groupJid;if(h(b)&&e.fromMe===!0)j=d("WAJids").AUTHOR_ME;else if(e.fromMe==!0)j=b;else{var k=e.participant;if(k==null)throw c("err")("key.participant is null");k=d("WAJids").interpretAndValidateJid(k);if(k.jidType==="msgrUser")j=k.userJid;else throw c("err")("key.participant is invalid")}}else if(g.jidType==="msgrUser"||g.jidType==="msgrDevice"){k=d("WAJids").interpretAndValidateJid(a);if(k.jidType!=="msgrUser")throw c("err")("expected user type jid.");i=k.userJid;h(b)?e.fromMe===!0?j=d("WAJids").AUTHOR_ME:j=k.userJid:e.fromMe===!0&&(j=k.userJid)}else throw c("err")("Unsupported jidtype type");return{chat:i,author:h(j)?d("WAJids").AUTHOR_ME:j,externalId:d("WAStanzaUtils").toStanzaId(f)}}g.extractProtocolMessageId=a}),98);
__d("WAParseConsumerMessagePollCreation",["WAGlobals","WAHex","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){a={unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:"pollCreationMessage"},id:b.id,ts:b.ts,sentTs:b.sentTs,serverTs:b.serverTs,ack:b.ack,reportingMeta:c},unstoredMedia:null,unstoredQuotedMedia:null};if(!e||!d("WAGlobals").getConfig().isPollsEnabled())return a;c=e.encKey;var f=e.options,g=e.name;e=e.selectableOptionsCount;var h=b.id,i=b.ts;b=b.ack;if(c==null||g==null||e==null)return a;a=f.map(function(a){return a.optionName}).filter(Boolean);return{unstoredMsg:{ack:b,id:h,ts:i,type:d("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE},unstoredGroupPollCreateInfo:{encKey:c,name:g,selectableOptionsCount:e,options:a},unstoredMedia:null,unstoredQuotedMedia:null}}g["default"]=a}),98);
__d("WAParseConsumerMessagePollUpdate",["WAGlobals","WAMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){a=b.id;c=b.ts;b=b.ack;return e==null||!d("WAGlobals").getConfig().isPollsEnabled()?{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}:{unstoredMsg:{ack:b,id:a,ts:c,type:d("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredGroupPollUpdateInfo:{pollUpdateMessage:e,type:d("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE},unstoredMedia:null,unstoredQuotedMedia:null}}g["default"]=a}),98);
__d("WAParseProtocolUtils",["WAGlobals","WALogger","WALongInt","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){b=i(b,a.serverTs);a=b==null?void 0:b.expirationTs;var c=b==null?void 0:b.deleteTs;b=b==null?void 0:b.ephemeralSetting;return{expirationTs:a,deleteTs:c,ephemeralSetting:b}}function b(a,b){b=j(b);b!=null&&(a.reportingMeta=b);return b}function i(a,b){var c,e,f=a==null||(c=a.chatEphemeralSetting)==null?void 0:c.ephemeralExpiration;a=a==null||(e=a.chatEphemeralSetting)==null?void 0:e.ephemeralSettingTimestamp;if(f==null||a==null||f===0)return null;b=d("WATimeUtils").castToUnixTime(b+d("WAGlobals").getDependencies().ephemeralMaxDeletionWindowForUnseenMessage());var g=b,h=null;try{a=d("WALongInt").numberOrThrowIfTooLarge(a)/1e3;h=d("WATimeUtils").castToUnixTime(a)}catch(a){return null}return{expirationTs:b,deleteTs:g,ephemeralSetting:{expirationTs:f,updatedTs:h}}}function j(a){a=a==null?void 0:a.frankingVersion;a!=null&&a!==0&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Unsupported franking version ",""])),a);return{frankingKey:void 0,frankingTag:void 0,frankingVersion:a,reportingContent:void 0,reportingTag:void 0}}g.parseEphemerality=a;g.enhanceReportingMeta=b}),98);
__d("WAParseConsumerMessageProtocol",["WACommon.pb","WAConsumerApplication.pb","WAGlobals","WAHex","WAJids","WALogger","WAMediaTransport.pb","WAMessageKey","WAMsgType","WAParseConsumerMessagePollCreation","WAParseConsumerMessagePollUpdate","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassUtils","WAResultOrError","WAStanzaUtils","WATimeUtils","decodeProtobuf","err","maybeConvertMessageTextMentionsV2ToV1"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=90*d("WATimeUtils").DAY_SECONDS;b=1;e=0;f=1;f=d("WAGlobals").getConfig().armadilloWebProcessFutureproof()?f+1:f;function a(a,b,e,f,g,k){var l;b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAConsumerApplication.pb").ConsumerApplicationSpec,b);l=(l=b.payload)==null||(l=l.applicationData)==null||(l=l.revoke)==null||(l=l.key)==null?void 0:l.id;if(l!=null)return{unstoredMsg:{type:d("WAMsgType").MSG_TYPE.REVOKED,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:e.reportingMeta,revokedExternalId:d("WAStanzaUtils").toStanzaId(l),unsendMsgContentDeleteTs:null,msgContent:null,ebTimestampMs:k},unstoredMedia:null,unstoredQuotedMedia:null};var m=(g==null?void 0:g.isForwarded)||!1;l=d("WAParseProtocolUtils").parseEphemerality(e,g);var v=l.expirationTs,w=l.deleteTs,x=l.ephemeralSetting;if(x!=null&&(x.expirationTs<0||x.expirationTs>j)){l=d("WAJids").interpretAndValidateJid(a);l=l.jidType;var y=x.expirationTs;d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["WAParseConsumerMessageProtocol - ephemeralSetting duration is invalid ",", jidType: ",""])),y,l)}var z=d("WAParseProtocolUtils").enhanceReportingMeta(e,g),A=(y=o(g))!=null?y:void 0,B=(l=b.payload)==null?void 0:l.content;if(!B)return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};var C=(y=b.metadata)==null?void 0:y.specialTextSize,D=t(B),E={contentTypeForLogging:D,unstoredMsg:{type:d("WAMsgType").MSG_TYPE.FUTUREPROOF,msgContent:{protobuf:d("WAHex").bytesToBuffer(f),subtype:null},id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:z},unstoredMedia:null,unstoredQuotedMedia:null},F=function(a){return babelHelpers["extends"]({},E,{unstoredMsg:babelHelpers["extends"]({},E.unstoredMsg,{msgContent:babelHelpers["extends"]({},E.unstoredMsg.msgContent,{subtype:a})})})};l=function(){try{switch(D){case"messageText":var b,h=B[D]&&c("maybeConvertMessageTextMentionsV2ToV1")(B[D]);if(h==null)throw c("err")("consumerMessage has no messageText");b=((b=h.commands)==null?void 0:b.some(function(a){return a.commandType===d("WACommon.pb").COMMAND_COMMAND_TYPE.AI}))===!0;if(b&&!d("WAGlobals").getConfig().isMetaAiInvocationMessageRenderEnabled())return F("metaAiMessage");if(d("WAParseReadOnlyMetadataDataclassUtils").isNoteMention(g))return F("noteMention");if(h.text==null)throw c("err")("consumerMessage has no messageText");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:h.text,mentionedJids:h.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean),commands:h.commands},quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m},e,{specialTextSize:C,ebTimestampMs:k}),unstoredMedia:null,unstoredQuotedMedia:null};case"reactionMessage":return{unstoredMsg:n(a,e,B[D]),unstoredMedia:null,unstoredQuotedMedia:null};case"imageMessage":b=p(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.IMAGE,quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,mediaId:b.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:b,unstoredQuotedMedia:null};case"videoMessage":var j,l,o,t;h=B[D];if(h==null)throw c("err")("consumerMessage has no videoMessage");b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,h==null||(j=h.video)==null?void 0:j.payload);var y=b==null||(l=b.integral)==null||(l=l.transport)==null||(l=l.ancillary)==null?void 0:l.mimetype;y=(b==null||(o=b.ancillary)==null?void 0:o.gifPlayback)===!0&&y==="image/gif";b=d("WAParseMediaTransportProtocol").parseVideoMsg(b,e.ts,y);if(b==null)throw c("err")("consumerMessage has no video media info");if(d("WAParseReadOnlyMetadataDataclassUtils").isPowerUp(g)&&((t=h.caption)==null?void 0:t.text)!=null){return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.TEXT,msgContent:{content:(t=h.caption)==null?void 0:t.text,mentionedJids:h.caption.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m},e,{specialTextSize:C,ebTimestampMs:k}),unstoredMedia:null,unstoredQuotedMedia:null}}return{unstoredMsg:y?babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.GIF},e,{quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,reportingMeta:z,mediaId:b.plaintextHash}):babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.VIDEO},e,{quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,mediaId:b.plaintextHash}),unstoredMedia:b,unstoredQuotedMedia:null};case"audioMessage":t=q(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.PTT,quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,mediaId:t.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:t,unstoredQuotedMedia:null};case"stickerMessage":if(d("WAGlobals").getConfig().isStickerEnabled()){h=r(B);y=d("WAParseMediaTransportProtocol").parseStickerMsg(h,e.ts);b=((b=h.integral)==null?void 0:b.receiverFetchId)!=null||((t=h.ancillary)==null?void 0:t.receiverFetchId)!=null;t=d("WAGlobals").getConfig().isStickerReceiverFetchEnabled();if(y==null){if(b){if(t){b=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(h);if(b==null)throw c("err")("consumerMessage has no sticker receiver fetch info");return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.RECEIVER_FETCH,quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,reportingMeta:z},e,{ebTimestampMs:k}),unstoredMedia:null,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:b}}return F("stickerReceiverFetchMessage")}throw c("err")("consumerMessage has no sticker media info")}return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.STICKER,quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,reportingMeta:z,mediaId:y.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:y,unstoredQuotedMedia:null}}return E;case"documentMessage":if(d("WAGlobals").getConfig().isDocumentReceiveEnabled()){t=s(B,e.ts);return{unstoredMsg:babelHelpers["extends"]({type:d("WAMsgType").MSG_TYPE.DOCUMENT_FILE,quote:A,expirationTs:v,deleteTs:w,ephemeralSetting:x,isForwarded:m,reportingMeta:z,mediaId:t.plaintextHash},e,{ebTimestampMs:k}),unstoredMedia:t,unstoredQuotedMedia:null}}return E;case"groupInviteMessage":return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null,unstoredIncomingGroupInvite:u(e,B)};case"editMessage":var G;h=B[D];b=h==null?void 0:h.message;y=b==null?void 0:b.text;t=h==null||(G=h.key)==null?void 0:G.id;if(h==null||b==null||y==null)throw c("err")("consumerMessage with editMessage type has no editMessage");if(t==null)throw c("err")("consumerMessage with editMessage type has no original Msg External Id.");h=d("WAStanzaUtils").toStanzaId(t);return{unstoredEditMsg:{type:d("WAMsgType").MSG_TYPE.EDIT_ACTION,editMsgContent:{content:y,mentionedJids:b.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean),commands:b.commands},originalMsgExternalId:h,id:e.id,ts:e.ts,sentTs:e.sentTs,serverTs:e.serverTs,ack:e.ack,reportingMeta:z,specialTextSize:C},unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null};case"pollCreationMessage":return c("WAParseConsumerMessagePollCreation")(f,e,z,B[D]);case"pollUpdateMessage":return c("WAParseConsumerMessagePollUpdate")(f,e,z,B[D]);case"contactMessage":case"locationMessage":case"extendedTextMessage":case"statusTextMessage":case"contactsArrayMessage":case"liveLocationMessage":case"viewOnceMessage":default:return E}}catch(a){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["parseConsumerMessageProtocol error :",""])),a);return{unstoredMsg:null,unstoredMedia:null,unstoredQuotedMedia:null}}}();return babelHelpers["extends"]({},l,{contentTypeForLogging:D})}function k(a){if(d("WAJids").isAuthorSystem(a))throw c("err")("Got system author");return a}var l=30;function m(a){if(a==null)return d("WAResultOrError").makeResult(null);return a.length>l?d("WAResultOrError").makeError("invalid-reaction-text-length"):d("WAResultOrError").makeResult(a)}function n(a,b,e){if(e==null)throw c("err")("consumerMessage has no reactionMessage");var f=k(b.id.author);a=d("WAMessageKey").extractProtocolMessageId(a,f,e.key);f=e.text;var g=e.groupingKey;e=e.senderTimestampMs;var h=m(f);if(!h.success)throw c("err")('"'+(f!=null?f:"")+'" is not a valid reaction ['+h.error+"]");return{type:d("WAMsgType").MSG_TYPE.REACTION,ack:b.ack,id:b.id,reactToExternalId:a.externalId,reactToAuthor:a.author,reaction:h.value,groupingKey:g,ts:b.ts,senderTimestampMs:e}}function o(a){var b,e,f,g=a==null||(b=a.quotedMessage)==null?void 0:b.stanzaId,h=a==null||(e=a.quotedMessage)==null?void 0:e.participant;a=a==null||(f=a.quotedMessage)==null?void 0:f.remoteJid;h=h!=null?d("WAJids").interpretAndValidateJid(h):null;var i;(h==null?void 0:h.jidType)==="msgrUser"&&h.userJid===d("WAGlobals").getMyUserJid()?i=d("WAJids").AUTHOR_ME:(h==null?void 0:h.jidType)==="msgrUser"?i=h.userJid:i=d("WAJids").AUTHOR_ME;if(g==null)return null;h={type:d("WAMsgType").MSG_TYPE.UNAVAILABLE,author:i,externalId:d("WAStanzaUtils").toStanzaId(g),ts:null};if(a!=null){i=d("WAJids").interpretAndValidateJid(a);if(i.jidType==="group")return{remoteJid:i.groupJid,content:h};else throw c("err")("not supported")}else return{remoteJid:null,content:h}}function p(a,b){var e;a=a.imageMessage;if(a==null)throw c("err")("consumerMessage has no imageMessage");return d("WAParseMediaTransportProtocol").decodeImageTransport(a==null||(e=a.image)==null?void 0:e.payload,b,"image")}function q(a,b){var e;a=a.audioMessage;if(a==null)throw c("err")("consumerMessage has no audioMessage");var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").AudioTransportSpec,a==null||(e=a.audio)==null?void 0:e.payload);f=d("WAParseMediaTransportProtocol").parseAudioMsg(f,(a==null?void 0:a.ptt)||!1,b);if(f==null)throw c("err")("consumerMessage has no audio media info");return f}function r(a){var b;a=a.stickerMessage;if(a==null)throw c("err")("consumerMessage has no stickerMessage");return d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").StickerTransportSpec,a==null||(b=a.sticker)==null?void 0:b.payload)}function s(a,b){var e;a=a.documentMessage;if(a==null)throw c("err")("consumerMessage has no documentMessage");var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").DocumentTransportSpec,a==null||(e=a.document)==null?void 0:e.payload);a=a==null?void 0:a.fileName;f=d("WAParseMediaTransportProtocol").parseDocumentMsg(f,a,b);if(f==null)throw c("err")("consumerMessage has no document media info");return f}function t(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("err")(JSON.stringify(a)+" consumerMessage payload content should have exactly one field, instead found "+JSON.stringify(b));return b[0]}function u(a,b){b=b.groupInviteMessage;if(b==null)throw c("err")("consumerMessage has no GroupInvite Data");return babelHelpers["extends"]({ack:a.ack,author:a.id.author,externalId:a.id.externalId,ts:a.ts},b)}g.MINIMAL_MEDIA_DURATION=b;g.DEFAULT_FILE_SIZE=e;g.SUPPORTED_TYPES_VERSION=f;g.parseConsumerMessageProtocol=a;g.interpretAsNonSystemAuthor=k;g.validReactionMessageText=m;g.parseReactionMessage=n;g.parsedQuotedConsumerMessage=o;g.parseOneOfContentType=t}),98);
__d("WAParseMediaTransportProtocol",["WAHashUtils","WALogger","WALongInt","WAMedia","WAMediaHdType","WAMediaTransport.pb","WAMediaUtils","WAMsgMap","WAParseConsumerMessageProtocol","WAProgressiveJpegGetScanLengths","WATimeUtils","decodeProtobuf","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a,b,c,e){var f,g,k;if(!((f=a.integral)!=null&&f.transport))return null;f=(f=a.integral)==null?void 0:f.transport;if(d("decodeProtobuf").getUnknownFields(f.integral)!=null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["There is unknown fileds in integral of VideoTransport"])));return null}g=(g=f.integral)==null?void 0:g.fileSha256;if(!g){c||d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["protobuf msg with no plaintext hash"])));return null}c=null;if(((k=a.ancillary)==null?void 0:k.scansSidecar)!=null&&((k=a.ancillary)==null?void 0:k.scanLengths)!=null){c={sidecar:(k=a.ancillary)==null?void 0:k.scansSidecar,scanLengths:(k=a.ancillary)==null||(k=k.scanLengths)==null?void 0:k.map(d("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength)}}if(((a=f.integral)==null?void 0:a.fileSha256)==null||((k=f.integral)==null?void 0:k.fileEncSha256)==null||((a=f.integral)==null?void 0:a.mediaKey)==null||((k=f.integral)==null?void 0:k.directPath)==null||((a=f.integral)==null?void 0:a.mediaKeyTimestamp)==null||((k=f.ancillary)==null?void 0:k.objectId)==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["cannot compose mediaEntry with the media message"])));return null}k=(a=f.ancillary)==null?void 0:a.fileLength;a=(a=f.ancillary.thumbnail)==null?void 0:a.downloadableThumbnail;f=d("WAMediaUtils").rawDataToMediaEntry({fileSha256:f.integral.fileSha256,fileEncSha256:f.integral.fileEncSha256,mediaKey:f.integral.mediaKey,directPath:f.integral.directPath,mediaKeyTimestamp:d("WATimeUtils").castLongIntToUnixTime(f.integral.mediaKeyTimestamp),serverMediaType:b,objectId:(b=f.ancillary)==null?void 0:b.objectId,fbid:void 0,downloadableThumbnail:{directPath:a==null?void 0:a.directPath,fileEncSha256:a==null?void 0:a.fileEncSha256,fileSha256:a==null?void 0:a.fileSha256,mediaKey:a==null?void 0:a.mediaKey,mediaKeyTimestamp:(a==null?void 0:a.mediaKeyTimestamp)==null?null:d("WATimeUtils").castLongIntToUnixTime(a==null?void 0:a.mediaKeyTimestamp),objectId:a==null?void 0:a.objectId},filename:e,progressiveJpegDetails:c,size:k==null?k:d("WALongInt").numberOrThrowIfTooLarge(k)});return{size:k==null?d("WAParseConsumerMessageProtocol").DEFAULT_FILE_SIZE:d("WALongInt").numberOrThrowIfTooLarge(k),plaintextHash:d("WAHashUtils").toPlaintextHash(new Uint8Array(g)),mediaEntry:f}}function l(a){switch(a){case d("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.NONE:return d("WAMediaHdType").HD_TYPE_NONE;case d("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.LQ_4K:return d("WAMediaHdType").HD_TYPE_LQ_4K;case d("WAMediaTransport.pb").IMAGE_TRANSPORT_ANCILLARY_HD_TYPE.HQ_4K:return d("WAMediaHdType").HD_TYPE_HQ_4K;default:a;return d("WAMediaHdType").HD_TYPE_NONE}}function m(a,b,c){var e;c=k(a,c,!1);if(!c)return null;c=p(c,b);b=(b=a.ancillary)==null?void 0:b.width;e=(e=a.ancillary)==null?void 0:e.height;a.ancillary!=null&&(a.ancillary.width!=null&&a.ancillary.width===4294967295&&(b=void 0),a.ancillary.height!=null&&a.ancillary.height===4294967295&&(e=void 0));b=babelHelpers["extends"]({},c,{mediaType:d("WAMedia").MEDIA_TYPE.IMAGE,validatedVideoInfo:null,validatedImageInfo:{width:b,height:e,jpegThumbnail:(c=a.integral)==null||(c=c.transport)==null||(c=c.ancillary)==null||(c=c.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null||(b=b.transport)==null||(b=b.ancillary)==null||(b=b.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null||(e=e.transport)==null||(e=e.ancillary)==null||(e=e.thumbnail)==null?void 0:e.thumbnailWidth,hdType:l((c=a.ancillary)==null?void 0:c.hdType)},validatedAudioInfo:null,validatedDocumentFileInfo:null});return b}function a(a,b,e){a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").ImageTransportSpec,a);a=m(a,b,e);if(a==null)throw c("err")("consumerMessage has no image media info");return a}function b(a,b,c){var e,f,g,h,i,j,l;if(!((e=a.integral)!=null&&e.transport))return null;e=k(a,c?"gif":"video",!1);if(!e)return null;e=p(e,b);c=babelHelpers["extends"]({},e,{accessibilitySummaryText:(b=a.ancillary)==null?void 0:b.accessibilityLabel,mediaType:c?d("WAMedia").MEDIA_TYPE.GIF:d("WAMedia").MEDIA_TYPE.VIDEO,validatedVideoInfo:c?null:{duration:(a==null||(f=a.ancillary)==null?void 0:f.seconds)!=null&&(a==null||(g=a.ancillary)==null?void 0:g.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null||(h=a.ancillary)==null?void 0:h.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,width:a==null||(i=a.ancillary)==null?void 0:i.width,height:a==null||(j=a.ancillary)==null?void 0:j.height,mimetype:a==null||(l=a.integral)==null||(l=l.transport)==null||(l=l.ancillary)==null?void 0:l.mimetype,jpegThumbnail:(e=a.integral)==null||(e=e.transport)==null||(e=e.ancillary)==null||(e=e.thumbnail)==null?void 0:e.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null||(b=b.transport)==null||(b=b.ancillary)==null||(b=b.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null||(e=e.transport)==null||(e=e.ancillary)==null||(e=e.thumbnail)==null?void 0:e.thumbnailWidth},validatedImageInfo:c?{width:(b=a.ancillary)==null?void 0:b.width,height:(e=a.ancillary)==null?void 0:e.height,jpegThumbnail:(c=a.integral)==null||(c=c.transport)==null||(c=c.ancillary)==null||(c=c.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null||(b=b.transport)==null||(b=b.ancillary)==null||(b=b.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(e=a.integral)==null||(e=e.transport)==null||(e=e.ancillary)==null||(e=e.thumbnail)==null?void 0:e.thumbnailWidth}:null,validatedAudioInfo:null,validatedDocumentFileInfo:null});return c}function e(a,b,c){var e,f,g,h;if(!((b=a.integral)!=null&&b.transport))return null;b=k(a,"ptt",!1);if(!b)return null;b=p(b,c);c=babelHelpers["extends"]({},b,{mediaType:d("WAMedia").MEDIA_TYPE.PTT,validatedVideoInfo:null,validatedImageInfo:null,validatedDocumentFileInfo:null,validatedAudioInfo:{duration:(a==null||(e=a.ancillary)==null?void 0:e.seconds)!=null&&(a==null||(f=a.ancillary)==null?void 0:f.seconds)>d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION?a==null||(g=a.ancillary)==null?void 0:g.seconds:d("WAParseConsumerMessageProtocol").MINIMAL_MEDIA_DURATION,mimetype:a==null||(h=a.integral)==null||(h=h.transport)==null||(h=h.ancillary)==null?void 0:h.mimetype,played:!1}});return c}function f(a,b){var c;if(!((c=a.integral)!=null&&c.transport))return null;c=((c=a.integral)==null?void 0:c.receiverFetchId)!=null;c=k(a,"sticker",c);if(!c)return null;c=p(c,b);b=babelHelpers["extends"]({},c,{accessibilitySummaryText:(b=a.ancillary)==null?void 0:b.accessibilityLabel,mediaType:d("WAMedia").MEDIA_TYPE.STICKER,validatedVideoInfo:null,validatedImageInfo:{width:(c=a.ancillary)==null?void 0:c.width,height:(b=a.ancillary)==null?void 0:b.height,jpegThumbnail:(c=a.integral)==null||(c=c.transport)==null||(c=c.ancillary)==null||(c=c.thumbnail)==null?void 0:c.jpegThumbnail,jpegThumbnailHeight:(b=a.integral)==null||(b=b.transport)==null||(b=b.ancillary)==null||(b=b.thumbnail)==null?void 0:b.thumbnailHeight,jpegThumbnailWidth:(c=a.integral)==null||(c=c.transport)==null||(c=c.ancillary)==null||(c=c.thumbnail)==null?void 0:c.thumbnailWidth},validatedAudioInfo:null,validatedDocumentFileInfo:null});return b}function n(a){var b,c,d,e;if(!((b=a.integral)!=null&&b.transport))return null;b=(b=a.ancillary)==null?void 0:b.width;c=(c=a.ancillary)==null?void 0:c.height;d=(d=(d=a.integral)==null?void 0:d.receiverFetchId)!=null?d:(d=a.ancillary)==null?void 0:d.receiverFetchId;a=a==null||(e=a.integral)==null||(e=e.transport)==null||(e=e.ancillary)==null?void 0:e.mimetype;if(b==null||c==null||d==null||a==null)return null;d={receiverFetchId:d,previewWidth:b,previewHeight:c,mimetype:a,type:"sticker"};return d}function o(a,b,c){var e,f;if(!((e=a.integral)!=null&&e.transport))return null;e=k(a,"document",!1,b);if(!e)return null;e=p(e,c);return babelHelpers["extends"]({},e,{mediaType:d("WAMedia").MEDIA_TYPE.DOCUMENT_FILE,validatedVideoInfo:null,validatedImageInfo:null,validatedAudioInfo:null,validatedDocumentFileInfo:{mimetype:a==null||(f=a.integral)==null||(f=f.transport)==null||(f=f.ancillary)==null?void 0:f.mimetype,filename:b!=null?b:void 0}})}function p(a,b){return{mediaEntry:a.mediaEntry,plaintextHash:a.plaintextHash,size:a.size,msgIds:[],mediaEntries:new(d("WAMsgMap").MsgMap)(),ts:b}}g.getMediaMeta=k;g.decodeImageTransport=a;g.parseVideoMsg=b;g.parseAudioMsg=e;g.parseStickerMsg=f;g.parseStickerReceiverFetchInfo=n;g.parseDocumentMsg=o}),98);
__d("MAWParseBumpExistingMessageMsg",["FBLogger","WAMessageKey","WAParseConsumerMessageProtocol","WAParseProtocolUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.chat,e=a.content,f=a.meta;a=a.metadata;e=e.bumpExistingMessage;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no content");e=e.key;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("bumpExistingMessage has no message key");var g=d("WAParseConsumerMessageProtocol").interpretAsNonSystemAuthor(f.id.author);g=d("WAMessageKey").extractProtocolMessageId(b,g,e);e=g.author;g=g.externalId;a=d("WAParseProtocolUtils").parseEphemerality(f,a);var h=a.deleteTs,i=a.ephemeralSetting;a=a.expirationTs;h={ack:f.ack,deleteTs:h,ephemeralSetting:i,expirationTs:a,id:{author:f.id.author,chat:f.id.chat,externalId:f.id.externalId},quote:{content:{author:e,externalId:g,ts:null,type:"Unavailable"},remoteJid:b},reportingMeta:f.reportingMeta,sentTs:f.sentTs,serverTs:f.serverTs,ts:f.serverTs,type:"BumpExistingMessage"};return{contentTypeForLogging:"bumpExistingMessage",unstoredMedia:null,unstoredMsg:h,unstoredQuotedMedia:null,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWParseNetworkVerificationMsg",["MAWMessageDropError","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){d("WALogger").EXPECTED_ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Web does not support network verification code"])));throw new(d("MAWMessageDropError").MAWMessageDropError)("Web does not support network verification")}g.parseNetworkVerificationMsg=a}),98);
__d("MAWParseNoteReplyMsg",["FBLogger","MAWJids","MAWMsgType","WAGlobals","WAJids","WALongInt","WAMediaTransport.pb","WAMsgType","WAParseMediaTransportProtocol","WAParseProtocolUtils","WAParseReadOnlyMetadataDataclassUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e=a.content,f=a.ebTimestampMs,g=a.meta;a=a.metadata;e=e.noteReplyMessage;if(d("WAParseReadOnlyMetadataDataclassUtils").isNoteMention(a))return"noteMention";if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no content");b=(b=e.noteText)==null?void 0:b.text;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no note text");var h=e.noteTimestampMs!=null?d("WATimeUtils").castMilliSecondsToUnixTime(d("WALongInt").numberOrThrowIfTooLarge(e.noteTimestampMs)):void 0,i=d("MAWJids").toUserJid(g.id.author),j=d("MAWJids").toUserJid(g.id.chat);i=j===i?d("WAJids").AUTHOR_ME:j;j=d("WAParseProtocolUtils").parseEphemerality(g,a);a=j.deleteTs;var k=j.ephemeralSetting;j=j.expirationTs;a={ack:g.ack,deleteTs:a,ebTimestampMs:f,ephemeralSetting:k,expirationTs:j,forwardingScore:g.forwardingScore,id:{author:g.id.author,chat:g.id.chat,externalId:g.id.externalId},quote:{content:{author:i,expirationTs:h,externalId:g.id.externalId,msgContent:{content:b},ts:g.serverTs,type:d("WAMsgType").NOTE_REPLY},remoteJid:g.id.chat},ts:g.serverTs};var l,m;k=(f=e.textContent)==null?void 0:f.text;j=e.stickerContent;i=e.videoContent;if(k!=null){h=babelHelpers["extends"]({msgContent:{content:k},type:d("MAWMsgType").MSG_TYPE.TEXT},a);b=h}else if(j!=null){f=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,j==null?void 0:j.payload);l=d("WAParseMediaTransportProtocol").parseStickerMsg(f,g.ts);if(l){e=babelHelpers["extends"]({mediaId:l.plaintextHash,type:d("MAWMsgType").MSG_TYPE.STICKER},a);b=e}else{if(((k=f.integral)==null?void 0:k.receiverFetchId)!=null)if(d("WAGlobals").getConfig().isStickerReceiverFetchEnabled()){m=d("WAParseMediaTransportProtocol").parseStickerReceiverFetchInfo(f);if(m==null)throw c("FBLogger")("messenger_web").mustfixThrow("consumerMessage has no sticker receiver fetch info");h=babelHelpers["extends"]({type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH},a);b=h}else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage sticker receiver fetch is not enabled");else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage sticker has no media")}}else if(i!=null){var n,o;j=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,i==null?void 0:i.payload);e=j==null||(n=j.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.mimetype;k=(j==null||(o=j.ancillary)==null?void 0:o.gifPlayback)===!0&&e==="image/gif";l=d("WAParseMediaTransportProtocol").parseVideoMsg(j,g.ts,k);if(l&&k){f=babelHelpers["extends"]({mediaId:l.plaintextHash,type:d("MAWMsgType").MSG_TYPE.GIF},a);b=f}else if(!l)throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video has no media");else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage video is not a gif")}else throw c("FBLogger")("messenger_web").mustfixThrow("noteReplyMessage has no valid content");return{contentTypeForLogging:"noteReplyMessage",unstoredMedia:l,unstoredMsg:b,unstoredQuotedMedia:null,unstoredReceiverFetchInfo:m,unstoredXMA:null}}g["default"]=a}),98);
__d("MAWParseRavenActionNotificationMsg",["FBLogger","MAWMsg","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,e,f=a.content;a=a.meta;b=(b=f.ravenActionNotifMessage)==null?void 0:b.actionType;b=d("MAWMsg").MAWRavenActionNotifType.cast(b);e=(e=f.ravenActionNotifMessage)==null?void 0:e.actionTimestamp;var g;if(e!=null){e=Number(e);e>d("WATimeUtils").MAX_INT?g=d("WATimeUtils").castMilliSecondsToUnixTime(e):g=d("WATimeUtils").castToUnixTime(e)}f=((e=f.ravenActionNotifMessage)==null||(e=e.key)==null?void 0:e.id)!=null?d("WAStanzaUtils").toStanzaId((e=f.ravenActionNotifMessage)==null||(e=e.key)==null?void 0:e.id):null;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when getting actionType for RavenNotificationMessage "+a.id.externalId);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when getting actionTimestamp for RavenNotificationMessage "+a.id.externalId);if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when getting ravenActionToMsgExternalId for RavenNotificationMessage "+a.id.externalId);e={ack:a.ack,actionTimestamp:g,actionType:b,id:a.id,ravenActionToMsgExternalId:f,sentTs:a.sentTs,serverTs:a.serverTs,ts:a.serverTs,type:"RavenAction"};return{unstoredMedia:null,unstoredMsg:e,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenActionNotificationMessage=a}),98);
__d("MAWParseSubprotocolVersionConsts",[],(function(a,b,c,d,e,f){"use strict";a=2;b=2;c=1;d=2;e=1;var g=1;f.ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION=a;f.XMA_PREVIEW_SUBPROTOCOL_VERSION=b;f.XMA_FAVICON_SUBPROTOCOL_VERSION=c;f.XMA_HEADER_SUBPROTOCOL_VERSION=d;f.RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION=e;f.RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION=g}),66);
__d("MAWParseRavenMsg",["FBLogger","MAWMsg","MAWMsgType","MAWParseSubprotocolVersionConsts","WALogger","WAMediaTransport.pb","WAParseMediaTransportProtocol","WAParseProtocolUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){var b=a.content,e=a.ebTimestampMs,f=a.meta;a=a.metadata;b=b.ravenMessageMsgr;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Raven message payload has no content");var g=d("MAWMsg").MAWRavenMsgEphemeralType.cast(b.ephemeralType);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error when casting ephemeralType for Raven message");var j=void 0,k=void 0;if(b.imageMessage)(b.imageMessage.version==null||b.imageMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["\n        received image messsage version is older than expected ",". "])),d("MAWParseSubprotocolVersionConsts").RAVEN_IMAGE_MESSAGE_SUBPROTOCOL_VERSION),j=d("WAParseMediaTransportProtocol").decodeImageTransport(b.imageMessage.payload,f.ts,"image"),k=d("MAWMsg").MAWRavenMsgMediaType.IMAGE;else if(b.videoMessage){(b.videoMessage.version==null||b.videoMessage.version<d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["\n        received video messsage version is older than expected ",". "])),d("MAWParseSubprotocolVersionConsts").RAVEN_VIDEO_MESSAGE_SUBPROTOCOL_VERSION);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMediaTransport.pb").VideoTransportSpec,b.videoMessage.payload);j=d("WAParseMediaTransportProtocol").parseVideoMsg(b,f.ts,!1);k=d("MAWMsg").MAWRavenMsgMediaType.VIDEO}else throw c("FBLogger")("messenger_web").mustfixThrow("Error unsupported Raven message type");if(j==null)throw c("FBLogger")("messenger_web").mustfixThrow("Error Raven message has no associated image or video");b=d("WAParseProtocolUtils").parseEphemerality(f,a);a=b.deleteTs;var l=b.ephemeralSetting;b=b.expirationTs;a={ack:f.ack,deleteTs:a,ebTimestampMs:e,ephemeralSetting:l,expirationTs:b,id:f.id,mediaId:j.plaintextHash,ravenEphemeralMediaState:g===d("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?d("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:d("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN,ravenEphemeralType:g,ravenMediaType:k,reportingMeta:f.reportingMeta,sentTs:f.sentTs,serverTs:f.serverTs,ts:f.ts,type:d("MAWMsgType").MSG_TYPE.RAVEN};return{unstoredMedia:j,unstoredMsg:a,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseRavenMessage=a}),98);
__d("MAWParseScreenshotActionMsg",["FBLogger","MAWExternalId","MAWMsgType","WAAckLevel","WAArmadilloApplication.pb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.content;a=a.meta;b=b.screenshotAction;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("screenshotAction has no content");b=b.screenshotType;if(b==null)throw c("FBLogger")("messenger_web").mustfixThrow("Missing screenshot type in payload");if(![d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE,d("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING].includes(b))throw c("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type");b={ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a.id.chat,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:[],adminType:"youEphemeralTakeScreenshot",screenshotActionType:b},ts:a.serverTs,type:d("MAWMsgType").EPHEMERAL_SCREENSHOT_ACTION};return{contentTypeForLogging:"screenshotAction",unstoredMedia:null,unstoredMsg:b,unstoredQuotedMedia:null,unstoredXMA:null}}g.parseEphemeralScreenshotActionProtocol=a}),98);
__d("MAWParseArmadilloProtocol",["FBLogger","MAWMessageParseError","MAWMsgType","MAWParseBumpExistingMessageMsg","MAWParseNetworkVerificationMsg","MAWParseNoteReplyMsg","MAWParseRavenActionNotificationMsg","MAWParseRavenMsg","MAWParseScreenshotActionMsg","MAWParseXMAProtocol","WAArmadilloApplication.pb","WAHex","WALogger","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i;b={unstoredMedia:null,unstoredMsg:null,unstoredQuotedMedia:null,unstoredXMA:null};var j=new Map([["screenshotAction",d("MAWParseScreenshotActionMsg").parseEphemeralScreenshotActionProtocol],["extendedContentMessage",d("MAWParseXMAProtocol").parseXMAProtocol],["paymentsTransactionMessage",d("MAWParseXMAProtocol").parseXMAProtocol],["noteReplyMessage",c("MAWParseNoteReplyMsg")],["bumpExistingMessage",c("MAWParseBumpExistingMessageMsg")],["ravenMessageMsgr",d("MAWParseRavenMsg").parseRavenMessage],["ravenActionNotifMessage",d("MAWParseRavenActionNotificationMsg").parseRavenActionNotificationMessage],["networkVerificationMessage",d("MAWParseNetworkVerificationMsg").parseNetworkVerificationMsg]]);function a(a,b,c,e,f,g){b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAArmadilloApplication.pb").ArmadilloSpec,b);b=(b=b.payload)==null?void 0:b.content;if(!b)throw new(d("MAWMessageParseError").MAWMessageParseError)("parse_armadillo_protocol_error:: empty_payload_content");var m=l(b);try{var n=j.get(m),o=null;if(n!=null){n=n({chat:a,content:b,ebTimestampMs:g,meta:c,metadata:f,protobuf:e});if(typeof n!=="string")return n;else o=n}d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - handling futureproof message for contentType: ",""])),m);return{contentTypeForLogging:m,unstoredMedia:null,unstoredMsg:{ack:c.ack,id:c.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(e),subtype:o!=null?o:k(m)},reportingMeta:c.reportingMeta,sentTs:c.sentTs,serverTs:c.serverTs,ts:c.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null}}catch(a){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MAWParseArmadilloProtocol - Dropping message. contentType: ",", reason: ",""])),m,a);throw new(d("MAWMessageParseError").MAWMessageParseError)("parse_armadillo_protocol_error:: contentType:: "+m+" reason:: "+a)}}function k(a){switch(a){case"bumpExistingMessage":return"bumpMessage";default:return null}}function l(a){var b=Object.keys(a).filter(function(a){return a!=="$$unknownFieldCount"});if(b.length!==1)throw c("FBLogger")("messenger_web").mustfixThrow(JSON.stringify(a)+" armadillo payload content should only have one field");a=b[0];return a}g.EMPTY_CONTENT=b;g.parseArmadilloProtocol=a;g.parseOneOfContentType=l}),98);
__d("MAWParseCollapsibleIdFromXMADataClass",["FBLogger","MWXMAV2IsDataclassLiveLocationXMA"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow("xmaDataclass is missing or invalid");var b=d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(a);if(b)return h(a);b=JSON.parse(a);a=b.layout_config;if(a==null||typeof a.collapsible_id!=="number")throw c("FBLogger")("messenger_web").mustfixThrow("Layout config or collapsible_id is missing or invalid");return a.collapsible_id}function h(a){a=JSON.parse(a);a=(a=a.content)==null?void 0:a.custom_template_data;if((a==null?void 0:a.__typename)!=="XMSGXmaLocationTemplateData"||a==null)throw c("FBLogger")("messenger_web").mustfixThrow("Live location metadata or session_id is missing");return parseInt(a.location_metadata.session_id,10)}g.parseCollapsibleIdFromXMADataClass=a}),98);
__d("MWXMAV2IsCollapsibleXMA",["FBLogger","MWXMAV2IsDataclassLiveLocationXMA"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return!1;var b;try{b=JSON.parse(a)}catch(a){c("FBLogger")("messenger_web_sharing").mustfix("Error parsing xma dataclass");return!1}if(b==null)return!1;var e=b.layout_config;return(e==null?void 0:e.collapsible_id)==null&&!d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(a)?!1:!0}g.isCollapsibleXMA=a}),98);
__d("MAWParseXMAProtocol",["FBLogger","MAWMsgType","MAWODSProxy","MAWParseArmadilloProtocol","MAWParseCollapsibleIdFromXMADataClass","MAWParseSubprotocolVersionConsts","MAWParseXMAFBConfig","MAWParseXMAUnsupportedMessageType","MAWXMALoggingUtils","MWXMAV2IsCollapsibleXMA","WAArmadilloXMA.pb","WAGetPlatformFromStanzaId","WAHex","WAJids","WALogger","WAMedia","WAMsgApplication.pb","WAOdsEnums","WAParseConsumerMessageProtocol","WAParseMediaTransportProtocol","WAParseMessageApplication","WAParseProtocolUtils","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var aa=["actionContentBlob"],h,i,j,k,l,m,n,o,p,q,r,s,t,u=new Set([d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY]);function v(a,b){return a==null||a.payload==null?void 0:d("WAParseMediaTransportProtocol").decodeImageTransport(a.payload,b,"xma-image")}function ba(a,b,e,f,g){if(b==null||b.payload==null)return null;b.version!==d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION&&d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[XMA] received associated message with incorrect version ",""])),b.version);b=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,b.payload);b=d("WAParseMessageApplication").parseMessageApplication(b);if(b.type==="error")throw c("FBLogger")("messenger_web").mustfixThrow("XMA contains unparseable message application.");b=b;if(b.subprotocolType!=="consumerMessage")throw c("FBLogger")("messenger_web").mustfixThrow("XMA contains incorrect message application type: "+b.subprotocolType);return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(a,b.payload,e,f,g)}var w="https://www.instagram.com/stories/",x="https://www.instagram.com/reel/",y="https://www.instagram.com/tv/",z="https://www.instagram.com/_n/profile_shop?",A="https://www.instagram.com/",B="https://www.alpha.facebook.com/share/",C="https://m.facebook.com/share/",D="https://www.facebook.com/share/",E="https://m.alpha.facebook.com/share/",F="https://facebook.com/share/",G="https://www.alpha.facebook.com/stories/",H="https://www.facebook.com/stories/",I="https://fb.gg/",J="https://www.facebook.com/",K="https://m.facebook.com/",L="https://www.alpha.facebook.com/",M="https://m.alpha.facebook.com/",N="https://facebook.com/",O="https://fb.watch/",P="https://www.facebook.com/l.php",Q="https://m.facebook.com/l.php",R="https://www.alpha.facebook.com/l.php",S="https://m.alpha.facebook.com/l.php",T="https://facebook.com/l.php",U="https://l.facebook.com/l.php",V="https://facebook.com/events/",W="https://www.facebook.com/events/",X="https://www.alpha.facebook.com/events/",Y="https://m.facebook.com/events/",ca="https://m.alpha.facebook.com/events/",da="fb-messenger://payments/receipt?product_id=",ea="messenger://location_share",fa="http://m.me/",ga=":",ha="http://",ia="https://";function a(a){var b=a.chat,e=a.content,f=a.ebTimestampMs,g=a.meta,h=a.metadata;a=a.protobuf;var n=d("MAWParseArmadilloProtocol").parseOneOfContentType(e);n=n==="paymentsTransactionMessage";var o=null;if(n){var p;o=(p=e.paymentsTransactionMessage)==null?void 0:p.extendedContentMessage}else o=e.extendedContentMessage;if(o==null&&n)return"paymentsTransactionMessage";if(o==null)throw c("FBLogger")("messenger_web").mustfixThrow("extendedContentMessage has no content");p=o;e=p.targetType;p=p.xmaDataclass;var q=d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(g.id.externalId);p!=null&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_dataclass.exists."+(e!=null?e:"null")});if(e==null||!d("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:e,xmaDataclass:p}))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:{ack:g.ack,id:g.id,msgContent:{protobuf:d("WAHex").bytesToBuffer(a),subtype:d("MAWParseXMAUnsupportedMessageType").getXMAUnsupportedMessageType(e,p,n)},reportingMeta:g.reportingMeta,sentTs:g.sentTs,serverTs:g.serverTs,ts:g.ts,type:d("MAWMsgType").MSG_TYPE.FUTUREPROOF},unstoredQuotedMedia:null,unstoredXMA:null,xmaTargetTypeForLogging:e};n=d("WAParseProtocolUtils").parseEphemerality(g,h);var r=n.deleteTs,s=n.ephemeralSetting;n=n.expirationTs;var t=d("WAParseProtocolUtils").enhanceReportingMeta(g,h),w=o,x=w.associatedMessage,y=w.commands,z=w.contentRef,A=w.ctas,B=w.favicon,C=w.headerImage,D=w.headerTitle,E=w.maxSubtitleNumOfLines,F=w.maxTitleNumOfLines,G=w.mentionedJid,H=w.messageText,I=w.overlayDescription,J=w.overlayIconGlyph,K=w.overlayTitle,L=w.previews,M=w.sentWithMessageId,N=w.subtitleText,O=w.targetId,P=w.targetUsername,Q=w.titleText;w=w.xmaLayoutType;x!=null&&(x.version==null||x.version<d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["\n      received associatedMessage version is older than expected "," as expected. "])),d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION);C!=null&&(C.version==null||C.version<d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["\n    received headerImage version is older than expected ",". "])),d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION);B!=null&&(B.version==null||B.version<d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["\n    received favicon version is older than expected ",". "])),d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION);L.every(function(a){(a.version==null||a.version<d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)&&d("WALogger").WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["\n      received previews version is older than expected ",". "])),d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)});o=o.targetExpiringAtSec!=null?d("WATimeUtils").castLongIntToUnixTime(o.targetExpiringAtSec):void 0;var R=x!=null&&M!=null?[d("WAStanzaUtils").toStanzaId(M),g.id.externalId]:[g.id.externalId,void 0],S=R[0];R=R[1];var T=[];if(L!=null)for(var U=0;U<L.length;U++){var V,W=v(L[U],g.ts);W!=null&&!((e===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE||e===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE)&&W.mediaType===d("WAMedia").MEDIA_TYPE.IMAGE&&((V=W.validatedImageInfo)==null?void 0:V.height)===1&&((V=W.validatedImageInfo)==null?void 0:V.width)===1)&&T.push(W)}V=v(C,g.ts);W=v(B,g.ts);L=(U=d("WAParseConsumerMessageProtocol").parsedQuotedConsumerMessage(h))!=null?U:void 0;var X;if(d("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(p))try{X=d("MAWParseCollapsibleIdFromXMADataClass").parseCollapsibleIdFromXMADataClass(p)}catch(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"xma_validation."+q+"."+(e||0)+".error"});throw c("FBLogger")("messenger_web").mustfixThrow("Unexpected error trying to parse collapsible ID: "+a.message)}C=babelHelpers["extends"]({collapsibleId:X,deleteTs:r,ebTimestampMs:f,ephemeralSetting:s,expirationTs:n,id:babelHelpers["extends"]({},g.id,{externalId:S}),quote:L,reportingMeta:t,type:d("MAWMsgType").MSG_TYPE.XMA},g);B=A.map(function(a){a.actionContentBlob;a=babelHelpers.objectWithoutPropertiesLoose(a,aa);return a});U=B.slice(1);e===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE&&A.length===1&&(U=B);q=e===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT;r={author:g.id.author,commands:y,contentRef:z,ctas:U,defaultCTA:B[0],externalId:S,faviconMediaId:q?V==null?void 0:V.plaintextHash:W==null?void 0:W.plaintextHash,headerMediaId:q?W==null?void 0:W.plaintextHash:V==null?void 0:V.plaintextHash,headerTitle:D,isTombstoned:o!=null?d("WATimeUtils").unixTime()>o:!1,maxSubtitleNumOfLines:E,maxTitleNumOfLines:F,mentionedJids:G.map(d("WAJids").validateUserJid).filter(Boolean),overlayDescription:I,overlayIconGlyph:J,overlayTitle:K,previewMediaIds:T.length>0?T.map(function(a){return a.plaintextHash}):void 0,sentWithMessage:H,subtitleText:N,targetExpiringAtSec:o,targetId:O,targetType:e,targetUsername:P,threadJid:b,titleText:Q,xmaDataclass:p,xmaLayoutType:w};var Y;if(x!=null&&M==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA associatedMessage cannot be received without sentWithMessageId field");x!=null&&R!=null&&(Y=ba(b,x,g,a,h));n=(s=(f=Y)==null?void 0:f.unstoredMedia)!=null?s:null;L=u.has(e);if(n!=null&&!L){t=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(e);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_XMA_PROTOCOL_PARSING,key:"assoc_msg_media_"+(t!=null?t:"unknown")});throw c("FBLogger")("messenger_web").mustfixThrow("XMA associated msg cannot have additioinal dbMedia")}z=(y=(A=Y)==null?void 0:A.unstoredMsg)!=null?y:null;R!=null&&z!=null&&(d("WALogger").DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["ExternalId: "," textId: ",""])),S,R),z.id=babelHelpers["extends"]({},z.id,{externalId:R}),C.id=babelHelpers["extends"]({},z.id,{externalId:S}),r.externalId=S);if(L&&n!=null&&((z==null?void 0:z.type)==="Gif"||(z==null?void 0:z.type)==="Sticker"))return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:C,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:n,unstoredAssociatedMsg:z,unstoredFavicon:q?T[0]:W,unstoredHeaderMedia:V,unstoredPreviews:T.length>0?T:void 0,xma:r},xmaTargetTypeForLogging:e};if(z!=null&&z.type!=="Text")throw c("FBLogger")("messenger_web").mustfixThrow('XMA associated msg cannot have type different from "Text". Received type: '+z.type);return{contentTypeForLogging:"extendedContentMessage",unstoredMedia:null,unstoredMsg:C,unstoredQuotedMedia:null,unstoredXMA:{unstoredAssociatedMedia:void 0,unstoredAssociatedMsg:z,unstoredFavicon:q?T[0]:W,unstoredHeaderMedia:V,unstoredPreviews:T.length>0&&!q?T:void 0,xma:r},xmaTargetTypeForLogging:e}}function ja(a){var b=a.ebRestore,c=a.hasActionUrl,e=a.hasNativeUrl,f=a.isActionUrlValid,g=a.isNativeUrlValid;a=a.targetType;!g&&!f?d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action and native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):g&&!f?d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid action URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c):f&&!g&&d("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose([""," XMA has invalid native URL for target type: ",". hasNativeUrl: ",". hasActionUrl: ","."])),b!=null&&b?"[labyrinth_web]":"[S410301][transport]",a,e,c)}function b(a,b,c){var d=a.nativeUrl;a=a.actionUrl;var e=Z(d,b,c),f=Z(a,b,c);ja({ebRestore:c,hasActionUrl:a!=null,hasNativeUrl:d!=null,isActionUrlValid:f,isNativeUrlValid:e,targetType:b});return e&&f}function Z(a,b,c,e){e===void 0&&(e=!1);if(a==null)return!0;if(na(a,b)===!1){c!=null&&c&&!e&&d("WALogger").ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid url prefix during XMA restore"])));return!1}if(!oa(a)){c!=null&&c&&!e&&d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid message text during XMA restore"])));return!1}return!0}function ka(a){return a.startsWith(B)||a.startsWith(C)||a.startsWith(D)||a.startsWith(E)||a.startsWith(F)}function la(a){return a.startsWith(P)||a.startsWith(Q)||a.startsWith(R)||a.startsWith(S)||a.startsWith(T)||a.startsWith(U)}function $(a){return a.startsWith(J)||a.startsWith(K)||a.startsWith(L)||a.startsWith(M)||a.startsWith(N)}function ma(a){return a.startsWith(V)||a.startsWith(W)||a.startsWith(X)||a.startsWith(Y)||a.startsWith(ca)}function na(a,b){if(a==null)return!0;switch(b){case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_HIGHLIGHT_REACTION:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:return a.startsWith(w);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return a.startsWith(x);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return a.startsWith(y);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return a.startsWith(z);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_IG_MEDIA_SHARE:return a.startsWith(A);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return a.startsWith(H)||a.startsWith(G)||ka(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:return $(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return a.startsWith(I);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:return($(a)||a.startsWith(O))&&!la(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return a.startsWith(ea);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_LOCAL_EVENT_REPLY:return ma(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return ma(a)||ka(a);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:return $(a)||a.startsWith(fa);case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_EXTERNAL_LINK:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL:if(a.includes(ga)&&(!a.startsWith(ha)&&!a.startsWith(ia))){b=a.indexOf("://");b===-1&&d("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(['S410301 The url is invalid. It contains a colon separator, but not "://"'])));return!1}break;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_RECEIVER_FETCH:case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.DATACLASS_SENDER_COPY:return!0;case d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_P2P_PAYMENT:return a.startsWith(da)}return!0}function oa(a){for(var b=0;b<a.length;b++){var c=a.charAt(b);switch(c){case"\u202c":case"\u202d":case"\u202e":d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["S410301 The url contains RTL characters"])));return!1;default:break}}return!0}g.SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES=u;g.kIGStoryCtaPrefix=w;g.kIGClipsCtaPrefix=x;g.kIGTVCtaPrefix=y;g.kIGShopCtaPrefix=z;g.kIGDefaultCtaPrefix=A;g.kFBStoryCtaPrefix=H;g.kFBGamingCustomUpdateCtaPrefix=I;g.kFBDefaultWWWCtaPrefix=J;g.kFBEventCtaPrefix=V;g.kMSGP2PPaymentUrlPrefix=da;g.kMessengerLocationSharePrefix=ea;g.kHttpPrefix=ha;g.parseXMAProtocol=a;g.isValidCTA=b;g.isURLValid=Z}),98);/*FB_PKG_DELIM*/
__d("LSDecryptMessageProtobufsV2",["LSArrayGetObjectAt","LSDecryptProtobuf","LSDecryptSupplementalKey","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSQplAnnotateInt.nop","LSQplMarkEnd.nop","LSQplMarkPoint.nop","LSQplStartTrace.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessageProtobufsV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[15]=new c.Map(),d[15].set("error_msg","Expected a nonempty query result"),d[15].set("code",c.i64.cast([0,3])),d[15].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[16]=c.createArray(),d[17]=(d[16].push(d[15]),d[16]),e=[void 0,d[16]],d[2]=e[0],d[3]=e[1]):(b=a.item,d[15]=new c.Map(),d[15].set("backup_id",b.backupId),d[15].set("device_public_key_blob",b.devicePublicKeyBlob),d[15].set("device_private_key_blob",b.devicePrivateKeyBlob),d[15].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[15].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[15].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[15].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[15].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[15].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[15].set("orf_client_state_v2_blob",void 0),d[15].set("orf_v2_authority_level",void 0),d[15].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[15].set("device_id",b.deviceId),d[15].set("backup_tenancy",b.backupTenancy),d[15].set("encryption_version",b.encryptionVersion),d[15].set("revision_version",b.revisionVersion),d[15].set("initialize_restore_result",void 0),d[15].set("device_creation_timestamp_sec",void 0),d[15].set("authority_level",b.authorityLevel),e=[d[15],void 0],d[2]=e[0],d[3]=e[1])})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[15]=d[6].get("backup_id"),d[16]=d[6].get("device_public_key_blob"),d[17]=d[6].get("device_private_key_blob"),d[18]=d[6].get("epoch_storage_public_key_blob"),d[19]=d[6].get("epoch_storage_private_key_blob"),d[20]=d[6].get("epoch_auth_public_key_blob"),d[21]=d[6].get("epoch_auth_private_key_blob"),d[22]=d[6].get("mailbox_root_key_blob"),d[23]=d[6].get("ocmf_client_state_blob"),d[24]=d[6].get("orf_client_state_v2_blob"),d[25]=d[6].get("orf_v2_authority_level"),d[26]=d[6].get("oblivious_validation_token_blob"),d[27]=d[6].get("device_id"),d[28]=d[6].get("backup_tenancy"),d[29]=d[6].get("encryption_version"),d[30]=d[6].get("revision_version"),d[31]=d[6].get("initialize_restore_result"),d[32]=d[6].get("device_creation_timestamp_sec"),d[33]=d[6].get("authority_level"),c.i64.neq(d[27],void 0)?c.sequence([function(a){return d[36]=void 0,c.i64.neq(d[36],void 0)?c.resolve(d[37]=d[36]):c.sequence([function(a){return d[49]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[59]=(d[49].push(c.i64.cast([0,0])),d[49]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[59]=(d[49].push(c.i64.cast([0,2])),d[49]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[59]=(d[49].push(c.i64.cast([0,3])),d[49]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[53]?d[59]=(d[49].push(c.i64.cast([0,4])),d[49]):0,d[54]=c.createArray(),d[55]=c.i64.of_int32(d[49].length),c.i64.gt(d[55],c.i64.cast([0,0]))?c.loopAsync(d[55],function(a){return d[59]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[49],d[59]).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(a){return d[62]=(d[54].push(d[60]),d[54])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[59]=c.createArray(),d[60]=c.i64.of_int32(d[54].length),c.i64.gt(d[60],c.i64.cast([0,0]))?c.loopAsync(d[60],function(a){return d[62]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[54],d[62]).then(function(a){return a=a,d[63]=a[0],d[64]=a[1],a})},function(a){return d[65]=(d[59].push(c.i64.to_string(d[63])),d[59])}])}):c.resolve()},function(a){return d[61]=d[59].join(","),d[56]=d[61]}])},function(a){return d[54].some(function(a){return c.i64.eq(d[29],a)})?d[57]=d[29]:d[57]=void 0,c.i64.neq(d[57],void 0)?d[58]=d[57]:d[58]=void 0,d[37]=d[58]}])},function(e){return c.i64.neq(d[37],void 0)?d[38]=d[37]:d[38]=c.i64.cast([0,0]),c.i64.neq(d[28],void 0)?d[39]=d[28]:d[39]=c.i64.cast([0,1]),d[40]=c.createArray(),d[41]=c.createArray(),d[42]=new c.Map(),a[2]!==void 0?d[43]=a[2]:(d[49]=new c.Map(),d[43]=d[49]),d[44]=d[43].keys(),d[45]=c.i64.of_int32(a[0].length),c.i64.gt(d[45],c.i64.cast([0,0]))?c.loopAsync(d[45],function(e){return d[49]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[49]).then(function(a){return a=a,d[50]=a[0],d[51]=a[1],a})},function(a){return d[52]=d[50].get("encrypted_protobufs_v2"),d[53]=d[52].get("toplevel_protobuf"),d[54]=c.i64.random(),d[61]=c.i64.to_string(d[54]),c.resolve()},function(a){return c.resolve()},function(a){return d[55]=d[50].get("otid"),d[56]=d[52].get("toplevel_protobuf_v2"),c.resolve((d[62]=new c.Map(),d[62].set("error_code",c.i64.cast([0,117])),d[62].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsV2StoredProcedure"),d[62].set("error_message",""),a=[void 0,d[62]],d[57]=a[0],d[58]=a[1]))},function(e){return d[57]!==void 0?c.sequence([function(a){return c.resolve()},function(a){return d[53]!==void 0?c.resolve(0):c.resolve()},function(a){return a=[d[57],d[58]],d[59]=a[0],d[60]=a[1],a}]):c.sequence([function(a){return c.resolve()},function(e){return d[53]!==void 0?c.sequence([function(a){return d[64]=d[53].get("epoch_id"),d[65]=d[53].get("epoch_anon_id"),d[66]=d[42].get(c.blobs.to_string(d[65])),d[66]!==void 0?c.resolve(d[67]=d[66]):c.sequence([function(a){return c.i64.neq(d[64],void 0)?c.sequence([function(a){return d[76]=c.createArray(),c.count(c.db.table(169).fetch([[[d[64]]]])).then(function(a){return d[77]=a})},function(a){return c.i64.le(d[77],c.i64.cast([0,1]))?c.sequence([function(a){return c.db.table(169).fetch([[[d[64]]]]).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[87]=new c.Map(),d[87].set("error_msg","Expected a nonempty query result"),d[87].set("code",c.i64.cast([0,3])),d[87].set("src_line","MEBEpochClientUtils.php:313 MEBEpochClientUtils::requireEpochReturnShapeFromPersistentEpochsTableDirectly()"),d[88]=c.createArray(),d[89]=(d[88].push(d[87]),d[88]),e=[void 0,d[88]],d[83]=e[0],d[84]=e[1]):(b=a.item,d[87]=new c.Map(),d[87].set("epoch_id",b.epochId),d[87].set("backup_id",b.backupId),d[87].set("epoch_anon_id_blob",b.epochAnonIdBlob),d[87].set("epoch_root_key_blob",b.epochRootKeyBlob),d[87].set("epoch_status",b.epochStatus),d[87].set("epoch_head",b.epochHead),d[87].set("authority_level",b.authorityLevel),e=[d[87],void 0],d[83]=e[0],d[84]=e[1])})},function(a){return d[86]=new c.Map(),d[86].set("value",d[83]),d[86].set("errors",d[84]),d[78]=d[86]}]):c.resolve((d[83]=new c.Map(),d[83].set("error_msg","Expected at most one result"),d[83].set("code",c.i64.cast([0,4])),d[83].set("src_line","MEBEpochClientUtils.php:313 MEBEpochClientUtils::requireEpochReturnShapeFromPersistentEpochsTableDirectly()"),d[84]=c.createArray(),d[86]=(d[84].push(d[83]),d[84]),d[85]=new c.Map(),d[85].set("value",void 0),d[85].set("errors",d[84]),d[78]=d[85]))},function(a){return d[79]=d[78].get("value"),d[79]!==void 0?(d[83]=d[79].get("epoch_id"),d[84]=d[79].get("backup_id"),d[85]=d[79].get("epoch_anon_id_blob"),d[86]=d[79].get("epoch_root_key_blob"),d[87]=d[79].get("epoch_status"),d[88]=d[79].get("epoch_head"),d[89]=d[79].get("authority_level"),c.i64.eq(d[89],c.i64.cast([0,80]))?d[90]=d[78]:(d[91]=new c.Map(),d[91].set("error_msg","NONE"),d[91].set("code",c.i64.cast([0,0])),d[91].set("src_line","MEBEpochClientUtils.php:315 Closure$MEBEpochClientUtils::requireEpochReturnShapeFromPersistentEpochsTableDirectly#2()"),d[92]=c.createArray(),d[94]=(d[92].push(d[91]),d[92]),d[93]=new c.Map(),d[93].set("value",void 0),d[93].set("errors",d[92]),d[90]=d[93]),d[80]=d[90]):(d[83]=d[78].get("errors"),d[84]=d[78].get("errors"),d[85]=new c.Map(),d[85].set("value",void 0),d[85].set("errors",d[83]),d[80]=d[85]),d[81]=d[80].get("value"),d[81]!==void 0?(d[83]=d[81].get("epoch_id"),d[84]=d[81].get("backup_id"),d[85]=d[81].get("epoch_anon_id_blob"),d[86]=d[81].get("epoch_root_key_blob"),d[87]=d[81].get("epoch_status"),d[88]=d[81].get("epoch_head"),d[89]=d[81].get("authority_level"),c.i64.eq(d[84],d[15])&&c.i64.eq(d[89],c.i64.cast([0,80]))?(d[90]=new c.Map(),d[90].set("epoch_root_key",d[86]),d[90].set("epoch_anon_id",d[85]),d[91]=(d[76].push(d[90]),d[76])):0,d[82]=!0):(d[83]=d[80].get("errors"),d[84]=d[80].get("errors"),d[82]=!1),d[75]=d[76]}]):c.sequence([function(a){return d[76]=c.createArray(),c.filter(c.db.table(169).fetch(),function(a){return c.blobs.eq(a.epochAnonIdBlob,d[65])}).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[83]=new c.Map(),d[83].set("error_msg","Expected a nonempty query result"),d[83].set("code",c.i64.cast([0,3])),d[83].set("src_line","MEBEpochClientUtils.php:556 MEBEpochClientUtils::maybeEpochWithAnonIDFromPersistentEpochsTableDirectly()"),d[84]=c.createArray(),d[85]=(d[84].push(d[83]),d[84]),e=[void 0,d[84]],d[77]=e[0],d[78]=e[1]):(b=a.item,d[83]=new c.Map(),d[83].set("epoch_id",b.epochId),d[83].set("backup_id",b.backupId),d[83].set("epoch_anon_id_blob",b.epochAnonIdBlob),d[83].set("epoch_root_key_blob",b.epochRootKeyBlob),d[83].set("epoch_status",b.epochStatus),d[83].set("epoch_head",b.epochHead),d[83].set("authority_level",b.authorityLevel),e=[d[83],void 0],d[77]=e[0],d[78]=e[1])})},function(a){return d[80]=new c.Map(),d[80].set("value",d[77]),d[80].set("errors",d[78]),d[81]=d[80].get("value"),d[81]!==void 0?(d[83]=d[81].get("epoch_id"),d[84]=d[81].get("backup_id"),d[85]=d[81].get("epoch_anon_id_blob"),d[86]=d[81].get("epoch_root_key_blob"),d[87]=d[81].get("epoch_status"),d[88]=d[81].get("epoch_head"),d[89]=d[81].get("authority_level"),c.i64.eq(d[84],d[15])&&c.i64.eq(d[89],c.i64.cast([0,80]))?(d[90]=new c.Map(),d[90].set("epoch_root_key",d[86]),d[90].set("epoch_anon_id",d[85]),d[91]=(d[76].push(d[90]),d[76])):0,d[82]=!0):(d[83]=d[80].get("errors"),d[84]=d[80].get("errors"),d[82]=!1),d[75]=d[76]}])},function(a){return d[67]=d[75]}])},function(e){return d[68]=d[53].get("epoch_anon_id"),d[42].set(c.blobs.to_string(d[68]),d[67]),d[69]=d[53].get("encrypted_protobuf"),d[70]=d[53].get("encryption_version"),c.storedProcedure(b("LSDecryptProtobuf"),d[69],d[70],a[1],d[67]).then(function(a){return a=a,d[71]=a[0],d[72]=a[1],a})},function(a){return c.blobs.neq(d[71],void 0)?(d[75]=d[53].get("protobuf_timestamp_ms"),d[76]=new c.Map(),d[76].set("decrypted_protobuf",d[71]),d[76].set("protobuf_timestamp_ms",d[75]),a=[d[76],void 0],d[73]=a[0],d[74]=a[1]):(a=[void 0,d[72]],d[73]=a[0],d[74]=a[1],a),a=[d[73],d[74]],d[62]=a[0],d[63]=a[1]}]):c.sequence([function(a){return c.resolve()},function(a){return d[64]=new c.Map(),d[64].set("error_code",c.i64.cast([0,116])),d[64].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsV2StoredProcedure"),d[64].set("error_message",""),a=[void 0,d[64]],d[62]=a[0],d[63]=a[1]}])},function(a){return a=[d[62],d[63]],d[59]=a[0],d[60]=a[1],a}])},function(e){return d[59]!==void 0?c.sequence([function(a){return d[62]=d[52].get("supplemental_protobufs"),d[63]=d[52].get("supplemental_protobufs_v2"),d[64]=d[50].get("otid"),d[65]=new c.Map(),d[66]=c.createArray(),c.resolve()},function(e){return d[67]=d[65].keys(),d[68]=d[62].keys(),d[69]=c.i64.of_int32(d[68].length),c.i64.gt(d[69],c.i64.cast([0,0]))?c.loopAsync(d[69],function(e){return d[75]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[68],d[75]).then(function(a){return a=a,d[76]=a[0],d[77]=a[1],a})},function(e){return d[78]=d[62].get(d[76]),d[78]!==void 0?c.sequence([function(a){return d[79]=d[78].get("supplemental_otid"),d[79]!==void 0?c.sequence([function(a){return d[81]=!1,d[82]=c.i64.of_int32(d[66].length),c.i64.gt(d[82],c.i64.cast([0,0]))?c.loopAsync(d[82],function(a){return d[83]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[66],d[83]).then(function(a){return a=a,d[84]=a[0],d[85]=a[1],a})},function(a){return d[81]=d[81]||d[79]===d[84]}])}):c.resolve()},function(a){return d[80]=!d[81]}]):c.resolve(d[80]=!0)},function(e){return d[80]?c.sequence([function(a){return d[81]=d[78].get("epoch_id"),d[82]=d[78].get("epoch_anon_id"),d[83]=d[42].get(c.blobs.to_string(d[82])),d[83]!==void 0?c.resolve(d[84]=d[83]):c.sequence([function(a){return c.i64.neq(d[81],void 0)?c.sequence([function(a){return d[90]=c.createArray(),c.count(c.db.table(169).fetch([[[d[81]]]])).then(function(a){return d[91]=a})},function(a){return c.i64.le(d[91],c.i64.cast([0,1]))?c.sequence([function(a){return c.db.table(169).fetch([[[d[81]]]]).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[101]=new c.Map(),d[101].set("error_msg","Expected a nonempty query result"),d[101].set("code",c.i64.cast([0,3])),d[101].set("src_line","MEBEpochClientUtils.php:313 MEBEpochClientUtils::requireEpochReturnShapeFromPersistentEpochsTableDirectly()"),d[102]=c.createArray(),d[103]=(d[102].push(d[101]),d[102]),e=[void 0,d[102]],d[97]=e[0],d[98]=e[1]):(b=a.item,d[101]=new c.Map(),d[101].set("epoch_id",b.epochId),d[101].set("backup_id",b.backupId),d[101].set("epoch_anon_id_blob",b.epochAnonIdBlob),d[101].set("epoch_root_key_blob",b.epochRootKeyBlob),d[101].set("epoch_status",b.epochStatus),d[101].set("epoch_head",b.epochHead),d[101].set("authority_level",b.authorityLevel),e=[d[101],void 0],d[97]=e[0],d[98]=e[1])})},function(a){return d[100]=new c.Map(),d[100].set("value",d[97]),d[100].set("errors",d[98]),d[92]=d[100]}]):c.resolve((d[97]=new c.Map(),d[97].set("error_msg","Expected at most one result"),d[97].set("code",c.i64.cast([0,4])),d[97].set("src_line","MEBEpochClientUtils.php:313 MEBEpochClientUtils::requireEpochReturnShapeFromPersistentEpochsTableDirectly()"),d[98]=c.createArray(),d[100]=(d[98].push(d[97]),d[98]),d[99]=new c.Map(),d[99].set("value",void 0),d[99].set("errors",d[98]),d[92]=d[99]))},function(a){return d[93]=d[92].get("value"),d[93]!==void 0?(d[97]=d[93].get("epoch_id"),d[98]=d[93].get("backup_id"),d[99]=d[93].get("epoch_anon_id_blob"),d[100]=d[93].get("epoch_root_key_blob"),d[101]=d[93].get("epoch_status"),d[102]=d[93].get("epoch_head"),d[103]=d[93].get("authority_level"),c.i64.eq(d[103],c.i64.cast([0,80]))?d[104]=d[92]:(d[105]=new c.Map(),d[105].set("error_msg","NONE"),d[105].set("code",c.i64.cast([0,0])),d[105].set("src_line","MEBEpochClientUtils.php:315 Closure$MEBEpochClientUtils::requireEpochReturnShapeFromPersistentEpochsTableDirectly#2()"),d[106]=c.createArray(),d[108]=(d[106].push(d[105]),d[106]),d[107]=new c.Map(),d[107].set("value",void 0),d[107].set("errors",d[106]),d[104]=d[107]),d[94]=d[104]):(d[97]=d[92].get("errors"),d[98]=d[92].get("errors"),d[99]=new c.Map(),d[99].set("value",void 0),d[99].set("errors",d[97]),d[94]=d[99]),d[95]=d[94].get("value"),d[95]!==void 0?(d[97]=d[95].get("epoch_id"),d[98]=d[95].get("backup_id"),d[99]=d[95].get("epoch_anon_id_blob"),d[100]=d[95].get("epoch_root_key_blob"),d[101]=d[95].get("epoch_status"),d[102]=d[95].get("epoch_head"),d[103]=d[95].get("authority_level"),c.i64.eq(d[98],d[15])&&c.i64.eq(d[103],c.i64.cast([0,80]))?(d[104]=new c.Map(),d[104].set("epoch_root_key",d[100]),d[104].set("epoch_anon_id",d[99]),d[105]=(d[90].push(d[104]),d[90])):0,d[96]=!0):(d[97]=d[94].get("errors"),d[98]=d[94].get("errors"),d[96]=!1),d[89]=d[90]}]):c.sequence([function(a){return d[90]=c.createArray(),c.filter(c.db.table(169).fetch(),function(a){return c.blobs.eq(a.epochAnonIdBlob,d[82])}).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[97]=new c.Map(),d[97].set("error_msg","Expected a nonempty query result"),d[97].set("code",c.i64.cast([0,3])),d[97].set("src_line","MEBEpochClientUtils.php:556 MEBEpochClientUtils::maybeEpochWithAnonIDFromPersistentEpochsTableDirectly()"),d[98]=c.createArray(),d[99]=(d[98].push(d[97]),d[98]),e=[void 0,d[98]],d[91]=e[0],d[92]=e[1]):(b=a.item,d[97]=new c.Map(),d[97].set("epoch_id",b.epochId),d[97].set("backup_id",b.backupId),d[97].set("epoch_anon_id_blob",b.epochAnonIdBlob),d[97].set("epoch_root_key_blob",b.epochRootKeyBlob),d[97].set("epoch_status",b.epochStatus),d[97].set("epoch_head",b.epochHead),d[97].set("authority_level",b.authorityLevel),e=[d[97],void 0],d[91]=e[0],d[92]=e[1])})},function(a){return d[94]=new c.Map(),d[94].set("value",d[91]),d[94].set("errors",d[92]),d[95]=d[94].get("value"),d[95]!==void 0?(d[97]=d[95].get("epoch_id"),d[98]=d[95].get("backup_id"),d[99]=d[95].get("epoch_anon_id_blob"),d[100]=d[95].get("epoch_root_key_blob"),d[101]=d[95].get("epoch_status"),d[102]=d[95].get("epoch_head"),d[103]=d[95].get("authority_level"),c.i64.eq(d[98],d[15])&&c.i64.eq(d[103],c.i64.cast([0,80]))?(d[104]=new c.Map(),d[104].set("epoch_root_key",d[100]),d[104].set("epoch_anon_id",d[99]),d[105]=(d[90].push(d[104]),d[90])):0,d[96]=!0):(d[97]=d[94].get("errors"),d[98]=d[94].get("errors"),d[96]=!1),d[89]=d[90]}])},function(a){return d[84]=d[89]}])},function(a){return d[85]=d[78].get("epoch_anon_id"),d[42].set(c.blobs.to_string(d[85]),d[84]),d[86]=d[78].get("sk_ciphertext"),c.storedProcedure(b("LSDecryptSupplementalKey"),d[86]==null?"":d[86],d[84]).then(function(a){return a=a,d[87]=a[0],d[88]=a[1],a})},function(e){return d[87]!==void 0?c.sequence([function(a){return d[89]=!1,d[90]=c.i64.of_int32(d[67].length),c.i64.gt(d[90],c.i64.cast([0,0]))?c.loopAsync(d[90],function(a){return d[91]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[67],d[91]).then(function(a){return a=a,d[92]=a[0],d[93]=a[1],a})},function(a){return d[89]=d[89]||d[87]===d[92]}])}):c.resolve()},function(e){return d[89]?c.resolve():c.sequence([function(e){return d[91]=d[78].get("encrypted_protobuf"),d[92]=d[78].get("encryption_version"),c.storedProcedure(b("LSDecryptProtobuf"),d[91],d[92],a[1],d[84]).then(function(a){return a=a,d[93]=a[0],d[94]=a[1],a})},function(a){return c.blobs.neq(d[93],void 0)?(d[95]=d[78].get("protobuf_timestamp_ms"),d[96]=new c.Map(),d[96].set("decrypted_protobuf",d[93]),d[96].set("protobuf_timestamp_ms",d[95]),d[65].set(d[87],d[96])):d[95]=(d[41].push(d[94]),d[41])}])}]):c.resolve((d[89]=new c.Map(),d[89].set("error_code",c.i64.cast([0,109])),d[89].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsV2StoredProcedure"),d[89].set("error_message",""),d[90]=(d[41].push(d[89]),d[41])))}]):c.resolve()}]):(d[79]=["Supplemental key is null for supplemental protobuf with otid: ",d[64]," act_thread_id: ",a[1]].join(""),function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][decryptMessageProtobufsV2] ","",d[79]].join("")),d[80]=c.createArray(),void 0!==void 0?d[81]=(d[80].push(void 0),d[80]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessageProtobufsV2",[d[79]].join(""),d[80],c.i64.cast([0,3])))}])}):c.resolve()},function(a){return d[70]=d[50].get("otid"),d[71]=d[50].get("message_tags"),d[72]=d[50].get("attachment_data"),d[72]!==void 0?c.sequence([function(a){return d[75]=c.createArray(),d[76]=c.i64.of_int32(d[72].length),c.i64.gt(d[76],c.i64.cast([0,0]))?c.loopAsync(d[76],function(a){return d[79]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[72],d[79]).then(function(a){return a=a,d[80]=a[0],d[81]=a[1],a})},function(a){return d[82]=(d[75].push(d[80]),d[75])}])}):c.resolve()},function(a){return d[77]=new c.Map(),d[77].set("attachment_data",d[75]),d[78]=c.toJSON(d[77]),d[73]=d[78]}]):c.resolve(d[73]=void 0)},function(a){return d[74]=new c.Map(),d[74].set("otid",d[70]),d[74].set("toplevel_protobuf",d[59]),d[74].set("supplemental_protobufs",d[65]),d[74].set("message_tags",d[71]),d[74].set("restore_message_data",d[73]),d[75]=(d[40].push(d[74]),d[40]),c.resolve()}]):(d[62]=(d[41].push(d[60]),d[41]),c.resolve())}])}):c.resolve()},function(a){return d[46]=c.i64.of_int32(d[41].length),c.i64.gt(d[46],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[41],c.i64.cast([0,0])).then(function(a){return a=a,d[49]=a[0],d[50]=a[1],a})},function(a){return a=[void 0,d[49]],d[47]=a[0],d[48]=a[1],a}]):c.resolve((a=[d[40],void 0],d[47]=a[0],d[48]=a[1],a))},function(a){return a=[d[47],d[48]],d[34]=a[0],d[35]=a[1],a}]):c.resolve((d[36]=new c.Map(),d[36].set("error_code",c.i64.cast([0,24])),d[36].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsV2StoredProcedure"),d[36].set("error_message",""),e=[void 0,d[36]],d[34]=e[0],d[35]=e[1]))},function(a){return a=[d[34],d[35]],d[7]=a[0],d[8]=a[1],a}]):c.resolve((d[15]=d[5].get("errors"),d[16]=d[5].get("errors"),d[17]=new c.Map(),d[17].set("error_code",c.i64.cast([0,1])),d[17].set("stored_procedure","LSEncryptedBackupsDecryptMessageProtobufsV2StoredProcedure"),d[17].set("error_message",""),e=[void 0,d[17]],d[7]=e[0],d[8]=e[1]))},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessageProtobufsV2] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessageProtobufsV2",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[7],d[8]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptMessageProtobufsV2StoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSHandleMessageWithProtobufsRestoreV2",["LSArrayGetObjectAt","LSDecryptMessageProtobufsV2","LSDeserializeFromJsonIntoDictionaryV2.nop","LSIsEncryptionVersionSecure","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSLogWebQpl.nop","LSQplAnnotateString.nop","LSQplMarkEnd.nop","LSQplMarkPoint.nop","LSQplStartTrace.nop","LSRestoreProtobufs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageWithProtobufsRestoreV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[2]=a[5].get("restore_task_source"),a[9]!==void 0?c.nativeOperation(b("LSQplStartTrace.nop"),c.i64.cast([0,679687866]),a[9],!0,void 0):c.resolve()},function(e){return d[3]=c.i64.of_int32(a[0].length),c.i64.eq(d[3],c.i64.cast([0,0]))?c.sequence([function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"maybe_populate_sender_device_keys_called"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"minos_sender_device_keys_table_null"):c.resolve()}]):c.resolve()},function(e){return c.storedProcedure(b("LSDecryptMessageProtobufsV2"),a[0],a[2],a[10]).then(function(a){return a=a,d[4]=a[0],d[5]=a[1],a})},function(e){return d[6]=a[5].get("request_id"),d[7]=c.i64.of_int32(a[0].length),d[6]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[6],c.i64.cast([0,521476165]),"call_from_client",d[7],void 0,void 0):c.resolve()},function(e){return c.i64.neq(a[7],void 0)?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[21]=new c.Map(),d[21].set("error_msg","Expected a nonempty query result"),d[21].set("code",c.i64.cast([0,3])),d[21].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[22]=c.createArray(),d[23]=(d[22].push(d[21]),d[22]),e=[void 0,d[22]],d[15]=e[0],d[16]=e[1]):(b=a.item,d[21]=new c.Map(),d[21].set("backup_id",b.backupId),d[21].set("device_public_key_blob",b.devicePublicKeyBlob),d[21].set("device_private_key_blob",b.devicePrivateKeyBlob),d[21].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[21].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[21].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[21].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[21].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[21].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[21].set("orf_client_state_v2_blob",void 0),d[21].set("orf_v2_authority_level",void 0),d[21].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[21].set("device_id",b.deviceId),d[21].set("backup_tenancy",b.backupTenancy),d[21].set("encryption_version",b.encryptionVersion),d[21].set("revision_version",b.revisionVersion),d[21].set("initialize_restore_result",void 0),d[21].set("device_creation_timestamp_sec",void 0),d[21].set("authority_level",b.authorityLevel),e=[d[21],void 0],d[15]=e[0],d[16]=e[1])})},function(e){return d[18]=new c.Map(),d[18].set("value",d[15]),d[18].set("errors",d[16]),d[19]=d[18].get("value"),d[19]!==void 0?c.sequence([function(e){return d[21]=d[19].get("backup_id"),d[22]=d[19].get("device_public_key_blob"),d[23]=d[19].get("device_private_key_blob"),d[24]=d[19].get("epoch_storage_public_key_blob"),d[25]=d[19].get("epoch_storage_private_key_blob"),d[26]=d[19].get("epoch_auth_public_key_blob"),d[27]=d[19].get("epoch_auth_private_key_blob"),d[28]=d[19].get("mailbox_root_key_blob"),d[29]=d[19].get("ocmf_client_state_blob"),d[30]=d[19].get("orf_client_state_v2_blob"),d[31]=d[19].get("orf_v2_authority_level"),d[32]=d[19].get("oblivious_validation_token_blob"),d[33]=d[19].get("device_id"),d[34]=d[19].get("backup_tenancy"),d[35]=d[19].get("encryption_version"),d[36]=d[19].get("revision_version"),d[37]=d[19].get("initialize_restore_result"),d[38]=d[19].get("device_creation_timestamp_sec"),d[39]=d[19].get("authority_level"),c.i64.neq(d[33],void 0)?c.sequence([function(a){return d[41]=void 0,c.i64.neq(d[41],void 0)?c.resolve(d[42]=d[41]):c.sequence([function(a){return d[45]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[46]?d[55]=(d[45].push(c.i64.cast([0,0])),d[45]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[55]=(d[45].push(c.i64.cast([0,2])),d[45]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[55]=(d[45].push(c.i64.cast([0,3])),d[45]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[55]=(d[45].push(c.i64.cast([0,4])),d[45]):0,d[50]=c.createArray(),d[51]=c.i64.of_int32(d[45].length),c.i64.gt(d[51],c.i64.cast([0,0]))?c.loopAsync(d[51],function(a){return d[55]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[45],d[55]).then(function(a){return a=a,d[56]=a[0],d[57]=a[1],a})},function(a){return d[58]=(d[50].push(d[56]),d[50])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[55]=c.createArray(),d[56]=c.i64.of_int32(d[50].length),c.i64.gt(d[56],c.i64.cast([0,0]))?c.loopAsync(d[56],function(a){return d[58]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[50],d[58]).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return d[61]=(d[55].push(c.i64.to_string(d[59])),d[55])}])}):c.resolve()},function(a){return d[57]=d[55].join(","),d[52]=d[57]}])},function(a){return d[50].some(function(a){return c.i64.eq(d[35],a)})?d[53]=d[35]:d[53]=void 0,c.i64.neq(d[53],void 0)?d[54]=d[53]:d[54]=void 0,d[42]=d[54]}])},function(b){return c.i64.neq(d[42],void 0)?d[43]=d[42]:d[43]=c.i64.cast([0,0]),c.i64.neq(d[34],void 0)?d[44]=d[34]:d[44]=c.i64.cast([0,1]),d[40]=c.i64.neq(d[33],a[7])}]):c.resolve(d[40]=!1)},function(a){return d[20]=d[40]}]):c.resolve((d[21]=d[18].get("errors"),d[22]=d[18].get("errors"),d[20]=!1))},function(a){return d[8]=d[20]}]):c.resolve(d[8]=!1)},function(e){return d[8]?c.sequence([function(e){return d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,110])),d[15].set("stored_procedure","LSEncryptedBackupsHandleMessageWithProtobufsRestoreV2StoredProcedure"),d[15].set("error_message",""),c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[16]=a[0],d[17]=a[1],a})},function(e){return d[18]=new c.Map(),d[18].set("error_code",c.i64.cast([0,110])),d[18].set("stored_procedure","LSEncryptedBackupsHandleMessageWithProtobufsRestoreV2StoredProcedure"),d[18].set("error_message",""),a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),a[9],"handle_restore_response"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),a[9],!1):c.resolve()},function(e){return d[18]!==void 0?(d[21]=d[18].get("error_code"),d[19]=["LSEBPayloadSerializerError","_",c.i64.to_string(d[21])].join("")):d[19]="unknown_failure",d[20]=["LSEncryptedBackupsHandleMessageWithProtobufsRestoreV2StoredProcedure",".",d[19]].join(""),a[9]!==void 0?d[20]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"error",d[20]):c.resolve():c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),a[9],!1):c.resolve()}]):c.sequence([function(e){return d[4]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[17]=a[0],d[18]=a[1],a})},function(e){return c.i64.neq(d[17],void 0)?c.sequence([function(e){return void 0!==void 0?c.resolve((d[23]=c.createArray(),e=[d[23],void 0],d[21]=e[0],d[22]=e[1])):c.sequence([function(e){return d[23]=a[1].get("has_more_before"),d[24]=a[1].get("has_more_after"),d[23]?(d[33]=a[1].get("next_message_timestamp_ms_before"),d[25]=d[33]):d[25]=void 0,d[24]?(d[33]=a[1].get("next_message_timestamp_ms_after"),d[26]=d[33]):d[26]=void 0,d[27]=a[1].get("has_more_before"),d[28]=a[1].get("has_more_after"),d[29]=a[5].get("request_id"),d[30]=a[5].get("reference_timestamp"),d[31]=c.createArray(),c.nativeOperation(b("LSRestoreProtobufs.nop"),a[2],d[4],d[27],d[25],d[28],d[26],a[4],d[29],d[30],a[6],d[31],d[2],void 0)},function(e){return void 0!==void 0?d[32]=void 0:(d[33]=c.createArray(),d[32]=d[33]),c.i64.eq(d[2],c.i64.cast([0,77]))?(d[33]=c.i64.of_int32(a[0].length),c.i64.gt(d[33],c.i64.cast([0,0]))?c.loopAsync(d[33],function(e){return d[34]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[34]).then(function(a){return a=a,d[35]=a[0],d[36]=a[1],a})},function(e){return d[37]=d[35].get("encrypted_protobufs_v2"),d[38]=d[37].get("toplevel_protobuf_v2"),d[38]?d[39]=!1:d[39]=!0,d[39]?c.sequence([function(e){return d[48]=d[35].get("otid"),a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"maybe_populate_sender_device_keys_called"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"minos_sender_device_keys_table_null"):c.resolve()}]):c.sequence([function(e){return d[48]=d[35].get("otid"),d[49]=d[38].get("transport_sender_signing_pk"),a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"maybe_populate_sender_device_keys_called"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"minos_sender_device_keys_table_null"):c.resolve()}])},function(e){return d[40]=d[35].get("encrypted_protobufs_v2"),d[41]=d[40].get("supplemental_protobufs_v2"),d[42]=d[41].keys(),d[43]=c.i64.of_int32(d[42].length),c.i64.gt(d[43],c.i64.cast([0,0]))?c.loopAsync(d[43],function(e){return d[48]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[42],d[48]).then(function(a){return a=a,d[49]=a[0],d[50]=a[1],a})},function(e){return d[51]=d[41].get(d[49]),d[51]!==void 0?c.sequence([function(e){return d[52]=d[51].get("supplemental_otid"),d[53]=d[51].get("transport_sender_signing_pk"),d[54]=d[35].get("otid"),a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"maybe_populate_sender_device_keys_called"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"minos_sender_device_keys_table_null"):c.resolve()}]):c.resolve()}])}):c.resolve()},function(e){return d[44]=d[35].get("encrypted_protobufs_v2"),d[45]=d[44].get("supplemental_protobufs"),d[46]=d[45].keys(),d[47]=c.i64.of_int32(d[46].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(e){return d[48]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[48]).then(function(a){return a=a,d[49]=a[0],d[50]=a[1],a})},function(e){return d[51]=d[45].get(d[49]),d[51]!==void 0?c.sequence([function(e){return d[52]=d[51].get("supplemental_otid"),d[53]=d[35].get("otid"),a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"maybe_populate_sender_device_keys_called"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"minos_sender_device_keys_table_null"):c.resolve()}]):c.resolve()}])}):c.resolve()}])}):c.resolve()):c.resolve()},function(a){return a=[d[32],void 0],d[21]=a[0],d[22]=a[1],a}])},function(a){return a=[d[21],d[22]],d[19]=a[0],d[20]=a[1],a}]):c.resolve((d[21]=c.createArray(),e=[d[21],d[18]],d[19]=e[0],d[20]=e[1]))},function(a){return a=[d[19],d[20]],d[15]=a[0],d[16]=a[1],a}]):c.sequence([function(e){return d[5]!==void 0?(d[18]=d[5].get("error_code"),c.i64.eq(d[18],c.i64.cast([0,1]))?0:0):0,a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"maybe_populate_sender_device_keys_called"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"minos_sender_device_keys_table_null"):c.resolve()},function(a){return d[17]=c.createArray(),a=[d[17],d[5]],d[15]=a[0],d[16]=a[1]}])},function(e){return d[16]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[17]=a[0],d[18]=a[1],a})},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),a[9],"handle_restore_response"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),a[9],!1):c.resolve()},function(e){return a[6]!==void 0?c.sequence([function(b){return d[19]=a[5].get("request_id"),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[41]=new c.Map(),d[41].set("error_msg","Expected a nonempty query result"),d[41].set("code",c.i64.cast([0,3])),d[41].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[42]=c.createArray(),d[43]=(d[42].push(d[41]),d[42]),e=[void 0,d[42]],d[20]=e[0],d[21]=e[1]):(b=a.item,d[41]=new c.Map(),d[41].set("backup_id",b.backupId),d[41].set("device_public_key_blob",b.devicePublicKeyBlob),d[41].set("device_private_key_blob",b.devicePrivateKeyBlob),d[41].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[41].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[41].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[41].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[41].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[41].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[41].set("orf_client_state_v2_blob",void 0),d[41].set("orf_v2_authority_level",void 0),d[41].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[41].set("device_id",b.deviceId),d[41].set("backup_tenancy",b.backupTenancy),d[41].set("encryption_version",b.encryptionVersion),d[41].set("revision_version",b.revisionVersion),d[41].set("initialize_restore_result",void 0),d[41].set("device_creation_timestamp_sec",void 0),d[41].set("authority_level",b.authorityLevel),e=[d[41],void 0],d[20]=e[0],d[21]=e[1])})},function(a){return d[23]=new c.Map(),d[23].set("value",d[20]),d[23].set("errors",d[21]),d[24]=d[23].get("value"),d[24]!==void 0?c.sequence([function(a){return d[41]=d[24].get("backup_id"),d[42]=d[24].get("device_public_key_blob"),d[43]=d[24].get("device_private_key_blob"),d[44]=d[24].get("epoch_storage_public_key_blob"),d[45]=d[24].get("epoch_storage_private_key_blob"),d[46]=d[24].get("epoch_auth_public_key_blob"),d[47]=d[24].get("epoch_auth_private_key_blob"),d[48]=d[24].get("mailbox_root_key_blob"),d[49]=d[24].get("ocmf_client_state_blob"),d[50]=d[24].get("orf_client_state_v2_blob"),d[51]=d[24].get("orf_v2_authority_level"),d[52]=d[24].get("oblivious_validation_token_blob"),d[53]=d[24].get("device_id"),d[54]=d[24].get("backup_tenancy"),d[55]=d[24].get("encryption_version"),d[56]=d[24].get("revision_version"),d[57]=d[24].get("initialize_restore_result"),d[58]=d[24].get("device_creation_timestamp_sec"),d[59]=d[24].get("authority_level"),c.i64.neq(d[53],void 0)?c.sequence([function(a){return d[61]=void 0,c.i64.neq(d[61],void 0)?c.resolve(d[62]=d[61]):c.sequence([function(a){return d[65]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[66]=a[0],a})},function(a){return d[66]?d[75]=(d[65].push(c.i64.cast([0,0])),d[65]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[67]=a[0],a})},function(a){return d[67]?d[75]=(d[65].push(c.i64.cast([0,2])),d[65]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[68]=a[0],a})},function(a){return d[68]?d[75]=(d[65].push(c.i64.cast([0,3])),d[65]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[69]=a[0],a})},function(a){return d[69]?d[75]=(d[65].push(c.i64.cast([0,4])),d[65]):0,d[70]=c.createArray(),d[71]=c.i64.of_int32(d[65].length),c.i64.gt(d[71],c.i64.cast([0,0]))?c.loopAsync(d[71],function(a){return d[75]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[65],d[75]).then(function(a){return a=a,d[76]=a[0],d[77]=a[1],a})},function(a){return d[78]=(d[70].push(d[76]),d[70])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[75]=c.createArray(),d[76]=c.i64.of_int32(d[70].length),c.i64.gt(d[76],c.i64.cast([0,0]))?c.loopAsync(d[76],function(a){return d[78]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[70],d[78]).then(function(a){return a=a,d[79]=a[0],d[80]=a[1],a})},function(a){return d[81]=(d[75].push(c.i64.to_string(d[79])),d[75])}])}):c.resolve()},function(a){return d[77]=d[75].join(","),d[72]=d[77]}])},function(a){return d[70].some(function(a){return c.i64.eq(d[55],a)})?d[73]=d[55]:d[73]=void 0,c.i64.neq(d[73],void 0)?d[74]=d[73]:d[74]=void 0,d[62]=d[74]}])},function(a){return c.i64.neq(d[62],void 0)?d[63]=d[62]:d[63]=c.i64.cast([0,0]),c.i64.neq(d[54],void 0)?d[64]=d[54]:d[64]=c.i64.cast([0,1]),d[60]=d[53]}]):c.resolve(d[60]=void 0)},function(a){return d[25]=d[60]}]):c.resolve((d[41]=d[23].get("errors"),d[42]=d[23].get("errors"),d[25]=void 0))},function(e){return d[26]=a[5].get("restore_task_source"),c.nativeOperation(b("LSDeserializeFromJsonIntoDictionaryV2.nop"),a[6]).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[28]=new c.Map(),d[29]=d[27].keys(),d[30]=c.i64.of_int32(d[29].length),c.i64.gt(d[30],c.i64.cast([0,0]))?c.loopAsync(d[30],function(a){return d[41]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[29],d[41]).then(function(a){return a=a,d[42]=a[0],d[43]=a[1],a})},function(a){return d[44]=d[27].get(d[42]),d[28].set(d[42],d[44])}])}):c.resolve()},function(a){return d[31]=d[28].get("query"),d[32]=new c.Map(),d[33]=d[31].keys(),d[34]=c.i64.of_int32(d[33].length),c.i64.gt(d[34],c.i64.cast([0,0]))?c.loopAsync(d[34],function(a){return d[41]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],d[41]).then(function(a){return a=a,d[42]=a[0],d[43]=a[1],a})},function(a){return d[44]=d[31].get(d[42]),d[32].set(d[42],d[44])}])}):c.resolve()},function(e){return d[35]=d[32].get("__typename"),d[35]==="MPSMessagePointQuery"?c.sequence([function(a){return d[41]=d[32].get("__typename"),d[41]==="MPSMessagePointQuery"?d[42]=d[32]:d[42]=void 0,d[42]?d[43]=!1:d[43]=!0,d[43]?c.resolve(d[44]=void 0):c.sequence([function(a){return d[45]=d[42].get("otids"),d[46]=c.createArray(),d[47]=c.i64.of_int32(d[45].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(a){return d[50]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[45],d[50]).then(function(a){return a=a,d[51]=a[0],d[52]=a[1],a})},function(a){return d[53]=(d[46].push(d[51]),d[46])}])}):c.resolve()},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],c.i64.cast([0,0])).then(function(a){return a=a,d[48]=a[0],d[49]=a[1],a})},function(a){return d[44]=d[48]}])},function(e){return a[9]!==void 0?d[44]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"message_id",d[44]):c.resolve():c.resolve()},function(a){return d[36]="POINT_QUERY_RESTORE"}]):c.resolve((d[41]=d[32].get("__typename"),d[41]==="MPSMessageRangeQuery"?d[42]="RANGE_QUERY_RESTORE":(d[43]=d[32].get("__typename"),d[43]==="MPSMessageSurroundingQuery"?d[44]="SURROUNDING_RESTORE":(d[45]=d[32].get("__typename"),d[45]==="MPSTaggedRangeQuery"?d[46]="TAGGED_RANGE_QUERY_RESTORE":d[46]="unknown_query_type",d[44]=d[46]),d[42]=d[44]),d[36]=d[42]))},function(e){return a[9]!==void 0?d[36]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"restore_type",d[36]):c.resolve():c.resolve()},function(d){return a[9]!==void 0?a[2]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"act_thread_id",a[2]):c.resolve():c.resolve()},function(e){return a[9]!==void 0?d[19]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"request_id",d[19]):c.resolve():c.resolve()},function(e){return d[38]=c.i64.to_string(d[25]),a[9]!==void 0?d[38]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"device_id",d[38]):c.resolve():c.resolve()},function(e){return d[39]=c.i64.to_string(d[26]),a[9]!==void 0?d[39]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"task_creation_source",d[39]):c.resolve():c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),a[9],"handle_restore_response"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),a[9],!1):c.resolve()},function(e){return d[16]!==void 0?(d[41]=d[16].get("error_code"),d[37]=["LSEBPayloadSerializerError","_",c.i64.to_string(d[41])].join("")):d[37]="unknown_failure",d[40]=["LSEncryptedBackupsHandleMessageWithProtobufsRestoreV2StoredProcedure",".",d[37]].join(""),a[9]!==void 0?d[40]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,679687866]),a[9],"error",d[40]):c.resolve():c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),a[9],!1):c.resolve()}]):c.resolve()}]):c.sequence([function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679677570]),a[9],"handle_restore_response"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679677570]),a[9],!0):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,679687866]),a[9],"handle_restore_response"):c.resolve()},function(d){return a[9]!==void 0?c.nativeOperation(b("LSQplMarkEnd.nop"),c.i64.cast([0,679687866]),a[9],!0):c.resolve()},function(b){return d[17]=a[5].get("restore_task_source"),c.i64.eq(d[17],c.i64.cast([0,58]))?0:0}])}])},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageWithProtobufsRestoreV2] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageWithProtobufsRestoreV2",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleMessageWithProtobufsRestoreV2StoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);/*FB_PKG_DELIM*/
__d("EncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYISingleton","I64"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l;async function a(a,b,c,e,f,g,n){var o=d("EncryptedBackupsDYISingleton").getSingleton(),p=o.getLogger();o=o.getThreadKeyForThreadId(b);if(o==null){p.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Cannot find thread key for thread id: ",""])),b);return}void p.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handling message range query for thread with thread key ",", hasMoreBefore: ",""])),b,e);c.length>0&&await g(o,b,c);if(!e||f==null){e&&f==null&&void p.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["nextTimestampMs was not supplied for thread with thread key ","."])),b);m(o);return}g=(l||(l=d("I64"))).to_string(f);void p.LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Issuing next range query for thread with thread key ",", server generated next reference timestamp: ",""])),b,g);void n(a,g,b)}function m(a){var b=d("EncryptedBackupsDYISingleton").getSingleton();b.deleteThreadKeyFromThreadsRestoreInProgress(a)}g.handleMessageRangeQueryRestore=a}),98);
__d("MAWAsyncEBPendingQueryPromise",["Promise"],(function(a,b,c,d,e,f){"use strict";var g,h=new Map(),i=new Map(),j=new Map(),k=new Map(),l=new Map(),m=new Map();function a(a){var c=new(g||(g=b("Promise")))(function(b,c){i.set(a,b),k.set(a,c)});h.set(a,c);return c}function c(a,b){j.set(a,b)}function d(a){return j.get(a)}function e(a){var c=new(g||(g=b("Promise")))(function(b,c){l.set(a,{data:null,resolve:b}),m.set(a,c)});return c}function n(a,b){var c=i.get(a);c!=null&&(i["delete"](a),c(b));c=l.get(a);c!=null&&l.set(a,{data:b,resolve:c.resolve})}function o(a,b){var c=k.get(a);c!=null&&(i["delete"](a),c(b));c=m.get(a);c!=null&&(m["delete"](a),c(b),l["delete"](a))}function p(a){var b=l.get(a);b!=null&&b.data!=null&&(b.resolve(b.data),l["delete"](a),m["delete"](a))}f.getPendingQueryPromiseFromTrace=a;f.setJidFromThreadId=c;f.getJidFromThreadId=d;f.getWaitForRestorePromiseFromTrace=e;f.resolvePendingQueryIfPresent=n;f.rejectPendingQueryIfPresent=o;f.resolvePendingQueryUponReStore=p}),66);
__d("MAWEncryptedBackupsDYIProcessProtobufMessages",["CurrentUser","EncryptedBackupsDYIMessageProcessingUtils","EncryptedBackupsDYISingleton","MAWGroupPollsDualEncryptionUtils","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWMsgType","WAHashUtils","WAJids","WALongInt","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;async function a(a,b,e){var f=d("EncryptedBackupsDYISingleton").getSingleton(),g=f.getLogger();void g.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Processing "," protobuf messages for thread ",""])),e.length,b);e=e.map(function(b){var c=f.hasMessage(a,d("WAStanzaUtils").toStanzaId(b.otid));if(c){g.DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Encountered a duplicate message otid ",", skipping"])),b.otid);return null}return b}).filter(Boolean);var n=d("MAWJids").toUserJid(c("CurrentUser").getAccountID()),o=!1,p=!1,q;try{for(var r=babelHelpers.asyncIterator(e),e;o=!(e=await r.next()).done;o=!1){e=e.value;try{e=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(e,n,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);if(e==null){void g.WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Decoded protobuf is empty"])));return}if(e!=null&&e.metadata!=null&&e.metadata.messageId!=null){var s=d("WAStanzaUtils").toStanzaId(e.metadata.messageId);e=await B(a,b,e);if(e==null){void g.WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"])));continue}f.setMessagesByThreadKey(a,s,e)}else{void g.WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Error converting protobuf to DYI format. Dropping the message"])));continue}}catch(a){void g.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf. Dropping the message: ",""])),a);continue}}}catch(a){p=!0,q=a}finally{try{o&&r.return!=null&&await r.return()}finally{if(p)throw q}}}async function B(a,b,c){var e=d("EncryptedBackupsDYISingleton").getSingleton(),f=e.getLogger(),g=c.metadata,h=c.msgType,i=c.sortOrderMs;if(g==null||h==null){void f.WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: metadata or message type is null"])));return}h=g.messageId;var j=g.senderId;g=g.timestampMs;if(g==null||typeof g!=="number"||h==null||j==null){void f.WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Error processing protobuf: ts or messageId or senderId is null"])));return}h=d("WATimeUtils").castMilliSecondsToUnixTime(g);g=d("EncryptedBackupsDYIMessageProcessingUtils").buildBaseDyiMessage(j,i);j=(j=c.decodedPayload)==null?void 0:j.text;if(c.editMsgData.length>0){var k=h;c.editMsgData.forEach(function(a){var b;if(a.ts>k&&((b=a.editMsgContent.message)==null?void 0:b.text)!=null){k=a.ts;j=(b=a.editMsgContent.message)==null?void 0:b.text}})}c.reactionData.length>0&&(g.reactions=c.reactionData.map(function(a){var b=a.reaction;a=a.senderId;return{actor:(a=e.getContactNameForContactId(a))!=null?a:"unknown",reaction:(a=b.text)!=null?a:"unknown"}}));switch(c.msgType){case d("MAWMsgType").MSG_TYPE.TEXT:g.type="text";g.text=j||"";break;case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.PTT:g.type="media";g.text=j||"";g=D(a,b,c,i,g);break;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:void f.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Documents are not supported in DYI"])));return;case d("MAWMsgType").MSG_TYPE.XMA:g.type="link";if(c.xmaData==null){void f.WARN(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] XMA message doesn't have xmaData"])));return}g.text=((h=c.xmaData)==null?void 0:h.ctas.map(function(a){return a.nativeUrl}).filter(Boolean).join("\n"))||"";break;case d("MAWMsgType").MSG_TYPE.REVOKED:g.type="placeholder";g.isUnsent=!0;g.text="User unsent a message";break;case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:g.type="poll";g.text=await C(c);break;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:void f.WARN(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Bump message is not supported in DYI"])));return;default:void f.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Explicitly dropping "," message type"])),c.msgType);return}return g}async function C(a){var b=d("EncryptedBackupsDYISingleton").getSingleton().getLogger(),c=a.groupPollInfo;if(c==null){void b.WARN(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Group poll creation message is missing group poll info"])));return""}var e=new Map(),f=new Map();await Promise.all(c.options.map(async function(a){var b=await d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(a);e.set(b,{optionName:a,voterUserJids:[]})}));if(a.groupPollUpdateData!=null){var g=!1,h=!1,i;try{for(var j=babelHelpers.asyncIterator(a.groupPollUpdateData),k;g=!(k=await j.next()).done;g=!1){k=k.value;var l,m;if(((l=k.pollCreationMessageKey)==null?void 0:l.id)==null||((l=k.pollCreationMessageKey)==null?void 0:l.remoteJid)==null){b.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Poll creation message key is incomplete. Skipping"])));continue}l=k.pollCreationMessageKey;var n=l.id;l=l.remoteJid;l=d("WAJids").unsafeCoerceToUserJid(l);m={pollCreationMessageKey:c.encKey,pollCreationSenderJid:d("WAJids").toMsgrUserJid(((m=a.metadata)==null?void 0:m.senderId)||""),pollCreationStanzaId:d("WAStanzaUtils").toStanzaId(n),pollUpdateSenderJid:l,pollUpdateStanzaId:k.externalId};if(k.addOption!=null){n=await d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollAddOption(k.addOption,m);if(n.success){var o=n.value,p=!1,q=!1,r;try{for(var s=babelHelpers.asyncIterator(o.pollOption),o;p=!(o=await s.next()).done;p=!1){o=o.value;if(o.optionName==null)continue;o=o.optionName;var y=await d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(o);e.has(y)||e.set(y,{optionName:o,voterUserJids:[]})}}catch(a){q=!0,r=a}finally{try{p&&s.return!=null&&await s.return()}finally{if(q)throw r}}}else b.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Decryption failure when trying to decrypt poll add option update: ",""])),n.error)}if(k.vote!=null){y=await d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollVote(k.vote,m);if(y.success){o=y.value;if(o.senderTimestampMs==null){b.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[Polls] senderTimestampMs is null. Cannot determine the latest poll vote"])));continue}p=o.selectedOptions;q=o.senderTimestampMs;n=f.get(l);(n==null||n.senderTimestampMs<d("WALongInt").numberOrThrowIfTooLarge(q))&&f.set(l,{senderTimestampMs:d("WALongInt").numberOrThrowIfTooLarge(q),votes:p.map(d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash)})}else b.ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[Polls] Decryption failure when trying to decrypt poll vote update: ",""])),y.error)}}}catch(a){h=!0,i=a}finally{try{g&&j.return!=null&&await j.return()}finally{if(h)throw i}}}for(k of f){m=k[0];o=k[1];for(n of o.votes){l=e.get(n);l==null?e.set(n,{optionName:"Unknown",voterUserJids:[m]}):e.set(n,babelHelpers.extends({},l,{voterUserJids:[].concat(l.voterUserJids,[m])}))}}return"Question: "+c.name+"; Options: "+Array.from(e).map(function(a){a[0];a=a[1];var b=a.optionName;a=a.voterUserJids;return b+" ("+a.length+" votes"+(a.length>0?": "+a.map(function(a){return d("EncryptedBackupsDYIMessageProcessingUtils").getSenderName(d("WAJids").userIdFromJid(d("WAJids").unsafeCoerceToUserJid(a)))}).join(", "):"")+")"}).join("; ")}function D(a,b,c,e,f){var g;a=d("EncryptedBackupsDYISingleton").getSingleton();var h=a.getLogger();if(c.mediaMetadata==null){void h.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media data"])));return f}var i=c.mediaMetadata,j=i.mediaEntryData;i=i.plaintextHash;g=(g=(g=c.metadata)==null?void 0:g.senderId)!=null?g:"0";c=d("WAStanzaUtils").toStanzaId(c.externalId);i=d("WAHashUtils").stringToPlaintextHash(i);f.media.add(i);if(!a.isAttachmentDownloadInProgressForPlaintextHash(i)&&!a.isAttachmentDownloadCompleteForPlaintextHash(i)){void h.LOG(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Starting DYI media download for attachemnt with hash ",""])),d("WAHashUtils").sanitisePlaintextHash(i));a.addPlaintextHashToAttachmentDownloadsInProgress(i);if(j==null){h.ERROR(A||(A=babelHelpers.taggedTemplateLiteralLoose(["[Protobuf] Media message is missing media entry data"])));a.deletePlaintextHashFromAttachmentDownloadsInProgress(i);return f}h={author:d("WAJids").toMsgrUserJid(g),chat:d("WAJids").toMsgrUserJid(b),externalId:c};void d("EncryptedBackupsDYIMessageProcessingUtils").downloadMediaWithMediaManager(i,h,e,j)}return f}g.processEBProtobufMessagesForDYI=a}),98);
__d("MAWEncryptedBackupsDYIHandleMessageRestore",["EncryptedBackupsDYIHandleMessageRestore","EncryptedBackupsDYISingleton","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","MAWEBRestoreTrackingUtils","MAWEncryptedBackupsDYIProcessProtobufMessages","MAWJobDefinitions","MAWThreadKeyUtils","MpsOverBridge","MpsTypes","WAJids","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a=(i||d("LSIntEnum")).ofNumber(c("LSMEBTaskCreationSource").MSGR_DYI);var l=c("justknobx")._("467"),m=async function(a,b,e){d("MAWEBRestoreTrackingUtils").markEBRestoreDYI(c("LSMEBTaskCreationSource").MSGR_DYI);a=d("WAJids").createJidUtils({platform:"msgr"}).toUserJid(e);b=d("MpsTypes").toTimestamp(Number(b));b=await d("MpsOverBridge").mps().loadMessages({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"remote-only"},debug:{purpose:"dyi"},direction:"desc",from:[b,null],numMessages:l,threadId:d("MpsTypes").toThreadId(a)});if(!b.success){d("EncryptedBackupsDYISingleton").getSingleton().getLogger().ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Message batch query failed for thread ",": ",""])),e,b.error);d("EncryptedBackupsDYISingleton").getSingleton().deleteThreadKeyFromThreadsRestoreInProgress(d("MAWThreadKeyUtils").toStringThreadKey(e));return}a=b.value;b=a.cursorInfo;a=a.messages;var f=(b==null?void 0:b.endCursor)!=null?(j||(j=d("I64"))).of_float(b.endCursor[0]):void 0;await n(e,a.map(d("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage),b.hasNext,f)};async function n(a,b,c,e){var f=await (k||(k=d("LSDatabaseSingleton"))).LSDatabaseSingleton;await d("EncryptedBackupsDYIHandleMessageRestore").handleMessageRangeQueryRestore(f,a,b,c,e,d("MAWEncryptedBackupsDYIProcessProtobufMessages").processEBProtobufMessagesForDYI,m)}g.taskCreationSource=a;g.MESSENGER_DYI_BATCH_SIZE=l;g.issueNextRangeQuery=m;g.handleMAWProtobufMessageRangeQueryRestore=n}),98);
__d("MWSimpleWorkQueue",["FBLogger","Promise","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i={first:null,last:null};function a(a){return new(h||(h=b("Promise")))(function(d,e){var f=function(){var f=new(h||(h=b("Promise")))(function(a,b){window.setTimeout(function(){b(c("err")("Work item timed out after 30 seconds"))},3e4)});return h.race([a(),f]).then(d,e)};if(i.first===null||i.last==null)i.first=i.last={next:null,value:f},j();else{var g=i.last;g.next={next:null,value:f};i.last=g.next}})}function j(){if(i.first===null)return;var a=i.first;if(a==null)return;var b=function(){i.first=a.next;if(i.first==null){i.last=null;return}j()};a.value().then(function(){b()})["catch"](function(a){c("FBLogger")("messenger_web").catching(a).mustfix("Error in MWSimpleWorkQueue"),b()})}g.queueWork=a}),98);
__d("MAWRestoreProtobufsFromEncryptedBackupsDeferred",["ExecutionEnvironment","I64","MWSimpleWorkQueue","WAJobOrchestratorTypes","cr:10036","justknobx","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("requireDeferred")("MAWRestoreProtobufsFromEncryptedBackupsNOP").__setRef("MAWRestoreProtobufsFromEncryptedBackupsDeferred");function a(a,e,f,g,k,l,m,n,o,p,q,r,s,t,u){t===void 0&&(t=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);return j.load().then(async function(j){(i||(i=c("ExecutionEnvironment"))).isInWorker&&b("cr:10036")!=null&&await b("cr:10036").init();var v=function(b){return j.call(b,a,e,f,g,k!=null?(h||(h=d("I64"))).to_float(k):0,l,m!=null?(h||(h=d("I64"))).to_float(m):(h||(h=d("I64"))).to_float((h||(h=d("I64"))).max_int),n,o,p,q,r,s,t,u)};return c("justknobx")._("4404")?d("MWSimpleWorkQueue").queueWork(function(){return v(null)}):v(null)})}g.call=a}),98);
__d("LSProtobufRestoreHandler",["CurrentUser","LSIntEnum","LSMEBTaskCreationSource","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEBUnstoredDbMsgUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","WAErrorMessage","WATagsLogger","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r=["ERROR"],s,t=d("WATagsLogger").TAGS(["labyrinth_web","protobuf_restore"]);async function a(a,b,e,f,g,v,w,x,y,z,A,B,C){var D=t.TAGS([x!=null?x:"no_request_id"]);D.ERROR;D=babelHelpers.objectWithoutPropertiesLoose(D,r);var E=D;D=null;A!=null&&(D=u(A));E.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop"])));d("MAWEBRestoreTrackingUtils").markEBRestoreProtobuf(B);b.type==="convertedProtobufs"?A=b.convertedProtobufs:(b.type,A=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(b.decryptedMessagesProtobufs));d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(A,"protobuf_restore");if(x!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:x});b=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());b=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(A,a,void 0,b);if(e===!0&&b.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_decodedMessages_inconsistency",traceId:x});var F=A.length;E.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""])),F);t.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""])),F)}d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(x,{echoMessages:D,hasMoreAfter:g,hasMoreBefore:e,isPointQuery:w,messages:b,nextMessageTimestampMsBefore:f,protobufMessages:A,referenceTimestamp:y,requestId:x,restoreType:"protobuf",threadId:a})}catch(a){F=d("WAErrorMessage").maybeGetMessageFromError(a);E.WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""])),F);t.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to decode protobufs, with error: ",""])),F);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(x,a instanceof Error?a:c("err")(F))}e===!0&&A.length===0&&(x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_messages_inconsistency",traceId:x}),E.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no messages but hasMoreBefore is true"]))),t.ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - no messages but hasMoreBefore is true"]))));b=B!=null&&(s||(s=d("LSIntEnum"))).unwrapIntEnum(B)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(b){x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"search_restore_end",traceId:x});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(x);return Promise.resolve()}F=B!=null&&(s||(s=d("LSIntEnum"))).unwrapIntEnum(B)===c("LSMEBTaskCreationSource").MSGR_DYI;if(F){E.LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"])));await d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(a,A,e,f);x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"dyi_restore_end",traceId:x});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(x);return Promise.resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),A,e,f,g,v,w,x,y,z,D,B,void 0,C!=null?C:void 0),function(){x!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end",traceId:x})},function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);E.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to restore protobufs, with error: ",""])),a);t.ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["restoreProtobufs nativeop - Failed to restore protobufs, with error: ",""])),a);a={string:{error:a}};x!=null&&d("MAWEBRestoreTrackingUtils").markEBRestoreFail(x,!1,"native_op_reject",a)});return Promise.resolve()}function u(a){return c("LSVec").toArray(a).map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(a)})}g.handleProtobufRestoreHelper=a;g.convertLSEchoMessageVecToArray=u}),98);
__d("MAWThreadIdToChatJidMapping",["I64","MAWAsyncEBPendingQueryPromise","MAWJidUtils","ReQL","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=new Map();async function a(a,b,c){if(l.has(b))return l.get(b);var e=d("MAWAsyncEBPendingQueryPromise").getJidFromThreadId(b);if(e!=null){l.set(b,e);return e}e=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table.index("jid")).getKeyRange((k||(k=d("I64"))).of_string(b)));if(e==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find MI ACT mapping table entry for threadId ",", called from ",""])),b,c);return null}var f=e.serverThreadKey;e=e.jid;a=await d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.threads).getKeyRange(f));if(a==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot find thread with serverThreadKey ",", called from ",""])),(k||(k=d("I64"))).to_string(f),c);return null}f=d("MAWJidUtils").LSJidtoChatJid(e,a.threadType);if(f!=null){l.set(b,f);return f}else{d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot generate ChatJid from threadKey, called from ",""])),c);return null}}g.genChatJidFromThreadId=a}),98);
__d("LSRestoreProtobufs.nop",["LSProtobufRestoreHandler","MAWMpsGating","MAWThreadIdToChatJidMapping","MWEBODSEntityName.enum","MWEBODSUtils","WAJids"],(function(a,b,c,d,e,f,g){"use strict";a=async function(a,b,e,f,g,h,i,j,k,l,m,n,o,p,q){d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore_protobufs");if(d("MAWMpsGating").isFullMpsEnabled())return;b=null;q!=null?b=d("WAJids").validateChatJid(q):d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore_protobufs.no_chat_jid_provided");b==null&&(b=await d("MAWThreadIdToChatJidMapping").genChatJidFromThreadId(a,e,"LSRestoreProtobufs.nop"));b==null&&d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"restore_protobufs.no_chat_jid");return d("LSProtobufRestoreHandler").handleProtobufRestoreHelper(e,{decryptedMessagesProtobufs:f,type:"decryptedMessagesProtobufs"},g,h,i,j,k,l,m,n,o,p,b)};a.__nop_name__="LSRestoreProtobufs";g.default=a}),98);
__d("MAWBridgeUpdateClientRestoreStatus",["I64","LSEncryptedBackupsClientRestoreState","LSIntEnum","MAWUpdateClientRestoreStatusOperationType","ReQL","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.encrypted_backups_client_restore_status).filter(function(a){return a.threadId===b})).then(function(b){if(b!=null)return a.encrypted_backups_client_restore_status.delete(b.threadId).then(c("emptyFunction"));else return Promise.resolve()})}function k(a,b,e,f){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.encrypted_backups_client_restore_status).getKeyRange(b)).then(function(f){if(f!=null)return a.encrypted_backups_client_restore_status.put({lastUpdated:(h||(h=d("I64"))).of_float(Date.now()),restoreStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsClientRestoreState").RESTORE_COMPLETE),serverThreadKey:e,threadId:b});else return Promise.resolve()})}function a(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.encrypted_backups_client_restore_status)).then(function(b){return b.reduce(function(b,c){return b.then(function(){return j(a,c.threadId)})},Promise.resolve())})}async function b(a,b){var e=b.threadId,f=b.action;f===d("MAWUpdateClientRestoreStatusOperationType").upsertClientRestoreStatus?await a.encrypted_backups_client_restore_status.put({lastUpdated:(h||(h=d("I64"))).of_float(Date.now()),restoreStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsClientRestoreState").RESTORE_IN_PROGRESS),serverThreadKey:void 0,threadId:e}):await k(a,b.threadId,void 0,b.ebPrefetch);return Promise.resolve()}g.truncateClientRestoreStatusTable=a;g.call=b}),98);
__d("MWEncryptedBackUpEBNotEnabledError",[],(function(a,b,c,d,e,f){"use strict";a="EB not enabled";f.EB_NOT_ENABLED=a}),66);
__d("isEbEnabledWithIGDEligibilityCheck",["EBIsEbEnabled","Promise","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return!c("gkx")("23914")?(h||(h=b("Promise"))).resolve(!1):d("EBIsEbEnabled").isEbEnabledLS(a.tables)}g.isEbEnabledWithIGDEligibilityCheck=a}),98);/*FB_PKG_DELIM*/
__d("MAWMainTraceUtils",["EBGating","I64","LSRequestId"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){return c("LSRequestId").generate()}async function b(a,b,c,e,f,g,i){if(d("EBGating").isRemoveLSDataTrace())return;await a.data_trace_meta.add({contextOne:f,contextThree:i,contextTwo:g,foregroundTimestampMs:(h||(h=d("I64"))).zero,initTimestampMs:b,predefinedId:void 0,shouldFlush:!1,traceId:c,traceType:e})}g.createTraceId=a;g.startTraceWithTxn=b}),98);
__d("WorkerSchedulerPriority",[],(function(a,b,c,d,e,f){"use strict";a=2;b=1;c=0;f.BACKGROUND_PRIORITY=a;f.REGULAR_PRIORITY=b;f.BLOCKING_PRIORITY=c}),66);
__d("WorkerScheduler",["$InternalEnum","Promise","QPLFlow","QuickPerformanceLogger","WAGetSafeQPLError","WAResolvable","WAShiftTimer","WATagsLogger","WATimeUtils","WorkerSchedulerPriority","err","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=d("WATagsLogger").TAGS(["WorkerScheduler"]),w=0,x=100,y=3e4,z=10,A=6e4,B=b("$InternalEnum")({CREATED:0,SCHEDULED:1,RUNNING:2,COMPLETED:3,CANCELLED:-3,FAILED:-2,STUCK:-1}),C=function(){function a(a,b){var c;this.$3=!1;this.$4=new Map();this.$5=new Map();this.$6=new Map();this.$7=[new Set(),new Set(),new Set()];this.$8=[new((c=d("WAResolvable")).Resolvable)(),new c.Resolvable(),new c.Resolvable()];this.$9=new c.Resolvable();this.$1=a;this.config=b;this.$2=v.TAGS([a])}var e=a.prototype;e.waitUntilEndReached=function(){return this.$9.promise};e.waitUntilBlockingEnded=function(){return this.$8[d("WorkerSchedulerPriority").BLOCKING_PRIORITY].promise};e.waitUntilRegularEnded=function(){return this.$8[d("WorkerSchedulerPriority").REGULAR_PRIORITY].promise};e.waitUntilBackgroundEnded=function(){return this.$8[d("WorkerSchedulerPriority").BACKGROUND_PRIORITY].promise};e.getDebugState=function(){var a=this,b=Date.now();return{activeTasks:Array.from(this.$6.entries()).map(function(c){var d=c[0];c=c[1];d=a.$5.get(d);return!d||d.startTime==null?null:{executionTimeMs:b-d.startTime,priority:c,task:d.name,waitTimeMs:b-d.scheduledTime}}).filter(Boolean),pendingTasksByPriority:this.$7.map(function(c){var d=[];c.forEach(function(c){c=a.$5.get(c);if(!c)return;d.push({task:c.name,waitTimeMs:b-c.scheduledTime})});return d})}};e.$10=function(){if(this.$6.size<this.config.maxConcurrency){var a=this.pendingTasksTick({increaseCounter:!1,lowestTier:this.$3?d("WorkerSchedulerPriority").BACKGROUND_PRIORITY:d("WorkerSchedulerPriority").BLOCKING_PRIORITY,tasksToPick:1,tickDelta:0});a=a.candidates;var b=E.getHighestActivePriority();a.length>0&&this.maybeStartTask(a[0].id,b)}};e.runTask=function(a){return this.task(a).run()};e.task=function(a){var b,c=this.$1+":"+a.name+":"+w++;b=(b=a.priority)!=null?b:d("WorkerSchedulerPriority").REGULAR_PRIORITY;a=this.$11(c,{annotations:a.annotations,customFlags:a.customFlags,eventSamplingRate:a.eventSamplingRate,fn:a.fn,name:a.name,priority:b});this.$4.set(c,a);return a.publicApi};e.$12=function(a){var d=this.$4.get(a);if(d==null)return(u||(u=b("Promise"))).reject(c("err")("Cannot run task from Scheduler:"+this.$1+" Task was already cancelled"));d.publicApi.status=B.SCHEDULED;this.$5.set(a,d);this.$7[d.priority].add(a);this.$13(d.priority);d.metric.addPoint("schedule_start");E.scheduleTimerIfNeeded();this.$10();return d.resolvable.promise};e.$11=function(a,b){var c,e=this,f=new(d("WAResolvable").Resolvable)();c=d("QPLFlow").startQplFlowWithCoinflip(F,b.eventSamplingRate!=null?b.eventSamplingRate:this.config.defaultSamplingRate,{annotations:{bool:babelHelpers["extends"]({},(c=b.annotations)==null?void 0:c.bool,b.customFlags),"int":babelHelpers["extends"]({},(c=b.annotations)==null?void 0:c["int"],{originalPriority:b.priority}),string:babelHelpers["extends"]({},(c=b.annotations)==null?void 0:c.string,{name:b.name,scheduler:this.$1,workerID:self!=null&&"worker_id"in self?self.worker_id:void 0})}});var g={fn:b.fn,id:a,loggingParams:{},maxTickDelta:0,metric:c,name:b.name,priority:b.priority,publicApi:{cancel:function(){if(g.publicApi.status!==B.CREATED&&g.publicApi.status!==B.SCHEDULED)return!1;e.$14(a,B.CANCELLED);return e.$4["delete"](a)},id:a,name:b.name,promise:f.promise,promote:function(a){e.$2.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Promoting "," from "," to ",""])),g.id,g.priority,a);if((g.publicApi.status===B.CREATED||g.publicApi.status===B.SCHEDULED)&&g.priority>a){e.$15(g,a);return!0}return!1},run:function(){return e.$12(a)},status:B.CREATED},resolvable:f,scheduledTime:Date.now(),startTime:null,tickCounter:0,waitCounter:0};return g};e.$14=function(a,b){var c=this.$5.get(a),e=c==null?void 0:c.publicApi.status;if(c==null||e===B.COMPLETED||e===B.FAILED||e===B.STUCK)return;this.$5["delete"](a);this.$6["delete"](a);c.publicApi.status=b;var f=[this.$7[d("WorkerSchedulerPriority").BLOCKING_PRIORITY].size===0,this.$7[d("WorkerSchedulerPriority").REGULAR_PRIORITY].size===0,this.$7[d("WorkerSchedulerPriority").BACKGROUND_PRIORITY].size===0];this.$6.forEach(function(a){f[a]=!1});f[d("WorkerSchedulerPriority").BLOCKING_PRIORITY]&&f[d("WorkerSchedulerPriority").REGULAR_PRIORITY]&&f[d("WorkerSchedulerPriority").BACKGROUND_PRIORITY]&&this.$9.resolve();for(e=d("WorkerSchedulerPriority").BLOCKING_PRIORITY;e<=d("WorkerSchedulerPriority").BACKGROUND_PRIORITY;e++)f[e]&&this.$8[e].resolve()};e.maybeStartTask=function(a,b){var c=this.$5.get(a);if(c==null){this.$2.ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Safeguard: Task without corresponding record: Task: ",", Scheduler: ",""])),a,this.$1);return}if(b==null||this.$3===!0)return this.$16(c);if(b<c.priority)return;return this.$16(c)};e.$16=function(a){var c=this;this.$7[a.priority]["delete"](a.id);this.$6.set(a.id,a.priority);this.$2.TAGS([a.name]).LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Started: ",""])),a.id);a.startTime=Date.now();a.publicApi.status=B.RUNNING;a.metric.addPoint("schedule_end",{"int":{priorityTier:a.priority,waitTicks:a.waitCounter}});a.metric.addPoint("run_start",{"int":{startPriority:a.priority}});var e;try{e=a.fn({metric:a.metric})}catch(a){e=(u||(u=b("Promise"))).reject(a)}e.then(function(b){a.resolvable.resolve(b),c.$2.TAGS([a.name]).LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Completed: ",""])),a.id),a.metric.addPoint("run_end",{"int":{executionTicks:a.tickCounter}}),c.$14(a.id,B.COMPLETED),a.metric.endSuccess({"int":{maxTickDeltaMs:a.maxTickDelta}}),c.$10()})["catch"](function(b){a.resolvable.reject(b),c.$2.TAGS([a.name]).WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed: ",""])),a.id),a.metric.addPoint("run_fail"),c.$2.TAGS([a.name]).ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Debug params: "," failed: ",""])),a.loggingParams,b),c.$14(a.id,B.FAILED),a.metric.endFail("runtime",{"int":{maxTickDeltaMs:a.maxTickDelta},string:{jsError:d("WAGetSafeQPLError").getSafeQPLErrorMessage(b)}}),c.$10()})};e.$13=function(a){for(var b=d("WorkerSchedulerPriority").BLOCKING_PRIORITY;b<=a;b++)this.$8[b].resolveWasCalled()&&(this.$8[b]=new(d("WAResolvable").Resolvable)());this.$9.resolveWasCalled()&&(this.$9=new(d("WAResolvable").Resolvable)())};e.getHighestActivePriority=function(){var a=this,b=null;this.$6.forEach(function(c,d){c=a.$5.get(d);if(c==null){v.ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Safeguard: Active task without corresponding record: Task: ",", Scheduler: ",""])),d,a.$1);a.$6["delete"](d);return}(b==null||b>c.priority)&&(b=c.priority)});return b};e.activeTasksTick=function(a){var b=this,d=null;this.$6.forEach(function(e,f){e=b.$5.get(f);if(e==null){v.ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Safeguard: Active task without corresponding record: Task: ",", Scheduler: ",""])),f,b.$1);b.$6["delete"](f);return}e.tickCounter++;e.maxTickDelta=Math.max(a,e.maxTickDelta);(d==null||d>e.priority)&&(d=e.priority);e.tickCounter>b.config.ticksToStuck&&e.publicApi.status===B.RUNNING&&(v.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Possibly stuck: ",""])),e.name),b.$14(e.id,B.STUCK),e.resolvable.reject(c("err")("Stuck")),e.metric.endFail("stuck",{"int":{maxTickDeltaMs:e.maxTickDelta}}))});return d};e.$15=function(a,b){function c(){switch(e){case d("WorkerSchedulerPriority").BACKGROUND_PRIORITY:return d("WorkerSchedulerPriority").REGULAR_PRIORITY;case d("WorkerSchedulerPriority").REGULAR_PRIORITY:return d("WorkerSchedulerPriority").BLOCKING_PRIORITY;default:return d("WorkerSchedulerPriority").BLOCKING_PRIORITY}}var e=a.priority;b=b!=null?b:c();if(b===e)return;a.metric.addPoint("promote_to_"+b);this.$7[e]["delete"](a.id);a.priority=b;this.$7[b].add(a.id)};e.pendingTasksTick=function(a){var b=this,c=a.increaseCounter,e=a.lowestTier,f=a.tasksToPick,g=a.tickDelta,h=[],i=!0;a=function(a){i&&(i=b.$7[a].size===0),b.$7[a].forEach(function(e){var i=b.$5.get(e);if(i==null){v.ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Safeguard: Pending task without corresponding record: Task: ",", Scheduler: ",""])),e,b.$1);b.$7[a]["delete"](e);return}c&&(i.waitCounter++,i.maxTickDelta=Math.max(g,i.maxTickDelta),i.priority>d("WorkerSchedulerPriority").REGULAR_PRIORITY&&i.waitCounter>=b.config.throttleTicks&&b.$15(i),i.priority===d("WorkerSchedulerPriority").REGULAR_PRIORITY&&i.waitCounter>=E.maxWaitTicksMultiplierForFinalPromotion*b.config.throttleTicks&&(v.LOG(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Promoting task ",":"," to blocking priority"])),b.$1,i.name),b.$15(i)));if(h.length>=f)return;if(b.$6.size+h.length>=b.config.maxConcurrency)return;h.push(i)})};for(var j=d("WorkerSchedulerPriority").BLOCKING_PRIORITY;j<=e;j++)a(j);return{candidates:h.map(function(a){return{id:a.id,priority:a.priority}}),isEmpty:i}};e.TEST_ONLY_ignore_delays=function(){this.$3=!0};return a}(),D=function(){function a(){var a=this;this.$1=new Map();this.tickFrequencyMs=x;this.maxThrottleMs=A;this.maxWaitTicksMultiplierForFinalPromotion=z;this.$2=null;this.$3=new(d("WAShiftTimer").ShiftTimer)(function(){var b=!1;try{var c,e=d("WATimeUtils").performanceAbsoluteNow();b=a.$4(e-((c=a.$2)!=null?c:e))}catch(a){v.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Scheduler fatal: ",""])),a)}finally{b===!1?(a.$2=d("WATimeUtils").performanceAbsoluteNow(),a.$3.onOrBefore(a.tickFrequencyMs)):a.$2=null}});this.$5=new Map()}var b=a.prototype;b.getHighestActivePriority=function(){var a=null;this.$5.forEach(function(b){b=b.getHighestActivePriority();a!=null&&b!=null&&a<b&&(a=b);a==null&&b!=null&&(a=b)});return a};b.$4=function(a){var b,c=!0,e=null;this.$5.forEach(function(b){b=b.activeTasksTick(a);e!=null&&b!=null&&e<b&&(e=b);e==null&&b!=null&&(e=b)});var f=[[],[],[]];this.$5.forEach(function(b){var e=b.pendingTasksTick({increaseCounter:!0,lowestTier:d("WorkerSchedulerPriority").BACKGROUND_PRIORITY,tasksToPick:b.config.concurrency,tickDelta:a}),g=e.candidates;e=e.isEmpty;c&&(c=e);g.forEach(function(a){f[a.priority].push({id:a.id,scheduler:b})})});b=(b=f.find(function(a){return a.length>0}))!=null?b:[];for(b of b){var g=b.id,h=b.scheduler;h.maybeStartTask(g,e)}return c};b.scheduleTimerIfNeeded=function(){this.$3.onOrBefore(this.tickFrequencyMs)};b.newScheduler=function(a,b){var c=this.$5.get(a);if(c)return c;c=new C(a,b);this.$5.set(a,c);return c};b.TEST_ONLY_reset=function(){this.$5=new Map(),this.$1=new Map()};return a}(),E=new D(),F=c("qpl")._(1056838280,"1566");function a(a,b){return E.newScheduler(a,{concurrency:(a=b.concurrency)!=null?a:1,defaultSamplingRate:(a=b.defaultSamplingRate)!=null?a:1e4,maxConcurrency:b.maxConcurrency,throttleTicks:Math.round(((a=b.maxThrottleMs)!=null?a:E.maxThrottleMs)/E.tickFrequencyMs),ticksToStuck:Math.round(((a=b.timeToStuckMs)!=null?a:y)/E.tickFrequencyMs)})}function e(a){a.tickFrequencyMs!=null&&(E.tickFrequencyMs=a.tickFrequencyMs),a.maxThrottleMs!=null&&(E.maxThrottleMs=a.maxThrottleMs),a.maxWaitTicksMultiplierForFinalPromotion!=null&&(E.maxWaitTicksMultiplierForFinalPromotion=a.maxWaitTicksMultiplierForFinalPromotion),a.qplEventType!=null&&(F=a.qplEventType),(t||(t=c("QuickPerformanceLogger"))).setAlwaysOnSampleRate(F,1)}function f(){E.TEST_ONLY_reset()}g.BACKGROUND_PRIORITY=d("WorkerSchedulerPriority").BACKGROUND_PRIORITY;g.BLOCKING_PRIORITY=d("WorkerSchedulerPriority").BLOCKING_PRIORITY;g.REGULAR_PRIORITY=d("WorkerSchedulerPriority").REGULAR_PRIORITY;g.SchedulerExecutionState=B;g.makeScheduler=a;g.configWorkerScheduler=e;g.TEST_ONLY_reset=f}),98);