;/*FB_PKG_DELIM*/

__d("EBBatchRequestResignCdnUrlQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9604466472985365"}),null);
__d("EBBatchRequestResignCdnUrlQuery.graphql",["EBBatchRequestResignCdnUrlQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"request"}],c=[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"MessengerDefaultEncryptedBackup",kind:"LinkedField",name:"messenger_default_encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:[{kind:"Variable",name:"payloads",variableName:"request"}],concreteType:"XFBResignCdnUrlResponse",kind:"LinkedField",name:"batch_resigned_attachment_cdn_url",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"instance_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"path",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_message",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"EBBatchRequestResignCdnUrlQuery",selections:c,type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"EBBatchRequestResignCdnUrlQuery",selections:c},params:{id:b("EBBatchRequestResignCdnUrlQuery_facebookRelayOperation"),metadata:{},name:"EBBatchRequestResignCdnUrlQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBBatchRequestResignCdnUrl",["EBBatchRequestResignCdnUrlQuery.graphql","EBEnqueueResignCdnUrlRequests","FBLogger","WADirectPath","WAErrorMessage","WAMediaUtils","WAResultOrError","createWorkerQuery"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r=function(){return c("FBLogger")("wmi").tags(["labyrinth_web","resign_cdn_url"])};async function a(a){var b=d("EBEnqueueResignCdnUrlRequests").getGqlRestoredCdnUrlMap();b=b.entries().filter(function(a){a[0];a=a[1];return!a.pending}).toArray();if(b.length<1)return;var c=b.map(function(a){return{instance_key:a[0],payload:a[1].payload}});b.forEach(function(a){var b=a[0];a=a[1];d("EBEnqueueResignCdnUrlRequests").setGqlRestoredCdnUrlMap(b,{payload:a.payload,pending:!0,resolvable:a.resolvable})});await s(a,c)}async function s(a,b){if(b.length<1)return;var e=d("EBEnqueueResignCdnUrlRequests").getGqlRestoredCdnUrlMap();a==null||a.addPoint("resign_cdn_url_query_start");try{var f,g,h=await c("createWorkerQuery")(t,{request:b.map(function(a){return{instance_key:a.instance_key,payload:a.payload.payload}})});a==null||a.addPoint("resign_cdn_url_query_end");h=h==null||(f=h.viewer)==null||(f=f.messenger_default_encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.batch_resigned_attachment_cdn_url;r().DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Received "," requests"])),h==null?void 0:h.length);a==null||a.addAnnotations({int:{resign_cdn_url_gql_batch_size:(g=h==null?void 0:h.length)!=null?g:0}});h==null||h.forEach(function(a){var b=a.instance_key!=null?d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key):null,c=a.path;if(b!=null){var f=d("WADirectPath").validateDirectPath(c);f.success||r().WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",", graphql error: ",""])),f.error,a.exception_message);a=(a=e.get(b))==null?void 0:a.resolvable;a!=null?a.resolve(f):r().MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["No resolvable found for instance key: ",""])),b);e.delete(b)}else r().MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url came back with no instance key, ",""])),c)})}catch(c){g=d("WAErrorMessage").maybeGetMessageFromError(c);a==null||a.addPoint("resign_cdn_url_query_fail");a==null||a.addAnnotations({string:{resign_cdn_url_gql_error:g}});r().WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",""])),g);b.forEach(function(a){var b;b=(b=e.get(d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key)))==null?void 0:b.resolvable;b!=null?b.resolve(d("WAResultOrError").makeError("resign-cdn-url-gql-error")):r().MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["No resolvable found during error for instance key: ",""])),a.instance_key)})}finally{b.forEach(function(a){var b=d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key);b=(b=e.get(b))==null?void 0:b.resolvable;(b==null?void 0:b.isSettled)===!1&&r().MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Resolvable was not properly settled"])));e.delete(d("WAMediaUtils").stringToDeliveryObjectId(a.instance_key))})}}async function e(a,b,e){a==null||a.addPoint("resign_cdn_url_query_start");try{var f;b=await c("createWorkerQuery")(t,{request:[{instance_key:b,payload:e.payload}]});a==null||a.addPoint("resign_cdn_url_query_end");e=b==null||(f=b.viewer)==null||(f=f.messenger_default_encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.batch_resigned_attachment_cdn_url;(e==null?void 0:e.length)!==1&&(a==null||a.addPoint("resign_cdn_url_should_have_one_response"));b=e==null?void 0:e[0];e=b==null?void 0:b.path;e=d("WADirectPath").validateDirectPath(e);e.success||r().WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",", graphql error: ",""])),e.error,b==null?void 0:b.exception_message);return e}catch(c){b=d("WAErrorMessage").maybeGetMessageFromError(c);a==null||a.addPoint("resign_cdn_url_query_fail");a==null||a.addAnnotations({string:{resign_cdn_url_gql_error:b}});r().WARN(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",""])),b);return d("WAResultOrError").makeError("resign-cdn-url-gql-error")}}var t=h!==void 0?h:h=b("EBBatchRequestResignCdnUrlQuery.graphql");g.batchedResignCdnUrlFromMap=a;g.batchedResignCdnUrlWithGraphQL=s;g.resignCdnUrlWithGraphQL=e}),98);
__d("EBEnqueueResignCdnUrlRequests",["EBBatchRequestResignCdnUrl","WACustomError","WAPromiseDelays","WAPromiseTimeout","WAResolvable","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){var a=!0;return{get:function(){return a},set:function(b){a=b}}}(),i=function(){var a=window.performance.now();return{get:function(){return a},set:function(b){a=b}}}(),j=new Map(),k=c("justknobx")._("4662"),l=c("justknobx")._("3244");function a(a,b,c){var e;e=(e=j.get(a))==null?void 0:e.resolvable;if(e!=null){c==null||c.addPoint("resign_cdn_url_map_hit");return m({mediaDownloadFlow:c,objectId:a,payload:b,promise:e.promise})}e=new(d("WAResolvable").Resolvable)();var f=j.size===0;j.set(a,{payload:b,pending:!1,resolvable:e});if(!h.get())return m({mediaDownloadFlow:c,objectId:a,payload:b,promise:e.promise});void n(f);return m({mediaDownloadFlow:c,objectId:a,payload:b,promise:e.promise})}function m(a){var b=a.mediaDownloadFlow,c=a.objectId,e=a.payload;a=a.promise;return d("WAPromiseTimeout").promiseTimeout(a,l).then(function(a){if(!a.success&&a.error==="direct-path-undefined"){j["delete"](c);return d("WAPromiseDelays").delayMs(l).then(function(){return d("EBBatchRequestResignCdnUrl").resignCdnUrlWithGraphQL(b,c,e)})}return a})["catch"](function(a){var f=a instanceof Error&&["NetworkTransportError","NetworkTimeoutError","NetworkRequestError"].includes(a.name);if(a instanceof d("WACustomError").TimeoutError||f){b==null||b.addPoint("resign-cdn-url-gql-timeout");j["delete"](c);return d("EBBatchRequestResignCdnUrl").resignCdnUrlWithGraphQL(b,c,e)}else{b==null||b.addPoint("resign-cdn-url-gql-unexpected-error");b==null||b.addAnnotations({string:{resign_cdn_url_payload_fail_reason:a.message}});throw a}})}function n(a,b){h.set(!1);if(a){h.set(!0);i.set(window.performance.now());return d("EBBatchRequestResignCdnUrl").batchedResignCdnUrlFromMap(b)}else{a=Math.max(k-(window.performance.now()-i.get()),0);return d("WAPromiseDelays").delayMs(a).then(function(){h.set(!0);i.set(window.performance.now());return d("EBBatchRequestResignCdnUrl").batchedResignCdnUrlFromMap(b)})}}function b(){return j}function e(a,b){j.set(a,b)}g.enqueueResignCdnUrl=a;g.getGqlRestoredCdnUrlMap=b;g.setGqlRestoredCdnUrlMap=e}),98);
__d("EBBucketUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a,b,c){b===void 0&&(b=100);c===void 0&&(c=5);if(a===0)return"zero";if(a<0)return"negative";if(c<=0)return"invalidIncrement";if(a>b)return"greaterThanLimit";a=Math.floor((a-1)/c)*c+1;c=Math.min(a+c-1,b);return a+"-"+c}f.getBucketName=a}),66);
__d("EBCreateResignCDNUrlPayload",["CreateDerivedKeys","EBBase64Encode","EBWorkerEBDBApi","GetBlobFromInt64BE","Hmac_v2","I64","LSVec","OcmfClientMap","OpeEncrypt","TruncateSortKey","WAArrayBufferUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i="thread_ope_key",j="__DEVICE_ID_PLACEHOLDER__";async function a(a){var b=a.accessTokenSecret,c=a.deliveryObjectId,d=a.mediaType,e=a.messageId,f=a.primaryKeySecret,g=a.productType,h=a.sort;h=h===void 0?!1:h;var i=a.sortOrderMs;a=a.threadId;b=await k({accessTokenSecret:b,deliveryObjectId:c,mediaType:d,messageId:e,primaryKeySecret:f,productType:g,sortOrderMs:i,threadId:a});if(b==null)return null;c=b.device_id;d=babelHelpers.extends({},b,{device_id:j});e=h?JSON.stringify(d,Object.keys(d).sort()):JSON.stringify(d);return e.replace('"'+j+'"',String(c))}async function k(a){var b=a.accessTokenSecret,e=a.deliveryObjectId,f=a.mediaType,g=a.messageId,h=a.primaryKeySecret,i=a.productType,j=a.sortOrderMs;a=a.threadId;var k=await d("EBWorkerEBDBApi").getSecureEBClientState(),n=String(k.backupId),o=k.deviceId;if(o==null)return null;var p=c("EBBase64Encode")(k.mailboxRootKeyBlob),q=c("EBBase64Encode")(k.ocmfClientStateBlob);k=await Promise.all([l("attachment_key_scope",JSON.stringify([n,e]),k.ocmfClientStateBlob),l("mailbox_id_scope",n,k.ocmfClientStateBlob),l("message_id_scope",g,k.ocmfClientStateBlob),l("attachment_token_salt_scope",g,k.ocmfClientStateBlob),l("attachment_key_salt_scope",JSON.stringify([n,e]),k.ocmfClientStateBlob),l("attachment_token_salt_scope",JSON.stringify([g,e]),k.ocmfClientStateBlob),l("thread_id_scope",a,k.ocmfClientStateBlob),m(k.mailboxRootKeyBlob,j,a)]);var r=k[0],s=k[1],t=k[2],u=k[3],v=k[4],w=k[5],x=k[6];k=k[7];return k==null?null:{access_token_secret:b,attachment_index_key:c("EBBase64Encode")(r),backup_ent_fbid:-8,backup_id:n,delivery_object_id:e,device_id:o,isOpenEB:0,mailbox_partial_id:c("EBBase64Encode")(s),media_type:f,message_partial_id:c("EBBase64Encode")(t),primary_key_secret:h,product_type:i,raw_identifiers:{otid:g,server_thread_key:null,timestamp:j.toString()},raw_tokens:{mailbox_root_key:p,ocmf_client_state_blob:q},salt_partial_access_token:c("EBBase64Encode")(w),salt_partial_attachment_index_key:c("EBBase64Encode")(v),salt_partial_id:c("EBBase64Encode")(u),sort_key:k,thread_id:a,thread_partial_id:c("EBBase64Encode")(x)}}function l(a,b,e){return c("Hmac_v2")(d("WAArrayBufferUtils").stringToArrayBuffer(a),d("WAArrayBufferUtils").stringToArrayBuffer(b)).then(function(a){return c("OcmfClientMap")(e,a[0])})}async function m(a,b,e){e=new TextEncoder().encode(i+"_"+e).buffer;e=(await d("CreateDerivedKeys").CreateDerivedKeys(e,void 0,a,[(h||(h=d("I64"))).of_int32(32)]))[0];if(e==null)return null;a=await d("GetBlobFromInt64BE").GetBlobFromInt64BE(h.of_float(b));b=await d("TruncateSortKey").TruncateSortKey(a[0]);a=await d("OpeEncrypt").OpeEncrypt(c("LSVec").toArray(e)[0],b[0],h.of_int32(16));e=Array.from(new Uint8Array(a[0]));b=e.map(function(a){return a.toString(16).padStart(2,"0")});return b.join("").toUpperCase()}g.createStringifiedMediaRestorePayloadFromEBDB=a}),98);
__d("EBMinosWasmDeriveAttachmentTokenPrimaryKey",["EBMinosWasmDeriveAttachmentAccessTokenSecret","EBMinosWasmDeriveAttachmentPrimaryKeySecret","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){var b=await d("EBMinosWasmDeriveAttachmentPrimaryKeySecret").deriveAttachmentPrimaryKeySecret({mediaKey:a});if(!b.success)return d("WAResultOrError").makeError("derive-primary-key-secret-error");a=await d("EBMinosWasmDeriveAttachmentAccessTokenSecret").deriveAttachmentAccessTokenSecret({mediaKey:a});return!a.success?d("WAResultOrError").makeError("derive-access-token-secret-error"):d("WAResultOrError").makeResult({accessToken:a.value,primaryKey:b.value})}g.deriveAttachmentTokenPrimaryKeySecret=a}),98);
__d("LSCreateResignCDNUrlPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSBinaryToHex.nop","LSCreateDerivedKeys.nop","LSFindBackup","LSGetBlobFromInt64BE.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSOpeEncrypt.nop","LSTruncateSortKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return a[10]?c.sequence([function(e){return c.blobs.neq(a[11],void 0)?c.sequence([function(e){return c.i64.neq(a[8],void 0)?c.sequence([function(e){return a[9]!==void 0?c.sequence([function(e){return c.blobs.neq(a[12],void 0)?c.sequence([function(e){return d[10]=c.createArray(),d[19]=(d[10].push(a[9]),d[10]),d[19]=(d[10].push(a[1]),d[10]),d[11]=c.toJSON(d[10]),d[12]=c.createArray(),d[19]=(d[12].push(c.i64.cast([0,32])),d[12]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[13]=a[0],a})},function(e){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[13],void 0,a[12],d[12]).then(function(a){return a=a,d[14]=a[0],a})},function(a){return d[14]?d[15]=!1:d[15]=!0,d[15]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[20]="Got null keys while deriving message list OPE key. Returning null blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoUtils] ","",d[20]].join("")),d[19]=c.createArray(),void 0!==void 0?d[21]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils",d[20],d[19],c.i64.cast([0,3]))},function(a){return d[16]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[14],c.i64.cast([0,0])).then(function(a){return a=a,d[19]=a[0],d[20]=a[1],a})},function(a){return d[16]=d[19]}])},function(e){return c.blobs.neq(d[16],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[19]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[16],d[20],c.i64.cast([0,16])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[21]).then(function(a){return a=a,d[22]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[11]).then(function(a){return a=a,d[23]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[23]).then(function(a){return a=a,d[24]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[24]).then(function(a){return a=a,d[25]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[25]).then(function(a){return a=a,d[26]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[9]).then(function(a){return a=a,d[27]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[27]).then(function(a){return a=a,d[28]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[28]).then(function(a){return a=a,d[29]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[29]).then(function(a){return a=a,d[30]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[31]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[31]).then(function(a){return a=a,d[32]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[32]).then(function(a){return a=a,d[33]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[33]).then(function(a){return a=a,d[34]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[35]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[35]).then(function(a){return a=a,d[36]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[36]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[37]).then(function(a){return a=a,d[38]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[40]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(e){return d[43]=new c.Map(),d[43].set("attachment_index_key",d[26]==null?"":d[26]),d[43].set("backup_ent_fbid",a[0]),d[43].set("delivery_object_id",a[1]),d[43].set("device_id",a[8]),d[43].set("mailbox_partial_id",d[30]==null?"":d[30]),d[43].set("media_type",a[3]),d[43].set("message_partial_id",d[34]==null?"":d[34]),d[43].set("product_type",a[2]),d[43].set("salt_partial_id",d[38]==null?"":d[38]),d[43].set("sort_key",d[22]==null?"":d[22]),d[43].set("thread_partial_id",d[42]==null?"":d[42]),d[43].set("isOpenEB",a[10]===!0),d[44]=new c.Map(),d[44].set("otid",a[4]),d[44].set("server_thread_key",a[7]),d[44].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),a[11]).then(function(a){return a=a,d[45]=a[0],a})},function(e){return c.nativeOperation(b("LSBase64Encode.nop"),a[12]).then(function(a){return a=a,d[46]=a[0],a})},function(e){return d[47]=new c.Map(),d[47].set("ocmf_client_state_blob",d[45]==null?"":d[45]),d[47].set("mailbox_root_key",d[46]==null?"":d[46]),d[48]=c.createArray(),d[60]=(d[48].push(a[4]),d[48]),d[60]=(d[48].push(a[1]),d[48]),d[49]=c.toJSON(d[48]),d[43].set("raw_identifiers",d[44]),d[43].set("backup_id",a[9]),d[43].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[43].set("salt_partial_access_token",d[53]==null?"":d[53]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[11]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(e){return c.nativeOperation(b("LSOcmfClientMap.nop"),a[11],d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(b){return d[43].set("salt_partial_attachment_index_key",d[57]==null?"":d[57]),d[43].set("raw_tokens",d[47]),a[13]!==void 0?d[43].set("access_token_secret",a[13]):0,a[14]!==void 0?d[43].set("primary_key_secret",a[14]):0,d[58]=c.toJSON(d[43]),d[59]=new c.Map(),d[59].set("payload",d[58]),b=[d[59],void 0],d[17]=b[0],d[18]=b[1]}]):c.resolve((d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,25])),d[19].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[19].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),e=[void 0,d[19]],d[17]=e[0],d[18]=e[1]))},function(a){return a=[d[17],d[18]],d[8]=a[0],d[9]=a[1],a}]):c.resolve((d[10]=new c.Map(),d[10].set("error_code",c.i64.cast([0,20])),d[10].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[10].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),e=[void 0,d[10]],d[8]=e[0],d[9]=e[1]))},function(a){return a=[d[8],d[9]],d[6]=a[0],d[7]=a[1],a}]):c.resolve((d[8]=new c.Map(),d[8].set("error_code",c.i64.cast([0,1])),d[8].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[8].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),e=[void 0,d[8]],d[6]=e[0],d[7]=e[1]))},function(a){return a=[d[6],d[7]],d[4]=a[0],d[5]=a[1],a}]):c.resolve((d[6]=new c.Map(),d[6].set("error_code",c.i64.cast([0,24])),d[6].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[6].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),e=[void 0,d[6]],d[4]=e[0],d[5]=e[1]))},function(a){return a=[d[4],d[5]],d[2]=a[0],d[3]=a[1],a}]):c.resolve((d[4]=new c.Map(),d[4].set("error_code",c.i64.cast([0,22])),d[4].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[4].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),e=[void 0,d[4]],d[2]=e[0],d[3]=e[1]))},function(a){return a=[d[2],d[3]],d[0]=a[0],d[1]=a[1],a}]):c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0,void 0],d[2]=f[0],d[3]=f[1],d[4]=f[2],d[5]=f[3],d[6]=f[4],d[7]=f[5],d[8]=f[6],d[9]=f[7],d[10]=f[8],d[11]=f[9],d[12]=f[10],d[13]=f[11],d[14]=f[12],d[15]=f[13],d[16]=f[14],d[17]=f[15],d[18]=f[16],d[19]=f[17],f):(e=a.item,c.sequence([function(a){return d[29]=e.backupTenancy,d[28]=e.encryptionVersion,d[24]=void 0,c.i64.neq(d[24],void 0)?c.resolve(d[25]=d[24]):c.sequence([function(a){return d[30]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[40]=(d[30].push(c.i64.cast([0,0])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[40]=(d[30].push(c.i64.cast([0,2])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[33]=a[0],a})},function(a){return d[33]?d[40]=(d[30].push(c.i64.cast([0,3])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[40]=(d[30].push(c.i64.cast([0,4])),d[30]):0,d[35]=c.createArray(),d[36]=c.i64.of_int32(d[30].length),c.i64.gt(d[36],c.i64.cast([0,0]))?c.loopAsync(d[36],function(a){return d[40]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[30],d[40]).then(function(a){return a=a,d[41]=a[0],d[42]=a[1],a})},function(a){return d[43]=(d[35].push(d[41]),d[35])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[40]=c.createArray(),d[41]=c.i64.of_int32(d[35].length),c.i64.gt(d[41],c.i64.cast([0,0]))?c.loopAsync(d[41],function(a){return d[43]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[35],d[43]).then(function(a){return a=a,d[44]=a[0],d[45]=a[1],a})},function(a){return d[46]=(d[40].push(c.i64.to_string(d[44])),d[40])}])}):c.resolve()},function(a){return d[42]=d[40].join(","),d[37]=d[42]}])},function(a){return d[35].some(function(a){return c.i64.eq(d[28],a)})?d[38]=d[28]:d[38]=void 0,c.i64.neq(d[38],void 0)?d[39]=d[38]:d[39]=void 0,d[25]=d[39]}])},function(a){return c.i64.neq(d[25],void 0)?d[26]=d[25]:d[26]=c.i64.cast([0,0]),c.i64.neq(d[29],void 0)?d[27]=d[29]:d[27]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[26],d[27],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0,void 0],d[2]=a[0],d[3]=a[1],d[4]=a[2],d[5]=a[3],d[6]=a[4],d[7]=a[5],d[8]=a[6],d[9]=a[7],d[10]=a[8],d[11]=a[9],d[12]=a[10],d[13]=a[11],d[14]=a[12],d[15]=a[13],d[16]=a[14],d[17]=a[15],d[18]=a[16],d[19]=a[17]}]))})},function(a){return c.storedProcedure(b("LSFindBackup")).then(function(a){return a=a,d[21]=a[0],a})},function(e){return c.blobs.neq(d[5],void 0)?c.sequence([function(e){return c.i64.neq(d[3],void 0)?c.sequence([function(e){return d[21]!==void 0?c.sequence([function(e){return c.blobs.neq(d[4],void 0)?c.sequence([function(e){return d[30]=c.createArray(),d[39]=(d[30].push(d[21]),d[30]),d[39]=(d[30].push(a[1]),d[30]),d[31]=c.toJSON(d[30]),d[32]=c.createArray(),d[39]=(d[32].push(c.i64.cast([0,32])),d[32]),c.nativeOperation(b("LSGetBlobFromString.nop"),["thread_ope_key","_",a[5]].join("")).then(function(a){return a=a,d[33]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[33],void 0,d[4],d[32]).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[35]=!1:d[35]=!0,d[35]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),d[40]="Got null keys while deriving message list OPE key. Returning null blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoUtils] ","",d[40]].join("")),d[39]=c.createArray(),void 0!==void 0?d[41]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils",d[40],d[39],c.i64.cast([0,3]))},function(a){return d[36]=void 0}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[34],c.i64.cast([0,0])).then(function(a){return a=a,d[39]=a[0],d[40]=a[1],a})},function(a){return d[36]=d[39]}])},function(e){return c.blobs.neq(d[36],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromInt64BE.nop"),a[6]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return c.nativeOperation(b("LSTruncateSortKey.nop"),d[39]).then(function(a){return a=a,d[40]=a[0],a})},function(a){return c.nativeOperation(b("LSOpeEncrypt.nop"),d[36],d[40],c.i64.cast([0,16])).then(function(a){return a=a,d[41]=a[0],a})},function(a){return c.nativeOperation(b("LSBinaryToHex.nop"),d[41]).then(function(a){return a=a,d[42]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[31]).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[43]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[44]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[45]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[21]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[49]).then(function(a){return a=a,d[50]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[53]).then(function(a){return a=a,d[54]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[4]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[57]).then(function(a){return a=a,d[58]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[5]).then(function(a){return a=a,d[59]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[59]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[60]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[61]).then(function(a){return a=a,d[62]=a[0],a})},function(e){return d[63]=new c.Map(),d[63].set("attachment_index_key",d[46]==null?"":d[46]),d[63].set("backup_ent_fbid",a[0]),d[63].set("delivery_object_id",a[1]),d[63].set("device_id",d[3]),d[63].set("mailbox_partial_id",d[50]==null?"":d[50]),d[63].set("media_type",a[3]),d[63].set("message_partial_id",d[54]==null?"":d[54]),d[63].set("product_type",a[2]),d[63].set("salt_partial_id",d[58]==null?"":d[58]),d[63].set("sort_key",d[42]==null?"":d[42]),d[63].set("thread_partial_id",d[62]==null?"":d[62]),d[63].set("isOpenEB",a[10]===!0),d[64]=new c.Map(),d[64].set("otid",a[4]),d[64].set("server_thread_key",a[7]),d[64].set("timestamp",c.i64.to_string(a[6])),c.nativeOperation(b("LSBase64Encode.nop"),d[5]).then(function(a){return a=a,d[65]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[4]).then(function(a){return a=a,d[66]=a[0],a})},function(e){return d[67]=new c.Map(),d[67].set("ocmf_client_state_blob",d[65]==null?"":d[65]),d[67].set("mailbox_root_key",d[66]==null?"":d[66]),d[68]=c.createArray(),d[80]=(d[68].push(a[4]),d[68]),d[80]=(d[68].push(a[1]),d[68]),d[69]=c.toJSON(d[68]),d[63].set("raw_identifiers",d[64]),d[63].set("backup_id",d[21]),d[63].set("thread_id",a[5]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[69]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[70]).then(function(a){return a=a,d[71]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[71]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return d[63].set("salt_partial_access_token",d[73]==null?"":d[73]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[31]).then(function(a){return a=a,d[74]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[74]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[5],d[75]).then(function(a){return a=a,d[76]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[76]).then(function(a){return a=a,d[77]=a[0],a})},function(b){return d[63].set("salt_partial_attachment_index_key",d[77]==null?"":d[77]),d[63].set("raw_tokens",d[67]),a[13]!==void 0?d[63].set("access_token_secret",a[13]):0,a[14]!==void 0?d[63].set("primary_key_secret",a[14]):0,d[78]=c.toJSON(d[63]),d[79]=new c.Map(),d[79].set("payload",d[78]),b=[d[79],void 0],d[37]=b[0],d[38]=b[1]}]):c.resolve((d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,25])),d[39].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[39].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),e=[void 0,d[39]],d[37]=e[0],d[38]=e[1]))},function(a){return a=[d[37],d[38]],d[28]=a[0],d[29]=a[1],a}]):c.resolve((d[30]=new c.Map(),d[30].set("error_code",c.i64.cast([0,20])),d[30].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[30].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),e=[void 0,d[30]],d[28]=e[0],d[29]=e[1]))},function(a){return a=[d[28],d[29]],d[26]=a[0],d[27]=a[1],a}]):c.resolve((d[28]=new c.Map(),d[28].set("error_code",c.i64.cast([0,1])),d[28].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[28].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),e=[void 0,d[28]],d[26]=e[0],d[27]=e[1]))},function(a){return a=[d[26],d[27]],d[24]=a[0],d[25]=a[1],a}]):c.resolve((d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,24])),d[26].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[26].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),e=[void 0,d[26]],d[24]=e[0],d[25]=e[1]))},function(a){return a=[d[24],d[25]],d[22]=a[0],d[23]=a[1],a}]):c.resolve((d[24]=new c.Map(),d[24].set("error_code",c.i64.cast([0,22])),d[24].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),d[24].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),e=[void 0,d[24]],d[22]=e[0],d[23]=e[1]))},function(a){return a=[d[22],d[23]],d[0]=a[0],d[1]=a[1],a}])},function(a){return a=[d[0],d[1]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSCreateResignCDNUrlPayloadStoredProcedure",["LSCreateResignCDNUrlPayload","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSCreateResignCDNUrlPayload"),e.backupEntFbid,e.deliveryObjectId,e.productType,e.mediaType,e.messageId,e.threadId,e.sortOrder,e.serverThreadKey,e.deviceId,e.backupId,e.isOpenEb,e.ocmfClientState,e.mailboxRootKey,e.accessTokenSecret,e.primaryKeySecret);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("EBLSResignCdnUrl",["Base64Utils","EBCreateResignCDNUrlPayload","EBEnqueueResignCdnUrlRequests","EBLS","EBMinosWasmDeriveAttachmentTokenPrimaryKey","FBLogger","I64","LSCreateResignCDNUrlPayloadStoredProcedure","LSFactory","LSShape","MAWConfig","Random","WAJids","WAResultOrError","getErrorSafe","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u=function(){return c("FBLogger")("wmi").tags(["labyrinth_web","resign_cdn_url"])};e="-8";var v=(t||(t=d("I64"))).of_string(e);async function a(a){var b=a.chatJid,e=a.deliveryObjectId,g=a.externalId,o=a.mediaDownloadFlow,p=a.mediaKey,q=a.mediaType;a=a.sortOrderMs;u().INFO(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL"])));o==null||o.addPoint("resign_cdn_url_gql_ebls_start");var r=(await d("EBLS").init()).db;o==null||o.addPoint("resign_cdn_url_gql_ebls_end");var s=null,x=null;if(c("qex")._("208")===!0){p=await d("EBMinosWasmDeriveAttachmentTokenPrimaryKey").deriveAttachmentTokenPrimaryKeySecret(p);!p.success?u().WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["",""])),p.error):(s=d("Base64Utils").fromArrayBuffer(p.value.accessToken),x=d("Base64Utils").fromArrayBuffer(p.value.primaryKey))}var y={accessTokenSecret:s,backupEntFbid:v,deliveryObjectId:e,mediaType:q,messageId:g,primaryKeySecret:x,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:(t||(t=d("I64"))).of_float(a),threadId:d("WAJids").threadIdForChatJid(b)};o==null||o.addPoint("resign_cdn_url_gql_payload_start");o==null||o.addPoint("resign_cdn_url_gql_js_payload_start");p=[r.runInTransaction(function(a){return c("LSCreateResignCDNUrlPayloadStoredProcedure")(c("LSFactory")(a),y)},"readwrite",void 0,void 0,f.id+":101").then(function(a){var b=a[0];a=a[1];if(b!=null){o==null||o.addPoint("resign_cdn_url_gql_payload_end");return d("LSShape").toRecord(b)}b=a==null?{}:d("LSShape").toRecord(a);u().MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to create payload. stored procedure: ",", error code: ",", error message: ",""])),b.stored_procedure,b.error_code,b.error_message);o==null||o.addPoint("resign_cdn_url_gql_payload_fail",{string:{payload_fail_error:b.error_message}});return null}).catch(function(a){a=c("getErrorSafe")(a);u().catching(a).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to create lsdb payload"])));o==null||o.addPoint("resign_cdn_url_gql_payload_fail",{string:{payload_fail_error:a.message}});return null}),d("EBCreateResignCDNUrlPayload").createStringifiedMediaRestorePayloadFromEBDB({accessTokenSecret:s,deliveryObjectId:e,mediaType:q,messageId:g,primaryKeySecret:x,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrderMs:a,threadId:d("WAJids").threadIdForChatJid(b)}).then(function(a){if(a!=null){o==null||o.addPoint("resign_cdn_url_gql_js_payload_end");return{payload:a}}o==null||o.addPoint("resign_cdn_url_gql_ebdb_payload_fail");return null}).catch(function(a){a=c("getErrorSafe")(a);u().catching(a).MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to create ebdb payload"])));o==null||o.addPoint("resign_cdn_url_gql_ebdb_payload_fail",{string:{payload_fail_error:a.message}});return null})];r=await Promise.all(p);s=r[0];q=r[1];g=s!=null?s:q;if(s!=null&&q!=null&&d("Random").coinflip(1e3)){x=w(JSON.parse(s.payload),JSON.parse(q.payload));o==null||o.addAnnotations({string:{mismatches:x.join(",")}})}s==null&&q!=null&&(o==null||o.addPoint("resign_cdn_url_fallback_to_ebdb"));q==null&&s!=null&&(o==null||o.addPoint("resign_cdn_url_fallback_to_lsdb"));if(g==null){o==null||o.addPoint("resign_cdn_url_gql_payload_fail");return d("WAResultOrError").makeError("create-payload-failed")}o==null||o.addPoint("resign_cdn_url_gql_payload_end");o==null||o.addPoint("resign_cdn_url_gql_restore_start");a=await d("EBEnqueueResignCdnUrlRequests").enqueueResignCdnUrl(e,g,o);if(!a.success){u().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL failed: ",""])),a.error);o==null||o.addPoint("resign_cdn_url_gql_restore_fail");return a}o==null||o.addPoint("resign_cdn_url_gql_restore_end");u().INFO(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBLS GraphQL succeeded"])));return d("WAResultOrError").makeResult(a.value)}function w(a,b){var c=[];for(var d in a)a[d]instanceof Object?!(b[d]instanceof Object)?c.push(d):c.push.apply(c,w(a[d],b[d])):a[d]!==b[d]&&c.push(d);return c}async function b(a){var b=a.chatJid,e=a.deliveryObjectId,g=a.externalId,h=a.mediaDownloadFlow,i=a.mediaKey,j=a.mediaType,k=a.sortOrderMs;u().INFO(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBDB GraphQL"])));var l=null,m=null;if(c("qex")._("208")===!0){a=await d("EBMinosWasmDeriveAttachmentTokenPrimaryKey").deriveAttachmentTokenPrimaryKeySecret(i);!a.success?u().WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["",""])),a.error):(l=d("Base64Utils").fromArrayBuffer(a.value.accessToken),m=d("Base64Utils").fromArrayBuffer(a.value.primaryKey))}h==null||h.addPoint("resign_cdn_url_gql_js_payload_start");i=await d("EBCreateResignCDNUrlPayload").createStringifiedMediaRestorePayloadFromEBDB({accessTokenSecret:l,deliveryObjectId:e,mediaType:j,messageId:g,primaryKeySecret:m,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrderMs:k,threadId:d("WAJids").threadIdForChatJid(b)}).then(function(a){if(a!=null){h==null||h.addPoint("resign_cdn_url_gql_js_payload_end");return{payload:a}}h==null||h.addPoint("resign_cdn_url_gql_ebdb_payload_fail");return null}).catch(function(a){a=c("getErrorSafe")(a);u().catching(a).MUSTFIX(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Failed to create ebdb payload"])));h==null||h.addPoint("resign_cdn_url_gql_ebdb_payload_fail",{string:{payload_fail_error:a.message}});return null});if(i==null)return d("WAResultOrError").makeError("create-payload-failed");h==null||h.addPoint("resign_cdn_url_gql_restore_start");a=await d("EBEnqueueResignCdnUrlRequests").enqueueResignCdnUrl(e,i,h);if(!a.success){u().MUSTFIX(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBDB GraphQL failed: ",""])),a.error);h==null||h.addPoint("resign_cdn_url_gql_restore_fail");var n=(await d("EBLS").init()).db;n=(await n.runInTransaction(function(a){return c("LSCreateResignCDNUrlPayloadStoredProcedure")(c("LSFactory")(a),{accessTokenSecret:l,backupEntFbid:v,deliveryObjectId:e,mediaType:j,messageId:g,primaryKeySecret:m,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:(t||(t=d("I64"))).of_float(k),threadId:d("WAJids").threadIdForChatJid(b)})},"readwrite",void 0,void 0,f.id+":317"))[0];if(n!=null){n=JSON.parse(d("LSShape").toRecord(n).payload);i=JSON.parse(i.payload);var x=w(n,i),y=w(i,n);h==null||h.addAnnotations({bool:{string_payload_mismatch:JSON.stringify(n,Object.keys(n).sort())!==JSON.stringify(i,Object.keys(i).sort())},string:{ebdb_mismatches:y.join(","),mismatches:x.join(",")}})}return a}h==null||h.addPoint("resign_cdn_url_gql_restore_end");u().INFO(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Resigning cdn url with EBDB GraphQL succeeded"])));return d("WAResultOrError").makeResult(a.value)}g.DEPRECATED_eblsResignCdnUrlWithGraphQL=a;g.getPayloadMismatches=w;g.ebdbResignCdnUrlWithGraphQL=b}),98);
__d("EBParseUploadSerializationPayload",["EBLogger","MAWEBFrontendQPLLogger","WAErrorMessage","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("EBLogger").EBLogger().tags(["parseUploadSerializationResponse"]);function a(a){try{a=JSON.parse(a);return d("WAResultOrError").makeResult(a)}catch(b){a=d("WAErrorMessage").maybeGetMessageFromError(b);j.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["parseUploadSerializationResponse: ",""])),a);return d("WAResultOrError").makeError("parse_exception")}}function b(a,b,c,e){var f=[],g=[];a.forEach(function(a){var d=a.error_code+": "+a.error_message;j.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["EB upload "," serializer error: "," in ",""])),b,d,c);f.push(a.error_code);g.push(a.error_message)});if(e!=null){d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e,b+"_upload_task_serialization_failure",{int_array:(a={},a[b+"_serialization_error_codes"]=f,a),string_array:(e={},e[b+"_serialization_errors"]=g,e)})}}g.parseUploadSerializationResponse=a;g.logUploadSerializationErrors=b}),98);
__d("EBUploadMessagesFromWorkerMutation_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="24365010893138670"}),null);
__d("EBUploadMessagesFromWorkerMutation.graphql",["EBUploadMessagesFromWorkerMutation_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a=[{defaultValue:null,kind:"LocalArgument",name:"input"}],c=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTUploadMessageGQLResponse",kind:"LinkedField",name:"xfb_upload_encrypted_msg_to_backup",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"device_epoch_status",storageKey:null},{alias:null,args:null,concreteType:"XFBTUploadMessageHandlerResponse",kind:"LinkedField",name:"backup_write_result_response",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"delete_mailbox",storageKey:null},{alias:null,args:null,concreteType:"XFBTProtobufParams",kind:"LinkedField",name:"protobuf_params",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"delete_on_success",storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:a,kind:"Fragment",metadata:null,name:"EBUploadMessagesFromWorkerMutation",selections:c,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:a,kind:"Operation",name:"EBUploadMessagesFromWorkerMutation",selections:c},params:{id:b("EBUploadMessagesFromWorkerMutation_facebookRelayOperation"),metadata:{},name:"EBUploadMessagesFromWorkerMutation",operationKind:"mutation",text:null}}}();e.exports=a}),null);
__d("LSWriteSupplementalMessage",["LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][writeSupplementalMessage] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.filter(c.db.table(302).fetch(),function(b){return b.threadId===a[1]&&b.toplevelOfflineThreadingId===a[2]&&b.supplementalKey===a[3]}).next().then(function(a,b){var c=a.done;a=a.value;return c?d[2]=void 0:(b=a.item,d[2]=b.messageTimestampMs)})},function(b){return c.i64.neq(d[2],void 0)?c.sequence([function(b){return c.i64.gt(d[2],a[5])?c.resolve((b=[!1,c.i64.cast([0,851])],d[12]=b[0],d[13]=b[1],b)):c.sequence([function(b){return c.forEach(c.filter(c.db.table(302).fetch(),function(b){return b.threadId===a[1]&&b.toplevelOfflineThreadingId===a[2]&&b.supplementalKey===a[3]}),function(a){return a["delete"]()})},function(b){return c.db.table(302).add({pk:void 0,messagePayload:a[0],threadId:a[1],toplevelOfflineThreadingId:a[2],supplementalKey:a[3],offlineThreadingId:a[4],messageTimestampMs:a[5]})},function(a){return a=[!0,void 0],d[12]=a[0],d[13]=a[1],a}])},function(a){return a=[d[12],d[13]],d[4]=a[0],d[5]=a[1],a}]):c.sequence([function(b){return c.forEach(c.filter(c.db.table(302).fetch(),function(b){return b.threadId===a[1]&&b.toplevelOfflineThreadingId===a[2]&&b.supplementalKey===a[3]}),function(a){return a["delete"]()})},function(b){return c.db.table(302).add({pk:void 0,messagePayload:a[0],threadId:a[1],toplevelOfflineThreadingId:a[2],supplementalKey:a[3],offlineThreadingId:a[4],messageTimestampMs:a[5]})},function(a){return a=[!0,void 0],d[4]=a[0],d[5]=a[1],a}])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][writeSupplementalMessage] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"writeSupplementalMessage",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[4],d[5]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMPSWriteSupplementalMessageStoredProcedure";a.__tables__=["local_message_persistence_store_supplemental"];e.exports=a}),null);
__d("LSWriteSupplementalMessageStoredProcedure",["LSSynchronousPromise","LSWriteSupplementalMessage","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSWriteSupplementalMessage"),e.messagePayload,e.threadId,e.toplevelOfflineThreadingId,e.supplementalKey,e.offlineThreadingId,e.messageTimestampMs);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSWriteTopLevelMessage",["LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][writeTopLevelMessage] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}).next().then(function(a,b){var c=a.done;a=a.value;return c?d[2]=void 0:(b=a.item,d[2]=b.messageTimestampMs)})},function(b){return c.i64.neq(d[2],void 0)?c.sequence([function(b){return c.i64.gt(d[2],a[3])?c.resolve((b=[!1,c.i64.cast([0,851])],d[12]=b[0],d[13]=b[1],b)):c.sequence([function(b){return c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}).next().then(function(a,b){b=a.done;a=a.value;return b?d[14]=!1:(a.item,d[14]=!0)})},function(b){return d[14]?c.sequence([function(b){return c.forEach(c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(b){var c=b.update;b.item;return c({deletedMessagePayload:a[0],isLocalOnlyMessage:a[4],messageTimestampMs:a[3]})})},function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]&&c.i64.eq(b.messageTimestampMs,c.i64.cast([-1,4294967295]))}),function(b){var c=b.update;b.item;return c({messageTimestampMs:a[3]})})},function(a){return a=[!1,c.i64.cast([0,852])],d[16]=a[0],d[17]=a[1],a}]):c.sequence([function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(a){return a["delete"]()})},function(b){return c.db.table(301).add({pk:void 0,messagePayload:a[0],threadId:a[1],offlineThreadingId:a[2],messageTimestampMs:a[3],isLocalOnlyMessage:a[4],extraData:a[5]})},function(a){return a=[!0,void 0],d[16]=a[0],d[17]=a[1],a}])},function(a){return a=[d[16],d[17]],d[12]=a[0],d[13]=a[1],a}])},function(a){return a=[d[12],d[13]],d[4]=a[0],d[5]=a[1],a}]):c.sequence([function(b){return c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}).next().then(function(a,b){b=a.done;a=a.value;return b?d[12]=!1:(a.item,d[12]=!0)})},function(b){return d[12]?c.sequence([function(b){return c.forEach(c.filter(c.db.table(303).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(b){var c=b.update;b.item;return c({deletedMessagePayload:a[0],isLocalOnlyMessage:a[4],messageTimestampMs:a[3]})})},function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]&&c.i64.eq(b.messageTimestampMs,c.i64.cast([-1,4294967295]))}),function(b){var c=b.update;b.item;return c({messageTimestampMs:a[3]})})},function(a){return a=[!1,c.i64.cast([0,852])],d[14]=a[0],d[15]=a[1],a}]):c.sequence([function(b){return c.forEach(c.filter(c.db.table(301).fetch(),function(b){return b.threadId===a[1]&&b.offlineThreadingId===a[2]}),function(a){return a["delete"]()})},function(b){return c.db.table(301).add({pk:void 0,messagePayload:a[0],threadId:a[1],offlineThreadingId:a[2],messageTimestampMs:a[3],isLocalOnlyMessage:a[4],extraData:a[5]})},function(a){return a=[!0,void 0],d[14]=a[0],d[15]=a[1],a}])},function(a){return a=[d[14],d[15]],d[4]=a[0],d[5]=a[1],a}])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][writeTopLevelMessage] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"writeTopLevelMessage",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[4],d[5]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSMPSWriteTopLevelMessageStoredProcedure";a.__tables__=["local_message_persistence_store","local_message_persistence_store_deleted_messages"];e.exports=a}),null);
__d("LSWriteTopLevelMessageStoredProcedure",["LSSynchronousPromise","LSWriteTopLevelMessage","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSWriteTopLevelMessage"),e.messagePayload,e.threadId,e.offlineThreadingId,e.messageTimestampMs,e.isLocalOnlyMessage,e.extraData);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MessageBackupTagsDelimiter",[],(function(a,b,c,d,e,f){"use strict";a=":";f.INSTAMADILLO_TAG_DELIMITER=a}),66);
__d("EncryptedBackupsWriteToMPSTables",["EncryptedBackupsUploadEntity","FBLogger","I64","IGDWEBUploadMessageUtils","LSFactory","LSWriteSupplementalMessageStoredProcedure","LSWriteTopLevelMessageStoredProcedure","MessageBackupTagsDelimiter","WAErrorMessage","WAGetSafeQPLError","WAResultOrError","gkx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("ReverbWriteFailureFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),j=c("requireDeferred")("ReverbWriteSuccessFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),k=c("gkx")("8488");function l(a,b,d,e,f,g){e?c("promiseDone")(j.load(),function(c){return c.log(function(){return{backup_action:d,backup_protocol:f,labyrinth_version:0,message_id:a,thread_id:b}})}):c("promiseDone")(i.load(),function(c){return c.log(function(){return{backup_action:d,backup_protocol:f,failure_reason:g,labyrinth_version:0,message_id:a,thread_id:b}})})}async function a(a,b,e,f,g){var i=b.backupActionType,j=b.instamadilloItemId,m=b.msgId,n=b.originalMsgProtocolId,o=b.protobuf,p=b.serverTs,q=b.sortOrderMs;b=b.supplementalKey;g==null||g.addPoint("mps_tables_write_start");m=m.externalId;n=n==null?void 0:n.externalId;j=j!=null?j:q;if(j==null){g==null||g.addPoint("mps_tables_write_missing_protobuf_ts");return d("WAResultOrError").makeError({errorCode:null,errorMsg:"protobufTimestampMs is null when writing to MPS tables"})}q=(h||(h=d("I64"))).of_float(j);j=!1;var r=k?"protobuf_only":"dual_upload";f&&(r="open_eb_ttlc");f=null;switch(i){case 1:g==null||g.addPoint("mps_top_level_write_start");try{i=await c("LSWriteTopLevelMessageStoredProcedure")(c("LSFactory")(a),{isLocalOnlyMessage:!1,messagePayload:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o),messageTimestampMs:q,offlineThreadingId:m,threadId:e});var s=i[0];i=i[1];f=i;s&&(j=!0);l(m,e,"upsert_top_level",s,r);g==null||g.addPoint("mps_top_level_write",{bool:{mps_top_level_write_succesful:s}})}catch(a){l(m,e,"upsert_top_level",!1,r,d("WAErrorMessage").maybeGetMessageFromError(a)),g==null||g.addPoint("mps_top_level_write_error",{string:{mps_top_level_write_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}break;case 2:g==null||g.addPoint("mps_supplemental_write_start");if(n==null||b==null)l(m,e,"upsert_supplemental",!1,r),c("FBLogger")("wmi_eb").warn("Missing toplevelOfflineThreadingId or supplementalKey when writing to MPS tables");else try{i=await c("LSWriteSupplementalMessageStoredProcedure")(c("LSFactory")(a),{messagePayload:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o),messageTimestampMs:q,offlineThreadingId:m,supplementalKey:b,threadId:e,toplevelOfflineThreadingId:n});s=i[0];q=i[1];f=q;s&&(j=!0);l(m,e,"upsert_supplemental",s,r);g==null||g.addPoint("mps_supplemental_write",{bool:{mps_supplemental_write_successful:s}})}catch(a){l(m,e,"upsert_supplemental",!1,r,d("WAErrorMessage").maybeGetMessageFromError(a)),g==null||g.addPoint("mps_supplemental_write_error",{string:{mps_supplemental_write_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}break;case 4:g==null||g.addPoint("mps_delete_top_level_with_placeholder_write_start");if(n==null)break;try{b=await c("LSWriteTopLevelMessageStoredProcedure")(c("LSFactory")(a),{isLocalOnlyMessage:!1,messagePayload:d("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o),messageTimestampMs:(h||(h=d("I64"))).of_float(d("IGDWEBUploadMessageUtils").generateProtobufServerTs(n,p)),offlineThreadingId:m,threadId:e});i=b[0];q=b[1];f=q;i&&(j=!0);l(n,e,"delete_top_level",i,r);g==null||g.addPoint("mps_delete_top_level_with_placeholder_write",{bool:{mps_delete_top_level_with_placeholder_write_successful:i}})}catch(a){l(n,e,"delete_top_level_with_placeholder",!1,r,d("WAErrorMessage").maybeGetMessageFromError(a)),g==null||g.addPoint("mps_delete_top_level_with_placeholder_write_error",{string:{mps_delete_top_level_with_placeholder_write_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}})}break;case 3:j=!0;n!=null&&l(n,e,"delete_top_level",!1,r);break;default:g==null||g.addPoint("mps_write_unsupported_backup_action_type"),c("FBLogger")("wmi_eb").warn("Unsupported backupActionType when writing to MPS tables")}if(j){g==null||g.addPoint("mps_write_successful");return d("WAResultOrError").makeResult(j)}else{g==null||g.addPoint("mps_write_unsuccessful");return d("WAResultOrError").makeError({errorCode:f,errorMsg:"Unsuccessful writing to MPS tables"})}}async function b(a,b,c){var e=b.msgId,f=b.sortOrderMs;b=b.tags;b!=null&&b.length!==0&&f!=null&&await a.local_message_persistence_store_tag_index.put({localMessagePersistenceStoreKey:(h||(h=d("I64"))).of_string(e.externalId),messageTimestampMs:h.of_float(f),offlineThreadingId:e.externalId,tag:b.join(d("MessageBackupTagsDelimiter").INSTAMADILLO_TAG_DELIMITER),threadId:c})}g.writeToMPSTables=a;g.writeTagsToMPSTables=b}),98);
__d("LSHandleBackupWriteCompletion",["EBEnableUnifiedAttachment","LSVec","MAWEBFrontendQPLLogger","cr:847"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,e,f,g){if(g!=null){e=c("LSVec").toArray(g);d("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()&&e.forEach(function(a){return d("MAWEBFrontendQPLLogger").endFlowUploadAttachmentBackup(a,f,"unified")})}if(b("cr:847")!=null){e=g!=null?c("LSVec").toArray(g):[];e.length>0&&await b("cr:847")(a,e)}return Promise.resolve()}g.call=a}),98);
__d("LSHandleBackupWriteCompletion.nop",["LSHandleBackupWriteCompletion"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c,e){return d("LSHandleBackupWriteCompletion").call(a,b,c,e)};a.__nop_name__="LSHandleBackupWriteCompletion";g["default"]=a}),98);
__d("LSMarkBackupAsCompleted.nop",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=function(a,c,d,e,f,h,i){return(g||(g=b("Promise"))).resolve()};a.__nop_name__="LSMarkBackupAsCompleted";f["default"]=a}),66);
__d("LSHandleProtobufWriteResult",["LSArrayGetObjectAt","LSMarkBackupAsCompleted.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return a[3]?d[0]=!1:d[0]=!0,d[0]?c.resolve():(d[1]=a[3].get("delete_on_success"),d[1]&&a[0]&&!a[1]?(a[2]?d[2]=!1:d[2]=!0,d[2]?c.resolve():c.sequence([function(e){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.of_int32(a[2].length),c.i64.gt(d[4],c.i64.cast([0,0]))?c.loopAsync(d[4],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,d){var e=a.done;a=a.value;return e?0:(d=a.item,c.nativeOperation(b("LSMarkBackupAsCompleted.nop"),d.actThreadId,d.toplevelOfflineThreadingId,d.supplementalKey,d.messageTimestampMs,d.backupAction))})}])}):c.resolve()},function(e){return d[5]=c.i64.of_int32(a[2].length),c.i64.gt(d[5],c.i64.cast([0,0]))?c.loopAsync(d[5],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,b){var e=a.done;a=a.value;return e?0:(b=a.item,d[12]=b.actThreadId,d[13]=b.toplevelOfflineThreadingId,d[11]=b.supplementalKey,d[14]=b.messageTimestampMs,d[11]!==void 0?c.forEach(c.filter(c.db.table(302).fetch(),function(a){return a.threadId===d[12]&&a.toplevelOfflineThreadingId===d[13]&&a.supplementalKey===d[11]&&c.i64.le(a.messageTimestampMs,d[14])}),function(a){return a["delete"]()}):c.forEach(c.filter(c.db.table(301).fetch(),function(a){return a.threadId===d[12]&&a.offlineThreadingId===d[13]&&c.i64.le(a.messageTimestampMs,d[14])}),function(a){return a["delete"]()}))})}])}):c.resolve()},function(e){return d[6]=c.i64.of_int32(a[2].length),c.i64.gt(d[6],c.i64.cast([0,0]))?c.loopAsync(d[6],function(e){return d[7]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[2],d[7]).then(function(a){return a=a,d[8]=a[0],d[9]=a[1],a})},function(a){return c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[8])}).next().then(function(a,b){var d=a.done;a=a.value;return d?0:(b=a.item,c.forEach(c.db.table(304).fetch([[[b.toplevelOfflineThreadingId,b.actThreadId]],"offlineThreadingId"]),function(a){return a["delete"]()}))})}])}):c.resolve()}])):c.resolve())},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleProtobufWriteResultStoredProcedure";a.__tables__=["pending_protobuf_backups_context","local_message_persistence_store_supplemental","local_message_persistence_store","local_message_persistence_store_tag_index"];e.exports=a}),null);
__d("LSHandleBackupWriteResultV2",["LSArrayGetObjectAt","LSDeleteBackupOnClient","LSHandleBackupWriteCompletion.nop","LSHandleProtobufWriteResult","LSLogMEBUploadSuccessEvent.nop","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Beginning execution."),d[1]=c.createArray(),d[2]=c.createArray(),a[3]?d[3]=!1:d[3]=!0,d[3]?c.resolve():(d[12]=c.i64.of_int32(a[3].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(e){return c.db.table(177).fetch([[[d[14]]],"fk_pending_tasks"]).next().then(function(e,f){var g=e.done;e=e.value;return g?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Pending backup task id not found!"),d[18]="Pending backup task id not found!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ","",d[18]].join("")),d[17]=c.createArray(),void 0!==void 0?d[19]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",d[18],d[17],c.i64.cast([0,3]))):(f=e.item,c.sequence([function(d){return c.i64.eq(f.contentType,c.i64.cast([0,1]))?c.nativeOperation(b("LSLogMEBUploadSuccessEvent.nop"),f.uniqueKey,f.lsTraceId,a[1]):c.resolve()},function(a){return d[17]=(d[2].push(f.persistentId),d[2])}]))})}])}):c.resolve())},function(d){return c.storedProcedure(b("LSHandleProtobufWriteResult"),a[1],a[2],a[3],a[4],!1)},function(e){return d[4]=c.i64.of_float(Date.now()),a[3]?d[5]=!1:d[5]=!0,d[5]?c.resolve():(d[12]=c.i64.of_int32(a[3].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(305).fetch(),function(a){return c.i64.eq(a.pendingBackupTaskId,d[14])}),function(a){return a["delete"]()})}])}):c.resolve())},function(e){return a[2]?c.sequence([function(e){return d[12]=c.i64.of_int32(a[0].length),c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],c.i64.cast([0,0])).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(a){return d[13]=d[14]}])},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[13],void 0,!0)}]):c.resolve()},function(e){return c.nativeOperation(b("LSHandleBackupWriteCompletion.nop"),a[1],a[0],d[2])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure";a.__tables__=["pending_backups_context_v2","pending_protobuf_backups_context"];e.exports=a}),null);
__d("LSHandleBackupWriteResultV2StoredProcedure",["LSHandleBackupWriteResultV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSHandleBackupWriteResultV2"),e.traceIds,e.isSuccess,e.deleteMailbox,e.taskIds,e.protobufParams);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSPrepareOpenEpochV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Beginning execution."),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50005"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[1]=!1:(a.item,d[1]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="320"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[3]=!1:(a.item,d[3]=!0)})},function(a){return d[1]||d[3]?c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Skipping openEpoch start because there is already an openEpoch flow in progress."),d[5]=c.i64.cast([0,1]))):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1441]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[18]=new c.Map(),d[18].set("error_msg","Expected a nonempty query result"),d[18].set("code",c.i64.cast([0,3])),d[18].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[19]=c.createArray(),d[20]=(d[19].push(d[18]),d[19]),e=[void 0,d[19]],d[12]=e[0],d[13]=e[1]):(b=a.item,d[18]=new c.Map(),d[18].set("backup_id",b.backupId),d[18].set("device_public_key_blob",b.devicePublicKeyBlob),d[18].set("device_private_key_blob",b.devicePrivateKeyBlob),d[18].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[18].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[18].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[18].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[18].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[18].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[18].set("orf_client_state_v2_blob",void 0),d[18].set("orf_v2_authority_level",void 0),d[18].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[18].set("device_id",b.deviceId),d[18].set("backup_tenancy",b.backupTenancy),d[18].set("encryption_version",b.encryptionVersion),d[18].set("revision_version",b.revisionVersion),d[18].set("initialize_restore_result",void 0),d[18].set("device_creation_timestamp_sec",void 0),d[18].set("authority_level",b.authorityLevel),e=[d[18],void 0],d[12]=e[0],d[13]=e[1])})},function(a){return d[15]=new c.Map(),d[15].set("value",d[12]),d[15].set("errors",d[13]),d[16]=d[15].get("value"),d[16]!==void 0?c.sequence([function(a){return d[18]=d[16].get("backup_id"),d[19]=d[16].get("device_public_key_blob"),d[20]=d[16].get("device_private_key_blob"),d[21]=d[16].get("epoch_storage_public_key_blob"),d[22]=d[16].get("epoch_storage_private_key_blob"),d[23]=d[16].get("epoch_auth_public_key_blob"),d[24]=d[16].get("epoch_auth_private_key_blob"),d[25]=d[16].get("mailbox_root_key_blob"),d[26]=d[16].get("ocmf_client_state_blob"),d[27]=d[16].get("orf_client_state_v2_blob"),d[28]=d[16].get("orf_v2_authority_level"),d[29]=d[16].get("oblivious_validation_token_blob"),d[30]=d[16].get("device_id"),d[31]=d[16].get("backup_tenancy"),d[32]=d[16].get("encryption_version"),d[33]=d[16].get("revision_version"),d[34]=d[16].get("initialize_restore_result"),d[35]=d[16].get("device_creation_timestamp_sec"),d[36]=d[16].get("authority_level"),c.i64.neq(d[30],void 0)?c.sequence([function(a){return d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[50]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[60]=(d[50].push(c.i64.cast([0,0])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[60]=(d[50].push(c.i64.cast([0,2])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[53]?d[60]=(d[50].push(c.i64.cast([0,3])),d[50]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[54]?d[60]=(d[50].push(c.i64.cast([0,4])),d[50]):0,d[55]=c.createArray(),d[56]=c.i64.of_int32(d[50].length),c.i64.gt(d[56],c.i64.cast([0,0]))?c.loopAsync(d[56],function(a){return d[60]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[50],d[60]).then(function(a){return a=a,d[61]=a[0],d[62]=a[1],a})},function(a){return d[63]=(d[55].push(d[61]),d[55])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[60]=c.createArray(),d[61]=c.i64.of_int32(d[55].length),c.i64.gt(d[61],c.i64.cast([0,0]))?c.loopAsync(d[61],function(a){return d[63]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[55],d[63]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return d[66]=(d[60].push(c.i64.to_string(d[64])),d[60])}])}):c.resolve()},function(a){return d[62]=d[60].join(","),d[57]=d[62]}])},function(a){return d[55].some(function(a){return c.i64.eq(d[32],a)})?d[58]=d[32]:d[58]=void 0,c.i64.neq(d[58],void 0)?d[59]=d[58]:d[59]=void 0,d[39]=d[59]}])},function(a){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[31],void 0)?d[41]=d[31]:d[41]=c.i64.cast([0,1]),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2821]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[51]=!0:d[51]=!1,d[51]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[53]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[53]].join("")),d[52]=c.createArray(),void 0!==void 0?d[54]=(d[52].push(void 0),d[52]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[53],d[52],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[50]=(d[42].push(a.epochId),d[42])})},function(a){return d[48]="Queried locally available epochs. Count: ",d[43]=c.i64.of_int32(d[42].length),d[49]=c.i64.to_string(d[43]),d[44]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[44],d[48],d[44],d[49]].join("")),c.resolve()},function(a){return d[45]=new c.Map(),d[45].set("backup_id",d[18]),d[45].set("locally_available_epochs",d[42]),d[45].set("device_id",d[30]),d[45].set("trace_id",void 0),d[46]=c.toJSON(d[45]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_request_for_asssoc_devices",c.i64.cast([0,50005]),d[46],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1442]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[51]=!0:d[51]=!1,d[51]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[53]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[53]].join("")),d[52]=c.createArray(),void 0!==void 0?d[54]=(d[52].push(void 0),d[52]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[53],d[52],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[37]=c.i64.cast([0,0])}]):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2822]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[39]?d[40]=!0:d[40]=!1,d[40]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[42]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[42]].join("")),d[41]=c.createArray(),void 0!==void 0?d[43]=(d[41].push(void 0),d[41]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[42],d[41],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[38]="No backup found.",d[38]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",d[38]].join("")),d[39]=c.createArray(),void 0!==void 0?d[40]=(d[39].push(void 0),d[39]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",d[38],d[39],c.i64.cast([0,3]))):c.resolve()},function(a){return d[37]=c.i64.cast([0,1])}])},function(a){return d[17]=d[37]}]):c.sequence([function(a){return d[18]=d[15].get("errors"),d[19]=d[15].get("errors"),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2822]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!0:d[22]=!1,d[22]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[24]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[24]].join("")),d[23]=c.createArray(),void 0!==void 0?d[25]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[24],d[23],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[20]="No backup found.",d[20]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",d[20]].join("")),d[21]=c.createArray(),void 0!==void 0?d[22]=(d[21].push(void 0),d[21]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",d[20],d[21],c.i64.cast([0,3]))):c.resolve()},function(a){return d[17]=c.i64.cast([0,1])}])},function(a){return d[5]=d[17]}])},function(a){return d[6]=c.i64.of_float(Date.now()),d[7]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[6],d[0])),d[11]=" ms",d[8]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ",d[8],d[9],d[8],d[10],d[8],d[11]].join("")),c.i64.eq(c.i64.mod_(d[7],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[5]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure";a.__tables__=["pending_tasks","secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSPrepareOpenEpochV2StoredProcedure",["LSPrepareOpenEpochV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){e===void 0&&(e={});a=a.storedProcedure(c("LSPrepareOpenEpochV2"),e.backupId,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSSyncEpochs",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(a){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] Beginning execution."),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,1436]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[13]=a[0],a})},function(a){return d[13]?d[14]=!0:d[14]=!1,d[14]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[16]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[16]].join("")),d[15]=c.createArray(),void 0!==void 0?d[17]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[16],d[15],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[13]=new c.Map(),d[13].set("error_msg","Expected a nonempty query result"),d[13].set("code",c.i64.cast([0,3])),d[13].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[14]=c.createArray(),d[15]=(d[14].push(d[13]),d[14]),e=[void 0,d[14]],d[1]=e[0],d[2]=e[1]):(b=a.item,d[13]=new c.Map(),d[13].set("backup_id",b.backupId),d[13].set("device_public_key_blob",b.devicePublicKeyBlob),d[13].set("device_private_key_blob",b.devicePrivateKeyBlob),d[13].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[13].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[13].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[13].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[13].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[13].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[13].set("orf_client_state_v2_blob",void 0),d[13].set("orf_v2_authority_level",void 0),d[13].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[13].set("device_id",b.deviceId),d[13].set("backup_tenancy",b.backupTenancy),d[13].set("encryption_version",b.encryptionVersion),d[13].set("revision_version",b.revisionVersion),d[13].set("initialize_restore_result",void 0),d[13].set("device_creation_timestamp_sec",void 0),d[13].set("authority_level",b.authorityLevel),e=[d[13],void 0],d[1]=e[0],d[2]=e[1])})},function(a){return d[4]=new c.Map(),d[4].set("value",d[1]),d[4].set("errors",d[2]),d[5]=d[4].get("value"),d[5]!==void 0?c.sequence([function(a){return d[13]=d[5].get("backup_id"),d[14]=d[5].get("device_public_key_blob"),d[15]=d[5].get("device_private_key_blob"),d[16]=d[5].get("epoch_storage_public_key_blob"),d[17]=d[5].get("epoch_storage_private_key_blob"),d[18]=d[5].get("epoch_auth_public_key_blob"),d[19]=d[5].get("epoch_auth_private_key_blob"),d[20]=d[5].get("mailbox_root_key_blob"),d[21]=d[5].get("ocmf_client_state_blob"),d[22]=d[5].get("orf_client_state_v2_blob"),d[23]=d[5].get("orf_v2_authority_level"),d[24]=d[5].get("oblivious_validation_token_blob"),d[25]=d[5].get("device_id"),d[26]=d[5].get("backup_tenancy"),d[27]=d[5].get("encryption_version"),d[28]=d[5].get("revision_version"),d[29]=d[5].get("initialize_restore_result"),d[30]=d[5].get("device_creation_timestamp_sec"),d[31]=d[5].get("authority_level"),c.i64.neq(d[25],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[41]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return d[42]?d[51]=(d[41].push(c.i64.cast([0,0])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[43]=a[0],a})},function(a){return d[43]?d[51]=(d[41].push(c.i64.cast([0,2])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[51]=(d[41].push(c.i64.cast([0,3])),d[41]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[51]=(d[41].push(c.i64.cast([0,4])),d[41]):0,d[46]=c.createArray(),d[47]=c.i64.of_int32(d[41].length),c.i64.gt(d[47],c.i64.cast([0,0]))?c.loopAsync(d[47],function(a){return d[51]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[41],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[54]=(d[46].push(d[52]),d[46])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[51].push(c.i64.to_string(d[55])),d[51])}])}):c.resolve()},function(a){return d[53]=d[51].join(","),d[48]=d[53]}])},function(a){return d[46].some(function(a){return c.i64.eq(d[27],a)})?d[49]=d[27]:d[49]=void 0,c.i64.neq(d[49],void 0)?d[50]=d[49]:d[50]=void 0,d[34]=d[50]}])},function(a){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[26],void 0)?d[36]=d[26]:d[36]=c.i64.cast([0,1]),c.filter(c.db.table(2).fetch(),function(a){return a.context==="50013"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[37]=!1:(a.item,d[37]=!0)})},function(a){return c.filter(c.db.table(2).fetch(),function(a){return a.context==="50025"}).next().then(function(a,b){b=a.done;a=a.value;return b?d[39]=!1:(a.item,d[39]=!0)})},function(a){return d[37]||d[39]?(d[41]="Another sync job is already in progress. Terminating this.",d[41]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[41]].join("")),d[42]=c.createArray(),void 0!==void 0?d[43]=(d[42].push(void 0),d[42]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[41],d[42],c.i64.cast([0,3]))):c.resolve()):c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2849]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[50]=!0:d[50]=!1,d[50]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[52]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[52]].join("")),d[51]=c.createArray(),void 0!==void 0?d[53]=(d[51].push(void 0),d[51]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[52],d[51],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[41]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[49]=(d[41].push(a.epochId),d[41])})},function(a){return d[47]="Queried locally available epochs. Count: ",d[42]=c.i64.of_int32(d[41].length),d[48]=c.i64.to_string(d[42]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[43],d[47],d[43],d[48]].join("")),c.resolve()},function(a){return d[44]=new c.Map(),d[44].set("backup_id",d[13]),d[44].set("device_id",d[25]),d[44].set("locally_available_epochs",d[41]),d[44].set("trace_id",void 0),d[45]=c.toJSON(d[44]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",c.i64.cast([0,50025]),d[45],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[46]=a[0],a})}])},function(a){return d[32]=!0}]):c.sequence([function(a){return d[33]=["Failed to load client state: ","","NULL_DEVICE_ID"].join(""),d[33]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[33]].join("")),d[34]=c.createArray(),void 0!==void 0?d[35]=(d[34].push(void 0),d[34]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[33],d[34],c.i64.cast([0,3]))):c.resolve()},function(a){return d[32]=!1}])},function(a){return d[6]=d[32]}]):c.sequence([function(a){return d[13]=d[4].get("errors"),d[14]=d[4].get("errors"),d[15]=["Failed to load client state: ","","BACKUP_NOT_FOUND"].join(""),d[15]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",d[15]].join("")),d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",d[15],d[16],c.i64.cast([0,3]))):c.resolve()},function(a){return d[6]=!1}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsSyncEpochsStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_tasks","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSSyncEpochsStoredProcedure",["LSSyncEpochs","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a){a=a.storedProcedure(c("LSSyncEpochs"));return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWEBFalcoLoggerUtils",["requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=(f=c("requireDeferred"))("EncryptedBackupTaskFailureFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),i=f("EncryptedBackupTaskIssuedFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),j=f("EncryptedBackupTaskSkippedFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),k=f("EncryptedBackupUploadSuccessFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),l={0:"unknown",1:"upsert_top_level",2:"upsert_supplemental",3:"delete_top_level",4:"delete_top_level_with_placeholder"};function a(a,b){m(a,b)}function b(a,b,c){m(a,b,c)}function d(a,b,c){m(a,b,void 0,c)}function m(a,b,c,d){c!=null?void h.onReady(function(d){d.log(function(){var d;return{backup_action:(d=l[(d=(d=a.protoMsg)==null?void 0:d.backupActionType)!=null?d:0])!=null?d:"unknown",backup_protocol:b,failure_reason:c,labyrinth_version:0,message_id:(d=(d=a.protoMsg)==null||(d=d.msgId)==null?void 0:d.externalId)!=null?d:a.messageId,thread_id:a.threadId,trace_id:a.traceId}})}):d!=null?void j.onReady(function(c){c.log(function(){var c;return{backup_action:(c=l[(c=(c=a.protoMsg)==null?void 0:c.backupActionType)!=null?c:0])!=null?c:"unknown",backup_protocol:b,labyrinth_version:0,message_id:(c=(c=a.protoMsg)==null||(c=c.msgId)==null?void 0:c.externalId)!=null?c:a.messageId,skipped_reason:d,thread_id:a.threadId,trace_id:a.traceId}})}):void i.onReady(function(c){c.log(function(){var c;return{backup_action:(c=l[(c=(c=a.protoMsg)==null?void 0:c.backupActionType)!=null?c:0])!=null?c:"unknown",backup_protocol:b,labyrinth_version:0,message_id:(c=(c=a.protoMsg)==null||(c=c.msgId)==null?void 0:c.externalId)!=null?c:a.messageId,thread_id:a.threadId,trace_id:a.traceId}})})}function e(a){void k.onReady(function(b){b.log(function(){var b;return{labyrinth_version:0,message_id:(b=(b=a.protoMsg)==null||(b=b.msgId)==null?void 0:b.externalId)!=null?b:a.messageId,thread_id:a.threadId,trace_id:a.traceId}})})}g.BackupActionMap=l;g.logEBFalcoTaskIssued=a;g.logEBFalcoTaskFailure=b;g.logEBFalcoTaskSkipped=d;g.logEBFalcoEncryptedBackupUploadSuccess=e}),98);
__d("LSBackupContentType",[],(function(a,b,c,d,e,f){a=Object.freeze({MESSAGE:1,THREAD:2});f["default"]=a}),66);
__d("LSEncryptedBackupsAttachmentErrorCode",[],(function(a,b,c,d,e,f){a=Object.freeze({NO_ERROR:0,UNKNOWN_ERROR:1,MEDIA_TYPE_MISSING:2,PRODUCT_TYPE_MISSING:3,SERIALIZATION_ERROR:21});f["default"]=a}),66);
__d("LSPendingBackupStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({NEEDS_BACKUP:1,BACKUP_IN_PROGRESS:2,BLOCKED:3});f["default"]=a}),66);
__d("LSSerializeAttachmentBackupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][serializeAttachmentBackupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[2]=void 0,d[3]=c.i64.of_int32(a[0].length),c.i64.gt(d[3],c.i64.cast([0,0]))?c.loopAsync(d[3],function(e){return d[17]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[17]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(a){return d[20]=d[18].get("attachment_trace_id"),d[2]=d[20]}])}):c.resolve()},function(a){return d[2]!==void 0?c.nativeOperation(b("LSQplMarkPoint.nop"),c.i64.cast([0,637746317]),d[2],"LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure_start"):c.resolve()},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[17]=new c.Map(),d[17].set("error_msg","Expected a nonempty query result"),d[17].set("code",c.i64.cast([0,3])),d[17].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[18]=c.createArray(),d[19]=(d[18].push(d[17]),d[18]),e=[void 0,d[18]],d[4]=e[0],d[5]=e[1]):(b=a.item,d[17]=new c.Map(),d[17].set("backup_id",b.backupId),d[17].set("device_public_key_blob",b.devicePublicKeyBlob),d[17].set("device_private_key_blob",b.devicePrivateKeyBlob),d[17].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[17].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[17].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[17].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[17].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[17].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[17].set("orf_client_state_v2_blob",void 0),d[17].set("orf_v2_authority_level",void 0),d[17].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[17].set("device_id",b.deviceId),d[17].set("backup_tenancy",b.backupTenancy),d[17].set("encryption_version",b.encryptionVersion),d[17].set("revision_version",b.revisionVersion),d[17].set("initialize_restore_result",void 0),d[17].set("device_creation_timestamp_sec",void 0),d[17].set("authority_level",b.authorityLevel),e=[d[17],void 0],d[4]=e[0],d[5]=e[1])})},function(e){return d[7]=new c.Map(),d[7].set("value",d[4]),d[7].set("errors",d[5]),d[8]=d[7].get("value"),d[8]!==void 0?c.sequence([function(e){return d[17]=d[8].get("backup_id"),d[18]=d[8].get("device_public_key_blob"),d[19]=d[8].get("device_private_key_blob"),d[20]=d[8].get("epoch_storage_public_key_blob"),d[21]=d[8].get("epoch_storage_private_key_blob"),d[22]=d[8].get("epoch_auth_public_key_blob"),d[23]=d[8].get("epoch_auth_private_key_blob"),d[24]=d[8].get("mailbox_root_key_blob"),d[25]=d[8].get("ocmf_client_state_blob"),d[26]=d[8].get("orf_client_state_v2_blob"),d[27]=d[8].get("orf_v2_authority_level"),d[28]=d[8].get("oblivious_validation_token_blob"),d[29]=d[8].get("device_id"),d[30]=d[8].get("backup_tenancy"),d[31]=d[8].get("encryption_version"),d[32]=d[8].get("revision_version"),d[33]=d[8].get("initialize_restore_result"),d[34]=d[8].get("device_creation_timestamp_sec"),d[35]=d[8].get("authority_level"),c.i64.neq(d[29],void 0)?c.sequence([function(a){return d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[44]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[54]=(d[44].push(c.i64.cast([0,0])),d[44]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[46]?d[54]=(d[44].push(c.i64.cast([0,2])),d[44]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[54]=(d[44].push(c.i64.cast([0,3])),d[44]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[54]=(d[44].push(c.i64.cast([0,4])),d[44]):0,d[49]=c.createArray(),d[50]=c.i64.of_int32(d[44].length),c.i64.gt(d[50],c.i64.cast([0,0]))?c.loopAsync(d[50],function(a){return d[54]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[44],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[57]=(d[49].push(d[55]),d[49])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[54]=c.createArray(),d[55]=c.i64.of_int32(d[49].length),c.i64.gt(d[55],c.i64.cast([0,0]))?c.loopAsync(d[55],function(a){return d[57]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[49],d[57]).then(function(a){return a=a,d[58]=a[0],d[59]=a[1],a})},function(a){return d[60]=(d[54].push(c.i64.to_string(d[58])),d[54])}])}):c.resolve()},function(a){return d[56]=d[54].join(","),d[51]=d[56]}])},function(a){return d[49].some(function(a){return c.i64.eq(d[31],a)})?d[52]=d[31]:d[52]=void 0,c.i64.neq(d[52],void 0)?d[53]=d[52]:d[53]=void 0,d[39]=d[53]}])},function(e){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[30],void 0)?d[41]=d[30]:d[41]=c.i64.cast([0,1]),c.i64.eq(a[4],c.i64.cast([0,0]))?c.sequence([function(e){return d[44]=c.createArray(),d[45]=c.i64.of_int32(a[0].length),c.i64.gt(d[45],c.i64.cast([0,0]))?c.loopAsync(d[45],function(e){return d[61]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[61]).then(function(a){return a=a,d[62]=a[0],d[63]=a[1],a})},function(a){return d[64]=d[62].get("media_type"),d[65]=d[62].get("zippy_object_id"),d[66]=d[65],c.like(d[66],"%.%")||c.like(d[66],"%\ufffd%")?(d[86]=["Object ID: ",d[66]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure] ",d[86]].join("")),d[85]=c.createArray(),void 0!==void 0?d[87]=(d[85].push(void 0),d[85]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",d[86],d[85],c.i64.cast([0,4]))):c.resolve()},function(e){return d[67]=d[62].get("attachment_trace_id"),d[68]=c.createArray(),d[85]=(d[68].push(c.i64.to_string(d[17])),d[68]),d[85]=(d[68].push(d[66]),d[68]),d[69]=c.toJSON(d[68]),d[70]=c.createArray(),d[85]=(d[70].push(a[1]),d[70]),d[85]=(d[70].push(d[66]),d[70]),d[71]=c.toJSON(d[70]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[69]).then(function(a){return a=a,d[72]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),d[72]).then(function(a){return a=a,d[73]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[73]).then(function(a){return a=a,d[74]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[74]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[71]).then(function(a){return a=a,d[76]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[76]).then(function(a){return a=a,d[77]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[77]).then(function(a){return a=a,d[78]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[78]).then(function(a){return a=a,d[79]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),d[69]).then(function(a){return a=a,d[80]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),d[80]).then(function(a){return a=a,d[81]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[81]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[82]).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[84]=new c.Map(),d[84].set("attachment_index_key",d[75]==null?"":d[75]),d[84].set("media_type",d[64]),d[84].set("zippy_object_id",d[66]),d[84].set("attachment_trace_id",d[67]),d[84].set("salt_partial_access_token",d[79]==null?"":d[79]),d[84].set("salt_partial_attachment_index_key",d[83]==null?"":d[83]),d[85]=(d[44].push(d[84]),d[44])}])}):c.resolve()},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWVzc2FnZV9pZF9zY29wZQ=="),d[46]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[50]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),d[50]).then(function(a){return a=a,d[51]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[2]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("dGhyZWFkX2lkX3Njb3Bl"),d[54]).then(function(a){return a=a,d[55]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[25],d[55]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(b){return d[58]=new c.Map(),d[58].set("attachment_infos",d[44]),d[58].set("message_partial_id",d[49]==null?"":d[49]),d[58].set("product_type",a[3]),d[58].set("salt_partial_id",d[53]==null?"":d[53]),d[58].set("thread_partial_id",d[57]==null?"":d[57]),d[59]=c.toJSON(d[58]),d[60]=new c.Map(),d[60].set("payload",d[59]),b=[d[60],void 0],d[42]=b[0],d[43]=b[1]}]):c.sequence([function(e){return a[5]!==void 0?d[44]=a[5]:d[44]="",d[45]=".",d[47]=["LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",d[45],d[44],d[45],c.i64.to_string(c.i64.cast([-1,4294967295]))].join(""),d[2]!==void 0?d[47]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,637746317]),d[2],"attachment_error",d[47]):c.resolve():c.resolve()},function(a){return d[46]=new c.Map(),d[46].set("error_code",c.i64.cast([-1,4294967295])),d[46].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),d[46].set("error_message",d[44]),a=[void 0,d[46]],d[42]=a[0],d[43]=a[1]}])},function(a){return a=[d[42],d[43]],d[36]=a[0],d[37]=a[1],a}]):c.sequence([function(a){return d[38]=".",d[40]=["LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",d[38],"Error while reading client state",d[38],c.i64.to_string(c.i64.cast([0,24]))].join(""),d[2]!==void 0?d[40]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,637746317]),d[2],"attachment_error",d[40]):c.resolve():c.resolve()},function(a){return d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,24])),d[39].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),d[39].set("error_message",""),a=[void 0,d[39]],d[36]=a[0],d[37]=a[1]}])},function(a){return a=[d[36],d[37]],d[9]=a[0],d[10]=a[1],a}]):c.sequence([function(a){return d[17]=d[7].get("errors"),d[18]=d[7].get("errors"),d[19]=".",d[21]=["LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",d[19],"Error while reading client state",d[19],c.i64.to_string(c.i64.cast([0,1]))].join(""),d[2]!==void 0?d[21]!==void 0?c.nativeOperation(b("LSQplAnnotateString.nop"),c.i64.cast([0,637746317]),d[2],"attachment_error",d[21]):c.resolve():c.resolve()},function(a){return d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,1])),d[20].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),d[20].set("error_message",""),a=[void 0,d[20]],d[9]=a[0],d[10]=a[1]}])},function(a){return d[11]=c.i64.of_float(Date.now()),d[12]=c.i64.random(),d[14]="Finishing execution. Execution time: ",d[15]=c.i64.to_string(c.i64.sub(d[11],d[0])),d[16]=" ms",d[13]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][serializeAttachmentBackupPayload] ",d[13],d[14],d[13],d[15],d[13],d[16]].join("")),c.i64.eq(c.i64.mod_(d[12],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[17]=",",d[18]=c.createArray(),void 0!==void 0?d[19]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"serializeAttachmentBackupPayload",[d[14],d[17],d[15],d[17],d[16]].join(""),d[18],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[9],d[10]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSSerializeAttachmentBackupPayloadStoredProcedure",["LSSerializeAttachmentBackupPayload","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSSerializeAttachmentBackupPayload"),e.attachmentInfos,e.messageId,e.threadId,e.productType,e.error,e.errorMessage);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSWriteToPendingProtobufBackupsContextV2",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(305).add({pk:void 0,pendingBackupTaskId:a[0],actThreadId:a[1],toplevelOfflineThreadingId:a[2],supplementalOfflineThreadingId:a[3],messageTimestampMs:a[6],backupAction:a[7],supplementalKey:a[5],attachmentPayload:a[8],senderId:a[9],deletionOfflineThreadingId:a[4]})},function(a){return b.resolve(c)}])}a.__sproc_name__="LSEncryptedBackupsWriteToPendingProtobufBackupsContextV2StoredProcedure";a.__tables__=["pending_protobuf_backups_context"];e.exports=a}),null);
__d("LSIssueMessageBackup",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIssueNewTaskAndGetTaskID","LSLogMebClientEvent.nop","LSSerializeAttachmentBackupPayload","LSWriteToPendingProtobufBackupsContextV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][issueMessageBackup] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[15]=new c.Map(),d[15].set("error_msg","Expected a nonempty query result"),d[15].set("code",c.i64.cast([0,3])),d[15].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[16]=c.createArray(),d[17]=(d[16].push(d[15]),d[16]),e=[void 0,d[16]],d[2]=e[0],d[3]=e[1]):(b=a.item,d[15]=new c.Map(),d[15].set("backup_id",b.backupId),d[15].set("device_public_key_blob",b.devicePublicKeyBlob),d[15].set("device_private_key_blob",b.devicePrivateKeyBlob),d[15].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[15].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[15].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[15].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[15].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[15].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[15].set("orf_client_state_v2_blob",void 0),d[15].set("orf_v2_authority_level",void 0),d[15].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[15].set("device_id",b.deviceId),d[15].set("backup_tenancy",b.backupTenancy),d[15].set("encryption_version",b.encryptionVersion),d[15].set("revision_version",b.revisionVersion),d[15].set("initialize_restore_result",void 0),d[15].set("device_creation_timestamp_sec",void 0),d[15].set("authority_level",b.authorityLevel),e=[d[15],void 0],d[2]=e[0],d[3]=e[1])})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[15]=d[6].get("backup_id"),d[16]=d[6].get("device_public_key_blob"),d[17]=d[6].get("device_private_key_blob"),d[18]=d[6].get("epoch_storage_public_key_blob"),d[19]=d[6].get("epoch_storage_private_key_blob"),d[20]=d[6].get("epoch_auth_public_key_blob"),d[21]=d[6].get("epoch_auth_private_key_blob"),d[22]=d[6].get("mailbox_root_key_blob"),d[23]=d[6].get("ocmf_client_state_blob"),d[24]=d[6].get("orf_client_state_v2_blob"),d[25]=d[6].get("orf_v2_authority_level"),d[26]=d[6].get("oblivious_validation_token_blob"),d[27]=d[6].get("device_id"),d[28]=d[6].get("backup_tenancy"),d[29]=d[6].get("encryption_version"),d[30]=d[6].get("revision_version"),d[31]=d[6].get("initialize_restore_result"),d[32]=d[6].get("device_creation_timestamp_sec"),d[33]=d[6].get("authority_level"),c.i64.neq(d[27],void 0)?c.sequence([function(a){return d[36]=void 0,c.i64.neq(d[36],void 0)?c.resolve(d[37]=d[36]):c.sequence([function(a){return d[48]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[58]=(d[48].push(c.i64.cast([0,0])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[58]=(d[48].push(c.i64.cast([0,2])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[51]=a[0],a})},function(a){return d[51]?d[58]=(d[48].push(c.i64.cast([0,3])),d[48]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]?d[58]=(d[48].push(c.i64.cast([0,4])),d[48]):0,d[53]=c.createArray(),d[54]=c.i64.of_int32(d[48].length),c.i64.gt(d[54],c.i64.cast([0,0]))?c.loopAsync(d[54],function(a){return d[58]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[48],d[58]).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return d[61]=(d[53].push(d[59]),d[53])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[58]=c.createArray(),d[59]=c.i64.of_int32(d[53].length),c.i64.gt(d[59],c.i64.cast([0,0]))?c.loopAsync(d[59],function(a){return d[61]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],d[61]).then(function(a){return a=a,d[62]=a[0],d[63]=a[1],a})},function(a){return d[64]=(d[58].push(c.i64.to_string(d[62])),d[58])}])}):c.resolve()},function(a){return d[60]=d[58].join(","),d[55]=d[60]}])},function(a){return d[53].some(function(a){return c.i64.eq(d[29],a)})?d[56]=d[29]:d[56]=void 0,c.i64.neq(d[56],void 0)?d[57]=d[56]:d[57]=void 0,d[37]=d[57]}])},function(e){var f;return c.i64.neq(d[37],void 0)?d[38]=d[37]:d[38]=c.i64.cast([0,0]),c.i64.neq(d[28],void 0)?d[39]=d[28]:d[39]=c.i64.cast([0,1]),c.sequence([function(e){return a[11]!==void 0?c.sequence([function(e){return d[50]=a[11].get("attachment_infos"),d[51]=a[11].get("attachment_infos"),d[52]=a[11].get("product_type"),d[53]=a[11].get("error"),d[54]=a[11].get("error_message"),c.storedProcedure(b("LSSerializeAttachmentBackupPayload"),d[51],a[1],a[0],d[52],d[53],d[54]).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return d[55]?d[57]=!1:d[57]=!0,d[57]?c.sequence([function(a){return d[56]?d[63]=!1:d[63]=!0,d[63]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] Invalid Attachment payload generated"),d[68]="Invalid Attachment payload generated",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ","",d[68]].join("")),d[67]=c.createArray(),void 0!==void 0?d[69]=(d[67].push(void 0),d[67]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[68],d[67],c.i64.cast([0,3]))},function(a){return a=[void 0,void 0,d[50]],d[64]=a[0],d[65]=a[1],d[66]=a[2],a}]):c.resolve((a=[void 0,d[56],d[50]],d[64]=a[0],d[65]=a[1],d[66]=a[2],a))},function(a){return a=[d[64],d[65],d[66]],d[58]=a[0],d[59]=a[1],d[60]=a[2],a}]):c.resolve((d[63]=d[55].get("payload"),a=[d[63],void 0,d[50]],d[58]=a[0],d[59]=a[1],d[60]=a[2]))},function(b){return d[63]=new c.Map(),d[64]=d[63].set("success",d[58]),d[65]=d[63].set("failure",d[59]),d[66]=d[63].set("upload_context",d[60]),d[67]=c.toJSON(d[63]),d[61]=d[67],d[62]=a[11].get("error"),b=[d[61],d[62]],d[48]=b[0],d[49]=b[1]}]):c.resolve((function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] Null Attachments for the message"),e=[void 0,void 0],d[48]=e[0],d[49]=e[1]))},function(a){return a=[d[48],d[49]],d[40]=a[0],d[41]=a[1],a}])},function(e){return d[46]=c.i64.add(c.i64.mul(c.i64.div(a[2],c.i64.cast([0,1e3])),c.i64.cast([0,1e3])),c.i64.div(c.i64.mod_(c.i64.and_(c.i64.asr_(c.i64.from_string(a[1]),c.i64.to_int32(c.i64.cast([0,22]))),c.i64.cast([511,4294967295])),c.i64.cast([0,1e5])),c.i64.cast([0,100]))),a[9]!==void 0?(d[48]=a[9].get("backup_action"),c.i64.eq(d[48],c.i64.cast([0,4]))?d[49]=a[2]:d[49]=d[46],d[42]=d[49]):d[42]=d[46],d[47]=["Sort Key (",c.i64.to_string(d[42]),") is not in MS. ","auth_ts (",c.i64.to_string(a[2]),"), otid (",a[1],")"].join(""),c.i64.lt(d[42],c.i64.cast([2,1410065408]))?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ","",d[47]].join("")),d[48]=c.createArray(),void 0!==void 0?d[49]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[47],d[48],c.i64.cast([0,3]))):c.i64.gt(c.i64.sub(d[42],c.i64.cast([249,3468343296])),c.i64.cast([255,4294967295]))?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ","",d[47]].join("")),d[48]=c.createArray(),void 0!==void 0?d[49]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[47],d[48],c.i64.cast([0,3]))):c.resolve()},function(e){return d[43]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["eb_upload",":",a[0]].join(""),c.i64.cast([0,50026]),"",void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),c.i64.cast([0,93]),void 0,c.i64.le(c.i64.cast([0,0]),c.i64.cast([0,0]))?c.i64.cast([0,0]):c.i64.add(d[43],c.i64.sub(c.i64.cast([0,0]),c.i64.mod_(d[43],c.i64.cast([0,0])))),c.i64.cast([0,0])).then(function(a){return a=a,d[44]=a[0],a})},function(b){return c.db.table(177).add({pk:void 0,pendingBackupTaskId:d[44],actionType:c.i64.cast([0,1]),contentType:c.i64.cast([0,1]),backupStatus:c.i64.cast([0,1]),listKey:a[0],uniqueKey:a[1],sortKey:c.i64.to_string(d[42]),persistentId:"",isInstamadillo:a[12],echoContent:a[4],lsTraceId:a[5],error:a[6],echoEncodingLatencyNs:a[7],errorMessage:a[8],attachmentPayload:d[40],attachmentErrorCode:d[41]})},function(b){return c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,1]))?c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,1]))?(d[48]=c.createArray(),d[50]=(d[48].push("Successfully issued message backup task. act thread id = "),d[48]),d[50]=(d[48].push(a[0]),d[48]),d[50]=(d[48].push(", otid = "),d[48]),d[50]=(d[48].push(a[1]),d[48]),d[49]=d[48].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[49]].join("")),c.resolve()):(d[48]=c.createArray(),d[50]=(d[48].push("Successfully issued message remove task. act thread id = "),d[48]),d[50]=(d[48].push(a[0]),d[48]),d[50]=(d[48].push(", otid = "),d[48]),d[50]=(d[48].push(a[1]),d[48]),d[49]=d[48].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[49]].join("")),c.resolve()):(d[48]=c.createArray(),d[50]=(d[48].push("Successfully issued thread remove task. act thread id = "),d[48]),d[50]=(d[48].push(a[0]),d[48]),d[49]=d[48].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[49]].join("")),c.resolve())},function(e){return a[9]!==void 0?c.sequence([function(e){return d[48]=a[9].get("act_thread_id"),d[49]=a[9].get("backup_action"),d[50]=a[9].get("toplevel_offline_threading_id"),d[51]=a[9].get("supplemental_offline_threading_id"),d[52]=a[9].get("message_timestamp_ms"),d[53]=a[9].get("supplemental_key"),d[54]=a[9].get("attachment_payload"),d[55]=a[9].get("extra_data_for_eb_upload"),d[56]=a[9].get("message_protobuf"),d[57]=a[9].get("deletion_offline_threading_id"),c.storedProcedure(b("LSWriteToPendingProtobufBackupsContextV2"),d[44],d[48],d[50],d[51],d[57],d[53],d[52],d[49],d[54],void 0,d[56],d[55])},function(e){return d[58]=a[9].get("backup_action"),c.i64.neq(d[42],a[2])?(d[60]=["Sort key (",c.i64.to_string(d[42]),") and authoritative_ts (",c.i64.to_string(a[2]),") are not equal given OTID (",a[1],") for event type: ",c.i64.to_string(d[58])].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ",d[60]].join("")),d[59]=c.createArray(),void 0!==void 0?d[61]=(d[59].push(void 0),d[59]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[60],d[59],c.i64.cast([0,4]))):c.resolve()}]):c.i64.neq(d[42],a[2])?(d[49]=["Sort key (",c.i64.to_string(d[42]),") and authoritative_ts (",c.i64.to_string(a[2]),") are not equal given OTID (",a[1],") for event type: ",c.i64.to_string(c.i64.cast([-1,4294967295]))].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueMessageBackupStoredProcedure] ",d[49]].join("")),d[48]=c.createArray(),void 0!==void 0?d[50]=(d[48].push(void 0),d[48]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueMessageBackupStoredProcedure",d[49],d[48],c.i64.cast([0,4]))):c.resolve()},function(a){return d[45]=new c.Map(),d[45].set("task_id",d[44]),a=[d[45],void 0],d[34]=a[0],d[35]=a[1]}]):c.sequence([function(b){return d[36]=c.createArray(),d[39]=(d[36].push("Skipping the message upload since EB is disabled. act thread id = "),d[36]),d[39]=(d[36].push(a[0]),d[36]),d[39]=(d[36].push(", otid = "),d[36]),d[39]=(d[36].push(a[1]),d[36]),d[37]=d[36].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[37]].join("")),c.resolve()},function(a){return d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,24])),d[38].set("stored_procedure","LSEncryptedBackupsIssueMessageBackupStoredProcedure"),d[38].set("error_message",""),a=[void 0,d[38]],d[34]=a[0],d[35]=a[1]}])},function(a){return a=[d[34],d[35]],d[7]=a[0],d[8]=a[1],a}]):c.sequence([function(b){return d[15]=d[5].get("errors"),d[16]=d[5].get("errors"),d[17]=c.createArray(),d[20]=(d[17].push("Skipping the message upload since EB is disabled. act thread id = "),d[17]),d[20]=(d[17].push(a[0]),d[17]),d[20]=(d[17].push(", otid = "),d[17]),d[20]=(d[17].push(a[1]),d[17]),d[18]=d[17].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ","",d[18]].join("")),c.resolve()},function(a){return d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,1])),d[19].set("stored_procedure","LSEncryptedBackupsIssueMessageBackupStoredProcedure"),d[19].set("error_message",""),a=[void 0,d[19]],d[7]=a[0],d[8]=a[1]}])},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageBackup] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"issueMessageBackup",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[7],d[8]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueMessageBackupStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_backups_context_v2"];e.exports=a}),null);
__d("LSIssueMessageBackupStoredProcedure",["LSIssueMessageBackup","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueMessageBackup"),e.actThreadId,e.otid,e.authoritativeTs,e.source,e.echoDocument,e.traceId,e.error,e.echoEncodingLatencyNs,e.errorMessage,e.protobufBackupContext,e.tamThreadSubtype,e.attachmentBackupContext,e.isInstamadillo);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSIssueMessageRemove",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIssueNewTaskAndGetTaskID","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][issueMessageRemove] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[15]=new c.Map(),d[15].set("error_msg","Expected a nonempty query result"),d[15].set("code",c.i64.cast([0,3])),d[15].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[16]=c.createArray(),d[17]=(d[16].push(d[15]),d[16]),e=[void 0,d[16]],d[2]=e[0],d[3]=e[1]):(b=a.item,d[15]=new c.Map(),d[15].set("backup_id",b.backupId),d[15].set("device_public_key_blob",b.devicePublicKeyBlob),d[15].set("device_private_key_blob",b.devicePrivateKeyBlob),d[15].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[15].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[15].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[15].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[15].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[15].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[15].set("orf_client_state_v2_blob",void 0),d[15].set("orf_v2_authority_level",void 0),d[15].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[15].set("device_id",b.deviceId),d[15].set("backup_tenancy",b.backupTenancy),d[15].set("encryption_version",b.encryptionVersion),d[15].set("revision_version",b.revisionVersion),d[15].set("initialize_restore_result",void 0),d[15].set("device_creation_timestamp_sec",void 0),d[15].set("authority_level",b.authorityLevel),e=[d[15],void 0],d[2]=e[0],d[3]=e[1])})},function(e){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(e){return d[15]=d[6].get("backup_id"),d[16]=d[6].get("device_public_key_blob"),d[17]=d[6].get("device_private_key_blob"),d[18]=d[6].get("epoch_storage_public_key_blob"),d[19]=d[6].get("epoch_storage_private_key_blob"),d[20]=d[6].get("epoch_auth_public_key_blob"),d[21]=d[6].get("epoch_auth_private_key_blob"),d[22]=d[6].get("mailbox_root_key_blob"),d[23]=d[6].get("ocmf_client_state_blob"),d[24]=d[6].get("orf_client_state_v2_blob"),d[25]=d[6].get("orf_v2_authority_level"),d[26]=d[6].get("oblivious_validation_token_blob"),d[27]=d[6].get("device_id"),d[28]=d[6].get("backup_tenancy"),d[29]=d[6].get("encryption_version"),d[30]=d[6].get("revision_version"),d[31]=d[6].get("initialize_restore_result"),d[32]=d[6].get("device_creation_timestamp_sec"),d[33]=d[6].get("authority_level"),c.i64.neq(d[27],void 0)?c.sequence([function(a){return d[36]=void 0,c.i64.neq(d[36],void 0)?c.resolve(d[37]=d[36]):c.sequence([function(a){return d[43]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[44]?d[53]=(d[43].push(c.i64.cast([0,0])),d[43]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[45]?d[53]=(d[43].push(c.i64.cast([0,2])),d[43]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return d[46]?d[53]=(d[43].push(c.i64.cast([0,3])),d[43]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[53]=(d[43].push(c.i64.cast([0,4])),d[43]):0,d[48]=c.createArray(),d[49]=c.i64.of_int32(d[43].length),c.i64.gt(d[49],c.i64.cast([0,0]))?c.loopAsync(d[49],function(a){return d[53]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[43],d[53]).then(function(a){return a=a,d[54]=a[0],d[55]=a[1],a})},function(a){return d[56]=(d[48].push(d[54]),d[48])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[53]=c.createArray(),d[54]=c.i64.of_int32(d[48].length),c.i64.gt(d[54],c.i64.cast([0,0]))?c.loopAsync(d[54],function(a){return d[56]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[48],d[56]).then(function(a){return a=a,d[57]=a[0],d[58]=a[1],a})},function(a){return d[59]=(d[53].push(c.i64.to_string(d[57])),d[53])}])}):c.resolve()},function(a){return d[55]=d[53].join(","),d[50]=d[55]}])},function(a){return d[48].some(function(a){return c.i64.eq(d[29],a)})?d[51]=d[29]:d[51]=void 0,c.i64.neq(d[51],void 0)?d[52]=d[51]:d[52]=void 0,d[37]=d[52]}])},function(e){return c.i64.neq(d[37],void 0)?d[38]=d[37]:d[38]=c.i64.cast([0,0]),c.i64.neq(d[28],void 0)?d[39]=d[28]:d[39]=c.i64.cast([0,1]),d[40]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSIssueNewTaskAndGetTaskID"),["eb_upload",":",a[0]].join(""),c.i64.cast([0,50026]),"",void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),c.i64.cast([0,93]),void 0,c.i64.le(c.i64.cast([0,0]),c.i64.cast([0,0]))?c.i64.cast([0,0]):c.i64.add(d[40],c.i64.sub(c.i64.cast([0,0]),c.i64.mod_(d[40],c.i64.cast([0,0])))),c.i64.cast([0,0])).then(function(a){return a=a,d[41]=a[0],a})},function(b){return c.db.table(177).add({pk:void 0,pendingBackupTaskId:d[41],actionType:c.i64.cast([0,2]),contentType:c.i64.cast([0,1]),backupStatus:c.i64.cast([0,1]),listKey:a[0],uniqueKey:a[1],sortKey:c.i64.to_string(c.i64.add(c.i64.mul(c.i64.div(a[2],c.i64.cast([0,1e3])),c.i64.cast([0,1e3])),c.i64.div(c.i64.mod_(c.i64.and_(c.i64.asr_(c.i64.from_string(a[1]),c.i64.to_int32(c.i64.cast([0,22]))),c.i64.cast([511,4294967295])),c.i64.cast([0,1e5])),c.i64.cast([0,100])))),persistentId:"",isInstamadillo:!1,lsTraceId:a[4],error:a[5]})},function(b){return c.i64.eq(c.i64.cast([0,1]),c.i64.cast([0,1]))?c.i64.eq(c.i64.cast([0,2]),c.i64.cast([0,1]))?(d[43]=c.createArray(),d[45]=(d[43].push("Successfully issued message backup task. act thread id = "),d[43]),d[45]=(d[43].push(a[0]),d[43]),d[45]=(d[43].push(", otid = "),d[43]),d[45]=(d[43].push(a[1]),d[43]),d[44]=d[43].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[44]].join("")),c.resolve()):(d[43]=c.createArray(),d[45]=(d[43].push("Successfully issued message remove task. act thread id = "),d[43]),d[45]=(d[43].push(a[0]),d[43]),d[45]=(d[43].push(", otid = "),d[43]),d[45]=(d[43].push(a[1]),d[43]),d[44]=d[43].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[44]].join("")),c.resolve()):(d[43]=c.createArray(),d[45]=(d[43].push("Successfully issued thread remove task. act thread id = "),d[43]),d[45]=(d[43].push(a[0]),d[43]),d[44]=d[43].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[44]].join("")),c.resolve())},function(a){return d[42]=new c.Map(),d[42].set("task_id",d[41]),a=[d[42],void 0],d[34]=a[0],d[35]=a[1]}]):c.sequence([function(b){return d[36]=c.createArray(),d[39]=(d[36].push("Skipping message upload since EB is disabled. act thread id = "),d[36]),d[39]=(d[36].push(a[0]),d[36]),d[39]=(d[36].push(", otid = "),d[36]),d[39]=(d[36].push(a[1]),d[36]),d[37]=d[36].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[37]].join("")),c.resolve()},function(a){return d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,24])),d[38].set("stored_procedure","LSEncryptedBackupsIssueMessageRemoveStoredProcedure"),d[38].set("error_message",""),a=[void 0,d[38]],d[34]=a[0],d[35]=a[1]}])},function(a){return a=[d[34],d[35]],d[7]=a[0],d[8]=a[1],a}]):c.sequence([function(b){return d[15]=d[5].get("errors"),d[16]=d[5].get("errors"),d[17]=c.createArray(),d[20]=(d[17].push("Skipping message upload since EB is disabled. act thread id = "),d[17]),d[20]=(d[17].push(a[0]),d[17]),d[20]=(d[17].push(", otid = "),d[17]),d[20]=(d[17].push(a[1]),d[17]),d[18]=d[17].join(void 0||""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ","",d[18]].join("")),c.resolve()},function(a){return d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,1])),d[19].set("stored_procedure","LSEncryptedBackupsIssueMessageRemoveStoredProcedure"),d[19].set("error_message",""),a=[void 0,d[19]],d[7]=a[0],d[8]=a[1]}])},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][issueMessageRemove] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"issueMessageRemove",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[7],d[8]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueMessageRemoveStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","pending_backups_context_v2"];e.exports=a}),null);
__d("LSIssueMessageRemoveStoredProcedure",["LSIssueMessageRemove","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueMessageRemove"),e.actThreadId,e.otid,e.authoritativeTs,e.source,e.traceId,e.error);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSTamThreadSubtype",[],(function(a,b,c,d,e,f){a=Object.freeze({STANDARD:0,VANISH_MODE:1,DUAL_SEND_SHADOW:2,BTV_COMPANION:3,BLEND_DUAL_SEND:4,BLEND_DUAL_SEND_NO_NETWORK:5});f["default"]=a}),66);
__d("MAWBridgeUploadMessageHandler",["EBIsEbEnabled","EncryptedBackupsWriteToMPSTables","FBLogger","I64","LSDataTraceCheckPoint","LSEncryptedBackupsAttachmentErrorCode","LSFactory","LSIntEnum","LSIssueMessageBackupStoredProcedure","LSIssueMessageRemoveStoredProcedure","LSMEBTaskCreationSource","LSShape","LSTamThreadSubtype","LSVec","MAWCastToMsgrServerMediaType","MAWEBFrontendQPLLogger","MAWMsgType","MAWTraceUtils","MWEBODSEntityName.enum","MWEBODSUtils","WATimeUtils","cr:17101","gkx","isInstamadillo","isInstamadilloEB"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function a(a,e){var f,g;if(c("isInstamadilloEB")())return Promise.resolve();var l=k(e.uploadTrackingInstanceKey);e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_tracking_bridge_handler");d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+((f=e.messageType)!=null?f:"unknown"));f=e.protoMsg;var m=e.traceId;g=((g=e.uploadTrackingInstanceKey)!=null?g:e.traceId).toString();if(!await d("EBIsEbEnabled").isEbEnabledLS(a,m,l)){if(e.uploadTrackingInstanceKey!=null){m=e.uploadTrackingInstanceKey;d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(m,"user_device_not_enrolled_invalid_echo_request");d("MAWEBFrontendQPLLogger").endEBUploadTracking(m)}d("MAWTraceUtils").recordCheckpointForTrace(g,(h||(h=d("LSIntEnum"))).ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_UPLOAD_USER_DEVICE_NOT_ENROLLED),[],!1);d("MAWTraceUtils").recordInvalidUploadRequestAndFlushTrace(g,h.ofNumber(c("LSDataTraceCheckPoint").LABYRINTH_WEB_ECHO_MESSAGE_UPLOAD_INVALID_REQUEST),[]);return}m=e.echoDocument;var n=d("WATimeUtils").castMilliSecondsToUnixTime(e.sortOrderMs);if(e.actionType===1){var o=e.echoEncodingLatencyNs,p=e.errorCode,q=e.errorMessage;e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"issuing_message_backup");var r;if(f!=null)try{var s=f.sortOrderMs;if(s==null)throw c("FBLogger")("messenger_web").mustfixThrow("sort order is null for the protobuf message");await d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(a,f,e.threadId,!1,l);r=d("LSShape").ofRecord({act_thread_id:e.threadId,attachment_payload:null,backup_action:(h||(h=d("LSIntEnum"))).ofNumber(f.backupActionType),message_timestamp_ms:(i||(i=d("I64"))).of_float(s),supplemental_key:f.supplementalKey,toplevel_offline_threading_id:(s=(l=f.originalMsgProtocolId)==null?void 0:l.externalId)!=null?s:f.msgId.externalId})}catch(a){a instanceof Error?c("FBLogger")("wmi_eb").catching(a).mustfix("[labyrinth_web] Error writing to MPSTables for the upload message due to runtime error"):c("FBLogger")("wmi_eb").mustfix("[labyrinth_web] Error writing to MPSTables for the upload message")}var t;if(e.attachmentBackupContext!=null){l=j({bridgeUploadAttachmentBackupContext:e.attachmentBackupContext,messageId:e.messageId,serverThreadKey:null,threadId:e.threadId,traceId:e.traceId});l!=null&&(t=d("LSShape").ofRecord(l))}e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_handler_echo_protobuf_context",{bool:{attachment_backup_context:t!=null,protobuf_context:r!=null}});if(e.messageType!=null){s=d("MAWMsgType").isMAWSupportedMediaType(e.messageType)?"media":"non-media";d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+s)}t!=null&&d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.attachment_unified_backup");await c("LSIssueMessageBackupStoredProcedure")(c("LSFactory")(a),{actThreadId:e.threadId,attachmentBackupContext:t,authoritativeTs:(i||(i=d("I64"))).of_float(n*1e3),echoDocument:m!=null?m:"",echoEncodingLatencyNs:o!=null?(i||(i=d("I64"))).of_float(o):void 0,error:p!=null?(h||(h=d("LSIntEnum"))).ofNumber(p):void 0,errorMessage:q!=null?q:void 0,isInstamadillo:c("isInstamadillo")(),otid:e.messageId,protobufBackupContext:r,source:(h||(h=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").TAM),tamThreadSubtype:h.ofNumber(c("isInstamadillo")()?c("LSTamThreadSubtype").BLEND_DUAL_SEND:c("LSTamThreadSubtype").STANDARD),traceId:g});e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_tracking_upload_task_issued");void b("cr:17101").log(function(){return{message_id:e.messageId,trace_id:e.traceId}})}else e.actionType===2&&(await c("LSIssueMessageRemoveStoredProcedure")(c("LSFactory")(a),{actThreadId:e.threadId,authoritativeTs:(i||(i=d("I64"))).of_float(n*1e3),otid:e.messageId,source:(h||(h=d("LSIntEnum"))).ofNumber(c("LSMEBTaskCreationSource").TAM),traceId:g}),e.uploadTrackingInstanceKey!=null&&d("MAWEBFrontendQPLLogger").addPointEBUploadTracking(e.uploadTrackingInstanceKey,"upload_tracking_remove_task_issued"))}function j(a){var b;if(!c("gkx")("6956"))return void 0;var e=a.bridgeUploadAttachmentBackupContext,f=a.messageId,g=a.serverThreadKey,i=a.threadId;a=a.traceId;if(e.attachmentInfos.length===0)return;var j=e.attachmentInfos;d("MAWEBFrontendQPLLogger").startFlowUploadAttachmentBackup({deliveryObjectId:j[0].zippyObjectId,flow:"unified",mediaType:(b=d("MAWCastToMsgrServerMediaType").castMediaAttachmentTypeToServerMediaType(j[0].mediaType))!=null?b:"unknown",messageId:f,threadId:i,traceId:a});b=c("LSVec").ofArray(j.map(function(a){return d("LSShape").ofRecord({attachment_trace_id:a.attachmentTraceId,media_type:a.mediaType,zippy_object_id:a.zippyObjectId})}));f=(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR);e.error!=null&&(f=(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR));i={attachment_infos:b,error:f,error_message:null,product_type:e.productType,server_thread_key:g};return i}function k(a){return a==null?null:d("MAWEBFrontendQPLLogger").makeEBFrontendQplFlowFromInstanceKey(a)}g.call=a;g.getMessageUploadAttachmentBackupContext=j}),98);
__d("MAWUploadPayloadGenerator",["EBLogger","EBParseUploadSerializationPayload","I64","LSBackupContentType","LSEncryptedBackupsAttachmentErrorCode","LSFactory","LSIntEnum","LSPendingBackupStatus","LSSerializeAttachmentBackupPayloadStoredProcedure","LSShape","LSTaskSerializerEncryptedBackupsUpload","LSVec","MAWBridgeUploadMessageHandler","MAWEBFrontendQPLLogger","MWEBODSUtils","Random","ReQL","WAErrorMessage","WAGetSafeQPLError","WAResultOrError","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("EBLogger").EBLogger().tags(["MAWUploadPayloadGenerator"]),m="0",n=new Set();function o(){for(var a=0;a<1e8;a++){var b=d("Random").uint32();if(!n.has(b))return b}throw l.mustfixThrow("Unable to generate a unique task ID after 100 million attempts")}async function a(a,b,e){var f="unknown";c("justknobx")._("4439")&&(f=await t(a)?"available":"unavailable");b=b.map(function(b){try{var c=o();n.add(c);return d("WAResultOrError").makeResult({msg:b,taskMetadata:p(a,b,c)})}catch(a){c=d("WAErrorMessage").maybeGetMessageFromError(a);return d("WAResultOrError").makeError({error:c,instanceKey:b.uploadTrackingInstanceKey})}});b=await Promise.all(b.map(function(a){return a.success?a.value:null}).filter(Boolean));b=await Promise.all(b.map(function(b){var g=b.taskMetadata;return g.then(function(g){var i;d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((i=g.uploadTrackingInstanceKey)!=null?i:null,"upload_task_serialization_start",{string:{base_epoch_availability:f,execution_environment:e}});return c("LSTaskSerializerEncryptedBackupsUpload")((j||(j=d("I64"))).of_int32(g.task),c("LSFactory")(a)).then(function(f){if(f.length>0&&f[0]!=null){var h=d("EBParseUploadSerializationPayload").parseUploadSerializationResponse(f[0]);if(h.success){h=h.value;var i=!1;h.failure!=null&&(i=!0,d("EBParseUploadSerializationPayload").logUploadSerializationErrors([h.failure],"echo",e,g.uploadTrackingInstanceKey));if(h.protobuf_failures!=null){h=c("LSVec").toArray(h.protobuf_failures).filter(Boolean);h.length>0&&(i=!0,d("EBParseUploadSerializationPayload").logUploadSerializationErrors(h,"protobuf",e,g.uploadTrackingInstanceKey))}if(!i){d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((h=g.uploadTrackingInstanceKey)!=null?h:null,"upload_task_serialization_success",{string:{execution_environment:e}})}}}i=g.pending_protobuf_backups_context_pk;return Promise.all([a.pending_backups_context_v2.delete(g.pending_backups_context_v2_pk),i!=null?a.pending_protobuf_backups_context.delete(i):Promise.resolve(null)]).then(function(){n.delete(g.task);return d("WAResultOrError").makeResult({msg:b.msg,payload:f[0]})})}).catch(function(a){var c,f=d("WAErrorMessage").maybeGetMessageFromError(a);d("MAWEBFrontendQPLLogger").addPointEBUploadTracking((c=g.uploadTrackingInstanceKey)!=null?c:null,"upload_task_serialization_failure",{string:{serialization_error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}});l.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["EB upload serializer error: "," in ",""])),d("WAGetSafeQPLError").getSafeQPLErrorMessage(a),e);return d("WAResultOrError").makeError({error:f,instanceKey:b.msg.uploadTrackingInstanceKey})})})}));return b}async function p(a,b,e){var f,g,h=b.sortOrderMs.toString(),m=(j||(j=d("I64"))).of_int32(e),n=j.of_float(b.actionType),o=await r(a,b),p=b.protoMsg,q=p==null||(f=p.originalMsgProtocolId)==null?void 0:f.externalId,t=p==null||(g=p.msgId)==null?void 0:g.externalId,u=p!=null&&c("gkx")("8488");if(!u&&(b.echoDocument==null||b.echoDocument.length===0)){var v;l.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["upload message is missing echo document msgType: ",""])),(v=b.messageType)!=null?v:"unknown");d("MWEBODSUtils").markODSForEB("upload","missing_echo_document."+((v=b.messageType)!=null?v:"unknown"))}n=await a.pending_backups_context_v2.add({actionType:n,attachmentErrorCode:s(b),attachmentPayload:o,backupStatus:(k||(k=d("LSIntEnum"))).ofNumber(c("LSPendingBackupStatus").BACKUP_IN_PROGRESS),contentType:k.ofNumber(c("LSBackupContentType").MESSAGE),echoContent:u?"":(v=b.echoDocument)!=null?v:"",listKey:b.threadId,pendingBackupTaskId:j.of_int32(e),persistentId:"",pk:m,sortKey:h,uniqueKey:b.messageId});if(p==null)return{pending_backups_context_v2_pk:n[0],task:e,uploadTrackingInstanceKey:b.uploadTrackingInstanceKey};m={actThreadId:b.threadId,attachmentPayload:o,backupAction:j.of_float(p.backupActionType),messageTimestampMs:j.of_float(b.sortOrderMs),pendingBackupTaskId:j.of_float(e),supplementalKey:p.supplementalKey,toplevelOfflineThreadingId:p.backupActionType===4?p.msgId.externalId:(v=(u=p.originalMsgProtocolId)==null?void 0:u.externalId)!=null?v:p.msgId.externalId};p.backupActionType===2&&q!=null&&t!=null&&q!==t&&(m=babelHelpers.extends({},m,{supplementalOfflineThreadingId:t}));if(p.backupActionType===4){o=(h=p.originalMsgProtocolId)==null?void 0:h.externalId;m=babelHelpers.extends({},m,{deletionOfflineThreadingId:o})}u=await a.pending_protobuf_backups_context.add(m);return{pending_backups_context_v2_pk:n[0],pending_protobuf_backups_context_pk:u[0],task:e,uploadTrackingInstanceKey:b.uploadTrackingInstanceKey}}function q(a){if(a.attachmentInfos.length!==1)return[];a=a.attachmentInfos[0];return[{attachment_trace_id:a.attachmentTraceId,media_type:a.mediaType,zippy_object_id:a.zippyObjectId}]}async function r(a,b){if(!c("gkx")("6956"))return void 0;var e,f,g=b.attachmentBackupContext;if(g!=null){f=d("MAWBridgeUploadMessageHandler").getMessageUploadAttachmentBackupContext({bridgeUploadAttachmentBackupContext:g,messageId:b.messageId,serverThreadKey:null,threadId:b.threadId,traceId:b.traceId});if(f!=null){a=await c("LSSerializeAttachmentBackupPayloadStoredProcedure")(c("LSFactory")(a),{attachmentInfos:f.attachment_infos,error:f.error,errorMessage:f.error_message,messageId:b.messageId,productType:f.product_type,threadId:b.threadId});f=a[0];b=a[1];if(f!=null){a=d("LSShape").toRecord(f);e=JSON.stringify({success:a.payload,upload_context:q(g)})}else if(b!=null){f=d("LSShape").toRecord(b);a=f.error_code;e=JSON.stringify({failure:{error_code:(j||(j=d("I64"))).to_float(a),error_message:f.error_message,stored_procedure:f.stored_procedure},upload_context:q(g)})}}}return e}function s(a){return!c("gkx")("6956")?void 0:(j||(j=d("I64"))).of_float(((a=a.attachmentBackupContext)==null?void 0:a.error)!=null?c("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR:c("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR)}function t(a){var b=new TextDecoder();return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.secure_encrypted_backups_epochs).filter(function(a){return b.decode(a.epochAnonIdBlob)===m})).then(function(a){if(a!=null)return!0;else return!1})}g.genUploadPayload=a}),98);
__d("XFBEBDeviceEpochStatus.facebook",["$InternalEnum"],(function(a,b,c,d,e,f){a=b("$InternalEnum").Mirrored(["INELIGIBLE_FOR_LABYRINTH_11","NO_OPEN_EPOCH","OK","OUTDATED","RATE_LIMITED"]);c=a;f["default"]=c}),66);
__d("EBUploadMessagesFromWorkerMutation",["EBBucketUtils","EBIsEbEnabled","EBLS","EBUploadMessagesFromWorkerMutation.graphql","EncryptedBackupsWriteToMPSTables","FBLogger","I64","LSEBPayloadSerializerError","LSFactory","LSHandleBackupWriteResultV2StoredProcedure","LSPrepareOpenEpochV2StoredProcedure","LSShape","LSSyncEpochsStoredProcedure","LSVec","MAWCurrentUser","MAWEBFalcoLoggerUtils","MAWEBUploadTrackingUtils","MAWUploadPayloadGenerator","MWEBODSEntityName.enum","ODS","WAErrorMessage","WALogger","WAResultOrError","createWorkerMutation"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=h!==void 0?h:h=b("EBUploadMessagesFromWorkerMutation.graphql");function p(a,b){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").addPointWorkerOnly(a.uploadTrackingInstanceKey,b)})}function q(a,b){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").addAnnotationsForEBWorkerQplFlow(a.uploadTrackingInstanceKey,b)})}function r(a,b,c){a.forEach(function(a){a.uploadTrackingInstanceKey!=null&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(a.uploadTrackingInstanceKey,b,c)})}async function s(a){var b=a.backupWriteResult,e=a.deviceEpochStatus,g=a.exception_string,h=a.inputMessages;if(b==null){r(h,"ebls_upload_failed_backup_write_result_null",{string:{error:"backupWriteResult is null"}});d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backupWriteResult is null"])));return d("WAResultOrError").makeError("backup_write_result_null")}a=await d("EBLS").getLSStorage();var j=b.is_success,k=b.delete_mailbox,l=(b=b.protobuf_params)==null?void 0:b.delete_on_success;if(j!=null&&k!=null){if(!j){r(h,"ebls_upload_failed",{string:{error:g}});return d("WAResultOrError").makeError("gql_upload_failed")}else c("FBLogger")("wmi_eb").info("Worker successfully completed GQL upload batch of size %s",h.length),p(h,"ebls_upload_success");await a.runInTransaction(function(a){return c("LSHandleBackupWriteResultV2StoredProcedure")(c("LSFactory")(a),{deleteMailbox:k,isSuccess:j,protobufParams:l!=null?d("LSShape").ofRecord({delete_on_success:l}):void 0,traceIds:c("LSVec").ofArray(h.map(function(a){return a.traceId}))})},"readwrite",void 0,void 0,f.id+":172")}if(e==null)return d("WAResultOrError").makeError("device_epoch_status_null");switch(e){case"NO_OPEN_EPOCH":p(h,"prepare_open_epoch_v2_start");await a.runInTransaction(function(a){return c("LSPrepareOpenEpochV2StoredProcedure")(c("LSFactory")(a),{backupId:void 0})},"readwrite",void 0,void 0,f.id+":196");p(h,"prepare_open_epoch_v2_end");break;case"OUTDATED":p(h,"sync_epochs_start");await a.runInTransaction(function(a){return c("LSSyncEpochsStoredProcedure")(c("LSFactory")(a))},"readonly",void 0,void 0,f.id+":207");p(h,"sync_epochs_start");break;case"OK":break;default:}return d("WAResultOrError").makeResult()}async function a(a){try{(m||(m=d("ODS"))).bumpEntityKey(7319,c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"worker_thread");p(a,"ebls_init_start");await d("EBLS").init();var b=await d("EBLS").getLSStorage();p(a,"ebls_backup_tenancy_start");var e={bool:{is_main_thread:!1},int:{batch_size:a.length},string:{batch_bucket:d("EBBucketUtils").getBucketName(a.length,100,10)}};q(a,e);if(!await d("EBIsEbEnabled").isEbEnabledLS(b.tables)){for(e of a)if(e.uploadTrackingInstanceKey!=null){var g=e.uploadTrackingInstanceKey;d("MAWEBUploadTrackingUtils").addPointWorkerOnly(g,"user_device_not_enrolled_invalid_gql_request");var h=e.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskSkipped(e,h,"user_device_not_enrolled");d("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(g,"upload_tracking_completed")}return d("WAResultOrError").makeError("ebls_not_initialized")}p(a,"ebls_upload_start");var i;try{i=await b.runInTransaction(async function(b){p(a,"ebls_lsdb_write_start");var e=await Promise.all(a.map(function(a){var e=a.protoMsg,f=a.threadId,g=a.uploadTrackingInstanceKey;if(e==null)return null;g=g!=null?d("MAWEBUploadTrackingUtils").makeEBWorkerQplFlowFromInstanceKey(g):null;e=e.backupActionType===1?Promise.all([d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(b,e,f,!1,g),d("EncryptedBackupsWriteToMPSTables").writeTagsToMPSTables(b,e,f)]).then(function(a){var b=a[0];a[1];return b}):d("EncryptedBackupsWriteToMPSTables").writeToMPSTables(b,e,f,!1,g);return e.then(function(b){if(!b.success){var e=a.uploadTrackingInstanceKey;b=b.error;var f=b.errorCode;b=b.errorMsg;e!=null&&(t(f)?d("MAWEBUploadTrackingUtils").endCancelWorkerOnly(e,{int:{errorCode:f!=null?(n||(n=d("I64"))).to_float(f):c("LSEBPayloadSerializerError").UNKNOWN},string:{error:b}}):d("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"mps_write_failed",{string:{error:b}}));return null}return a})})).then(function(a){return a.filter(Boolean)});p(a,"ebls_mps_write_complete");return d("MAWUploadPayloadGenerator").genUploadPayload(b,e,"worker").then(function(a){return a.map(function(a){if(!a.success){var b=a.error,c=b.error;b=b.instanceKey;b!=null&&d("MAWEBUploadTrackingUtils").endFailWorkerOnly(b,"ebls_payload_generation_failed",{string:{error:c}});return null}return a.value}).filter(Boolean)})},"readwrite",void 0,void 0,f.id+":268"),p(a,"ebls_upload_payload_generated")}catch(b){h=d("WAErrorMessage").maybeGetMessageFromError(b);r(a,"ebls_upload_failed_payload",{string:{error:h}});d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to generate payload: ",""])),h);return d("WAResultOrError").makeError("upload_serialization_failure")}if(i.length===0){r(a,"ebls_upload_payload_empty");return d("WAResultOrError").makeResult()}g=i.map(function(a){return a.msg});g.forEach(function(b){var a=b.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskIssued(b,a)});e=c("createWorkerMutation")(o);b=e[0];h=await b({input:{app_id_str:d("MAWCurrentUser").getAppID(),payload:{msg_payloads:i.map(function(a){return a.payload}).filter(Boolean)}}});p(g,"ebls_received_gql_upload_response");if(h==null){r(g,"ebls_upload_failed_response_null");d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphqlResponse is null"])));g.forEach(function(b){var a=b.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(b,a,"ebls_not_initialized")});return d("WAResultOrError").makeError("gql_upload_null_response")}b=(e=h.xfb_upload_encrypted_msg_to_backup)!=null?e:{};h=b.backup_write_result_response;e=b.device_epoch_status;b=b.exception_string;var u=await s({backupWriteResult:h,deviceEpochStatus:e,exception_string:b,inputMessages:g});!u.success?g.forEach(function(b){var a=b.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(b,a,u.error)}):g.forEach(function(a){d("MAWEBFalcoLoggerUtils").logEBFalcoEncryptedBackupUploadSuccess(a)});return u}catch(b){h=d("WAErrorMessage").maybeGetMessageFromError(b);r(a,"ebls_upload_failed_response",{string:{error:h}});a.forEach(function(b){var a=b.echoDocument!=null?"dual_upload":"protobuf_only";d("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(b,a,"ebls_not_initialized")});d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to upload with EBLS: ",""])),b);return d("WAResultOrError").makeError("gql_upload_runtime_error")}}function t(a){switch(a){case c("LSEBPayloadSerializerError").SKIP_MPS_WRITE_DUE_TO_HIGHER_TIMESTAMP_AVAILABILITY:case c("LSEBPayloadSerializerError").MESSAGE_ALREADY_DELETED:return!0;default:return!1}return!1}g.uploadMessagesFromWorker=a}),98);
__d("EncryptedBackupTaskSkippedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5727");b=d("FalcoLoggerInternal").create("encrypted_backup_task_skipped",a);e=b;g["default"]=e}),98);
__d("ReverbWriteFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5829");b=d("FalcoLoggerInternal").create("reverb_write_failure",a);e=b;g["default"]=e}),98);
__d("ReverbWriteSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5831");b=d("FalcoLoggerInternal").create("reverb_write_success",a);e=b;g["default"]=e}),98);
__d("WASmaxInAbPropsIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","error");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQErrorResponseMixin=a}),98);
__d("WASmaxInAbPropsIQErrorBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","bad-request");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",400);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorBadRequestMixin=a}),98);
__d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","feature-not-implemented");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",501);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorFeatureNotImplementedMixin=a}),98);
__d("WASmaxInAbPropsNoRetryErrors",["WAResultOrError","WASmaxInAbPropsIQErrorBadRequestMixin","WASmaxInAbPropsIQErrorFeatureNotImplementedMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInAbPropsIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:b.value});var c=d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin").parseIQErrorFeatureNotImplementedMixin(a);return c.success?d("WAResultOrError").makeResult({name:"IQErrorFeatureNotImplemented",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorBadRequest","IQErrorFeatureNotImplemented"],[b,c])}g.parseNoRetryErrors=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry",["WAResultOrError","WASmaxInAbPropsIQErrorResponseMixin","WASmaxInAbPropsNoRetryErrors","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInAbPropsNoRetryErrors").parseNoRetryErrors(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorNoRetryErrors:b.value}))}g.parseGetExperimentConfigResponseErrorNoRetry=a}),98);
__d("WASmaxInAbPropsIQErrorInternalServerErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","internal-server-error");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",500);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorInternalServerErrorMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry",["WAResultOrError","WASmaxInAbPropsIQErrorInternalServerErrorMixin","WASmaxInAbPropsIQErrorResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInAbPropsIQErrorInternalServerErrorMixin").parseIQErrorInternalServerErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorIQErrorInternalServerErrorMixin:c.value},a.value))}g.parseGetExperimentConfigResponseErrorRetry=a}),98);
__d("WASmaxInAbPropsExperimentConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxParseUtils").attrIntRange(a,"config_code",1,void 0);if(!b.success)return b;var c=d("WASmaxParseUtils").attrString(a,"config_value");if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"config_expo_key",0,void 0);return!a.success?a:d("WAResultOrError").makeResult({configCode:b.value,configValue:c.value,configExpoKey:a.value})}g.parseExperimentConfigMixin=a}),98);
__d("WASmaxInAbPropsSamplingConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxParseUtils").attrIntRange(a,"event_code",1,void 0);if(!b.success)return b;a=d("WASmaxParseUtils").attrIntRange(a,"sampling_weight",-1e4,1e4);return!a.success?a:d("WAResultOrError").makeResult({eventCode:b.value,samplingWeight:a.value})}g.parseSamplingConfigMixin=a}),98);
__d("WASmaxInAbPropsConfigs",["WAResultOrError","WASmaxInAbPropsExperimentConfigMixin","WASmaxInAbPropsSamplingConfigMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInAbPropsExperimentConfigMixin").parseExperimentConfigMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"ExperimentConfig",value:b.value});var c=d("WASmaxInAbPropsSamplingConfigMixin").parseSamplingConfigMixin(a);return c.success?d("WAResultOrError").makeResult({name:"SamplingConfig",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["ExperimentConfig","SamplingConfig"],[b,c])}g.parseConfigs=a}),98);
__d("WASmaxInAbPropsIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","result");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQResultResponseMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseSuccess",["WAResultOrError","WASmaxInAbPropsConfigs","WASmaxInAbPropsIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxInAbPropsConfigs").parseConfigs(a);return!b.success?b:d("WAResultOrError").makeResult({configs:b.value})}function i(a){var b=d("WASmaxParseUtils").assertTag(a,"erid");if(!b.success)return b;b=d("WASmaxParseUtils").contentBytesRange(a,1,100);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"props");if(!c.success)return c;var e=d("WASmaxParseUtils").optionalChildWithTag(a,"erid",i);if(!e.success)return e;var f=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,c.value,"protocol","1");if(!f.success)return f;var g=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrString,c.value,"ab_key");if(!g.success)return g;var j=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrString,c.value,"hash");if(!j.success)return j;var k=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,c.value,"refresh",0,void 0);if(!k.success)return k;var l=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,c.value,"refresh_id",0,void 0);if(!l.success)return l;a=d("WASmaxInAbPropsIQResultResponseMixin").parseIQResultResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxParseUtils").mapChildrenWithTag(c.value,"prop",0,Infinity,h);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({propsProtocol:f.value,propsAbKey:g.value,propsHash:j.value,propsRefresh:k.value,propsRefreshId:l.value},a.value,{erid:e.value,propsProp:b.value}))}g.parseGetExperimentConfigResponseSuccessPropsProp=h;g.parseGetExperimentConfigResponseSuccessErid=i;g.parseGetExperimentConfigResponseSuccess=a}),98);
__d("WASmaxOutAbPropsBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{id:d("WAWap").generateId(),type:"get"});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeBaseIQGetRequestMixin=a}),98);
__d("WASmaxOutAbPropsGetExperimentConfigRequest",["WASmaxAttrs","WASmaxJsx","WASmaxOutAbPropsBaseIQGetRequestMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){a=a.propsHash;a=d("WASmaxOutAbPropsBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",{xmlns:"abt",to:d("WAWap").S_WHATSAPP_NET},d("WASmaxJsx").smax("props",{protocol:"1",hash:d("WASmaxAttrs").OPTIONAL(d("WAWap").CUSTOM_STRING,a)})));return a}g.makeGetExperimentConfigRequest=a}),98);
__d("WASmaxAbPropsGetExperimentConfigRPC",["WAComms","WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry","WASmaxInAbPropsGetExperimentConfigResponseErrorRetry","WASmaxInAbPropsGetExperimentConfigResponseSuccess","WASmaxOutAbPropsGetExperimentConfigRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a,b){a=d("WASmaxOutAbPropsGetExperimentConfigRequest").makeGetExperimentConfigRequest(a);b=await d("WAComms").sendSmaxStanza(a,b);var c=d("WASmaxInAbPropsGetExperimentConfigResponseSuccess").parseGetExperimentConfigResponseSuccess(b,a);if(c.success)return{name:"GetExperimentConfigResponseSuccess",value:c.value};var e=d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry").parseGetExperimentConfigResponseErrorNoRetry(b,a);if(e.success)return{name:"GetExperimentConfigResponseErrorNoRetry",value:e.value};b=d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry").parseGetExperimentConfigResponseErrorRetry(b,a);if(b.success)return{name:"GetExperimentConfigResponseErrorRetry",value:b.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("GetExperimentConfig",{Success:c,ErrorNoRetry:e,ErrorRetry:b}))}g.sendGetExperimentConfigRPC=a}),98);
__d("WAGetAbPropsProtocol",["WALogger","WAResultOrError","WASmaxAbPropsGetExperimentConfigRPC"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a){a=await d("WASmaxAbPropsGetExperimentConfigRPC").sendGetExperimentConfigRPC({propsHash:a});if(a.name==="GetExperimentConfigResponseSuccess"){var b=a.value,c=b.propsAbKey,e=b.propsHash,f=b.propsRefresh,g=b.propsRefreshId,j=b.propsProp;b=b.erid;j=i(j);var k=j.newProps;j=j.samplingConfigs;return d("WAResultOrError").makeResult({abKey:c,hash:e,refresh:f,refreshId:g,props:k,samplingConfigs:j,erid:b==null?void 0:b.elementValue})}d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["getAbPropsProtocol failed ",""])),a.value);return d("WAResultOrError").makeError()}function i(a){var b=[],c=[];a.forEach(function(a){a=a.configs;if(a.name==="ExperimentConfig"){var d;b.push({configCode:a.value.configCode,configValue:a.value.configValue,configExpoKey:(d=a.value.configExpoKey)==null?void 0:d.toString()})}else a.name==="SamplingConfig"&&c.push({eventCode:a.value.eventCode,samplingWeight:a.value.samplingWeight})});return{newProps:b,samplingConfigs:c}}g.getAbPropsProtocol=a}),98);
__d("WAAbPropsSync",["WAAbProps","WAAbPropsHelpers","WAGetAbPropsProtocol","WALogger","WAPromiseManagement","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;b=d("WAPromiseManagement").cacheWhilePending(function(){return"abProps"},a);function a(a){var b=a.sendHash;b=b===void 0?!0:b;var c=a.eventFlow;c==null||c.addPoint("sync_ab_props",{bool:{sendHash:b}});return b==null||b===!1?l(null,c):d("WAAbProps").getHash().then(function(a){return l(a,c)})}c=a;async function l(a,b){b==null||b.addPoint("fetch_ab_props");a=await d("WAGetAbPropsProtocol").getAbPropsProtocol(a);if(!a.success)d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["fetchAbProps failed"])));else{a=a.value;var c=a.abKey,e=a.hash,f=a.refresh;a=a.props;a=d("WAAbPropsHelpers").parseAbProps(d("WAAbProps").getConfig(),a);b==null||b.addPoint("save_ab_props");b=await m(c,e,f,a);b.success===!1&&(b.error,d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["syncAbProps: detected no hash"]))))}c=await d("WAAbProps").getRefreshSecs();return{seconds:c}}async function m(a,b,c,e){var f=await d("WAAbProps").getAbProps();a={abKey:a!=null?a:f.abKey,hash:b!=null?b:f.hash,refresh:d("WAAbPropsHelpers").maybeUpdateRefresh(c),lastSyncTime:d("WATimeUtils").unixTime(),propValues:f.propValues,propExpoKeys:f.propExpoKeys,internalExpoKeys:f.internalExpoKeys,expoKeyStr:f.expoKeyStr};if(b==null){await d("WAAbProps").setAbProps(a);d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: detected no hash"])));return d("WAResultOrError").makeError("noHash")}d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: updating ab configs"])));c=e.values;b=e.expoKeys;e=d("WAAbPropsHelpers").maybeUpdatePropValues(c,f.propValues,d("WAAbProps").getConfig());c=d("WAAbPropsHelpers").maybeUpdateExpoKeys(b,f.propExpoKeys,d("WAAbProps").getConfig());b=c.propExpoKeys;c=c.expoKeysToDelete;var g,h;c=d("WAAbPropsHelpers").maybeUpdateInternalExpoKeys(c,f.internalExpoKeys);c!=null&&(g=c.internalExpoKeys,h=c.expoKeyStr);await d("WAAbProps").setAbProps(babelHelpers.extends({},a,{propValues:e,propExpoKeys:b,internalExpoKeys:g,expoKeyStr:h}));return d("WAResultOrError").makeResult()}g.syncAbProps=b;g.syncAbPropsDebug=c}),98);
__d("WACheckCiphertextInServer",["WAHttpResumeCheck","WAMediaUrl","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){return e.run(async function(e,f){e=d("WAMediaUrl").buildUploadUrl(a,c,b,e.domain,f,!0);f=await d("WAHttpResumeCheck").httpResumeCheck(e);if(f.success)return d("WAResultOrError").makeResult(f);else{e=f.error;switch(e){case"server-timeout":case"unspecified-http-error":return d("WAResultOrError").makeError({progressMade:!0});default:return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(e))}}}).then(function(a){return a!=null?a:d("WAResultOrError").makeError("max-attempts-exceeded")})}g.checkCiphertextInServer=a}),98);
__d("WAIsMediaKeyReusable",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=2*d("WATimeUtils").DAY_SECONDS;function a(a){var b=Math.floor(Math.random()*d("WATimeUtils").DAY_SECONDS);return a!=null&&d("WATimeUtils").happenedWithin(a,h+b)}g.MMS_MEDIA_KEY_TTL=h;g.isMediaKeyReusable=a}),98);
__d("WAFindReusableMediaEntry",["WAIsMediaKeyReusable","WAMediaUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=["fileEncSha256","mediaKey","mediaKeyTimestamp","uploadToken"];function a(a,b){if(a==null)return null;b=b.get(a);if(b==null)return null;a=d("WAMediaUtils").decodeMediaEntryData(b);b=a.fileEncSha256;var c=a.mediaKey,e=a.mediaKeyTimestamp,f=a.uploadToken;a=babelHelpers.objectWithoutPropertiesLoose(a,h);return c!=null&&f!=null&&b!=null&&e!=null&&d("WAIsMediaKeyReusable").isMediaKeyReusable(e)?babelHelpers["extends"]({},a,{fileEncSha256:b,mediaKey:c,mediaKeyTimestamp:e,uploadToken:f}):null}g.findReusableMediaEntryForArmadillo=a}),98);
__d("WASmaxInDevicesFetchSelfResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup").parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup:b.value}))}g.parseFetchSelfResponseError=a}),98);
__d("WASmaxInDevicesDeviceInfoMixin",["WAResultOrError","WASmaxInDevicesIdentityKeyMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"platform");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function i(a){var b=d("WASmaxParseUtils").assertTag(a,"manufacturer");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function j(a){var b=d("WASmaxParseUtils").assertTag(a,"model");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function k(a){var b=d("WASmaxParseUtils").assertTag(a,"seen");if(!b.success)return b;b=d("WASmaxParseUtils").contentInt(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function l(a){var b=d("WASmaxParseUtils").assertTag(a,"creation");if(!b.success)return b;b=d("WASmaxParseUtils").contentInt(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function m(a){var b=d("WASmaxParseUtils").assertTag(a,"ip");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function n(a){var b=d("WASmaxParseUtils").assertTag(a,"location");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"latitude");if(!b.success)return b;var c=d("WASmaxParseUtils").attrString(a,"longitude");if(!c.success)return c;a=d("WASmaxParseUtils").contentString(a);return!a.success?a:d("WAResultOrError").makeResult({latitude:b.value,longitude:c.value,elementValue:a.value})}function a(a){var b=d("WASmaxParseUtils").assertTag(a,"device");if(!b.success)return b;b=d("WASmaxParseUtils").optionalChildWithTag(a,"platform",h);if(!b.success)return b;var c=d("WASmaxParseUtils").optionalChildWithTag(a,"manufacturer",i);if(!c.success)return c;var e=d("WASmaxParseUtils").optionalChildWithTag(a,"model",j);if(!e.success)return e;var f=d("WASmaxParseUtils").optionalChildWithTag(a,"seen",k);if(!f.success)return f;var g=d("WASmaxParseUtils").optionalChildWithTag(a,"creation",l);if(!g.success)return g;var o=d("WASmaxParseUtils").optionalChildWithTag(a,"ip",m);if(!o.success)return o;var p=d("WASmaxParseUtils").optionalChildWithTag(a,"location",n);if(!p.success)return p;var q=d("WASmaxParseUtils").attrIntRange(a,"id",1,999);if(!q.success)return q;a=d("WASmaxInDevicesIdentityKeyMixin").parseIdentityKeyMixin(a);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({id:q.value},a.value,{platform:b.value,manufacturer:c.value,model:e.value,seen:f.value,creation:g.value,ip:o.value,location:p.value}))}g.parseDeviceInfoPlatform=h;g.parseDeviceInfoManufacturer=i;g.parseDeviceInfoModel=j;g.parseDeviceInfoSeen=k;g.parseDeviceInfoCreation=l;g.parseDeviceInfoIp=m;g.parseDeviceInfoLocation=n;g.parseDeviceInfoMixin=a}),98);
__d("WASmaxInDevicesFetchSelfResponseSuccess",["WAResultOrError","WASmaxInDevicesDeviceInfoMixin","WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"device");if(!b.success)return b;b=d("WASmaxInDevicesDeviceInfoMixin").parseDeviceInfoMixin(a);return!b.success?b:b}function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"self");if(!c.success)return c;a=d("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxParseUtils").mapChildrenWithTag(c.value,"device",1,25,h);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{selfDevice:b.value}))}g.parseFetchSelfResponseSuccessSelfDevice=h;g.parseFetchSelfResponseSuccess=a}),98);
__d("WASmaxOutDevicesFetchSelfRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQGetRequestMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(){var a=d("WASmaxOutDevicesBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},d("WASmaxJsx").smax("self",null)));return a}g.makeFetchSelfRequest=a}),98);
__d("WASmaxDevicesFetchSelfRPC",["WAComms","WASmaxInDevicesFetchSelfResponseError","WASmaxInDevicesFetchSelfResponseSuccess","WASmaxOutDevicesFetchSelfRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a){var b=d("WASmaxOutDevicesFetchSelfRequest").makeFetchSelfRequest();a=await d("WAComms").sendSmaxStanza(b,a);var c=d("WASmaxInDevicesFetchSelfResponseSuccess").parseFetchSelfResponseSuccess(a,b);if(c.success)return{name:"FetchSelfResponseSuccess",value:c.value};a=d("WASmaxInDevicesFetchSelfResponseError").parseFetchSelfResponseError(a,b);if(a.success)return{name:"FetchSelfResponseError",value:a.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("FetchSelf",{Success:c,Error:a}))}g.sendFetchSelfRPC=a}),98);
__d("WAGetCurrentUserDeviceList",["WAAssertUnreachable","WAGlobals","WAJids","WALogger","WAPersistedJobManager","WASignalKeys","WASmaxDevicesFetchSelfRPC","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){if(a.isCurrentDevice&&b.isCurrentDevice){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Two devices were detected as isCurrentDevice in getCurrentUserDeviceList"])));return 0}if(a.isCurrentDevice)return-1;if(b.isCurrentDevice)return 1;if(a.lastSeen!=null&&b.lastSeen==null)return-1;if(a.lastSeen==null&&b.lastSeen!=null)return 1;if(a.lastSeen!=null&&b.lastSeen!=null){a=a.lastSeen;b=b.lastSeen;return b.getTime()-a.getTime()}return 0}async function a(a){a=await d("WASmaxDevicesFetchSelfRPC").sendFetchSelfRPC();switch(a.name){case"FetchSelfResponseError":var b=a.value.errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup;switch(b.name){case"RetryableIQError":var e=b.value.backoff;if(e!=null)throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{delay:e,type:"constant"},jitter:0});else throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{first:d("WATimeUtils").HOUR_MILLISECONDS/60,type:"exponential"},jitter:.1});default:b.name;e=b.value.code;throw c("err")("Failed with an error code "+e)}case"FetchSelfResponseSuccess":var f=d("WAJids").extractDeviceId(d("WAGlobals").getMyDeviceJid());return a.value.selfDevice.map(function(a){var b=a.creation,c=a.elementValue,e=a.id,g=a.ip,h=a.location,i=a.manufacturer,j=a.model,k=a.platform;a=a.seen;return{creationTime:b==null?null:d("WATimeUtils").toDate(d("WATimeUtils").castToUnixTime(b.elementValue)),id:d("WAJids").interpretAsDeviceId(e),identityKey:d("WASignalKeys").serializeIdentity(c),ipAddress:(b=g==null?void 0:g.elementValue)!=null?b:null,isCurrentDevice:e===f,lastSeen:a==null?null:d("WATimeUtils").toDate(d("WATimeUtils").castToUnixTime(a.elementValue)),latitude:h==null?null:parseFloat(h.latitude),location:(c=h==null?void 0:h.elementValue)!=null?c:null,longitude:h==null?null:parseFloat(h.longitude),manufacturer:(g=i==null?void 0:i.elementValue)!=null?g:null,model:(b=j==null?void 0:j.elementValue)!=null?b:null,platform:(e=k==null?void 0:k.elementValue)!=null?e:null}}).sort(i);default:return c("WAAssertUnreachable")(a.name)}}g.getCurrentUserDeviceList=a}),98);
__d("WASaveReceiptApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"saveReceipt",function(a){return function(b){return a.receipts.put({msgId:b.id.externalId.toString(),permittedIdentitiesPerDevice:b.permittedIdentitiesPerDevice,recipientDevices:b.recipientDevices,waMsgId:d("WAMsg").craftWAMsgIdString(b.id)}).then(function(){})}});g.saveReceipt=a}),98);
__d("WAPublishMessage",["FBLogger","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function j(a,b){var c=a.identities;a=a.messagePayload;a={author:a.protocolMsgId.author,chat:a.protocolMsgId.chat,externalId:a.protocolMsgId.externalId};var e=await d("WALoadReceiptApi").loadReceipt(a);if(e.success)return e.value;e=new Map();for(c of c){c[0];var f=c[1];for(f of f){var g=f[0],h=f[1];if(g===d("WAGlobals").getMyDeviceJid())continue;e.set(g,{pubKey:h})}}g=new Set();h={permittedIdentitiesPerDevice:e,recipientDevices:g,id:a};b.addPoint("save_receipts_start");await d("WASaveReceiptApi").saveReceipt(h);b.addPoint("save_receipts_end");return h}async function a(a,b){var e=a.messagePayload,f=a.identities;a=a.sendIdentity;a=a===void 0?!1:a;b.addPoint("prepare_receipt_start");f=await j({messagePayload:e,identities:f},b);b.addPoint("prepare_receipt_end");b.addPoint("calculate_recipients_start");var g=e.frankingKey,i=e.frankingVersion,m=e.messageBytes,n=e.backupDirective,o=e.messageType;e=e.protocolMsgId;f=k(f.permittedIdentitiesPerDevice);f=o.type==="text"&&o.invitedParticipantUserJid!=null?f.filter(function(a){return a.user===o.invitedParticipantUserJid||a.user===d("WAGlobals").getMyUserJid()}):f;b.addPoint("calculate_recipients_end",{int:{recipientsCount:f.length}});var p=o.type==="text"&&o.invitedParticipantUserJid!=null?o.invitedParticipantUserJid:e.chat,q=e.chat===d("WAGlobals").getMyUserJid();if(f.length===0&&!q)throw c("FBLogger")("wmi").mustfixThrow("Trying to send a message with no recipients");else if(f.length===0&&q)return{serverResponse:{type:"success",ts:d("WATimeUtils").unixTime(),phash:{type:"ok"},count:null,reportingMeta:null},encryption:{type:"user",messageTo:d("WAGlobals").getMyUserJid(),participants:[],phash:""}};q=a?await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return l(a)},{operationType:"get_my_device_identity",flush:!1,afterInit:!0}):null;a=await (o.isRevoked===!0?Promise.resolve(null):d("WAGenReportingMeta").genReportingMeta(m.bytes,g,i));p=await d("WASendMsgInternal").sendMessageV2({type:"chat",messageBytes:m,chat:p,deviceIdentity:q,messageType:o,protocolMsgId:e,externalId:e.externalId,recipients:f,reportingMeta:a,backupDirective:n},b);q=p.serverResponse;q.type==="success"&&await d("WASentBytesCache").sentBytesCache().saveSentBytes({ts:q.ts,frankingKey:g,frankingVersion:i,messageBytes:m,backupDirective:n,messageType:o,protocolMsgId:e,waMsgId:d("WAMsg").craftWAMsgIdString({author:e.author,chat:e.chat,externalId:e.externalId})}).catch(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""])),a)});return p}function k(a){var b=new Map();a.forEach(function(a,c){a=a.pubKey;var e=d("WAJids").extractUserJid(c);a={identity:a,jid:c};c=b.get(e)||[];c.push(a);b.set(e,c)});return Array.from(b,function(a){var b=a[0];a=a[1];return{devicesInfo:a,user:b}})}async function l(a){try{a=await a.storage.loadIdentities(d("WAGlobals").getMyUserJid());a=a.get(d("WAGlobals").getMyDeviceJid());if(a!=null)return a;throw c("err")("missing-identity")}catch(a){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""])),a)}}g.publishMessage=a}),98);
__d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestMixin","WASmaxInDevicesIQErrorItemNotFoundMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInDevicesIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:b.value});var c=d("WASmaxInDevicesIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(a);return c.success?d("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorBadRequest","IQErrorItemNotFound"],[b,c])}g.parseIQErrorBadRequestOrItemNotFoundMixinGroup=a}),98);
__d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup").parseIQErrorBadRequestOrItemNotFoundMixinGroup(a);return!b.success?b:d("WAResultOrError").makeResult({iQErrorBadRequestOrItemNotFoundMixinGroup:b.value})}g.parseNonRetryableRemoveDeviceIQErrorMixin=a}),98);
__d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup",["WAResultOrError","WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin","WASmaxInDevicesRetryableIQErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInDevicesRetryableIQErrorMixin").parseRetryableIQErrorMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"RetryableIQError",value:b.value});var c=d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin").parseNonRetryableRemoveDeviceIQErrorMixin(a);return c.success?d("WAResultOrError").makeResult({name:"NonRetryableRemoveDeviceIQError",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["RetryableIQError","NonRetryableRemoveDeviceIQError"],[b,c])}g.parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup=a}),98);
__d("WASmaxInDevicesRemoveResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup").parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup:b.value}))}g.parseRemoveResponseError=a}),98);
__d("WASmaxInDevicesRemoveResponseSuccess",["WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!c.success?c:c}g.parseRemoveResponseSuccess=a}),98);
__d("WASmaxOutDevicesKeyDataMixin",["WASmaxJsx","WASmaxMixins"],(function(a,b,c,d,e,f,g){function h(a){a=a.anyElementValue;a=d("WASmaxJsx").smax("smax$any",null,a);return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeKeyDataMixin=a}),98);
__d("WASmaxOutDevicesIdentityKeyMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutDevicesKeyDataMixin"],(function(a,b,c,d,e,f,g){function h(a){a=d("WASmaxJsx").smax("smax$any",null,d("WASmaxOutDevicesKeyDataMixin").mergeKeyDataMixin(d("WASmaxJsx").smax("identity",null),a));return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeIdentityKeyMixin=a}),98);
__d("WASmaxOutDevicesRemoveRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQSetRequestMixin","WASmaxOutDevicesIdentityKeyMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.removeId;a=a.identityKeyMixinArgs;b=d("WASmaxOutDevicesBaseIQSetRequestMixin").mergeBaseIQSetRequestMixin(d("WASmaxJsx").smax("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},d("WASmaxOutDevicesIdentityKeyMixin").mergeIdentityKeyMixin(d("WASmaxJsx").smax("remove",{id:d("WAWap").INT(b)}),a)));return b}g.makeRemoveRequest=a}),98);
__d("WASmaxDevicesRemoveRPC",["WAComms","WASmaxInDevicesRemoveResponseError","WASmaxInDevicesRemoveResponseSuccess","WASmaxOutDevicesRemoveRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a,b){a=d("WASmaxOutDevicesRemoveRequest").makeRemoveRequest(a);b=await d("WAComms").sendSmaxStanza(a,b);var c=d("WASmaxInDevicesRemoveResponseSuccess").parseRemoveResponseSuccess(b,a);if(c.success)return{name:"RemoveResponseSuccess",value:c.value};b=d("WASmaxInDevicesRemoveResponseError").parseRemoveResponseError(b,a);if(b.success)return{name:"RemoveResponseError",value:b.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("Remove",{Success:c,Error:b}))}g.sendRemoveRPC=a}),98);
__d("WARemoveDevice",["WALogger","WAPersistedJobManager","WAPushSafeTypes","WAResultOrError","WASignalOther","WASmaxDevicesRemoveRPC","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i;async function a(a,b){a=d("WAPushSafeTypes").unsafeNotNullable(b);b=a.deviceId;a=a.identity;d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["removeDevice called for device "," and identity ",""])),b,a);a=d("WASignalOther").sliceBytes(a,1,32);a=await d("WASmaxDevicesRemoveRPC").sendRemoveRPC({removeId:b,identityKeyMixinArgs:{anyElementValue:a}});d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["removeDevice result for ",": "," "])),b,a);if(a.name==="RemoveResponseSuccess")return d("WAResultOrError").makeResult();else{a.name;b=a.value.errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup;if(b.name!=="RetryableIQError")return d("WAResultOrError").makeError();b.name;a=b.value.backoff;if(a!=null)throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"constant",delay:a},jitter:0});else throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"exponential",first:d("WATimeUtils").HOUR_MILLISECONDS/60},jitter:.1})}}g.removeDevice=a}),98);
__d("WARemoveCurrentDevice",["WAGetCurrentUserDeviceInfoApi","WAGlobals","WALogger","WARemoveDevice","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=async function(a){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["removeCurrentDevice called for current device"])));var b=await d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();if(b==null){d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["There is no stored user info, it was already deleted or this job was called twice, possibly from another tab"])));return d("WAResultOrError").makeResult()}var c=b.deviceId;b=b.identityKey;a=await d("WARemoveDevice").removeDevice(a,{deviceId:c,identity:b});if(a.success){await d("WAGlobals").getDependencies().clearSignalAndTempStores();return d("WAResultOrError").makeResult()}return d("WAResultOrError").makeResult()};g.removeCurrentDevice=a}),98);
__d("WASendAppDataFanoutProtocol",["WAAsMessageApplication","WABridge","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=d("WATagsLogger").TAGS(["sendAppDataFanout"]),p=24;function a(a,b){a=b.contents;var c=b.externalId,e=b.permittedIdentitiesPerDevice;b=b.checkPhash;b=b===void 0?"checkPhash":b;return q(a,c,e,b).catch(function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);o.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to devices with error: ",""])),a);return d("WAResultOrError").makeError("runtime-error")})}async function q(a,b,c,e){e===void 0&&(e="checkPhash");o.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""])),b);a=d("WAConvertAppData").convertAppData(a);var f={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()),version:"v3"},g=[];a=Array.from(c.entries()).map(function(a){var b=a[0];a=a[1];return{identity:a.pubKey,jid:b}});c=p;a.length>c&&(o.WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to "," devices"])),a.length),o.ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to more than the allowed "," devices"])),c),a=a.slice(0,c));var h=[{devicesInfo:a,user:d("WAGlobals").getMyUserJid()}];c=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WAEncUserMsg").encryptUserMsg(h,{messageBytes:f,type:"appdata"},{cryptoManager:a})},{operationType:"encrypt",flush:!0});a=c.phash;var q=!1;c.participants!=null&&c.participants.forEach(function(a){a.type==="pkmsg"&&(q=!0),g.push({toJid:a.to,encTypeIndividualMixinArgs:{encType:a.type,encElementValue:a.ciphertext},encVersionFutureproofMixinArgs:{encV:parseInt(a.v,10)}})});c={appdataTo:d("WAGlobals").getMyUserJid(),toArgs:g};c={peerPeerFanout:c};var r=void 0;if(q){var s=await d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();s=s==null?void 0:s.identityKey;if(s==null){o.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"])));return d("WAResultOrError").makeError("no-public-identity")}r={deviceIdentityElementValue:s}}s={appdataDeviceListCheck:e==="checkPhash"?"true":"false"};e={appdataId:b,peerMsgTypesArgs:c,deviceIdentityMixinArgs:r,withDeviceListCheckMixinArgs:s};b=await d("WASmaxAppdataPublishPeerRPC").sendPeerRPC(e);switch(b.name){case"PeerResponseSuccess":r=(c=b.value.deviceListStaleMixin)==null?void 0:c.phash;if(r!=null&&a!=null&&r!==a){o.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"])),a,r);d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"});return d("WAResultOrError").makeResult({phashMismatch:!0,serverTs:d("WATimeUtils").castToUnixTime(b.value.t)})}else return d("WAResultOrError").makeResult({phashMismatch:!1,serverTs:d("WATimeUtils").castToUnixTime(b.value.t)});default:b.name;o.ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""])),b.value.error);return d("WAResultOrError").makeError("ack-failure")}}g.MAX_APPDATA_RECIPIENTS=p;g.sendAppDataToDevicesProtocol=a}),98);
__d("WASendMsgUtilV2",["WADevicesState","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WAResultOrError","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n;function o(a){return Promise.resolve()}function p(a,b){return d("WADevicesState").getDevicesState().waitForUserDevices(Array.from(new Set([a,d("WAGlobals").getMyUserJid()])),"GetDevicesBeforeSend: "+b)}function q(a,b){a=b.chatJid;var c=b.reason;return d("WAJids").switchOnChatJidType(a,{group:function(a){return o(a)},interopUser:function(a){return p(a,c)},lidUser:function(a){return p(a,c)},msgrUser:function(a){return p(a,c)},phoneUser:function(a){return p(a,c)}}).catch(function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Error during get devices before sending: ",""])),a);return Promise.resolve()})}async function r(a,b){var c=a.messagePayload;a=a.loadThreadParticipants;var e={author:c.protocolMsgId.author,chat:c.protocolMsgId.chat,externalId:c.protocolMsgId.externalId},f=await d("WALoadReceiptApi").loadReceipt(e);if(f.success)return f;b.addPoint("get_devices_before_send_start");await q(void 0,{chatJid:c.protocolMsgId.chat,reason:"prepareReceipt"});b.addPoint("get_devices_before_send_end");var g=await a(c.protocolMsgId.chat);b.addPoint("get_identities_start");f=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(g)},{flush:!1,afterInit:!0,operationType:"prepare_receipt_load_identities"});a=[];if(f.size===0)a=[].concat(g);else for(c of f){var h=c[0],j=c[1];j.size===0&&a.push(h)}a.length>0&&(await d("WADevicesState").getDevicesState().waitForUserDevices(a,"GetDevicesBeforeSend: prepareReceipt",!0),f=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(g)},{afterInit:!0,flush:!1,operationType:"prepare_receipt_load_identities"}));j=new Map();for(h of f){h[0];c=h[1];for(a of c){f=a[0];c=a[1];if(f===d("WAGlobals").getMyDeviceJid())continue;j.set(f,{pubKey:c})}}b.addPoint("get_identities_end");f=new Set();c={permittedIdentitiesPerDevice:j,recipientDevices:f,id:e};b.addPoint("save_receipts_start");await d("WASaveReceiptApi").saveReceipt(c).catch(function(a){b.addPoint("save_receipts_fail");d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to save receipt for message with error ",""])),a);return d("WAResultOrError").makeError("missing-receipt")});b.addPoint("save_receipts_end");return d("WAResultOrError").makeResult(c)}async function a(a,b,c){a=b.messagePayload;var e=b.loadThreadParticipants,f=b.sendIdentity;f=f===void 0?!1:f;b=b.isInstamadillo;b=b===void 0?!1:b;c.addPoint("prepare_receipt_start");e=await r({messagePayload:a,loadThreadParticipants:e},c);if(e.success===!1){c.addPoint("prepare_receipt_fail");d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message that does not have a receipt in db"])));return d("WAResultOrError").makeError({type:"missing-receipt"})}c.addPoint("prepare_receipt_end");e=e.value;var g=a.frankingKey,h=a.frankingVersion,i=a.messageBytes,n=a.backupDirective,o=a.messageType,p=a.protocolMsgId;a=s(e.permittedIdentitiesPerDevice);e=o.type==="text"&&o.invitedParticipantUserJid!=null?a.filter(function(a){return a.user===o.invitedParticipantUserJid||a.user===d("WAGlobals").getMyUserJid()}):a;c.addPoint("recipients-calculated",{int:{recipientsCount:e.length},string:{msgType:o.type}});a=o.type==="text"&&o.invitedParticipantUserJid!=null?o.invitedParticipantUserJid:p.chat;var q=p.chat===d("WAGlobals").getMyUserJid();if(e.length===0&&!q){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients"])));return d("WAResultOrError").makeError({type:"no-recipients",isRetriable:!1})}else if(e.length===0&&q){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients, but it is a self thread"])));return d("WAResultOrError").makeResult({baseKey:null,reportingMeta:null,serverTs:d("WATimeUtils").unixTime()})}q=f?await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return t(a)},{operationType:"get_my_device_identity",flush:!1,afterInit:!0}):null;f=await (o.isRevoked===!0?Promise.resolve(null):d("WAGenReportingMeta").genReportingMeta(i.bytes,g,h));return d("WASendMsgInternal").sendMessage({type:"chat",messageBytes:i,chat:a,deviceIdentity:q,messageType:o,protocolMsgId:p,externalId:p.externalId,recipients:e,reportingMeta:f,backupDirective:n},c,b).then(function(a){if(a.success)return d("WASentBytesCache").sentBytesCache().saveSentBytes({ts:a.value.serverTs,frankingKey:g,frankingVersion:h,messageBytes:i,backupDirective:n,messageType:o,protocolMsgId:p,waMsgId:d("WAMsg").craftWAMsgIdString({author:p.author,chat:p.chat,externalId:p.externalId})}).catch(function(a){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""])),a)}).then(function(){return a});else return a})}function s(a){var b=new Map();a.forEach(function(a,c){a=a.pubKey;var e=d("WAJids").extractUserJid(c);a={identity:a,jid:c};c=b.get(e)||[];c.push(a);b.set(e,c)});return Array.from(b,function(a){var b=a[0];a=a[1];return{devicesInfo:a,user:b}})}async function t(a){try{a=await a.storage.loadIdentities(d("WAGlobals").getMyUserJid());a=a.get(d("WAGlobals").getMyDeviceJid());if(a!=null)return a;throw c("err")("missing-identity")}catch(a){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""])),a)}}g.getDevicesBeforeSend=q;g.sendChatMessage=a}),98);
__d("WASetClockSkewApi",["WASetMetaApi"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){a=a.clockSkew;return d("WASetMetaApi").setMeta({clockSkew:a})};g.setClockSkew=a}),98);
__d("WASendPing",["WAComms","WALogger","WASetClockSkewApi","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendPing: sending"]))),d("WAComms").sendPing()}async function b(a,b){a=b.clockSkew;d("WATimeUtils").setClockSkew(a);await d("WASetClockSkewApi").setClockSkew({clockSkew:a})}g.sendPing=a;g.updateClockSkew=b}),98);
__d("WASyncAbProps",["WAAbPropsSync","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a,b){b=b.sendHash;d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Syncing ABProps"])));await d("WAAbPropsSync").syncAbProps({sendHash:b,eventFlow:a!=null?a:void 0})}g.syncAbProps=a}),98);
__d("WAUploadMedia",["WABase64","WABlobToArrayBuffer","WACheckCiphertextInServer","WACreateRetrier","WAEncryptAndUploadPlaintext","WAErrorMessage","WAFindReusableMediaEntry","WALogger","WAMediaUtils","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u;function a(a){var b=a.uploadMediaMetric;return v(babelHelpers.extends({},a)).catch(function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: unexpected runtime error: ",""])),a);return d("WAResultOrError").makeError("runtime-error")}).then(function(a){a.success?b.endSuccess():b.endFail(a.error,{string:{failReason:a.error}});return a})}async function v(a){a.chatJid;var b=a.filename,c=a.hash,e=a.mediaTypeDetails,f=a.protocolMsgId,g=a.size,h=a.uploadMediaMetric,u=a.getMediaKnownEntries,v=a.getMediaPlaintext,x=a.updateMediaEntryForMsg,y=a.updateMediaEntryForOptimisticUpload;a=a.getDownloadableThumbnailForMedia;var z;e.type==="regular"?z=e.mediaType:(z="preview",h.addAnnotations({string:{fullSizeMediaType:e.messageType}}));h.addPoint("create_upload_retrier_start");e=await d("WACreateRetrier").createUploadRetrier(z,h);if(!e.success){d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: fail to gather media routes"])));h.addPoint("create_upload_retrier_fail");return e}h.addPoint("create_upload_retrier_end");e=e.value;x=w(f,c,x,y,h);h.addPoint("get_media_entry_start");y=await u(c).catch(function(a){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: get media entry unexpected runtime error: ",""])),d("WAErrorMessage").maybeGetMessageFromError(a));h.addPoint("get_media_entry_fail");throw a});u=d("WAFindReusableMediaEntry").findReusableMediaEntryForArmadillo(f,y);h.addPoint("get_media_entry_end");if(u==null){h.addPoint("create_media_key_start");d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: no media entry found, need to upload media"])));f=d("WAMediaUtils").createMediaKey();y=d("WAMediaUtils").createUploadToken();var A=d("WATimeUtils").unixTime();h.addPoint("create_media_key_end");h.addPoint("get_media_plaintext_start");var B=await v(c).then(function(a){return a==null?null:d("WABlobToArrayBuffer").blobToArrayBuffer(a)});if(B==null){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: no plaintext"])));h.addPoint("get_media_plaintext_fail");return d("WAResultOrError").makeError("no-plaintext")}h.addPoint("get_media_plaintext_end");return d("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({size:g,filename:b,mediaKey:f,mediaKeyTimestamp:A,serverMediaType:z,mediaUploadFlow:h,plaintext:B,plaintextHash:c,updateMediaEntry:x,uploadRetrier:e,uploadToken:y,getDownloadableThumbnailForMedia:a})}f=u.directPath;A=u.downloadableThumbnail;B=u.fileEncSha256;y=u.fileSha256;var C=u.mediaKey,D=u.mediaKeyTimestamp,E=u.objectId;u=u.uploadToken;A={directPath:f,downloadableThumbnail:A,fileEncSha256:B,filename:b,fileSha256:y||d("WABase64").decodeB64UrlSafe(c),mediaKey:C,mediaKeyTimestamp:D,objectId:E,serverMediaType:z,size:g,uploadToken:u};if(f!=null){d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: async upload"])));await x(A);h.addAnnotations({bool:{reused_media_entry:!0}});return d("WAResultOrError").makeResult(A)}h.addPoint("resume_check_start");y=await d("WACheckCiphertextInServer").checkCiphertextInServer(z,B,u,e).catch(function(a){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: resume check unexpected runtime error: ",""])),d("WAErrorMessage").maybeGetMessageFromError(a));h.addPoint("resume_check_fail");throw a});if(!y.success){h.addPoint("resume_check_fail");d("WALogger").WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: resume/exist check exhausted available retries"])));return y}h.addPoint("resume_check_end");E=y.value;if(E.type==="media-found"){d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: media is on the server"])));h.addAnnotations({bool:{existingMediaFound:!0}});f=babelHelpers.extends({},A,{directPath:E.directPath,objectId:E.objectId});await x(f);h.addAnnotations({bool:{reused_media_entry:!0}});return d("WAResultOrError").makeResult(f)}else if(E.type==="media-partial-found"){d("WALogger").LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: media is partially on the server, start uploading from byteOffset ",""])),E.resumeFromBytes);B=E.resumeFromBytes;h.addPoint("get_media_plaintext_start");y=await v(c).then(function(a){return a==null?null:d("WABlobToArrayBuffer").blobToArrayBuffer(a)});if(y==null){d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: no plaintext"])));h.addPoint("get_media_plaintext_fail");return d("WAResultOrError").makeError("no-plaintext")}h.addPoint("get_media_plaintext_end");return d("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({size:g,filename:b,fromOffset:B,mediaKey:C,mediaKeyTimestamp:D,serverMediaType:z,mediaUploadFlow:h,plaintext:y,plaintextHash:c,updateMediaEntry:x,uploadRetrier:e,uploadToken:u,getDownloadableThumbnailForMedia:a})}d("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: media is not on the server, start uploading"])));A=d("WATimeUtils").unixTime();h.addPoint("get_media_plaintext_start");f=await v(c).then(function(a){return a==null?null:d("WABlobToArrayBuffer").blobToArrayBuffer(a)});if(f==null){d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: no plaintext"])));h.addPoint("get_media_plaintext_fail");return d("WAResultOrError").makeError("no-plaintext")}h.addPoint("get_media_plaintext_end");return d("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({size:g,filename:b,mediaKey:C,mediaKeyTimestamp:A,serverMediaType:z,mediaUploadFlow:h,plaintext:f,plaintextHash:c,updateMediaEntry:x,uploadRetrier:e,uploadToken:u,getDownloadableThumbnailForMedia:a})}function w(a,b,c,e,f){return function(g){f.addPoint("update_media_entry_start");var h=d("WAMediaUtils").encodeMediaEntryForUpload(g);g=a==null?e(b,function(){return h},g==null?void 0:g.objectId,g==null?void 0:g.serverMediaType):c(b,a,function(){return h},g==null?void 0:g.objectId,g==null?void 0:g.serverMediaType);return g.then(function(a){f.addPoint("update_media_entry_end");return a}).catch(function(a){d("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updateMediaEntry unexpected runtime error: ",""])),d("WAErrorMessage").maybeGetMessageFromError(a));f.addPoint("update_media_entry_fail");throw a})}}g.uploadMedia=a}),98);