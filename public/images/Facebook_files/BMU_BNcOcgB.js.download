;/*FB_PKG_DELIM*/

__d("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="24052353867781136"}),null);
__d("EBMessageRangeQueryWithPersistenceQuery.graphql",["EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessageRangeQueryWithPersistence",["Base64Utils","EBAPIConvertNativeToLS","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBDeriveAndStoreEpochs","EBGetClientState","EBMessageRangeQueryUtils","EBMessageRangeQueryWithPersistenceQuery.graphql","I64","LSDatabaseSingleton","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWJids","MAWJobDefinitions","MAWMiActGetThreadLifecycleState__DO_NOT_USE","MAWMiActThreadLifecycleState__DO_NOT_USE","QPLFlow","WAHashStringToNumber","WAJids","WAResultOrError","WATagsLogger","WorkerRelay","WorkerRelayNetwork","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryWithPersistence"),F=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("EBMessageRangeQueryWithPersistence"),G=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("EBMessageRangeQueryWithPersistence"),H=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryWithPersistence"]),I=h!==void 0?h:h=b("EBMessageRangeQueryWithPersistenceQuery.graphql");async function a(a){var b=a.chatJid,e=a.direction,g=a.includeOffset;g=g===void 0?!1:g;var h=a.numMessages,p=a.sortOrderMs,q=a.source,r=a.traceId;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql");var s=d("WAHashStringToNumber").hashStringToNumber(r),t=c("qpl")._(521471755,"2586"),u=d("QPLFlow").startQPLFlow(t,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1},int:{num_messages_requested:h,source:q!=null?q:c("LSMEBTaskCreationSource").UNKNOWN},string:{request_args:JSON.stringify(a)}},instanceKey:s,timeoutInMs:c("justknobx")._("2950")});try{H.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[","] Issuing messageRangeQuery with args: ",""])),r,JSON.stringify(a));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(q,r,"GQL_MAIN_THREAD");var v=await (B||(B=d("LSDatabaseSingleton"))).getLSDatabaseSingletonPromiseOrValue(),w;await v.runInTransaction(async function(a){var c;u.addPoint("get_client_state_start");w=await d("EBGetClientState").getClientState(v,a);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{device_id:(C||(C=d("I64"))).to_string((c=(c=w)==null?void 0:c.device_id)!=null?c:(C||(C=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:r});u.addPoint("get_client_state_end",{string:{device_id:C.to_string((c=(c=w)==null?void 0:c.device_id)!=null?c:(C||(C=d("I64"))).zero)}});c=await d("MAWMiActGetThreadLifecycleState__DO_NOT_USE").getThreadLifecycleStateByJid(a,d("MAWJids").convertChatJidToIntJid(b),"GQL_range_restore_eb_api_call");if(c.type===d("MAWMiActThreadLifecycleState__DO_NOT_USE").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW||c.type===d("MAWMiActThreadLifecycleState__DO_NOT_USE").MiActThreadStatesEnum.JID_MISSING_MI_THREAD){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:c.type}},pointName:"chat_jid_not_found_in_act_mapping_table",traceId:r});u.addPoint("chat_jid_not_found_in_act_mapping_table");d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(r,!1);u.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.thread.missing.error");return d("WAResultOrError").makeError("thread-not-found-in-mi-act-mapping-table")}else d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:c.type}},pointName:"chat_jid_exists_in_act_mapping_table",traceId:r}),u.addPoint("chat_jid_exists_in_act_mapping_table")},"readwrite",void 0,void 0,f.id+":185");if(w==null){H.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"])));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("no-client-state")}t=w;s=t.backupId;a=t.device_id;var x=t.locally_available_epochs,y=t.mailboxRootKey;t=t.ocmfClientStateBlob;if(s==null||a==null||y==null||t==null){H.ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"])));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"client_state_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var z=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"app_id_retrieved",traceId:r});u.addPoint("app_id_retrieved");var A=d("WAJids").threadIdForChatJid(b);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"converted_chatjid_to_threadid",traceId:r});u.addPoint("converted_chatjid_to_threadid");e=e==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;x={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(A),site:"www",tam_thread_subtype:0},success:babelHelpers.extends({device_context:{device_id:(C||(C=d("I64"))).to_string(a),locally_available_epochs:x,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(y),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(t)}},direction:e,include_offset:g,query_num_messages:h,server_thread_key:A},p!=null?{reference_timestamp:d("EBMessageRangeQueryUtils").safeTimestampMsString(p)}:{})};u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_start",traceId:r});var D;try{await d("WorkerRelayNetwork").createWorkerNetworkExecute(),D=await d("WorkerRelay").createWorkerQuery(I,{app_id:String(z!=null?z:"0"),restore_payload_string:JSON.stringify(x),restore_type:"RANGE_QUERY_RESTORE"}),u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_end",traceId:r})}catch(a){y=c("getErrorSafe")(a);u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,errorStackTrace:y.stack}});return d("WAResultOrError").makeError("invalid-graphql-response")}if(D==null||((t=D)==null||(t=t.viewer)==null||(t=t.encrypted_backup)==null?void 0:t.mailbox)==null){u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=(e=D)==null||(e=e.viewer)==null||(e=e.encrypted_backup)==null||(e=e.mailbox)==null?void 0:e.messages;if(g==null){H.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["GQL worker range restore query returned null for message response"])));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}h=g;if((h==null?void 0:h.encrypted_messages)==null){u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}A=h.backup_id;z=h.encrypted_messages;x=h.epoch_derivation_set;y=h.exception_string;t=h.message_range_info;e=h.should_delete_mailbox;g=h.thread_not_found;u.addAnnotations({bool:{should_delete_mailbox:e!=null?e:!1},int:{response_messages:z.length},string:{message_range_info:JSON.stringify(t)}});if(y!=null){H.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["server side exception during graphql restore - ",""])),y);if(g!=null&&g){u.addPoint("thread_not_found_on_server");d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"thread_not_found_on_server",traceId:r});u.endSuccess();d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(r,!1);return d("WAResultOrError").makeError("thread-not-found-on-server")}e===!0&&(u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"delete_mailbox",traceId:r}));u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:y}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{exception:y}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("server-side-exception")}u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);c("gkx")("7473")?await d("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(v,x):await d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(x,v,a,r);u.addAnnotations({bool:{hasEpochs:x!=null&&x.epoch_edges.length>0,nonLS:c("gkx")("7473")}});u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END);A==null&&(H.WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["backup_id is null during graphQL restore"]))),u.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"backup_id_null",traceId:r}));h=await J(v,b,z,A!=null?A:(C||(C=d("I64"))).to_string(s),t,r,u);if(h.success===!1)return h;K(v,b,h.value,p,q,r);return d("WAResultOrError").makeResult()}catch(a){g=c("getErrorSafe")(a);H.ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""])),g);u.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(e=g.stack)!=null?e:""}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(r,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",g)}}async function J(a,b,e,g,h,i,j){var k=d("WAJids").threadIdForChatJid(b),l=d("WAHashStringToNumber").hashStringToNumber(i),m=c("qpl")._(521471755,"2586");e.length===0&&(H.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No messages to restore"]))),j.addAnnotations({bool:{hasMessagesToRestore:!1}}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"no_messages",traceId:i}));if(h==null){H.ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["message range info is null - cannot proceed with graphQL restore"])));j.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}var n=h.has_more_after,o=h.has_more_before,B=h.next_message_timestamp_ms_after;h=h.next_message_timestamp_ms_before;if(o==null||n==null||B==null||h==null){H.ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["message range info is not complete - cannot proceed with graphQL restore"])));j.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}if(e.length===0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE);j.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:[],messageRangeInfo:{has_more_after:n,has_more_before:o,next_message_timestamp_ms_after:B,next_message_timestamp_ms_before:h},protobuf:[]})}g=d("handleRestoreMessagesGraphQLResponse").processMessageArray(e,g,m,l);var C=g.encryptedLSEchoMessages,D=g.encryptedMessagesWithProtobufs;m=g.encryptedNonLSEchoMessages;l=g.encryptedNonLSProtobufs;j.addAnnotations({bool:{hasEchoMessages:C.length>0,hasProtobufMessages:D.length>0}});if(c("gkx")("7473")){j.addPoint("native_decryption_start");g=d("WAJids").threadIdForChatJid(b);b=await d("EBAPIDecryptionModule").decryptUsingNativeJS(a,g,l,m);if(!b.success){j.endFail("native_decryption_error",{string:{error_description:"native_decryption_error"}});return d("WAResultOrError").makeError("native-decryption-error")}g=b.value.decryptedEchoMessages;b=b.value.decryptedProtobufs;g=d("EBAPIConvertNativeToLS").convertNativeDecryptionResponseToDecryptedMessageType(g,b);j.addPoint("native_decryption_success");return d("WAResultOrError").makeResult({echo:c("LSVec").toArray(g.echo),messageRangeInfo:{has_more_after:n,has_more_before:o,next_message_timestamp_ms_after:B,next_message_timestamp_ms_before:h},protobuf:c("LSVec").toArray(g.protobuf)})}e.length!==C.length+D.length&&j.addAnnotations({bool:{hasEchoProtobufCountMismatch:!0}});H.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery echo: "," protobuf: "," nonLsEcho: "," nonLSProtobuf: ",""])),i,C.length,D.length,m.length,l.length);var E,F;if(C.length>0&&D.length>0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RESTORING_MIXED_ECHO_PROTOBUF_PAYLOAD);j.addAnnotations({int:{echoMessagesPayloadSize:C.length,protobufMessagesPayloadSize:D.length,totalRestorePayloadSize:C.length+D.length}});j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_START);b=await a.runInTransaction(async function(a){var b=await c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessages:c("LSVec").ofArray(C)}),e=b[0];b=b[1];if(b!=null){var f=d("LSShape").toRecord(b);H.ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with an error."])));H.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with error: ",""])),f.error_message);j.addAnnotations({string:{echo_decryption_error:f.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error")}f=await c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessagesWithProtobufs:c("LSVec").ofArray(D)});a=f[0];f=f[1];if(f!=null){f=d("LSShape").toRecord(f);H.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with an error."])));H.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with error: ",""])),f.error_message);j.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}f=a==null?0:c("LSVec").toArray(a).length;b!=null&&f>0&&j.addAnnotations({bool:{continuedAfterEchoDecryptFailure:!0}});return{decryptedEchoMsgs:e,decryptedProtobufMsgs:a}},"readwrite",void 0,void 0,f.id+":768");g=b.decryptedEchoMsgs;e=b.decryptedProtobufMsgs;j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_END);var G;g!=null&&(G=c("LSVec").toArray(g).map(function(a){return d("LSShape").toRecord(a).value}));E=G;F=e==null?[]:c("LSVec").toArray(e)}else if(D.length===0){j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START);m=await a.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessages:c("LSVec").ofArray(C)})},"readwrite",void 0,void 0,f.id+":872");l=m[0];b=m[1];if(b!=null){g=d("LSShape").toRecord(b);H.ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."])));H.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""])),g.error_message);j.endFail("ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:g.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END);if(l!=null){e=c("LSVec").toArray(l).map(function(a){return d("LSShape").toRecord(a).value});E=e}}else{j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START);m=await a.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:k,encryptedMessagesWithProtobufs:c("LSVec").ofArray(D)})},"readwrite",void 0,void 0,f.id+":921");b=m[0];g=m[1];if(g!=null){l=d("LSShape").toRecord(g);H.ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"])));H.WARN(A||(A=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""])),l.error_message);j.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:l.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(i,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:l.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}j.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END);F=b==null?[]:c("LSVec").toArray(b)}j.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:E!=null?E:[],messageRangeInfo:{has_more_after:n,has_more_before:o,next_message_timestamp_ms_after:B,next_message_timestamp_ms_before:h},protobuf:F!=null?F:[]})}function K(a,b,e,g,h,i){var j=e.echo,k=e.messageRangeInfo,l=e.protobuf,m=d("WAJids").threadIdForChatJid(b);j.length>0&&l.length>0?c("promiseDone")(E.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(m,c("LSVec").ofArray(l),k.has_more_before,(C||(C=d("I64"))).of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray(j),(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)})):j.length>0?c("promiseDone")(F.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,(C||(C=d("I64"))).zero,c("LSVec").ofArray(j),k.has_more_before,C.of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,m,i,g,(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1010")})):c("promiseDone")(G.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,m,c("LSVec").ofArray(l),k.has_more_before,(C||(C=d("I64"))).of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray([]),(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1033")}))}g.query=I;g.messageRangeQueryWithPersistence_DEPRECATED_DO_NOT_USE=a}),98);
__d("EbFetchTimeoutMsForMLv2",["justknobx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("justknobx")._("3074")}g["default"]=a}),98);
__d("LSEBUnifiedRestoreUtils",["CurrentUser","LSIntEnum","LSMEBTaskCreationSource","LSProtobufRestoreHandler","LSVec","MAWAsyncEBPendingQueryPromise","MAWBridgeSafeActionsWorkerAndUI","MAWEBRestoreTrackingUtils","MAWEBUnstoredDbMsgUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWEBODSEntityName.enum","MWEBODSUtils","WATagsLogger","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n;async function a(a,b,e,f,g,o,p,q,r,s,t,u,v){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",q!=null?q:"no_request_id"]).LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["starting eb restore - ",""])),q!=null?q:"no_request_id");d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"unified_restore");var w=[].concat(d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(b));t=d("LSProtobufRestoreHandler").convertLSEchoMessageVecToArray(t);t=await d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("convertEchoMessagesToEBProtobufs",{chatJid:v,encodedEchoMessages:t});w.push.apply(w,t);d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(w,"protobuf_restore");if(q!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start_unified",traceId:q});t=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());t=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(w,a,void 0,t);if(e===!0&&t.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_decodedMessages_inconsistency",traceId:q});b=b!=null?c("LSVec").toArray(b).length:0;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",q!=null?q:"no_request_id"]).ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""])),b)}d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(q,{echoMessages:void 0,hasMoreAfter:g,hasMoreBefore:e,isPointQuery:p,messages:t,nextMessageTimestampMsBefore:f,protobufMessages:w,referenceTimestamp:r,requestId:q,restoreType:"protobuf",threadId:a})}catch(a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",q!=null?q:"no_request_id"]).ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["eb restore native op - Failed to decode protobufs, with error: ",""])),a.message)}e===!0&&w.length===0&&(q!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_messages_inconsistency",traceId:q}),d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",q!=null?q:"no_request_id"]).ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - no messages but hasMoreBefore is true"]))));b=u!=null&&(n||(n=d("LSIntEnum"))).unwrapIntEnum(u)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(b){q!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"search_restore_end",traceId:q});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(q);return Promise.resolve()}t=u!=null&&(n||(n=d("LSIntEnum"))).unwrapIntEnum(u)===c("LSMEBTaskCreationSource").MSGR_DYI;if(t){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",q!=null?q:"no_request_id"]).LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"])));await d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(a,w,e,f);q!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"dyi_restore_end",traceId:q});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(q);return Promise.resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),w,e,f,g,o,p,q,r,s,void 0,u,void 0,v),function(){q!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end_unified",traceId:q})},function(a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",q!=null?q:"no_request_id"]).ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - Failed to restore protobufs, with error: ",""])),a.message);a={string:{error:a.message}};q!=null&&d("MAWEBRestoreTrackingUtils").markEBRestoreFail(q,!1,"native_op_reject_unified",a)});return Promise.resolve()}g.echoProtobufConsolidatedRestoreHelper=a}),98);
__d("MWRestoreMessagesFromEB",["EBIsEbEnabled","EBMessageRangeQueryWithPersistence","I64","MAWAsyncEBPendingQueryPromise","MAWMainTraceUtils","MWEncryptedBackUpEBNotEnabledError","Promise","WATagsLogger","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a){var e=a.chatJid,f=a.newerNumMessages,g=a.passedTraceId,k=a.sortOrderMs,l=a.source;a=a.storage;if(!c("gkx")("23914"))return null;var m=g!=null?g:d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("EBIsEbEnabled").isEbEnabledLS(a.tables).then(function(a){if(a)return d("EBMessageRangeQueryWithPersistence").messageRangeQueryWithPersistence_DEPRECATED_DO_NOT_USE({chatJid:e,direction:(j||(j=d("I64"))).to_float(f)>0?"after":"before",includeOffset:c("gkx")("5340"),sortOrderMs:(j||(j=d("I64"))).to_string(k),source:l,traceId:m}).then(function(a){a.success||d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(m,c("err")(a.error))});else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore"]).WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Issuing message range query for chatJid: "," skipped. EB not enabled"])),e);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(m,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(i||(i=b("Promise"))).resolve()}}));return m}g["default"]=a}),98);
__d("MAWEBFetch",["EBFormatUtils","FBLogger","I64","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MWEncryptedBackUpEBNotEnabledError","MWRestoreMessagesFromEB","WAResultOrError","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;b=c("justknobx")._("3177");var i=Math.max(3,b-5);async function a(a){var b=a.chatJid,e=a.count,f=a.db,g=a.direction,i=a.timestampMs;a=a.traceId;e=d("EBFormatUtils").adjustCount(e,g);var k=e[0];e=e[1];b=c("MWRestoreMessagesFromEB")({chatJid:b,newerNumMessages:(h||(h=d("I64"))).of_int32(e),numMessages:h.of_int32(k),passedTraceId:a,sortOrderMs:d("EBFormatUtils").adjustTs(i,g),source:c("LSMEBTaskCreationSource").MESSENGER_MESSAGE_LIST_PAGINATION,storage:f});if(b==null)return d("WAResultOrError").makeResult({hasMoreAfter:!1,hasMoreBefore:!1,isEndOfCurrentFormat:!1,messages:[],restoreType:"none"});e=d("MAWAsyncEBPendingQueryPromise").getWaitForRestorePromiseFromTrace(b);k=await e.then(function(a){return d("WAResultOrError").makeResult(a)}).catch(function(a){if(a&&(a==null?void 0:a.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED)return d("WAResultOrError").makeError(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED);c("FBLogger")("messenger_web").catching(a).mustfix("[EBFetch] Failed to fetch");return d("WAResultOrError").makeError((a=a==null?void 0:a.message)!=null?a:"unknown")});if(k.success===!1)return k;a=k.value;i=a.hasMoreAfter;f=a.hasMoreBefore;b=a.messages;e=a.restoreType;return d("WAResultOrError").makeResult({hasMoreAfter:i,hasMoreBefore:f,isEndOfCurrentFormat:j(g,i,f,b),messages:b,restoreType:e})}function j(a,b,c,d){if(a==="before"&&c===!1)return!1;return a==="after"&&b===!1?!1:d.length<i}g.default=a}),98);
__d("MAWMessageIntegrityChecker",["FBLogger","MAWMessagesCompare","ReQL"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a.externalId===b.externalId)return 0;if(a.sortOrderMs>b.sortOrderMs)return 1;return a.sortOrderMs<b.sortOrderMs?-1:-1}function i(a,b){var c=b.reduce(function(a,b){b.externalId!=null&&a.set(b.externalId,b.sortOrderMs);return a},new Map());return a.map(function(a){var b;return babelHelpers.extends({},a,{sortOrderMs:(b=a.externalId!=null?c.get(a.externalId):null)!=null?b:a.sortOrderMs})}).sort(d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc"))}function j(a,b,c){a=new Set(a.map(function(a){return a.externalId}).filter(Boolean));return b.toSorted(d("MAWMessagesCompare").makeCompareMessageMetadataForDescOrderFn(a)).slice(0,c)}function a(a,b,d,e,f){var g=new Set(a.map(function(a){return a.externalId})),l=new Set(b.map(function(a){return a.externalId})),m=k(g,l);l=k(l,g);g=i(a,b);a=j(g,b,d);b=0;var n=0,o=0,p=0,q=[],r=null;while(b<g.length&&n<a.length){var s=g[b],t=a[n];if(r!=null&&h(t,r)===0){n+=1;r=t;c("FBLogger")("messenger_web_missing_messages").mustfix("Detected duplicate messages in reference. Target source: %s, reference source: %s",e,f);continue}var u=h(s,t);u===0?(b+=1,n+=1,r=t,q.push([s,{result:"consistent"}])):u<0?(n+=1,r=t,o+=1,q.push([t,{result:"missing_in_target"}])):(b+=1,p+=1,q.push([s,{result:"missing_in_reference"}]))}while(b<g.length){u=g[b];b+=1;a.length<d?(p+=1,q.push([u,{result:"missing_in_reference"}])):q.push([u,{result:"skipped_in_target"}])}while(n<a.length){t=a[n];n+=1;g.length<d?(o+=1,q.push([t,{result:"missing_in_target"}])):q.push([t,{result:"skipped_in_reference"}])}if(o===0&&p===0)return{detailedResults:q,result:"consistent",setDifferenceInReference:l,setDifferenceInTarget:m};else if(o>0&&p===0)return{detailedResults:q,numOfMissingMessages:o,result:"missing_in_target",setDifferenceInReference:l,setDifferenceInTarget:m};else if(o===0&&p>0)return{detailedResults:q,numOfMissingMessages:p,result:"missing_in_reference",setDifferenceInReference:l,setDifferenceInTarget:m};else return{detailedResults:q,numOfMissingMessages:p+o,result:"missing_in_both",setDifferenceInReference:l,setDifferenceInTarget:m}}async function b(a,b,d){a=d.filter(function(a){a[0];a=a[1];return a.result==="missing_in_target"}).map(function(a){var b=a[0];a[1];return b.externalId});var e={admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1},f=await b.fetchMessagesByExternalId(a,e),g=new Set(f.map(function(a){return a.externalId}));return Promise.all(d.map(async function(a){var b=a[0];a=a[1];if(!g.has(b.externalId))return[b,a];a=f.find(function(a){return a.externalId===b.externalId});if(!a){c("FBLogger")("messenger_web_missing_messages").mustfix("Failed to find msg with external id: %s in MAW",b.externalId);return[b,{result:"missing_in_target_invalid_sortOrder"}]}var d={sortOrderSkewMs:a.sortOrderMs-b.sortOrderMs,sortOrderSkewNumberOfMsg:0},e={result:"missing_in_target_invalid_sortOrder",sortOrderSkewMs:0};d.sortOrderSkewNumberOfMsg!=null&&(e=babelHelpers.extends({},e,{sortOrderSkewNumberOfMsg:d.sortOrderSkewNumberOfMsg}));return[babelHelpers.extends({},b,{msgType:a.msgType}),e]}))}async function e(a,b){var c=b.filter(function(a){a[0];a=a[1];return a.result==="missing_in_target"}).map(function(a){var b=a[0];a[1];return b.externalId});if(c.length===0)return b;c=c.map(function(b){return d("ReQL").fromTableAscending(a.tables.messages.index("optimistic")).getKeyRange(b)});var e=c.length===1;c=c.length>1?d("ReQL").union.apply(void 0,c):c[0];var f=await d("ReQL").toArrayAsync(c);return b.map(function(a){var b=a[0];a=a[1];var c=f.find(function(a){return a.offlineThreadingId===b.externalId});if(c!=null)return[b,{result:"missing_in_target_exists_in_lsdb",transportKey:c.transportKey,wouldHaveThrownS518614:e}];a.wouldHaveThrownS518614=e;return[b,a]})}function k(a,b){var c=0;for(a of a)b.has(a)||(c+=1);return c}g.checkIntegrityforMessageList=a;g.checkMsgsExistenceInMAWAndDecomposeTargetConsistencyResult=b;g.checkMsgsExistenceInLSDB=e}),98);
__d("MAWMessageIntegrityMissingInTargetCategory",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.hasEBFetchFailed,c=a.mawVsEB;a=a.uiVsEB;var d=i(a);a=c.detailedResults.filter(function(a){var b=a[0];a[1];return d.has(b.externalId)});return a.map(function(a){var c=a[0];a=a[1];a=h(c.externalId,a,b);return a==null?null:[c,a]}).filter(Boolean)}function h(a,b,d){switch(b.result){case"consistent":return"client_inconsistency";case"missing_in_target":return d?"eb_restore_timeout":"message_not_persisted_after_eb_restore";case"missing_in_target_invalid_sortOrder":return b.sortOrderSkewMs==null||b.sortOrderSkewMs===0?"message_out_of_order_same_timestamp":"message_out_of_order_different_timestamp";case"skipped_in_target":return"client_inconsistency_skipped";case"skipped_in_reference":return"unknown_skipped";case"missing_in_reference":case"missing_in_target_exists_in_lsdb":c("FBLogger")("messenger_web_missing_messages").mustfix("Unexpected consistency result %s for message with externalId %s when calculating missing in target category",b.result,a);return null;default:b.result;return null}}function i(a){return a.detailedResults.reduce(function(a,b){var c=b[0];b=b[1];b.result==="missing_in_target"&&a.add(c.externalId);return a},new Set())}g.calculateMissingInTargetCategory=a}),98);
__d("MAWMessageIntegrityCompareMessagesData",["I64","MAWMessageIntegrityChecker","MAWMessageIntegrityMissingInTargetCategory","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("WATagsLogger").TAGS(["MissingMessages"]);async function a(a,b,c,d,e,f){var g=e.S518614_messagesBacktest,h=g.backendMessages,i=g.ebMessages,j=g.mpsMessages;g=g.uiMessages;var k=e.S518614_pageSizeBacktest,l=e.messages,n=l.backendMessages,o=l.ebMessages,p=l.mpsMessages;l=l.uiMessages;e=e.pageSize;n=await m(a,b,c,d,f,n,o,p,l,e);o=n.mawVsEB;p=n.missingInTargetCategory;l=n.mpsVsEB;var q=n.mpsVsMaw,r=n.uiVsEB;n=n.uiVsMaw;a=await m(a,b,c,d,f,h,i,j,g,k,!0);b=a.mawVsEB;c=a.mpsVsEB;d=a.mpsVsMaw;f=a.uiVsEB;h=a.uiVsMaw;i=a.wouldHaveThrownS518614;return{S518614_mawVsEB:b,S518614_mpsVsEB:c,S518614_mpsVsMaw:d,S518614_pageSize:k,S518614_uiVsEB:f,S518614_uiVsMaw:h,S518614_wouldHaveThrown:i,mawVsEB:o,missingInTargetCategory:p,mpsVsEB:l,mpsVsMaw:q,pageSize:e,uiVsEB:r,uiVsMaw:n}}async function m(a,b,c,e,f,g,m,o,p,q,r){r===void 0&&(r=!1);var s=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(p,g,q,"ui","maw"),t=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(p,m,q,"ui","eb"),u=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(g,m,q,"maw","eb");g=o?d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(o,g,q,"mps","maw"):null;o=o?d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(o,m,q,"mps","eb"):null;t.result!=="consistent"&&(!r?l.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Missing message detected for ",", result: ",", num of messages missing: ",""])),(k||(k=d("I64"))).to_float(e),t.result,t.numOfMissingMessages):l.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["S518614 backtest: Missing message detected for ",", result: ",", num of messages missing: ",""])),(k||(k=d("I64"))).to_float(e),t.result,t.numOfMissingMessages));(t.result==="missing_in_target"||t.result==="missing_in_both")&&(t.detailedResults=n(t.detailedResults,p));(u.result==="missing_in_target"||u.result==="missing_in_both")&&(u.detailedResults=await d("MAWMessageIntegrityChecker").checkMsgsExistenceInMAWAndDecomposeTargetConsistencyResult(c,b,u.detailedResults));var v=!1;if(s.result==="missing_in_target"||s.result==="missing_in_both")try{s.detailedResults=await d("MAWMessageIntegrityChecker").checkMsgsExistenceInLSDB(a,s.detailedResults),s.detailedResults.map(function(a){a[0];a=a[1];v||(v=a.wouldHaveThrownS518614===!0)})}catch(a){l.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to get detailed results for UI vs MAW comparison: ",""])),a)}m=d("MAWMessageIntegrityMissingInTargetCategory").calculateMissingInTargetCategory({hasEBFetchFailed:f,mawVsEB:u,uiVsEB:t});return{mawVsEB:u,missingInTargetCategory:m,mpsVsEB:o,mpsVsMaw:g,pageSize:q,uiVsEB:t,uiVsMaw:s,wouldHaveThrownS518614:v}}function n(a,b){var c=new Set(b.map(function(a){return a.externalId}));return a.map(function(a){var b=a[0];a=a[1];return a.result==="missing_in_target"&&c.has(b.externalId)?[b,babelHelpers.extends({},a,{existingInUISamePage:!0})]:[b,a]})}g.compareMessagesData=a}),98);
__d("MAWMessageIntegrityFetchMessagesData",["I64","MAWBridgeSendAndReceive","MAWDbMsg","MAWEBDeanonFetch","MAWMessagesCompare","MAWMpsGating","MAWMpsMessageIntegrityFetch","MpsTypes","WAResultOrError","WAStanzaUtils","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a,b,c,e,f,g){var h=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","identifyXMAWithAssociatedTextByExternalId",{externalIds:g.map(function(a){return d("WAStanzaUtils").toStanzaId(a.offlineThreadingId)})}),m=g.map(k);a=await Promise.all([l(g),d("MAWMpsGating").isFullMpsEnabled()?[]:i(a,b,c,f,e),j(c,f,e),d("MAWMpsMessageIntegrityFetch").mpsMessageIntegrityFetch(c,"before",f,e)]);b=a[0];c=a[1];f=a[2];a=a[3];var n=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","identifyCollapsedMessagesByExternalId",{externalIds:f.map(function(a){return d("WAStanzaUtils").toStanzaId(a.externalId)})});function o(a){return!h.includes(a.externalId)}function p(a){return!n.includes(a.externalId)}function q(a){return o(a)&&p(a)}var r=b.filter(q),s=c.filter(q),t=f.filter(q),u=a==null?null:a.filter(q);m=m.filter(q);q=g.length-m.length;g=e-q;if(t.length===0)return d("WAResultOrError").makeError("EB result not available");m=d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc");q=[].concat(s).sort(m).slice(0,g);s=[].concat(t).sort(m).slice(0,g);t=r.sort(m).slice(0,g);r=u!=null?[].concat(u).sort(m).slice(0,g):null;u=e;e=[].concat(c).sort(m).slice(0,u);c=[].concat(f).sort(m).slice(0,u);f=[].concat(b).sort(m).slice(0,u);b=a!=null?[].concat(a).sort(m).slice(0,u):null;return d("WAResultOrError").makeResult({S518614_messagesBacktest:{backendMessages:e,ebMessages:c,mpsMessages:b,uiMessages:f},S518614_pageSizeBacktest:u,messages:{backendMessages:q,ebMessages:s,mpsMessages:r,uiMessages:t},pageSize:g})}async function i(a,b,c,e,f){e=m(e);var g=e.msgId;e=e.timestampMs;b=await b.requestMessages(a,c,(h||(h=d("I64"))).of_float(e),g,"before",f,{admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1},"integrity");return b.msgs}async function j(a,b,c){var e=m(b),f=e.msgId;e=e.timestampMs;f=await (f==null?Promise.resolve(null):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:f}));var g=(f=f==null?void 0:f.externalId)!=null?f:(f=b.lastItemFromPreviousPage)==null?void 0:f.offlineThreadingId;b=await d("MAWEBDeanonFetch").fetchMessagesMetadataFromEBDeanon({chatJid:a,count:c*2,direction:"before",includeReferenceTimestamp:!0,referenceExternalId:g,referenceTimestampMs:e});if(b.success===!1)return[];f=b.value.sort(d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc"));a=f.findIndex(function(a){return a.externalId===g});return f.slice(a+1)}function k(a){return{externalId:a.offlineThreadingId,msgType:(h||(h=d("I64"))).to_string(a.displayedContentTypes),sortOrderMs:h.to_float(a.primarySortKey)}}function l(a){var b=function(a){var b=d("MAWDbMsg").toMsgId(a.messageId);return b==null?Promise.resolve(k(a)):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:b}).then(function(b){return babelHelpers.extends({},a,{offlineThreadingId:(b=b==null?void 0:b.externalId)!=null?b:a.offlineThreadingId})}).then(k)};return Promise.all(a.map(b))}function m(a){if(a.type==="lastItemFromPreviousPage")return{messageId:d("MpsTypes").toMessageId(a.lastItemFromPreviousPage.offlineThreadingId),msgId:d("MAWDbMsg").toMsgId(a.lastItemFromPreviousPage.messageId),timestampMs:d("WATimeUtils").castToMillisTime((h||(h=d("I64"))).to_float(a.lastItemFromPreviousPage.primarySortKey))};a.type;return c("gkx")("15880")===!0?{messageId:null,msgId:null,timestampMs:a.timeOfSnapshotMs}:{messageId:null,msgId:null,timestampMs:d("WATimeUtils").millisTime()}}g.fetchMessagesDataForComparison=a;g.getRangeDetailsFromMessageIntegrityFromReference=m}),98);
__d("MAWMpsMessageIntegrityFetch",["MAWCurrentUser","MAWEBLSInWorkerSwitch","MAWEBSwitch","MAWMessageIntegrityFetchMessagesData","MAWMessagesDirection","MpsOverBridge","MpsTypes","WAPromiseDelays"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,e,f){e=d("MAWMessageIntegrityFetchMessagesData").getRangeDetailsFromMessageIntegrityFromReference(e);var g=e.messageId;e=e.timestampMs;c("MAWEBSwitch").isEnabled()===!0&&await Promise.race([d("WAPromiseDelays").delayMs(1e4),await c("MAWEBLSInWorkerSwitch").waitForEBEnabled()]);b=await d("MpsOverBridge").mps().loadMessages({config:{shouldFetchSupplementals:!1,shouldIgnoreLocalOnly:!0,strategy:"full-fetch"},debug:{purpose:"integrity-check"},direction:d("MAWMessagesDirection").translateMawDirectionToMwpDirection(b),from:[d("MpsTypes").toTimestamp(e),g],numMessages:f*2,threadId:d("MpsTypes").toThreadId(a)});return b.success===!1?null:b.value.messages.map(function(a){return{externalId:a.toplevelProtobuf.messageId,isOutgoing:a.toplevelProtobuf.senderId!==d("MAWCurrentUser").getID(),msgType:"",sortOrderMs:a.toplevelProtobuf.timestampMs}})}g.mpsMessageIntegrityFetch=a}),98);
__d("MAWSecureDataSource",[],(function(a,b,c,d,e,f){"use strict";a=10;f.DEFAULT_NUM_MESSAGES=a}),66);
__d("MAWSecureLocalDBDataSource",["I64","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWMessagesDirection","MAWMessagesPaginationUtils","MAWMiActOnActThreadReady","MAWPutMessagesToDB","MAWSecureDataSource","MAWSecureLocalDBFetch","MLV2DataSourceLogger","ReQL","WAStanzaUtils","WATagsLogger","err","isEbEnabledWithIGDEligibilityCheck","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=c("requireDeferred")("MAWEBFetch").__setRef("MAWSecureLocalDBDataSource"),n=d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]);function o(a){return a.msgs.map(function(a){return{externalId:a.externalId,isOptimistic:a.ack<1,isOutgoing:a.isAuthorMe,msgType:a.type_,sortOrderMs:a.sortOrderMs}})}a=function(){function a(){}var b=a.prototype;b.$1=async function(a,b,e,g,j,k,o,p,q){if(j==="after")return;j;n.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Fetch more: ",""])),b);d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(o,"before",b);j=await d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"MAWSecureLocalDBDataSource");j=j.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(o);d("MAWDataSourceLogger").logLoadMessagesFromLocalDBStart(o);var r=g.minMessageId,s=await d("MAWMessagesPaginationUtils").getExternalIdByMsgId(r);p=await c("MAWSecureLocalDBFetch")({actionType:p,chatJid:j,config:{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0},count:k,direction:"before",offsetMsg:{externalId:s,includeOriginalMsg:!1,messageId:r},timestampMs:e});if(p.success===!1){throw(s=p.payload)!=null?s:c("err")(p.error)}var t=p.value;d("MAWDataSourceLogger").logLoadMessagesFromLocalDBEnd(o);d("MAWDataSourceLogger").logInsertMessageResponseToLSDBStart(o);d("MAWMessagesPaginationUtils").populateExternalIdCache(t.msgs);var u=t.msgs.length>0?t.msgs[t.msgs.length-1].msgId:g.minMessageId;await a.runInTransaction(async function(b){var c;await d("MAWPutMessagesToDB").insertMessageResponseToDBInExistingTransaction(a,b,t,q,o);c=await (c=b.messages_ranges_v2__generated).get.apply(c,[g.threadKey,g.minTimestampMs,g.minMessageId]);if(c==null)return;var e=t.hasMoreBefore;t.hasMoreBefore===!1&&await d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(a)&&(e=!0);await b.messages_ranges_v2__generated.upsert([c.threadKey,c.minTimestampMs,c.minMessageId],{hasMoreAfter:!1,hasMoreBefore:e,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:c.maxMessageId,maxTimestampMs:c.maxTimestampMs,minMessageId:u,minTimestampMs:(l||(l=d("I64"))).zero,threadKey:g.threadKey})},"readwrite","ui",void 0,f.id+":146");d("MAWDataSourceLogger").logInsertMessageResponseToLSDBEnd(o);d("MAWDataSourceLogger").logLoadMoreMsgsFetched(o,t.hasMoreBefore);if(t.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(o);return}r=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{chatJid:j,mayBeAdminMsgId:d("MAWDbMsg").toMsgId(g.minMessageId)});d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," minMsgSortOrderTsResponse ",""])),j,r.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(o,r.minMsgTimestampMs);e=await m.load();s=await e({chatJid:j,count:k,db:a,direction:"before",timestampMs:(l||(l=d("I64"))).of_float(r.minMsgTimestampMs)});s.success&&s.value.hasMoreBefore===!1&&await a.runInTransaction(async function(c){var e=g.minTimestampMs,f=await d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(b).bounds({lte:[e]}).filter(function(a){var b=a.maxTimestampMs;a=a.minTimestampMs;return(l||(l=d("I64"))).ge(e,a)&&(l||(l=d("I64"))).le(e,b)}));if(f==null)return;await c.messages_ranges_v2__generated.upsert([f.threadKey,f.minTimestampMs,f.minMessageId],babelHelpers.extends({},f,{hasMoreBefore:!1,isLoadingBefore:!1}))},"readwrite","ui",void 0,f.id+":231");d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(o)};b.requestMessages=async function(a,b,e,f,g,h,i,j){a=await d("MAWMessagesPaginationUtils").getExternalIdByMsgId(f);j=await c("MAWSecureLocalDBFetch")({actionType:j,chatJid:b,config:i,count:h!=null?h:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES,direction:g,offsetMsg:f==null?null:{externalId:a,includeOriginalMsg:!1,messageId:f},timestampMs:e});if(j.success===!1){throw(b=j.payload)!=null?b:c("err")(j.error)}i=j.value;d("MAWMessagesPaginationUtils").populateExternalIdCache(i.msgs);h=i.msgs.map(function(a){return{externalId:a.externalId,isOptimistic:a.ack<1,isOutgoing:a.isAuthorMe,msgType:a.type_,sortOrderMs:a.sortOrderMs}});return{hasMoreAfter:i.hasMoreAfter,hasMoreBefore:i.hasMoreBefore,msgs:h}};b.fetchSecureMessagesProtocol=function(a,b,c,e,f,g,h,i,k){h===void 0&&(h=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);c=d("MAWDataSourceLogger").logLoadMoreMsgsStart(c);return this.$1(a,b,e,f,g,h,c,i,k).catch(function(a){var c;n.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch messages: ",""])),a);(c=d("MLV2DataSourceLogger").getMLV2LoggerForThread(b,d("MAWMessagesDirection").translateMawDirectionToMwpDirection(g)))==null||c.markQPLFailure(a)})};b.fetchMessagesByExternalId=function(a,b){a.length>2&&n.WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Fetching "," messages by external id, which is not optimal.\n      Consider migrating 'loadMsgsByExternalId' backend request to a batch version "])),a.length);a=a.map(function(a){return d("MAWBridgeSendAndReceive").sendAndReceive("backend","loadMsgsByExternalId",{config:b,externalId:d("WAStanzaUtils").toStanzaId(a)})});return Promise.all(a).then(function(a){return a.map(function(a){return o(a)}).flat()})};return a}();g.default=a}),98);
__d("MAWMessageIntegrityFetchAndCompareData",["MAWMessageIntegrityCompareMessagesData","MAWMessageIntegrityFetchMessagesData","MAWMiActOnActThreadReady","MAWSecureLocalDBDataSource","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h=new(c("MAWSecureLocalDBDataSource"))();async function a(a){var b=a.db,c=a.fromReferencePoint,e=a.hasEbFetchFailed,f=a.localMessages,g=a.pageSize;a=a.threadKey;var i=await d("MAWMiActOnActThreadReady").waitForACTThreadReady(b.tables,a,"fetchAndCompareMessagesData");i=i.chatJid;g=await d("MAWMessageIntegrityFetchMessagesData").fetchMessagesDataForComparison(b,h,i,g,c,f);if(g.success===!1)return g;c=await d("MAWMessageIntegrityCompareMessagesData").compareMessagesData(b,h,i,a,g.value,e);return d("WAResultOrError").makeResult(c)}g.fetchAndCompareMessagesData=a}),98);
__d("MAWMessagesIntegrityEphemeralSettings",["I64","MAWGetEphemeralSettings","MAWMiActOnActThreadReady","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;async function a(a,b,c){a=await d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"getIsEphemeralMessagesEnabledForPage");a=a.chatJid;a=await d("MAWGetEphemeralSettings").getEphemeralSetting(a,b);if(a==null||a.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").DEFAULT_UNIXTIME)return"disabled";return d("WATimeUtils").castUnixTimeToMillisTime(a.ephemeralLastUpdatedOrSetTimestamp)<(h||(h=d("I64"))).to_float(c)?a.ephemeralExpirationInSec>0?"enabled":"disabled":a.ephemeralExpirationInSec>0?"maybeDisabled":"maybeEnabled"}g.getEphemeralMessagesStatusForPage=a}),98);
__d("MAWMessageIntegrityCheck",["CometDebounce","DateConsts","EbFetchTimeoutMsForMLv2","I64","MAWBridgeSendAndReceive","MAWEBCombinedSwitch","MAWMessageIntegrityCheckFlytrapResultCache","MAWMessageIntegrityEBFetchStatus","MAWMessageIntegrityFetchAndCompareData","MAWMessageIntegrityTruncateStatus","MAWMessagesIntegrityEphemeralSettings","MAWMiActOnActThreadReady","WACommsConnectionState","WAPromiseDelays","WATagsLogger","WATimeUtils","gkx","justknobx","logMessengerWebFalcoEvent"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v="11",w=1e3*60*2,x=d("WATagsLogger").TAGS(["MissingMessages"]),y=c("CometDebounce")(c("logMessengerWebFalcoEvent"));function z(a){if(a.length===0)return null;var b=0;for(a of a)b=Math.max(b,(u||(u=d("I64"))).to_float(a.primarySortKey));return d("WATimeUtils").castToMillisTime(b)}function A(a,b){a=z(a);if(a==null)return b;var d=Math.abs(a-b),e=c("justknobx")._("4843");return d<e?a:b}async function a(a,b,e,f,g,z,D,H,I,J){x.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["run Message Integrity Check - threadKey: ",", lastItem: ",", pageSize: ",""])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),g);if(d("WATimeUtils").millisTime()-I>w){x.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: check was scheduled more than 2 minutes ago"])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey));return}var K=d("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled();if(z==null&&d("WACommsConnectionState").WACommsConnectionState.isConnected()===!1&&c("gkx")("15879")===!0){x.LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: WACOMMS is disconnected"])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey));return}var L=z==null&&c("gkx")("15880")===!0;if(L){var M=c("justknobx")._("4844"),N=I+M;N=Math.min(N-d("WATimeUtils").millisTime(),M);x.LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check - threadKey "," - Latest Page - waiting ","ms"])),(u||(u=d("I64"))).to_string(b),N);await d("WAPromiseDelays").delayMs(N)}M=d("WATimeUtils").millisTime();N=c("gkx")("1626");var O=d("MAWMessageIntegrityEBFetchStatus").hasEBFailure(b),P=d("MAWMessageIntegrityTruncateStatus").getThreadThuncateState(b),Q=z!=null?{lastItemFromPreviousPage:z,type:"lastItemFromPreviousPage"}:{timeOfSnapshotMs:A(D,I),type:"latestPageSnapshot"};Q=await d("MAWMessageIntegrityFetchAndCompareData").fetchAndCompareMessagesData({db:a,fromReferencePoint:Q,hasEbFetchFailed:O,localMessages:D,pageSize:g,threadKey:b});if(Q.success===!1){x.LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: ",""])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),Q.error);return}g=Q.value;c("gkx")("4852")&&g.uiVsEB.detailedResults.some(function(a){a[0];a=a[1];return a==="missing_in_target"})&&J();Q=d("MAWMessageIntegrityCheckFlytrapResultCache").generateMessageIntegrityCheckPageKey(b,D);d("MAWMessageIntegrityCheckFlytrapResultCache").cacheMessageIntegrityCheckResult(Q,g.missingInTargetCategory);x.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against backend data: ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.uiVsMaw));x.LOG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against EB data: ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.uiVsEB));x.LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", MPS (target) vs MAW (reference): ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.mpsVsMaw));x.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", MPS (target) vs EB (reference): ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.mpsVsEB));x.LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check Flytrap result - threadKey: ",", missingInTargetCategory: ",""])),u.to_string(b),JSON.stringify(g.missingInTargetCategory));x.LOG(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check Truncate state - threadKey: ",", state: ",""])),u.to_string(b),JSON.stringify(P));J=C(g.mawVsEB);Q=C(g.uiVsEB);var R=C(g.uiVsMaw),S=g.mpsVsMaw!=null?C(g.mpsVsMaw):{},T=g.mpsVsEB!=null?C(g.mpsVsEB):{},U=C(g.S518614_mawVsEB),V=C(g.S518614_uiVsEB),W=C(g.S518614_uiVsMaw),X=g.S518614_mpsVsMaw!=null?C(g.S518614_mpsVsMaw):{},Y=g.S518614_mpsVsEB!=null?C(g.S518614_mpsVsEB):{};D=E(D);var Z=await d("MAWMessagesIntegrityEphemeralSettings").getEphemeralMessagesStatusForPage(a,b,D);a=await F(a,b);var $=await d("WAPromiseDelays").withTimeout(G({messages:[]}).catch(function(a){x.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to get extra debug info: ",""])),a);return"error"}),1e4,function(){return"timeout"});T={MAW_vs_EB_detailedResults:J.detailedResults,MAW_vs_EB_numOfMissingInReference:J.numOfMissingInReference,MAW_vs_EB_numOfMissingInTarget:J.numOfMissingInTarget,MAW_vs_EB_numOfMissingInTargetInvalidSortOrder:J.numOfMissingInTargetInvalidSortOrder,MAW_vs_EB_setNumOfMissingInReference:J.setDifferenceInReference,MAW_vs_EB_setNumOfMissingInTarget:J.setDifferenceInTarget,MPS_vs_EB_detailedResults:(J=T.detailedResults)!=null?J:"",MPS_vs_EB_numOfMissingInReference:(J=T.numOfMissingInReference)!=null?J:"",MPS_vs_EB_numOfMissingInTarget:(J=T.numOfMissingInTarget)!=null?J:"",MPS_vs_MAW_detailedResults:(T=S.detailedResults)!=null?T:"",MPS_vs_MAW_numOfMissingInReference:(J=S.numOfMissingInReference)!=null?J:"",MPS_vs_MAW_numOfMissingInTarget:(T=S.numOfMissingInTarget)!=null?T:"",S518614_MAW_vs_EB_detailedResults:(J=U.detailedResults)!=null?J:"",S518614_MPS_vs_EB_detailedResults:(S=Y.detailedResults)!=null?S:"",S518614_MPS_vs_MAW_detailedResults:(T=X.detailedResults)!=null?T:"",S518614_pageSize:g.S518614_pageSize.toString(),S518614_UI_vs_EB_detailedResults:(U=V.detailedResults)!=null?U:"",S518614_UI_vs_MAW_detailedResults:(J=W.detailedResults)!=null?J:"",S518614_wouldHaveThrown:B(g.S518614_wouldHaveThrown),UI_vs_EB_detailedResults:Q.detailedResults,UI_vs_EB_numOfMissingInReference:Q.numOfMissingInReference,UI_vs_EB_numOfMissingInTarget:Q.numOfMissingInTarget,UI_vs_EB_setNumOfMissingInReference:Q.setDifferenceInReference,UI_vs_EB_setNumOfMissingInTarget:Q.setDifferenceInTarget,UI_vs_MAW_detailedResults:R.detailedResults,UI_vs_MAW_numOfMissingInReference:R.numOfMissingInReference,UI_vs_MAW_numOfMissingInTarget:R.numOfMissingInTarget,UI_vs_MAW_setNumOfMissingInReference:R.setDifferenceInReference,UI_vs_MAW_setNumOfMissingInTarget:R.setDifferenceInTarget,ebMetadataCacheStatus:a,ebTimeoutSec:(c("EbFetchTimeoutMsForMLv2")()/d("DateConsts").MS_PER_SEC).toString(),endRangeTimestampMs:u.to_string(D),ephemeralMessagesStatus:Z+"",extraDebugInfo:$,hasAdditionalData:B(N),hasEBFetchFailed:B(O),integrityCheckScheduleTimestampMs:I.toString(),isDogfooding:B(c("gkx")("2972")),isEbEnabled:B(K),isEbGraphQL:K?"false":B(c("gkx")("7083")),isHoldout_H2_2025:B(c("gkx")("15728")),isJidOptimisationInRestoreEnabled:B(c("gkx")("3137")),isMpsEnabled:"true",isUsePageTimeForLatestPage:B(L),isUsingLsInitCache:B(c("gkx")("15958")),lastItemExternalId:(Y=z==null?void 0:z.offlineThreadingId)!=null?Y:"null",lastItemTimestamp:u.to_string((S=z==null?void 0:z.primarySortKey)!=null?S:(u||(u=d("I64"))).zero),missingInTargetCategory:JSON.stringify(g.missingInTargetCategory),pageIndex:H+"",pageSize:g.pageSize+"",reportTimeMs:M.toString(),truncateState:(X=JSON.stringify(P))!=null?X:"null",version:K?v:"0",waCommsIsConnected:B(d("WACommsConnectionState").WACommsConnectionState.isConnected())};c("gkx")("970")&&x.DEV(t||(t=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check - Falco Report"]))).devConsole({falcoReport:T});y({threadKey:b,threadType:e},"message_integrity_check",f,T)}function B(a){return a===!0?"true":"false"}function C(a){var b=0,c=0,d=0;a.detailedResults.forEach(function(a){a[0];a=a[1];switch(a.result){case"missing_in_target":case"missing_in_target_exists_in_lsdb":b+=1;break;case"missing_in_target_invalid_sortOrder":c+=1;b+=1;break;case"missing_in_reference":d+=1;break;case"consistent":case"skipped_in_target":case"skipped_in_reference":break;default:a.result}});return{detailedResults:D(a.detailedResults),numOfMissingInReference:d+"",numOfMissingInTarget:b+"",numOfMissingInTargetInvalidSortOrder:c+"",setDifferenceInReference:a.setDifferenceInReference+"",setDifferenceInTarget:a.setDifferenceInTarget+""}}function D(a){a=a.map(function(a){var b=a[0];a=a[1];var d=a.existingInUISamePage,e=a.result,f=a.sortOrderSkewMs;a=a.sortOrderSkewNumberOfMsg;return babelHelpers.extends({existingInUISamePage:d,externalId:b.externalId,isOutgoing:b.isOutgoing},c("gkx")("1626")?{msgType:b.msgType,sortOrderMs:b.sortOrderMs}:{},{result:e,sortOrderSkewMs:f!=null?f:0,sortOrderSkewNumberOfMsg:a!=null?a:0})});return JSON.stringify(a)}function E(a){return a.length===0?(u||(u=d("I64"))).min_int:a.map(function(a){return a.timestampMs}).sort((u||(u=d("I64"))).compare)[0]}async function F(a,b){a=await d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"fetchAndCompareMessagesData");b=a.chatJid;a=await d("MAWBridgeSendAndReceive").sendAndReceive("backend","getEBMetadataCacheDetailsForThread",{chatJid:b});return JSON.stringify(a)}async function G(a){a={browser:{loadEventEnd:window.performance.timing.loadEventEnd,navigationStart:window.performance.timing.navigationStart},worker:await d("MAWBridgeSendAndReceive").sendAndReceive("backend","getWorkerBasedMessageIntegrityDebugInfo",a)};return JSON.stringify(a)}b={runMessageIntegrityCheck:a};g.default=b}),98);